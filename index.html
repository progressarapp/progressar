<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PROGRESSAR â€” ProgressÃ£o de Carga Inteligente</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PROGRESSAR">
  <link rel="apple-touch-icon" href="icons/icon-192.svg">
  <meta name="theme-color" content="#FF5C00">
  <meta name="description" content="App de progressÃ£o de carga baseado no MÃ©todo Paulo Muzy. Sem planilha, sem achismo.">
  <meta property="og:title" content="PROGRESSAR â€” ProgressÃ£o Inteligente">
  <meta property="og:description" content="Coach virtual, cardio inteligente, modo iniciante e progressÃ£o automÃ¡tica.">
  <meta property="og:type" content="website">
<style>
  /* (mesmo estilo do original, sem alteraÃ§Ãµes) */
  :root {
    --orange: #FF5C00;
    --orange-dim: #FF5C0022;
    --orange-mid: #FF5C0055;
    --dark: #0A0A0A;
    --darker: #060606;
    --card: #111111;
    --card2: #161616;
    --border: #222222;
    --border2: #2A2A2A;
    --text: #F0F0F0;
    --muted: #666666;
    --muted2: #888888;
    --green: #00E676;
    --green-dim: #00E67622;
    --blue: #448AFF;
    --blue-dim: #448AFF22;
    --red: #FF5252;
    --red-dim: #FF525222;
    --yellow: #FFD740;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--darker);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 9999;
    opacity: 0.4;
  }

  .app { display: flex; height: 100vh; }

  .sidebar {
    width: 68px;
    background: var(--card);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 0;
    gap: 8px;
    position: fixed;
    left: 0; top: 0; bottom: 0;
    z-index: 200;
  }

  .logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    color: var(--orange);
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    letter-spacing: 4px;
    margin-bottom: 24px;
    cursor: pointer;
  }

  .nav-btn {
    width: 44px; height: 44px;
    border-radius: 12px;
    border: 1px solid transparent;
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s;
    position: relative;
  }

  .nav-btn:hover { background: var(--border); color: var(--text); }
  .nav-btn.active {
    background: var(--orange-dim);
    border-color: var(--orange-mid);
    color: var(--orange);
  }

  .nav-btn .tooltip {
    position: absolute;
    left: 54px;
    background: var(--card2);
    border: 1px solid var(--border2);
    color: var(--text);
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 6px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }

  .nav-btn:hover .tooltip { opacity: 1; }

  .main {
    margin-left: 68px;
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .view { display: none; animation: fadeIn 0.3s ease; }
  .view.active { display: block; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  .page-header {
    padding: 32px 32px 0;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
  }

  .page-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 48px;
    color: var(--text);
    letter-spacing: 2px;
    line-height: 1;
  }

  .page-subtitle { font-size: 14px; color: var(--muted2); margin-top: 4px; }

  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
  }

  .card-sm { padding: 16px; border-radius: 12px; }

  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }

  .btn {
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    font-size: 14px;
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn-primary {
    background: var(--orange);
    color: white;
  }
  .btn-primary:hover { background: #FF7020; transform: translateY(-1px); box-shadow: 0 4px 20px var(--orange-mid); }

  .btn-ghost {
    background: transparent;
    border: 1px solid var(--border2);
    color: var(--muted2);
  }
  .btn-ghost:hover { background: var(--card2); color: var(--text); }

  .btn-success {
    background: var(--green-dim);
    border: 1px solid var(--green);
    color: var(--green);
  }
  .btn-success:hover { background: var(--green); color: var(--dark); }

  .btn-full { width: 100%; justify-content: center; }
  .btn-lg { padding: 14px 28px; font-size: 16px; border-radius: 14px; }

  .tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .tag-orange { background: var(--orange-dim); color: var(--orange); border: 1px solid var(--orange-mid); }
  .tag-green { background: var(--green-dim); color: var(--green); }
  .tag-blue { background: var(--blue-dim); color: var(--blue); }
  .tag-red { background: var(--red-dim); color: var(--red); }

  input, select {
    background: var(--card2);
    border: 1px solid var(--border2);
    border-radius: 10px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    padding: 10px 14px;
    width: 100%;
    outline: none;
    transition: border-color 0.2s;
  }

  input:focus, select:focus { border-color: var(--orange); }
  input[type=number] { font-family: 'DM Mono', monospace; }

  select option { background: var(--card2); }

  label { font-size: 12px; color: var(--muted2); font-weight: 500; margin-bottom: 6px; display: block; }

  .sep { border: none; border-top: 1px solid var(--border); margin: 24px 0; }

  .stat-number {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 52px;
    color: var(--orange);
    line-height: 1;
  }

  .stat-label { font-size: 12px; color: var(--muted2); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }

  .progress-bar {
    height: 6px;
    background: var(--border2);
    border-radius: 99px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--orange);
    border-radius: 99px;
    transition: width 0.5s ease;
  }

  .progress-fill.green { background: var(--green); }

  .exercise-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .exercise-row:hover { border-color: var(--orange-mid); background: #1A1A1A; }
  .exercise-row.selected { border-color: var(--orange); background: var(--orange-dim); }

  .exercise-icon {
    width: 40px; height: 40px;
    background: var(--border);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }

  .exercise-name { font-weight: 600; font-size: 14px; }
  .exercise-meta { font-size: 12px; color: var(--muted2); margin-top: 2px; }

  .set-row {
    display: grid;
    grid-template-columns: 36px 1fr 1fr 40px;
    gap: 8px;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }

  .set-number {
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    color: var(--muted);
    text-align: center;
    background: var(--border);
    border-radius: 6px;
    padding: 4px 0;
  }

  .set-number.done { background: var(--green-dim); color: var(--green); }

  .chart-container {
    position: relative;
    width: 100%;
    height: 160px;
  }

  canvas { width: 100% !important; }

  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--card);
    border: 1px solid var(--border2);
    border-radius: 14px;
    padding: 14px 18px;
    max-width: 320px;
    z-index: 9998;
    transform: translateX(400px);
    transition: transform 0.3s ease;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }

  .notification.show { transform: translateX(0); }
  .notification-icon { font-size: 22px; }
  .notification-title { font-weight: 700; font-size: 14px; margin-bottom: 2px; }
  .notification-msg { font-size: 13px; color: var(--muted2); }
  .notification.success { border-color: var(--green); }
  .notification.warning { border-color: var(--yellow); }

  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.78);
    backdrop-filter: blur(4px);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px 14px;
    box-sizing: border-box;
  }
  .modal-overlay.open { display: flex; }

  /* Bottom sheet â€” apenas coach, tecnica e rest */
  #coach-modal.open,
  #tecnica-modal.open,
  #rest-modal.open {
    align-items: flex-end;
    padding: 0;
  }

  .modal {
    background: var(--card);
    border: 1px solid var(--border2);
    border-radius: 20px;
    padding: 24px 22px;
    width: 100%;
    max-width: 500px;
    max-height: 85vh;
    overflow-y: auto;
    margin: 0 auto;
    box-sizing: border-box;
    animation: slideUp 0.25s ease;
  }

  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  .modal-title { font-family: 'Bebas Neue', sans-serif; font-size: 28px; margin-bottom: 20px; letter-spacing: 1px; }

  .timer-display {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 64px;
    color: var(--orange);
    text-align: center;
    letter-spacing: 4px;
    line-height: 1;
  }

  .timer-label { text-align: center; font-size: 12px; color: var(--muted2); text-transform: uppercase; letter-spacing: 2px; margin-top: 4px; }

  .workout-header {
    background: linear-gradient(135deg, #1A0800 0%, #0F0F0F 100%);
    border-bottom: 1px solid var(--border);
    padding: 20px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .progress-arrow {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 13px;
    font-weight: 700;
  }

  .progress-arrow.up { color: var(--green); }
  .progress-arrow.same { color: var(--yellow); }
  .progress-arrow.down { color: var(--red); }

  .suggestion-box {
    background: linear-gradient(135deg, #1A0D00 0%, #111111 100%);
    border: 1px solid var(--orange-mid);
    border-radius: 16px;
    padding: 20px;
  }

  .suggestion-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    color: var(--orange);
    letter-spacing: 1px;
    margin-bottom: 12px;
  }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 99px; }

  .section { padding: 24px 32px; }

  .section-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    color: var(--muted2);
    letter-spacing: 2px;
    margin-bottom: 16px;
  }

  .onboarding-bg {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: radial-gradient(ellipse at 30% 50%, #1A0D00 0%, var(--darker) 60%);
    padding: 32px;
  }

  .onboarding-card {
    background: var(--card);
    border: 1px solid var(--border2);
    border-radius: 24px;
    padding: 40px;
    max-width: 440px;
    width: 100%;
    text-align: center;
  }

  .onboarding-logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 56px;
    color: var(--orange);
    letter-spacing: 6px;
    margin-bottom: 8px;
  }

  .step { display: none; }
  .step.active { display: block; }

  .step-dots {
    display: flex;
    gap: 6px;
    justify-content: center;
    margin-bottom: 28px;
  }

  .dot {
    width: 6px; height: 6px;
    border-radius: 99px;
    background: var(--border2);
    transition: all 0.3s;
  }
  .dot.active { background: var(--orange); width: 20px; }

  .muscle-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }

  .muscle-btn {
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    font-size: 12px;
    color: var(--muted2);
  }

  .muscle-btn:hover, .muscle-btn.active {
    background: var(--orange-dim);
    border-color: var(--orange);
    color: var(--orange);
  }

  .muscle-btn .emoji { font-size: 20px; display: block; margin-bottom: 4px; }

  .ring-chart {
    position: relative;
    width: 80px; height: 80px;
    flex-shrink: 0;
  }

  .ring-chart svg { transform: rotate(-90deg); }
  .ring-chart .ring-value {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    color: var(--orange);
  }

  @media (max-width: 768px) {
    .sidebar {
      width: 100% !important;
      height: 60px !important;
      top: auto !important;
      bottom: 0 !important;
      left: 0 !important;
      right: 0 !important;
      flex-direction: row !important;
      justify-content: space-around !important;
      align-items: center !important;
      padding: 0 8px !important;
      border-right: none !important;
      border-top: 1px solid var(--border) !important;
      gap: 0 !important;
      z-index: 1000 !important;
    }

    .sidebar .logo { display: none !important; }

    .main {
      margin-left: 0 !important;
      margin-bottom: 60px !important;
      width: 100% !important;
    }

    .nav-btn .tooltip { display: none !important; }

    .nav-btn {
      width: 48px !important;
      height: 48px !important;
      border-radius: 12px !important;
      font-size: 20px !important;
    }

    .grid-2, .grid-3 { grid-template-columns: 1fr !important; }

    .section { padding: 16px !important; }
    .page-header { padding: 16px 16px 0 !important; }

    .page-title { font-size: 36px !important; }

    #active-workout-view .card { margin-left: 0 !important; margin-right: 0 !important; }

    .modal-overlay {
      padding: 12px !important;
      align-items: center !important;
    }

    /* Bottom sheets â€” coach, tecnica, rest ficam na base */
    #coach-modal,
    #tecnica-modal,
    #rest-modal {
      padding: 0 !important;
      align-items: flex-end !important;
    }
    #coach-modal > div,
    #tecnica-modal > div,
    #rest-modal > div {
      width: 100% !important;
      border-radius: 22px 22px 0 0 !important;
      max-height: 90vh !important;
      overflow-y: auto !important;
      padding-bottom: 32px !important;
    }

    .modal {
      width: 100% !important;
      max-width: 100% !important;
      max-height: 80vh !important;
      overflow-y: auto !important;
      border-radius: 16px !important;
      padding: 18px 14px 22px !important;
    }

    .grid-2 { grid-template-columns: 1fr 1fr !important; }
    .execution-btn { font-size: 11px !important; padding: 9px 4px !important; }
    .num-input-wrap input { font-size: 16px !important; }
    .num-btn { width: 38px !important; height: 42px !important; font-size: 17px !important; }
  }

  @keyframes pulse-orange {
    0%, 100% { box-shadow: 0 0 0 0 var(--orange-mid); }
    50% { box-shadow: 0 0 0 8px transparent; }
  }

  .pulse { animation: pulse-orange 2s infinite; }

  .num-input-wrap {
    display: flex;
    align-items: center;
    gap: 0;
    background: var(--card2);
    border: 1px solid var(--border2);
    border-radius: 10px;
    overflow: hidden;
  }

  .num-input-wrap input {
    border: none;
    border-radius: 0;
    text-align: center;
    background: transparent;
  }

  .num-btn {
    width: 36px;
    height: 40px;
    background: var(--border);
    border: none;
    color: var(--text);
    font-size: 18px;
    cursor: pointer;
    transition: background 0.2s;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .num-btn:hover { background: var(--border2); }

  .wb-step-indicator { display:flex; flex-direction:column; align-items:center; gap:4px; flex-shrink:0; }
  .wb-step-circle { width:28px; height:28px; border-radius:50%; background:var(--border2); color:var(--muted); font-size:13px; font-weight:700; display:flex; align-items:center; justify-content:center; transition:all 0.3s; }
  .wb-step-indicator.active .wb-step-circle { background:var(--orange); color:white; }
  .wb-step-indicator.done .wb-step-circle { background:var(--green); color:var(--dark); }
  .wb-step-label { font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; white-space:nowrap; }
  .wb-step-indicator.active .wb-step-label { color:var(--orange); }
  .wb-step-indicator.done .wb-step-label { color:var(--green); }
  .wb-step-line { flex:1; height:2px; background:var(--border2); margin:0 8px; margin-bottom:14px; transition:background 0.3s; }
  .wb-step-line.done { background:var(--green); }
  .day-pill { background:var(--card2); border:1px solid var(--border2); border-radius:8px; color:var(--muted2); font-size:11px; font-weight:600; padding:8px 4px; cursor:pointer; transition:all 0.2s; font-family:'DM Sans',sans-serif; text-align:center; }
  .day-pill:hover { border-color:var(--orange-mid); color:var(--text); }
  .day-pill.selected { background:var(--orange); border-color:var(--orange); color:white; }
  .wb-ex-row { display:flex; align-items:center; gap:10px; padding:10px 12px; background:var(--card2); border:1px solid var(--border); border-radius:10px; cursor:pointer; transition:all 0.15s; user-select:none; }
  .wb-ex-row:hover { border-color:var(--orange-mid); }
  .wb-ex-row.selected { border-color:var(--orange); background:var(--orange-dim); }
  .wb-ex-check { width:20px; height:20px; border-radius:6px; border:2px solid var(--border2); display:flex; align-items:center; justify-content:center; font-size:12px; flex-shrink:0; transition:all 0.15s; }
  .wb-ex-row.selected .wb-ex-check { background:var(--orange); border-color:var(--orange); color:white; }

  /* â”€â”€ EBOOK COMPONENTS â”€â”€ */
  .ebook-card {
    background: var(--card);
    border: 1px solid var(--border2);
    border-radius: 20px;
    overflow: hidden;
    margin-bottom: 16px;
    transition: all 0.25s;
  }
  .ebook-card:hover { border-color: var(--orange-mid); transform: translateY(-2px); box-shadow: 0 12px 32px rgba(0,0,0,0.4); }

  .ebook-cover {
    width: 100%;
    height: 160px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: 'Bebas Neue', sans-serif;
    letter-spacing: 2px;
    position: relative;
    overflow: hidden;
  }
  .ebook-cover::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, transparent 40%, rgba(0,0,0,0.6));
  }

  .ebook-cover-emoji { font-size: 48px; margin-bottom: 8px; position: relative; z-index: 1; }
  .ebook-cover-title { font-size: 18px; color: white; position: relative; z-index: 1; text-shadow: 0 2px 8px rgba(0,0,0,0.5); }
  .ebook-cover-sub { font-size: 11px; color: rgba(255,255,255,0.7); position: relative; z-index: 1; letter-spacing: 3px; font-family: 'DM Sans', sans-serif; font-weight: 600; }

  .ebook-body { padding: 16px; }
  .ebook-title { font-weight: 700; font-size: 16px; margin-bottom: 4px; }
  .ebook-desc { font-size: 13px; color: var(--muted2); margin-bottom: 14px; line-height: 1.5; }
  .ebook-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 14px; }
  .ebook-lock { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--muted2); }

  /* Reader */
  .ebook-reader {
    position: fixed;
    inset: 0;
    background: var(--darker);
    z-index: 500;
    display: flex;
    flex-direction: column;
    transform: translateY(100%);
    transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
  }
  .ebook-reader.open { transform: translateY(0); }

  .reader-header {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
  }
  .reader-title { font-family: 'Bebas Neue', sans-serif; font-size: 18px; letter-spacing: 1px; flex: 1; }
  .reader-content { flex: 1; overflow-y: auto; padding: 24px 20px; max-width: 680px; margin: 0 auto; width: 100%; }

  .reader-chapter {
    margin-bottom: 32px;
    padding-bottom: 32px;
    border-bottom: 1px solid var(--border);
  }
  .reader-chapter:last-child { border-bottom: none; }

  .reader-ch-tag { font-size: 10px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--orange); margin-bottom: 6px; }
  .reader-ch-title { font-family: 'Bebas Neue', sans-serif; font-size: 24px; letter-spacing: 1px; margin-bottom: 14px; }
  .reader-ch-body { font-size: 14px; line-height: 1.8; color: var(--muted2); }
  .reader-ch-body p { margin-bottom: 12px; }
  .reader-ch-body strong { color: var(--text); }
  .reader-ch-body ul { padding-left: 18px; margin-bottom: 12px; }
  .reader-ch-body li { margin-bottom: 6px; }

  .reader-paywall {
    background: linear-gradient(to bottom, transparent, var(--darker) 40%);
    position: sticky;
    bottom: 0;
    padding: 60px 20px 24px;
    text-align: center;
    margin-top: -80px;
  }
  .reader-paywall-card {
    background: var(--card);
    border: 1px solid var(--orange-mid);
    border-radius: 16px;
    padding: 24px 20px;
    max-width: 400px;
    margin: 0 auto;
  }

  /* â”€â”€ LEVEL BUTTONS (onboarding) â”€â”€ */
  .level-btn {
    display: flex; align-items: center; gap: 14px; padding: 16px;
    background: var(--card2); border: 2px solid var(--border2);
    border-radius: 14px; cursor: pointer; transition: all 0.2s;
    width: 100%; text-align: left; font-family: 'DM Sans', sans-serif; color: var(--text);
  }
  .level-btn:hover { border-color: var(--orange-mid); background: var(--orange-dim); }
  .level-btn.selected { border-color: var(--orange); background: var(--orange-dim); }
  .level-btn .level-title { font-weight: 700; font-size: 15px; }
  .level-btn .level-desc  { font-size: 12px; color: var(--muted2); margin-top: 2px; }

  .type-btn {
    display: flex; flex-direction: column; align-items: center; gap: 5px;
    padding: 14px 8px; background: var(--card2); border: 2px solid var(--border2);
    border-radius: 12px; cursor: pointer; transition: all 0.2s;
    font-family: 'DM Sans', sans-serif; color: var(--muted2); font-size: 13px; font-weight: 600;
  }
  .type-btn:hover { border-color: var(--orange-mid); }
  .type-btn.active { border-color: var(--orange); background: var(--orange-dim); color: var(--orange); }

  .cardio-fields {
    background: var(--card2); border-radius: 12px; padding: 14px;
    margin-top: 8px; border: 1px solid var(--border); animation: fadeIn 0.2s ease;
  }

  .effort-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 14px 8px;
    background: var(--card2);
    border: 1.5px solid var(--border2);
    border-radius: 14px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 700;
    color: var(--muted2);
    transition: all 0.2s;
    width: 100%;
  }
  .effort-btn:hover { border-color: var(--orange-mid); color: var(--text); }
  .effort-btn.selected-facil  { background: var(--green-dim);  border-color: var(--green);  color: var(--green); }
  .effort-btn.selected-certo  { background: var(--orange-dim); border-color: var(--orange); color: var(--orange); }
  .effort-btn.selected-pesado { background: rgba(255,82,82,0.12); border-color: var(--red); color: var(--red); }

  .execution-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    padding: 12px 8px;
    background: var(--card2);
    border: 1.5px solid var(--border2);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'DM Sans', sans-serif;
    color: var(--muted2);
    width: 100%;
  }
  .execution-btn:hover { border-color: var(--orange-mid); color: var(--text); }
  .execution-btn.active {
    background: var(--orange-dim);
    border-color: var(--orange);
    color: var(--orange);
  }
  .execution-btn.active span:last-child { color: var(--orange) !important; opacity: 0.8; }

  .rest-preset-btn {
    background: var(--card2);
    border: 1px solid var(--border2);
    border-radius: 8px;
    color: var(--muted2);
    font-size: 12px;
    font-weight: 600;
    padding: 7px 12px;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    transition: all 0.15s;
  }
  .rest-preset-btn:hover { border-color: var(--orange-mid); color: var(--text); }
  .rest-preset-btn.active { background: var(--orange-dim); border-color: var(--orange); color: var(--orange); }

  #pre-workout-modal {
    align-items: flex-end;
    padding-bottom: 0;
  }
  .pwm-option {
    background: var(--card2);
    border: 2px solid var(--border2);
    border-radius: 14px;
    padding: 16px 10px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'DM Sans', sans-serif;
    color: var(--text);
    text-align: center;
  }
  .pwm-option:hover { border-color: var(--orange-mid); }
  .pwm-option.selected { border-color: var(--orange); background: var(--orange-dim); }

  .pwm-load-btn {
    background: var(--card2);
    border: 2px solid var(--border2);
    border-radius: 12px;
    padding: 12px 8px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    color: var(--text);
    text-align: center;
    transition: all 0.2s;
    font-size: 12px;
  }
  .pwm-load-btn:hover { border-color: var(--orange-mid); }
  .pwm-load-btn.selected { border-color: var(--orange); background: var(--orange-dim); color: var(--orange); font-weight: 700; }

  .set-row {
    display: grid;
    grid-template-columns: 36px 1fr 1fr 44px;
    gap: 8px;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }
  .set-num {
    width: 36px; height: 36px;
    border-radius: 50%;
    background: var(--border);
    display: flex; align-items: center; justify-content: center;
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    font-weight: 700;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  .set-num.done { background: var(--green); color: var(--dark); }
  .set-done-btn {
    width: 44px; height: 44px;
    border-radius: 10px;
    border: 2px solid var(--border2);
    background: transparent;
    color: var(--muted2);
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex; align-items: center; justify-content: center;
  }
  .set-done-btn.done { background: var(--green); border-color: var(--green); color: var(--dark); }
</style>
</head>
<body>

<!-- NOTIFICATION -->
<div class="notification" id="notification">
  <div class="notification-icon" id="notif-icon">ğŸ¯</div>
  <div>
    <div class="notification-title" id="notif-title">TÃ­tulo</div>
    <div class="notification-msg" id="notif-msg">Mensagem</div>
  </div>
</div>

<!-- COACH VIRTUAL MODAL -->
<div class="modal-overlay" id="coach-modal" style="align-items:flex-end; padding-bottom:0;">
  <div style="background:var(--card); border:1px solid var(--border2); border-radius:24px 24px 0 0; padding:28px 24px 40px; width:100%; max-width:480px;">
    <div style="width:40px; height:4px; background:var(--border2); border-radius:99px; margin:0 auto 20px;"></div>
    <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
      <div style="font-size:36px;">ğŸ¤–</div>
      <div>
        <div style="font-family:'Bebas Neue'; font-size:22px; letter-spacing:1px; color:var(--orange);">COACH VIRTUAL</div>
        <div style="font-size:12px; color:var(--muted2);" id="coach-ex-name">ExercÃ­cio</div>
      </div>
    </div>

    <div style="font-size:13px; color:var(--muted2); margin-bottom:10px; text-transform:uppercase; letter-spacing:1px; font-weight:700;">Como foi esse exercÃ­cio?</div>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:20px;">
      <button class="effort-btn" data-effort="facil" onclick="selectEffort('facil')" aria-label="FÃ¡cil">
        <span style="font-size:22px;">ğŸ˜Š</span>
        <span>FÃ¡cil</span>
      </button>
      <button class="effort-btn" data-effort="certo" onclick="selectEffort('certo')" aria-label="Certo">
        <span style="font-size:22px;">ğŸ’ª</span>
        <span>Certo</span>
      </button>
      <button class="effort-btn" data-effort="pesado" onclick="selectEffort('pesado')" aria-label="Pesado">
        <span style="font-size:22px;">ğŸ”¥</span>
        <span>Pesado</span>
      </button>
    </div>

    <div id="coach-suggestion" style="display:none; background:var(--orange-dim); border:1px solid var(--orange-mid); border-radius:14px; padding:16px; margin-bottom:16px;">
      <div style="font-size:11px; font-weight:800; color:var(--orange); letter-spacing:2px; margin-bottom:6px;">PRÃ“XIMO TREINO</div>
      <div style="font-size:20px; font-weight:800; color:var(--white);" id="coach-next-weight">Use Xkg</div>
      <div style="font-size:12px; color:var(--muted2); margin-top:4px;" id="coach-reason"></div>
    </div>

    <div id="coach-tecnica-invite" style="display:none; background:var(--card2); border:1px solid var(--border2); border-radius:14px; padding:16px; margin-bottom:16px;">
      <div style="font-size:14px; font-weight:700; color:var(--text); margin-bottom:12px; line-height:1.5;">
        âš¡ VocÃª estÃ¡ com energia! Quer fechar com uma <span style="color:var(--orange);">TÃ©cnica AvanÃ§ada</span> para acelerar os ganhos?
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-ghost" style="flex:1;" onclick="closeCoach()">NÃ£o, obrigado</button>
        <button class="btn btn-primary" style="flex:1;" onclick="showTecnica()" id="coach-sim-btn">Sim, quero! â†’</button>
      </div>
    </div>

    <button class="btn btn-ghost btn-full" style="margin-top:4px;" onclick="closeCoach()">Fechar</button>
  </div>
</div>

<!-- TÃ‰CNICA AVANÃ‡ADA MODAL -->
<div class="modal-overlay" id="tecnica-modal" style="align-items:flex-end; padding-bottom:0;">
  <div style="background:var(--card); border:1px solid var(--border2); border-radius:24px 24px 0 0; padding:28px 24px 40px; width:100%; max-width:480px; max-height:85vh; overflow-y:auto;">
    <div style="width:40px; height:4px; background:var(--border2); border-radius:99px; margin:0 auto 20px;"></div>
    <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
      <div style="font-size:36px;" id="tecnica-icon">âš¡</div>
      <div>
        <div style="font-family:'Bebas Neue'; font-size:22px; letter-spacing:1px; color:var(--orange);" id="tecnica-nome">TÃ‰CNICA</div>
        <div style="font-size:12px; color:var(--muted2);">TÃ©cnica avanÃ§ada Â· NÃ­vel <span id="tecnica-nivel"></span></div>
      </div>
    </div>

    <div style="background:var(--green-dim); border:1px solid var(--green); border-radius:12px; padding:14px; margin-bottom:14px;">
      <div style="font-size:10px; font-weight:800; color:var(--green); letter-spacing:2px; margin-bottom:6px;">POR QUÃŠ FUNCIONA</div>
      <div style="font-size:13px; color:var(--text); line-height:1.6;" id="tecnica-porque"></div>
    </div>

    <div style="background:var(--blue-dim); border:1px solid var(--blue); border-radius:12px; padding:14px; margin-bottom:20px;">
      <div style="font-size:10px; font-weight:800; color:var(--blue); letter-spacing:2px; margin-bottom:6px;">COMO EXECUTAR</div>
      <div id="tecnica-como" style="font-size:13px; color:var(--text); line-height:1.6;"></div>
    </div>

    <button class="btn btn-primary btn-full btn-lg" onclick="closeTecnica()">Entendido! Vou aplicar ğŸ’ª</button>
    <button class="btn btn-ghost btn-full" style="margin-top:8px;" onclick="closeTecnica()">Pular desta vez</button>
  </div>
</div>

<!-- BOTÃƒO FLUTUANTE APOIAR -->
<div id="fab-wrapper" style="position:fixed; bottom:72px; right:16px; z-index:900; display:flex; align-items:center; gap:6px;">
  <button onclick="document.getElementById('fab-wrapper').style.display='none'"
    style="background:rgba(0,0,0,0.6); border:1px solid var(--border2); color:var(--muted2); border-radius:99px; width:24px; height:24px; cursor:pointer; font-size:11px; display:flex; align-items:center; justify-content:center; padding:0;" aria-label="Fechar">âœ•</button>
  <a id="fab-support" href="https://wa.me/?text=Quero%20apoiar%20o%20PROGRESSAR!" target="_blank"
     style="background:var(--orange); color:white; border-radius:99px; padding:11px 16px; font-family:'DM Sans',sans-serif; font-size:12px; font-weight:700; text-decoration:none; display:flex; align-items:center; gap:6px; box-shadow:0 4px 20px rgba(255,92,0,0.4); white-space:nowrap;">
    ğŸ’š Apoiar o Projeto
  </a>
</div>

<!-- MODAL REST TIMER -->
<div class="modal-overlay" id="rest-modal" style="align-items:flex-end; padding-bottom:0;">
  <div style="background:var(--card); border:1px solid var(--border2); border-radius:24px 24px 0 0; padding:32px 28px 36px; width:100%; max-width:480px; text-align:center; animation:slideUp 0.3s ease;">
    <div style="width:48px; height:4px; background:var(--border2); border-radius:99px; margin:0 auto 24px;"></div>
    <div style="font-size:12px; color:var(--muted2); text-transform:uppercase; letter-spacing:2px; margin-bottom:4px;" id="rest-ex-name">DESCANSO</div>
    <div style="font-size:14px; color:var(--muted2); margin-bottom:20px;" id="rest-serie-info">PrÃ³xima sÃ©rie em breve</div>

    <div style="position:relative; width:160px; height:160px; margin:0 auto 24px;">
      <svg width="160" height="160" viewBox="0 0 160 160" style="transform:rotate(-90deg);">
        <circle cx="80" cy="80" r="68" fill="none" stroke="var(--border2)" stroke-width="8"/>
        <circle cx="80" cy="80" r="68" fill="none" stroke="var(--orange)" stroke-width="8"
          stroke-dasharray="427" id="rest-ring" stroke-dashoffset="0" stroke-linecap="round"
          style="transition:stroke-dashoffset 1s linear;"/>
      </svg>
      <div style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div class="timer-display" id="timer-display" style="font-size:52px;">01:30</div>
        <div style="font-size:11px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px;">restando</div>
      </div>
    </div>

    <div style="display:flex; gap:6px; justify-content:center; margin-bottom:20px;" id="rest-presets">
      <button class="rest-preset-btn" onclick="setRestTimer(45)">45s</button>
      <button class="rest-preset-btn" onclick="setRestTimer(60)">1min</button>
      <button class="rest-preset-btn active" onclick="setRestTimer(90)" id="preset-active">1:30</button>
      <button class="rest-preset-btn" onclick="setRestTimer(120)">2min</button>
      <button class="rest-preset-btn" onclick="setRestTimer(180)">3min</button>
    </div>

    <div style="display:flex; gap:8px;">
      <button class="btn btn-ghost" style="flex:1;" onclick="addTime(-15)">âˆ’15s</button>
      <button class="btn btn-primary" style="flex:2;" onclick="skipTimer()">Pular descanso â†’</button>
      <button class="btn btn-ghost" style="flex:1;" onclick="addTime(15)">+15s</button>
    </div>
  </div>
</div>

<!-- MODAL PRÃ‰-TREINO: ExecuÃ§Ã£o + Tipo de Carga -->
<div class="modal-overlay" id="pre-workout-modal">
  <div style="background:var(--card); border:1px solid var(--border2); border-radius:24px 24px 0 0; padding:28px 24px 36px; width:100%; max-width:520px; margin-top:auto; animation:slideUp 0.3s ease;">
    <div style="width:40px; height:4px; background:var(--border2); border-radius:99px; margin:0 auto 20px;"></div>
    <div style="font-family:'Bebas Neue'; font-size:22px; letter-spacing:2px; margin-bottom:4px;" id="pwm-ex-name">EXERCÃCIO</div>
    <div style="font-size:13px; color:var(--muted2); margin-bottom:24px;" id="pwm-ex-sub">Configure antes de comeÃ§ar</div>

    <div style="margin-bottom:20px;">
      <div style="font-size:11px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;">Como vai executar?</div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;" id="pwm-exec-options">
        <button class="pwm-option" data-exec="maquina" onclick="selectExec(this)" aria-label="MÃ¡quina">
          <div style="font-size:28px; margin-bottom:6px;">ğŸ‹ï¸</div>
          <div style="font-weight:700; font-size:14px;">MÃ¡quina</div>
          <div style="font-size:11px; color:var(--muted2); margin-top:3px;">Guiado, fixo</div>
        </button>
        <button class="pwm-option" data-exec="livre" onclick="selectExec(this)" aria-label="Livre">
          <div style="font-size:28px; margin-bottom:6px;">ğŸ’ª</div>
          <div style="font-weight:700; font-size:14px;">Livre</div>
          <div style="font-size:11px; color:var(--muted2); margin-top:3px;">Amplitude livre</div>
        </button>
      </div>
    </div>

    <div style="margin-bottom:24px;">
      <div style="font-size:11px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;">Tipo de carga</div>
      <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px;" id="pwm-load-options">
        <!-- Preenchido dinamicamente -->
      </div>
    </div>

    <div style="background:var(--card2); border-radius:12px; padding:14px 16px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
      <div>
        <div style="font-size:11px; color:var(--muted2); margin-bottom:4px;">PESO DE INÃCIO</div>
        <div style="font-family:'Bebas Neue'; font-size:28px; color:var(--orange);" id="pwm-weight-display">20kg</div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:11px; color:var(--muted2); margin-bottom:4px;">INCREMENTO</div>
        <div style="font-family:'Bebas Neue'; font-size:20px; color:var(--muted2);" id="pwm-inc-display">+2kg</div>
      </div>
    </div>

    <div style="display:flex; gap:8px;">
      <button class="btn btn-ghost" style="flex:1;" onclick="skipPreWorkout()">Pular</button>
      <button class="btn btn-primary btn-lg" style="flex:2;" id="pwm-confirm-btn" onclick="confirmPreWorkout()" disabled>
        Iniciar exercÃ­cio â†’
      </button>
    </div>
  </div>
</div>

<!-- MODAL NOVO EXERCÃCIO -->
<div class="modal-overlay" id="exercise-modal">
  <div class="modal">
    <div class="modal-title">NOVO EXERCÃCIO</div>
    <div style="display:flex; flex-direction:column; gap:14px;">

      <!-- Seletor: MusculaÃ§Ã£o ou Cardio -->
      <div>
        <label style="margin-bottom:8px; display:block;">Tipo de exercÃ­cio</label>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
          <button type="button" class="type-btn active" data-type="musculacao" onclick="setExerciseType('musculacao')">
            <span style="font-size:20px;">ğŸ’ª</span><span>MusculaÃ§Ã£o</span>
          </button>
          <button type="button" class="type-btn" data-type="cardio" onclick="setExerciseType('cardio')">
            <span style="font-size:20px;">ğŸƒ</span><span>Cardio</span>
          </button>
        </div>
        <input type="hidden" id="ex-type" value="musculacao">
      </div>

      <!-- â•â• CAMPOS CARDIO â•â• -->
      <div id="cardio-extra-fields" style="display:none;">
        <div class="cardio-fields">
          <div class="grid-2">
            <div>
              <label>Tipo de cardio</label>
              <select id="cardio-tipo">
                <option value="Esteira">ğŸƒ Esteira</option>
                <option value="Bike">ğŸš´ Bike</option>
                <option value="Escada">ğŸªœ Escada</option>
                <option value="Corrida externa">ğŸŒ³ Corrida</option>
                <option value="Pular corda">ğŸª¢ Pular corda</option>
                <option value="NataÃ§Ã£o">ğŸŠ NataÃ§Ã£o</option>
                <option value="Remo">ğŸš£ Remo</option>
              </select>
            </div>
            <div>
              <label>DuraÃ§Ã£o (min)</label>
              <input type="number" id="cardio-tempo" value="20" min="5" step="5">
            </div>
          </div>
          <div class="grid-2" style="margin-top:10px;">
            <div>
              <label>Intensidade</label>
              <select id="cardio-intensidade">
                <option value="leve">ğŸ˜Œ Leve</option>
                <option value="moderado" selected>ğŸ˜Š Moderado</option>
                <option value="intenso">ğŸ¥µ Intenso</option>
              </select>
            </div>
            <div>
              <label>DistÃ¢ncia (km, opcional)</label>
              <input type="number" id="cardio-distancia" placeholder="0.0" step="0.1" min="0">
            </div>
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:14px;">
          <button class="btn btn-ghost btn-full" onclick="closeModal('exercise-modal')">Cancelar</button>
          <button class="btn btn-primary btn-full" onclick="saveCardioExercise()">ğŸƒ Registrar Cardio</button>
        </div>
      </div>

      <!-- â•â• CAMPOS MUSCULAÃ‡ÃƒO â•â• -->
      <div id="musculacao-fields">
        <!-- Linha 1: Nome -->
        <div style="margin-bottom:14px;">
          <label>Nome do exercÃ­cio</label>
          <input type="text" id="ex-name" placeholder="Ex: Supino Reto com Barra">
        </div>

        <!-- Linha 2: Grupo muscular -->
        <div style="margin-bottom:14px;">
          <label>Grupo muscular</label>
          <select id="ex-group">
            <option value="Peito">ğŸ’ª Peito</option>
            <option value="Costas">ğŸ¦º Costas</option>
            <option value="Ombro">ğŸ”º Ombro</option>
            <option value="BÃ­ceps">ğŸ’ª BÃ­ceps</option>
            <option value="TrÃ­ceps">ğŸ’ª TrÃ­ceps</option>
            <option value="Perna">ğŸ¦µ Perna</option>
            <option value="GlÃºteo">ğŸ‘ GlÃºteo</option>
            <option value="AbdÃ´men">ğŸ”¥ AbdÃ´men</option>
          </select>
        </div>

        <!-- Linha 3: Livre ou MÃ¡quina -->
        <div style="margin-bottom:14px;">
          <label>Tipo de execuÃ§Ã£o</label>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:6px;">
            <button type="button" class="execution-btn active" id="ex-exec-livre" onclick="setExecution('livre', 'ex')">
              <span style="font-size:20px;">ğŸ‹ï¸</span>
              <span style="font-weight:700; font-size:13px;">Livre</span>
              <span style="font-size:10px; color:var(--muted2);">Haltere Â· Anilha Â· Barra</span>
            </button>
            <button type="button" class="execution-btn" id="ex-exec-maquina" onclick="setExecution('maquina', 'ex')">
              <span style="font-size:20px;">âš™ï¸</span>
              <span style="font-weight:700; font-size:13px;">MÃ¡quina</span>
              <span style="font-size:10px; color:var(--muted2);">Guiado Â· Cabo Â· Polia</span>
            </button>
          </div>
          <input type="hidden" id="ex-execution" value="livre">
        </div>

        <!-- Linha 4: Equipamento -->
        <div style="margin-bottom:14px;">
          <label>Equipamento</label>
          <select id="ex-equip">
            <option value="Halteres (1-10kg)">ğŸ‹ï¸ Halteres (fixos 1â€“10kg)</option>
            <option value="Dumbbells (12kg+)">ğŸ’ª Dumbbells (12, 14, 16kg...)</option>
            <option value="Anilhas (barra)">ğŸ”´ Anilhas (combinaÃ§Ã£o de placas)</option>
          </select>
        </div>

        <!-- Linha 5: Peso + Reps -->
        <div class="grid-2" style="margin-bottom:14px;">
          <div>
            <label>Peso inicial (kg)</label>
            <input type="number" id="ex-weight" value="20" min="0" step="0.5">
          </div>
          <div>
            <label>Faixa de reps</label>
            <select id="ex-reps">
              <option value="6-10">6â€“10 (ForÃ§a)</option>
              <option value="8-12" selected>8â€“12 (Hipertrofia)</option>
              <option value="10-15">10â€“15 (Volume)</option>
              <option value="12-20">12â€“20 (ResistÃªncia)</option>
            </select>
          </div>
        </div>

        <!-- Linha 6: SÃ©ries + Descanso -->
        <div class="grid-2" style="margin-bottom:14px;">
          <div>
            <label>SÃ©ries</label>
            <select id="ex-sets">
              <option value="2">2 sÃ©ries</option>
              <option value="3" selected>3 sÃ©ries</option>
              <option value="4">4 sÃ©ries</option>
              <option value="5">5 sÃ©ries</option>
            </select>
          </div>
          <div>
            <label>Descanso</label>
            <select id="ex-rest">
              <option value="45">45 seg</option>
              <option value="60">1 min</option>
              <option value="90" selected>1 min 30s</option>
              <option value="120">2 min</option>
              <option value="180">3 min</option>
              <option value="240">4 min</option>
            </select>
          </div>
        </div>

        <!-- Linha 7: Incremento -->
        <div style="margin-bottom:14px;">
          <label>Incremento mÃ­nimo (kg) âš¡</label>
          <select id="ex-increment">
            <option value="0.5">0.5 kg â€” ElevaÃ§Ã£o lateral</option>
            <option value="1">1 kg â€” Haltere fixo</option>
            <option value="2" selected>2 kg â€” Dumbbell</option>
            <option value="2.5">2.5 kg â€” Barra livre / Anilha</option>
            <option value="5">5 kg â€” Barra com pino</option>
            <option value="10">10 kg â€” Pino pesado</option>
          </select>
        </div>

        <!-- BotÃµes -->
        <div style="display:flex; gap:8px;">
          <button class="btn btn-ghost btn-full" onclick="closeModal('exercise-modal')">Cancelar</button>
          <button class="btn btn-primary btn-full" onclick="saveExercise()">Salvar ExercÃ­cio</button>
        </div>
      </div><!-- /musculacao-fields -->

    </div>
  </div>
</div>

<!-- MODAL EDITAR EXERCÃCIO -->
<div class="modal-overlay" id="edit-exercise-modal">
  <div class="modal">
    <div class="modal-title">EDITAR EXERCÃCIO</div>
    <div style="display:flex; flex-direction:column; gap:14px;">
      <input type="hidden" id="edit-ex-id">
      <div>
        <label>Nome do exercÃ­cio</label>
        <input type="text" id="edit-ex-name" placeholder="Ex: Supino Reto com Barra">
      </div>
      <div class="grid-2">
        <div>
          <label>Grupo muscular</label>
          <select id="edit-ex-group">
            <option value="Peito">ğŸ’ª Peito</option>
            <option value="Costas">ğŸ¦º Costas</option>
            <option value="Ombro">ğŸ”º Ombro</option>
            <option value="BÃ­ceps">ğŸ’ª BÃ­ceps</option>
            <option value="TrÃ­ceps">ğŸ’ª TrÃ­ceps</option>
            <option value="Perna">ğŸ¦µ Perna</option>
            <option value="GlÃºteo">ğŸ‘ GlÃºteo</option>
            <option value="AbdÃ´men">ğŸ”¥ AbdÃ´men</option>
          </select>
        </div>
        <div>
          <label>Tipo de execuÃ§Ã£o</label>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:4px;">
            <button type="button" class="execution-btn active" id="edit-ex-exec-livre" onclick="setExecution('livre', 'edit')">
              <span style="font-size:20px;">ğŸ‹ï¸</span>
              <span style="font-weight:700; font-size:13px;">Livre</span>
              <span style="font-size:10px; color:var(--muted2);">Haltere Â· Anilha Â· Barra livre</span>
            </button>
            <button type="button" class="execution-btn" id="edit-ex-exec-maquina" onclick="setExecution('maquina', 'edit')">
              <span style="font-size:20px;">âš™ï¸</span>
              <span style="font-weight:700; font-size:13px;">MÃ¡quina</span>
              <span style="font-size:10px; color:var(--muted2);">Guiado Â· Cabo Â· Polia</span>
            </button>
          </div>
          <input type="hidden" id="edit-ex-execution" value="livre">
        </div>
        <div>
          <label>Equipamento</label>
          <select id="edit-ex-equip">
            <option value="Halteres (1-10kg)">ğŸ‹ï¸ Halteres (fixos 1â€“10kg)</option>
            <option value="Dumbbells (12kg+)">ğŸ’ª Dumbbells (12, 14, 16kg...)</option>
            <option value="Anilhas (barra)">ğŸ”´ Anilhas (combinaÃ§Ã£o de placas)</option>
          </select>
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>Peso inicial (kg)</label>
          <input type="number" id="edit-ex-weight" value="20" min="0" step="0.5">
        </div>
        <div>
          <label>Faixa de reps</label>
          <select id="edit-ex-reps">
            <option value="6-10">6â€“10</option>
            <option value="8-12" selected>8â€“12</option>
            <option value="10-15">10â€“15</option>
            <option value="12-20">12â€“20</option>
          </select>
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>SÃ©ries</label>
          <select id="edit-ex-sets">
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
        <div>
          <label>Descanso</label>
          <select id="edit-ex-rest">
            <option value="45">45s</option>
            <option value="60">1 min</option>
            <option value="90" selected>1:30</option>
            <option value="120">2 min</option>
            <option value="180">3 min</option>
            <option value="240">4 min</option>
          </select>
        </div>
        <div>
          <label>Incremento (kg)</label>
          <select id="edit-ex-increment">
            <option value="0.5">0.5</option>
            <option value="1">1</option>
            <option value="2" selected>2</option>
            <option value="2.5">2.5</option>
            <option value="5">5</option>
            <option value="10">10</option>
          </select>
        </div>
      </div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button class="btn btn-ghost btn-full" onclick="closeModal('edit-exercise-modal')">Cancelar</button>
        <button class="btn btn-primary btn-full" onclick="updateExercise()">Salvar alteraÃ§Ãµes</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL NOVO TREINO â€” MULTI-STEP -->
<div class="modal-overlay" id="workout-plan-modal">
  <div class="modal" style="max-width:520px; width:100%; max-height:85vh; overflow-y:auto;">

    <div style="display:flex; align-items:center; gap:0; margin-bottom:24px;">
      <div class="wb-step-indicator active" id="wbi-1">
        <div class="wb-step-circle" id="wbc-1">1</div>
        <div class="wb-step-label">InformaÃ§Ãµes</div>
      </div>
      <div class="wb-step-line" id="wbl-1"></div>
      <div class="wb-step-indicator" id="wbi-2">
        <div class="wb-step-circle" id="wbc-2">2</div>
        <div class="wb-step-label">ExercÃ­cios</div>
      </div>
      <div class="wb-step-line" id="wbl-2"></div>
      <div class="wb-step-indicator" id="wbi-3">
        <div class="wb-step-circle" id="wbc-3">3</div>
        <div class="wb-step-label">Confirmar</div>
      </div>
    </div>

    <div id="wb-step-1" class="wb-step">
      <div class="modal-title">NOVO TREINO</div>
      <p style="color:var(--muted2); font-size:13px; margin-bottom:20px;">DÃª um nome e escolha o dia da semana para este treino.</p>
      <div style="display:flex; flex-direction:column; gap:16px;">
        <div>
          <label>Nome do treino</label>
          <input type="text" id="plan-name" placeholder="Ex: Treino A â€” Peito e TrÃ­ceps">
        </div>
        <div>
          <label>Dias da semana</label>
          <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-top:4px;" id="day-selector">
            <button class="day-pill" data-day="Dom" onclick="toggleDay(this)">Dom</button>
            <button class="day-pill" data-day="Seg" onclick="toggleDay(this)">Seg</button>
            <button class="day-pill" data-day="Ter" onclick="toggleDay(this)">Ter</button>
            <button class="day-pill" data-day="Qua" onclick="toggleDay(this)">Qua</button>
            <button class="day-pill" data-day="Qui" onclick="toggleDay(this)">Qui</button>
            <button class="day-pill" data-day="Sex" onclick="toggleDay(this)">Sex</button>
            <button class="day-pill" data-day="SÃ¡b" onclick="toggleDay(this)">SÃ¡b</button>
          </div>
        </div>
      </div>
      <div style="display:flex; gap:8px; margin-top:24px;">
        <button class="btn btn-ghost btn-full" onclick="closeModal('workout-plan-modal')">Cancelar</button>
        <button class="btn btn-primary btn-full" onclick="wbNext(1)">PrÃ³ximo â†’</button>
      </div>
    </div>

    <div id="wb-step-2" class="wb-step" style="display:none;">
      <div class="modal-title">ADICIONAR EXERCÃCIOS</div>
      <p style="color:var(--muted2); font-size:13px; margin-bottom:16px;">Selecione dos exercÃ­cios prÃ©-definidos ou crie novos.</p>

      <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:12px;" id="wb-group-filters">
        <button class="btn btn-primary" style="font-size:11px; padding:5px 10px;" onclick="wbFilter('Todos')">Todos</button>
        <button class="btn btn-ghost" style="font-size:11px; padding:5px 10px;" onclick="wbFilter('Peito')">ğŸ’ª Peito</button>
        <button class="btn btn-ghost" style="font-size:11px; padding:5px 10px;" onclick="wbFilter('Costas')">ğŸ¦º Costas</button>
        <button class="btn btn-ghost" style="font-size:11px; padding:5px 10px;" onclick="wbFilter('Ombro')">ğŸ”º Ombro</button>
        <button class="btn btn-ghost" style="font-size:11px; padding:5px 10px;" onclick="wbFilter('Perna')">ğŸ¦µ Perna</button>
        <button class="btn btn-ghost" style="font-size:11px; padding:5px 10px;" onclick="wbFilter('BÃ­ceps')">ğŸ’ª BÃ­ceps</button>
        <button class="btn btn-ghost" style="font-size:11px; padding:5px 10px;" onclick="wbFilter('TrÃ­ceps')">ğŸ”± TrÃ­ceps</button>
      </div>

      <div id="wb-exercise-list" style="max-height:260px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; margin-bottom:12px;"></div>

      <div id="wb-new-ex-panel" style="display:none; background:var(--card2); border:1px solid var(--border2); border-radius:12px; padding:14px; margin-bottom:12px;">
        <div style="font-weight:700; font-size:14px; margin-bottom:12px; color:var(--orange);">+ Novo exercÃ­cio</div>
        <div style="display:flex; flex-direction:column; gap:10px;">
          <input type="text" id="wb-ex-name" placeholder="Nome do exercÃ­cio">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <select id="wb-ex-group">
              <option value="Peito">ğŸ’ª Peito</option>
              <option value="Costas">ğŸ¦º Costas</option>
              <option value="Ombro">ğŸ”º Ombro</option>
              <option value="BÃ­ceps">ğŸ’ª BÃ­ceps</option>
              <option value="TrÃ­ceps">ğŸ”± TrÃ­ceps</option>
              <option value="Perna">ğŸ¦µ Perna</option>
              <option value="GlÃºteo">ğŸ‘ GlÃºteo</option>
              <option value="AbdÃ´men">ğŸ”¥ AbdÃ´men</option>
            </select>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:2px;">
              <button type="button" class="execution-btn active" id="wb-exec-livre" onclick="setExecution('livre','wb')" style="padding:8px 6px;">
                <span style="font-size:16px;">ğŸ‹ï¸</span>
                <span style="font-weight:700; font-size:11px;">Livre</span>
              </button>
              <button type="button" class="execution-btn" id="wb-exec-maquina" onclick="setExecution('maquina','wb')" style="padding:8px 6px;">
                <span style="font-size:16px;">âš™ï¸</span>
                <span style="font-weight:700; font-size:11px;">MÃ¡quina</span>
              </button>
            </div>
            <input type="hidden" id="wb-execution" value="livre">
            <select id="wb-ex-equip" style="margin-top:6px;">
              <option value="Halteres (1-10kg)">ğŸ‹ï¸ Halteres (fixos 1â€“10kg)</option>
              <option value="Dumbbells (12kg+)">ğŸ’ª Dumbbells (12, 14, 16kg...)</option>
              <option value="Anilhas (barra)">ğŸ”´ Anilhas (combinaÃ§Ã£o de placas)</option>
            </select>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
            <div>
              <label style="font-size:11px;">Peso inicial (kg)</label>
              <input type="number" id="wb-ex-weight" value="20" min="0" step="0.5">
            </div>
            <div>
              <label style="font-size:11px;">Faixa de reps</label>
              <select id="wb-ex-reps">
                <option value="6-10">6â€“10</option>
                <option value="8-12" selected>8â€“12</option>
                <option value="10-15">10â€“15</option>
                <option value="12-20">12â€“20</option>
              </select>
            </div>
            <div>
              <label style="font-size:11px;">SÃ©ries</label>
              <select id="wb-ex-sets">
                <option value="2">2</option>
                <option value="3" selected>3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div>
              <label style="font-size:11px;">Descanso</label>
              <select id="wb-ex-rest">
                <option value="45">45s</option>
                <option value="60">1 min</option>
                <option value="90" selected>1:30</option>
                <option value="120">2 min</option>
                <option value="180">3 min</option>
                <option value="240">4 min</option>
              </select>
            </div>
            <div>
              <label style="font-size:11px;">Incremento (kg)</label>
              <select id="wb-ex-increment">
                <option value="0.5">0.5 kg</option>
                <option value="1">1 kg</option>
                <option value="2" selected>2 kg</option>
                <option value="2.5">2.5 kg</option>
                <option value="5">5 kg</option>
                <option value="10">10 kg</option>
              </select>
            </div>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-ghost" style="flex:1;" onclick="toggleNewExPanel()">Cancelar</button>
            <button class="btn btn-primary" style="flex:1;" onclick="wbCreateAndAdd()">Criar e adicionar</button>
          </div>
        </div>
      </div>

      <button class="btn btn-ghost btn-full" style="border-style:dashed; margin-bottom:16px;" onclick="toggleNewExPanel()">
        + Criar novo exercÃ­cio
      </button>

      <div id="wb-selected-preview" style="background:var(--card2); border-radius:10px; padding:12px; min-height:48px;">
        <div style="font-size:12px; color:var(--muted2); margin-bottom:8px;">SELECIONADOS (<span id="wb-selected-count">0</span>)</div>
        <div id="wb-selected-tags" style="display:flex; flex-wrap:wrap; gap:6px;">
          <span style="color:var(--muted); font-size:13px; font-style:italic;">Nenhum exercÃ­cio selecionado</span>
        </div>
      </div>

      <div style="display:flex; gap:8px; margin-top:16px;">
        <button class="btn btn-ghost btn-full" onclick="wbBack(2)">â† Voltar</button>
        <button class="btn btn-primary btn-full" onclick="wbNext(2)">Revisar â†’</button>
      </div>
    </div>

    <div id="wb-step-3" class="wb-step" style="display:none;">
      <div class="modal-title">CONFIRMAR TREINO</div>
      <div id="wb-confirm-content" style="margin-bottom:20px;"></div>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-ghost btn-full" onclick="wbBack(3)">â† Voltar</button>
        <button class="btn btn-primary btn-full btn-lg" onclick="saveWorkoutPlan()">âœ“ Criar treino</button>
      </div>
    </div>

  </div>
</div>

<!-- MODAL EDITAR TREINO -->
<div class="modal-overlay" id="edit-workout-modal">
  <div class="modal">
    <div class="modal-title">EDITAR TREINO</div>
    <input type="hidden" id="edit-plan-id">
    <div style="display:flex; flex-direction:column; gap:16px;">
      <div>
        <label>Nome do treino</label>
        <input type="text" id="edit-plan-name" placeholder="Ex: Treino A">
      </div>
      <div>
        <label>Dias da semana</label>
        <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:6px;" id="edit-day-selector">
          <button class="day-pill" data-day="Dom">Dom</button>
          <button class="day-pill" data-day="Seg">Seg</button>
          <button class="day-pill" data-day="Ter">Ter</button>
          <button class="day-pill" data-day="Qua">Qua</button>
          <button class="day-pill" data-day="Qui">Qui</button>
          <button class="day-pill" data-day="Sex">Sex</button>
          <button class="day-pill" data-day="SÃ¡b">SÃ¡b</button>
        </div>
      </div>
    </div>
    <div style="display:flex; gap:8px; margin-top:24px;">
      <button class="btn btn-ghost btn-full" onclick="closeModal('edit-workout-modal')">Cancelar</button>
      <button class="btn btn-primary btn-full" onclick="updateWorkoutPlan()">Salvar</button>
    </div>
  </div>
</div>

<!-- ONBOARDING -->
<div id="onboarding-screen" class="onboarding-bg">
  <div class="onboarding-card">
    <div class="onboarding-logo">PROGRESSAR</div>
    <p style="color: var(--muted2); font-size:14px; margin-bottom:32px;">O app que pensa na sua progressÃ£o por vocÃª</p>

    <div class="step-dots">
      <div class="dot active" id="dot-0"></div>
      <div class="dot" id="dot-1"></div>
      <div class="dot" id="dot-2"></div>
    </div>

    <div class="step active" id="step-0">
      <div style="font-size:48px; margin-bottom:16px;">ğŸ‹ï¸</div>
      <h2 style="font-family:'Bebas Neue'; font-size:28px; margin-bottom:8px; letter-spacing:1px;">Evolua com mÃ©todo</h2>
      <p style="color:var(--muted2); font-size:14px; line-height:1.6; margin-bottom:28px;">Baseado no mÃ©todo de Paulo Muzy, o PROGRESSAR automatiza sua progressÃ£o de carga â€” sem planilha, sem cÃ¡lculo, sem estagnaÃ§Ã£o.</p>
      <button class="btn btn-primary btn-full btn-lg" onclick="nextStep()">ComeÃ§ar â†’</button>
    </div>

    <div class="step" id="step-1">
      <h2 style="font-family:'Bebas Neue'; font-size:28px; margin-bottom:16px; letter-spacing:1px;">SOBRE VOCÃŠ</h2>
      <div style="display:flex; flex-direction:column; gap:14px; text-align:left;">
        <div>
          <label>Seu nome</label>
          <input type="text" id="user-name" placeholder="Como vocÃª quer ser chamado?">
        </div>
        <div>
          <label style="margin-bottom:8px; display:block;">Qual seu nÃ­vel de treino?</label>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <button type="button" class="level-btn" id="lvl-beginner" onclick="setUserLevel('beginner')">
              <span style="font-size:28px;">ğŸŒ±</span>
              <div>
                <div class="level-title">Iniciante</div>
                <div class="level-desc">AtÃ© 6 meses de treino â€” foco na tÃ©cnica e adaptaÃ§Ã£o</div>
              </div>
            </button>
            <button type="button" class="level-btn selected" id="lvl-intermediate" onclick="setUserLevel('intermediate')">
              <span style="font-size:28px;">ğŸ’ª</span>
              <div>
                <div class="level-title">IntermediÃ¡rio</div>
                <div class="level-desc">6 meses a 2 anos â€” evoluindo cargas progressivamente</div>
              </div>
            </button>
            <button type="button" class="level-btn" id="lvl-advanced" onclick="setUserLevel('advanced')">
              <span style="font-size:28px;">ğŸ”¥</span>
              <div>
                <div class="level-title">AvanÃ§ado</div>
                <div class="level-desc">Mais de 2 anos â€” volume e tÃ©cnicas avanÃ§adas</div>
              </div>
            </button>
          </div>
          <input type="hidden" id="user-level" value="intermediate">
        </div>
        <div>
          <label>Objetivo principal</label>
          <select id="user-goal">
            <option value="hypertrophy" selected>Hipertrofia muscular</option>
            <option value="strength">ForÃ§a mÃ¡xima</option>
            <option value="endurance">ResistÃªncia muscular</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary btn-full btn-lg" style="margin-top:20px;" onclick="nextStep()">Continuar â†’</button>
    </div>

    <div class="step" id="step-2">
      <div style="font-size:48px; margin-bottom:16px;">ğŸ¯</div>
      <h2 style="font-family:'Bebas Neue'; font-size:28px; margin-bottom:8px; letter-spacing:1px;">TUDO PRONTO!</h2>
      <p style="color:var(--muted2); font-size:14px; line-height:1.6; margin-bottom:28px;">Vamos configurar seus primeiros treinos e vocÃª jÃ¡ comeÃ§a a registrar sua evoluÃ§Ã£o hoje.</p>
      <button class="btn btn-primary btn-full btn-lg" onclick="finishOnboarding()">Entrar no app ğŸš€</button>
    </div>
  </div>
</div>

<!-- APP -->
<div class="app" id="app-screen" style="display:none;">

  <nav class="sidebar">
    <div class="logo" onclick="switchView('dashboard')" aria-label="Dashboard">P</div>
    <button class="nav-btn active" id="nav-dashboard" onclick="switchView('dashboard')" aria-label="Dashboard">
      ğŸ  <span class="tooltip">Dashboard</span>
    </button>
    <button class="nav-btn" id="nav-treinos" onclick="switchView('treinos')" aria-label="Meus Treinos">
      ğŸ“‹ <span class="tooltip">Meus Treinos</span>
    </button>
    <button class="nav-btn" id="nav-exercicios" onclick="switchView('exercicios')" aria-label="ExercÃ­cios">
      ğŸ’ª <span class="tooltip">ExercÃ­cios</span>
    </button>
    <button class="nav-btn" id="nav-historico" onclick="switchView('historico')" aria-label="HistÃ³rico">
      ğŸ“ˆ <span class="tooltip">HistÃ³rico</span>
    </button>
    <button class="nav-btn" id="nav-cardio" onclick="switchView('cardio')" aria-label="Cardio">
      ğŸƒ <span class="tooltip">Cardio</span>
    </button>
    <div style="flex:1;"></div>
    <button class="nav-btn" id="nav-ebooks" onclick="switchView('ebooks')" aria-label="Ebooks">
      ğŸ“š <span class="tooltip">Ebooks</span>
    </button>
    <button class="nav-btn" id="nav-foco" onclick="switchView('foco')" aria-label="Modo Foco">
      ğŸ¯ <span class="tooltip">Modo Foco</span>
    </button>
    <button class="nav-btn" id="nav-perfil" onclick="switchView('perfil')" aria-label="Perfil">
      ğŸ‘¤ <span class="tooltip">Perfil</span>
    </button>
  </nav>

  <main class="main">

    <div class="view active" id="view-dashboard">
      <div class="page-header">
        <div>
          <div class="page-title" id="dash-greeting">BOM DIA!</div>
          <div class="page-subtitle" id="dash-subtitle">Carregando...</div>
        </div>
        <button class="btn btn-primary btn-lg pulse" id="start-workout-btn" onclick="startWorkout()">
          â–¶ Iniciar Treino
        </button>
      </div>

      <div class="section">
        <div class="grid-3" style="margin-bottom:20px;">
          <div class="card" style="display:flex; align-items:center; gap:16px;">
            <div class="ring-chart">
              <svg width="80" height="80" viewBox="0 0 80 80">
                <circle cx="40" cy="40" r="32" fill="none" stroke="#222" stroke-width="8"/>
                <circle cx="40" cy="40" r="32" fill="none" stroke="var(--orange)" stroke-width="8"
                  stroke-dasharray="201" id="ring-streak" stroke-dashoffset="201" stroke-linecap="round"/>
              </svg>
              <div class="ring-value" id="ring-streak-val">0</div>
            </div>
            <div>
              <div class="stat-number" style="font-size:36px;" id="stat-streak">0</div>
              <div class="stat-label">Semanas seguidas</div>
            </div>
          </div>
          <div class="card">
            <div class="stat-number" id="stat-sessions">0</div>
            <div class="stat-label">Treinos realizados</div>
          </div>
          <div class="card">
            <div class="stat-number" id="stat-progressions">0</div>
            <div class="stat-label">ProgressÃµes feitas</div>
          </div>
        </div>

        <div class="suggestion-box" style="margin-bottom:20px;">
          <div class="suggestion-title">âš¡ PRÃ“XIMO TREINO SUGERIDO</div>
          <div id="next-workout-content">
            <p style="color:var(--muted2); font-size:14px;">Crie seu primeiro treino para comeÃ§ar!</p>
          </div>
        </div>

        <div id="progression-alerts" style="margin-bottom:20px;"></div>

        <div class="section-title">ÃšLTIMAS SESSÃ•ES</div>
        <div id="recent-sessions">
          <div style="color:var(--muted2); font-size:14px; padding:16px; text-align:center; background:var(--card); border-radius:12px; border:1px solid var(--border);">
            Nenhuma sessÃ£o registrada ainda.<br>Inicie seu primeiro treino!
          </div>
        </div>
      </div>
    </div>

    <div class="view" id="view-treinos">
      <div class="page-header">
        <div>
          <div class="page-title">TREINOS</div>
          <div class="page-subtitle">Gerencie suas fichas de treino</div>
        </div>
        <button class="btn btn-primary" onclick="openWorkoutBuilder()">+ Novo Treino</button>
      </div>

      <div class="section">
        <div id="workout-plans-list">
          <div style="color:var(--muted2); font-size:14px; padding:24px; text-align:center; background:var(--card); border-radius:12px; border:1px dashed var(--border2);">
            <div style="font-size:32px; margin-bottom:8px;">ğŸ“‹</div>
            Nenhum treino criado ainda.<br>Crie seu primeiro treino acima!
          </div>
        </div>
      </div>
    </div>

    <div class="view" id="view-exercicios">
      <div class="page-header">
        <div>
          <div class="page-title">EXERCÃCIOS</div>
          <div class="page-subtitle">Seu banco de exercÃ­cios pessoal</div>
        </div>
        <button class="btn btn-primary" onclick="openModal('exercise-modal'); setExerciseType('musculacao')">+ Novo ExercÃ­cio</button>
      </div>

      <div class="section">
        <div style="margin-bottom:16px; display:flex; gap:8px; flex-wrap:wrap;" id="muscle-filters">
          <button class="btn btn-primary" style="font-size:12px;" onclick="filterExercises('all')">Todos (0)</button>
        </div>
        <div id="exercises-list"></div>
      </div>
    </div>

    <div class="view" id="view-historico">
      <div class="page-header">
        <div>
          <div class="page-title">HISTÃ“RICO</div>
          <div class="page-subtitle">Sua evoluÃ§Ã£o ao longo do tempo</div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">EVOLUÃ‡ÃƒO POR EXERCÃCIO</div>
        <div style="margin-bottom:16px;">
          <select id="history-exercise-select" onchange="renderHistoryChart()" style="max-width:300px;">
            <option value="">Selecione um exercÃ­cio...</option>
          </select>
        </div>

        <div class="card" style="margin-bottom:20px;">
          <div id="chart-placeholder" style="text-align:center; padding:32px; color:var(--muted2);">
            <div style="font-size:32px; margin-bottom:8px;">ğŸ“Š</div>
            Selecione um exercÃ­cio para ver a evoluÃ§Ã£o
          </div>
          <canvas id="progress-chart" style="display:none;"></canvas>
          <div id="chart-stats" style="display:none; margin-top:16px;" class="grid-3"></div>
        </div>

        <div class="section-title">TODAS AS SESSÃ•ES</div>
        <div id="all-sessions-list"></div>
      </div>
    </div>

    <div class="view" id="view-workout-active">
      <div class="workout-header">
        <div>
          <div style="font-family:'Bebas Neue'; font-size:28px; letter-spacing:1px;" id="active-workout-title">TREINO</div>
          <div style="font-size:13px; color:var(--muted2);" id="active-workout-timer">00:00</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-ghost" onclick="cancelWorkout()">Cancelar</button>
          <button class="btn btn-success btn-lg" onclick="finishWorkout()">âœ“ Finalizar</button>
        </div>
      </div>

      <div class="section">
        <div id="active-exercises"></div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- CARDIO VIEW                                     -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="view" id="view-cardio">
      <div class="page-header" style="display:flex; justify-content:space-between; align-items:center;">
        <div class="page-title">CARDIO</div>
        <button class="btn btn-primary" onclick="abrirRegistroCardio()">+ Registrar</button>
      </div>
      <div class="section">

        <!-- Registro rÃ¡pido -->
        <div class="card" id="cardio-form-card" style="margin-bottom:16px; display:none;">
          <div style="font-family:'Bebas Neue'; font-size:20px; letter-spacing:1px; margin-bottom:16px;">ğŸƒ NOVA SESSÃƒO DE CARDIO</div>
          <div class="grid-2" style="gap:10px;">
            <div>
              <label>Tipo de cardio</label>
              <select id="cardio-tipo-v">
                <option value="Esteira">ğŸƒ Esteira</option>
                <option value="Bike">ğŸš´ Bike</option>
                <option value="Escada">ğŸªœ Escada</option>
                <option value="Corrida externa">ğŸŒ³ Corrida</option>
                <option value="Pular corda">ğŸª¢ Pular corda</option>
                <option value="NataÃ§Ã£o">ğŸŠ NataÃ§Ã£o</option>
                <option value="Remo">ğŸš£ Remo</option>
              </select>
            </div>
            <div>
              <label>DuraÃ§Ã£o (min)</label>
              <input type="number" id="cardio-tempo-v" value="20" min="5" step="5">
            </div>
          </div>
          <div class="grid-2" style="gap:10px; margin-top:10px;">
            <div>
              <label>Intensidade</label>
              <select id="cardio-intensidade-v">
                <option value="leve">ğŸ˜Œ Leve</option>
                <option value="moderado" selected>ğŸ˜Š Moderado</option>
                <option value="intenso">ğŸ¥µ Intenso</option>
              </select>
            </div>
            <div>
              <label>DistÃ¢ncia (km, opcional)</label>
              <input type="number" id="cardio-distancia-v" placeholder="0.0" step="0.1" min="0">
            </div>
          </div>
          <div style="display:flex; gap:8px; margin-top:14px;">
            <button class="btn btn-ghost btn-full" onclick="fecharRegistroCardio()">Cancelar</button>
            <button class="btn btn-primary btn-full" onclick="salvarCardioView()">âœ“ Salvar sessÃ£o</button>
          </div>
        </div>

        <!-- Regras por objetivo -->
        <div class="card" style="margin-bottom:16px;" id="cardio-dica-objetivo"></div>

        <!-- Alertas cardio -->
        <div id="cardio-alertas-view" style="margin-bottom:8px;"></div>

        <!-- Stats rÃ¡pidas -->
        <div class="card" style="margin-bottom:16px;">
          <div class="section-title" style="margin-bottom:14px;">ğŸ“Š ESTATÃSTICAS</div>
          <div id="cardio-stats-view"><!-- filled by JS --></div>
        </div>

        <!-- HistÃ³rico cardio -->
        <div class="card">
          <div class="section-title" style="margin-bottom:14px;">ğŸ“… HISTÃ“RICO</div>
          <div id="cardio-historico-view"><!-- filled by JS --></div>
        </div>

      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â• EBOOKS VIEW â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="view" id="view-ebooks">
      <div class="page-header">
        <div class="page-title">ğŸ“š EBOOKS</div>
      </div>
      <div class="section">

        <div style="background:var(--orange-dim); border:1px solid var(--orange-mid); border-radius:14px; padding:14px 16px; margin-bottom:20px; font-size:13px; color:var(--muted2); line-height:1.6;">
          ğŸ <strong style="color:var(--text);">CapÃ­tulos 1 e 2 sÃ£o gratuitos.</strong> Desbloqueie o conteÃºdo completo com uma contribuiÃ§Ã£o via Pix ou assinatura mensal.
        </div>

        <!-- EBOOK 1: ECTOMORFA -->
        <div class="ebook-card">
          <div class="ebook-cover" style="background: linear-gradient(135deg, #1a0a2e 0%, #2d1b4e 50%, #0a0a0a 100%);">
            <div class="ebook-cover-emoji">ğŸŒ¿</div>
            <div class="ebook-cover-title">ECTOMORFA</div>
            <div class="ebook-cover-sub">Guia Completo Â· Biotipo Feminino</div>
          </div>
          <div class="ebook-body">
            <div class="ebook-title">O Guia da Ectomorfa</div>
            <div class="ebook-desc">Para a mulher que tem dificuldade em ganhar massa, entende por que vocÃª Ã© assim e o que fazer de diferente.</div>
            <div class="ebook-tags">
              <span class="tag tag-blue">NutriÃ§Ã£o</span>
              <span class="tag tag-green">Treino</span>
              <span class="tag" style="background:rgba(180,120,255,0.1);color:#b478ff;">HormÃ´nios</span>
              <span class="tag tag-orange">Mindset</span>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-primary btn-full" onclick="openEbook('ectomorfa')">ğŸ“– Ler agora</button>
              <button class="btn btn-ghost" onclick="downloadEbookPDF('ectomorfa')" style="white-space:nowrap;">â¬‡ PDF</button>
            </div>
          </div>
        </div>

        <!-- EBOOK 2: MESOMORFA -->
        <div class="ebook-card">
          <div class="ebook-cover" style="background: linear-gradient(135deg, #0a1a0a 0%, #1a3a1a 50%, #0a0a0a 100%);">
            <div class="ebook-cover-emoji">ğŸ’ª</div>
            <div class="ebook-cover-title">MESOMORFA</div>
            <div class="ebook-cover-sub">Guia Completo Â· Biotipo Feminino</div>
          </div>
          <div class="ebook-body">
            <div class="ebook-title">O Guia da Mesomorfa</div>
            <div class="ebook-desc">Para a mulher que ganha mÃºsculo e gordura com facilidade â€” como usar essa vantagem a seu favor.</div>
            <div class="ebook-tags">
              <span class="tag tag-blue">NutriÃ§Ã£o</span>
              <span class="tag tag-green">Treino</span>
              <span class="tag" style="background:rgba(180,120,255,0.1);color:#b478ff;">HormÃ´nios</span>
              <span class="tag tag-orange">Mindset</span>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-primary btn-full" onclick="openEbook('mesomorfa')">ğŸ“– Ler agora</button>
              <button class="btn btn-ghost" onclick="downloadEbookPDF('mesomorfa')" style="white-space:nowrap;">â¬‡ PDF</button>
            </div>
          </div>
        </div>

        <!-- EBOOK 3: ENDOMORFA -->
        <div class="ebook-card">
          <div class="ebook-cover" style="background: linear-gradient(135deg, #1a0a00 0%, #3a1a00 50%, #0a0a0a 100%);">
            <div class="ebook-cover-emoji">ğŸ”¥</div>
            <div class="ebook-cover-title">ENDOMORFA</div>
            <div class="ebook-cover-sub">Guia Completo Â· Biotipo Feminino</div>
          </div>
          <div class="ebook-body">
            <div class="ebook-title">O Guia da Endomorfa</div>
            <div class="ebook-desc">Para a mulher que acumula gordura com facilidade â€” estratÃ©gias especÃ­ficas para definiÃ§Ã£o e saÃºde hormonal.</div>
            <div class="ebook-tags">
              <span class="tag tag-blue">NutriÃ§Ã£o</span>
              <span class="tag tag-green">Treino</span>
              <span class="tag" style="background:rgba(180,120,255,0.1);color:#b478ff;">HormÃ´nios</span>
              <span class="tag tag-orange">Mindset</span>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-primary btn-full" onclick="openEbook('endomorfa')">ğŸ“– Ler agora</button>
              <button class="btn btn-ghost" onclick="downloadEbookPDF('endomorfa')" style="white-space:nowrap;">â¬‡ PDF</button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â• EBOOK READER (full screen) â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="ebook-reader" id="ebook-reader">
      <div class="reader-header">
        <button class="btn btn-ghost" style="padding:8px 12px; font-size:18px;" onclick="closeEbook()">â†</button>
        <div class="reader-title" id="reader-title">EBOOK</div>
        <button class="btn btn-ghost" style="padding:8px 12px; font-size:13px;" onclick="downloadCurrentPDF()">â¬‡ PDF</button>
      </div>
      <div class="reader-content" id="reader-content">
        <!-- filled by JS -->
      </div>
    </div>

    <div class="view" id="view-perfil">
      <div class="page-header">
        <div class="page-title">PERFIL</div>
      </div>
      <div class="section">
        <div class="card" style="margin-bottom:16px;">
          <div style="display:flex; align-items:center; gap:16px; margin-bottom:20px;">
            <div style="width:60px; height:60px; background:var(--orange-dim); border:2px solid var(--orange); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px;">ğŸ‹ï¸</div>
            <div>
              <div style="font-family:'Bebas Neue'; font-size:28px; letter-spacing:1px;" id="profile-name">â€”</div>
              <div style="font-size:13px; color:var(--muted2);" id="profile-level">â€”</div>
            </div>
          </div>
          <hr class="sep" style="margin:0 0 16px;">
          <div class="grid-2">
            <div>
              <div class="stat-label">MÃ©todo de progressÃ£o</div>
              <div style="font-weight:600; margin-top:4px;">MÃ©todo Muzy (8â€“12 reps)</div>
            </div>
            <div>
              <div class="stat-label">Objetivo</div>
              <div style="font-weight:600; margin-top:4px;" id="profile-goal">â€”</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="section-title" style="margin-bottom:16px;">SOBRE O MÃ‰TODO</div>
          <div style="background:var(--card2); border-radius:12px; padding:16px; border-left:3px solid var(--orange);">
            <p style="font-size:13px; color:var(--muted2); line-height:1.7;">
              <strong style="color:var(--text);">Como funciona a progressÃ£o automÃ¡tica:</strong><br>
              1. Defina um peso que vocÃª consegue fazer 8 repetiÃ§Ãµes<br>
              2. Treine atÃ© conseguir 12 reps com boa tÃ©cnica<br>
              3. O app sugere aumentar a carga em 5â€“10%<br>
              4. Com o novo peso, vocÃª volta a fazer 8 reps<br>
              5. O ciclo se repete â€” isso Ã© progresso real!
            </p>
          </div>
          <p style="font-size:12px; color:var(--muted); margin-top:12px; font-style:italic;">
            "Se nÃ£o hÃ¡ progressÃ£o de carga, nÃ£o hÃ¡ evoluÃ§Ã£o no treino." â€” Paulo Muzy
          </p>
        </div>

        <!-- Cardio stats card -->
        <div class="card" style="margin-top:16px;" id="cardio-stats-card">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
            <div class="section-title" style="margin:0;">ğŸƒ CARDIO</div>
            <button class="btn btn-ghost" style="font-size:12px;" onclick="openModal('exercise-modal'); setTimeout(()=>setExerciseType('cardio'),100)">+ Registrar</button>
          </div>
          <div id="cardio-stats-content"><!-- filled by updateProfile --></div>
        </div>

        <div style="margin-top:16px;">
          <button class="btn btn-ghost btn-full" onclick="resetApp()" style="color:var(--red); border-color:var(--red-dim);">
            ğŸ—‘ Resetar todos os dados
          </button>
        </div>
      </div>
    </div>

    <div class="view" id="view-foco">
      <div id="foco-idle" style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; text-align:center; padding:32px;">
        <div style="font-size:64px; margin-bottom:16px;">ğŸ¯</div>
        <div style="font-family:'Bebas Neue'; font-size:40px; letter-spacing:2px; margin-bottom:8px;">MODO FOCO</div>
        <p style="color:var(--muted2); font-size:15px; line-height:1.6; max-width:320px; margin-bottom:32px;">
          Interface minimalista para durante o treino.<br>SÃ³ o essencial â€” sem distraÃ§Ãµes.
        </p>
        <button class="btn btn-primary btn-lg" onclick="startFocoMode()" aria-label="Modo Foco">Iniciar Treino em Foco</button>
        <p style="color:var(--muted); font-size:12px; margin-top:12px;">Selecione um treino para comeÃ§ar</p>
        <div id="foco-plan-select" style="margin-top:16px; display:flex; flex-direction:column; gap:8px; width:100%; max-width:320px;"></div>
      </div>

      <div id="foco-active" style="display:none; min-height:100vh; background:var(--darker);">
        <div style="background:var(--card); border-bottom:1px solid var(--border); padding:16px 24px; display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div style="font-family:'Bebas Neue'; font-size:20px; letter-spacing:1px;" id="foco-workout-name">TREINO</div>
            <div style="font-size:12px; color:var(--muted2);" id="foco-timer-label">00:00</div>
          </div>
          <button class="btn btn-ghost" style="font-size:12px;" onclick="exitFoco()">âœ• Sair do foco</button>
        </div>

        <div style="padding:24px; max-width:480px; margin:0 auto;">
          <div style="display:flex; gap:6px; justify-content:center; margin-bottom:24px;" id="foco-ex-dots"></div>

          <div style="text-align:center; margin-bottom:32px;">
            <div style="font-size:48px; margin-bottom:8px;" id="foco-ex-emoji">ğŸ’ª</div>
            <div style="font-family:'Bebas Neue'; font-size:36px; letter-spacing:1px; margin-bottom:4px;" id="foco-ex-name">EXERCÃCIO</div>
            <div style="font-size:14px; color:var(--muted2);" id="foco-ex-meta">3 sÃ©ries Â· 8-12 reps</div>
          </div>

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:32px;">
            <div class="card" style="text-align:center; padding:20px;">
              <div style="font-size:12px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">PESO</div>
              <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
                <button class="num-btn" onclick="focoAdjust('weight',-0.5)" style="border-radius:8px;" aria-label="Diminuir peso">âˆ’</button>
                <div style="font-family:'Bebas Neue'; font-size:40px; color:var(--orange); min-width:60px;" id="foco-weight">20</div>
                <button class="num-btn" onclick="focoAdjust('weight',0.5)" style="border-radius:8px;" aria-label="Aumentar peso">+</button>
              </div>
              <div style="font-size:12px; color:var(--muted2);">kg</div>
            </div>
            <div class="card" style="text-align:center; padding:20px;">
              <div style="font-size:12px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">REPS</div>
              <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
                <button class="num-btn" onclick="focoAdjust('reps',-1)" style="border-radius:8px;" aria-label="Diminuir repetiÃ§Ãµes">âˆ’</button>
                <div style="font-family:'Bebas Neue'; font-size:40px; color:var(--orange); min-width:40px;" id="foco-reps">0</div>
                <button class="num-btn" onclick="focoAdjust('reps',1)" style="border-radius:8px;" aria-label="Aumentar repetiÃ§Ãµes">+</button>
              </div>
              <div style="font-size:12px; color:var(--muted2);">repetiÃ§Ãµes</div>
            </div>
          </div>

          <div style="margin-bottom:24px;">
            <div style="font-size:12px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px; margin-bottom:10px; text-align:center;" id="foco-set-label">SÃ‰RIE 1 DE 3</div>
            <div style="display:flex; gap:8px; justify-content:center;" id="foco-set-dots"></div>
          </div>

          <button class="btn btn-primary btn-full btn-lg" style="font-size:18px; padding:18px; border-radius:16px;" id="foco-action-btn" onclick="focoNextSet()">
            âœ“ SÃ©rie concluÃ­da
          </button>

          <button class="btn btn-ghost btn-full" style="margin-top:10px;" onclick="focoNextExercise()">
            PrÃ³ximo exercÃ­cio â†’
          </button>
        </div>
      </div>

      <div id="foco-finish" style="display:none; min-height:100vh; display:none; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:32px;">
        <div style="font-size:64px; margin-bottom:16px;">ğŸ†</div>
        <div style="font-family:'Bebas Neue'; font-size:48px; color:var(--orange); letter-spacing:2px; margin-bottom:8px;">TREINO FEITO!</div>
        <p style="color:var(--muted2); margin-bottom:32px;" id="foco-summary"></p>
        <button class="btn btn-primary btn-lg" onclick="focoFinish()">Salvar e voltar</button>
      </div>
    </div>

  </main>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let state = {
  user: null,
  exercises: [],
  workoutPlans: [],
  sessions: [],
  activeWorkout: null,
  workoutStartTime: null,
  workoutTimerInterval: null,
  restTimerInterval: null,
  restSecondsLeft: 0,
  // Modo Iniciante
  modoIniciante: {
    ativo: false,
    dataInicio: null,
    dataFim: null,
    semanasRestantes: 4
  },
  // RecuperaÃ§Ã£o
  recuperacao: {
    diasConsecutivos: 0,
    ultimoTreinoData: null,
    bloqueioProgressao: false,
    motivoBloqueio: null
  },
  // Cardio
  cardio: {
    historico: [],
    ultimoCardioIntenso: null
  }
};

function save() {
  localStorage.setItem('progressar_state', JSON.stringify(state));
}

function load() {
  const raw = localStorage.getItem('progressar_state');
  if (raw) {
    try { state = { ...state, ...JSON.parse(raw) }; } catch(e) {}
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ONBOARDING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentStep = 0;

function nextStep() {
  if (currentStep === 1) {
    const name = document.getElementById('user-name').value.trim();
    if (!name) { showNotif('âš ï¸', 'AtenÃ§Ã£o', 'Digite seu nome para continuar', 'warning'); return; }
  }
  document.getElementById(`step-${currentStep}`).classList.remove('active');
  document.getElementById(`dot-${currentStep}`).classList.remove('active');
  currentStep++;
  document.getElementById(`step-${currentStep}`).classList.add('active');
  document.getElementById(`dot-${currentStep}`).classList.add('active');
}

function finishOnboarding() {
  const name = document.getElementById('user-name').value.trim() || 'Atleta';
  const level = document.getElementById('user-level').value;
  const goal = document.getElementById('user-goal').value;

  state.user = { name, level, goal };
  state.exercises = [];
  state.workoutPlans = [];

  // Activate beginner mode if selected
  if (level === 'beginner') {
    state.modoIniciante = {
      ativo: true,
      dataInicio: Date.now(),
      dataFim: Date.now() + (28 * 86400000),
      semanasRestantes: 4
    };
  }

  save();
  document.getElementById('onboarding-screen').style.display = 'none';
  document.getElementById('app-screen').style.display = 'flex';
  initApp();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initApp() {
  updateDashboard();
  renderWorkoutPlans();
  renderExercises();
  renderHistorySelect();
  renderAllSessions();
  updateProfile();
}

function uid() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchView(view) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`view-${view}`).classList.add('active');
  const nb = document.getElementById(`nav-${view}`);
  if (nb) nb.classList.add('active');
  // Refresh views when navigating
  if (view === 'perfil') updateProfile();
  if (view === 'cardio') renderCardioView();
  // ebooks view needs no JS refresh â€” static
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateDashboard() {
  if (!state.user) return;

  const hour = new Date().getHours();
  const greet = hour < 12 ? 'BOM DIA' : hour < 18 ? 'BOA TARDE' : 'BOA NOITE';
  document.getElementById('dash-greeting').textContent = `${greet}, ${state.user.name.toUpperCase()}!`;

  // Show install button if PWA prompt available
  const installBtn = document.getElementById('install-btn');
  if (installBtn && window.deferredPrompt) installBtn.style.display = 'flex';
  document.getElementById('dash-subtitle').textContent = getTodayMessage();

  document.getElementById('stat-sessions').textContent = state.sessions.length;
  document.getElementById('stat-progressions').textContent = countProgressions();
  const streak = calcStreak();
  document.getElementById('stat-streak').textContent = streak;
  document.getElementById('ring-streak-val').textContent = streak;

  const circ = 201;
  const maxStreak = 8;
  const offset = circ - (Math.min(streak, maxStreak) / maxStreak) * circ;
  setTimeout(() => { document.getElementById('ring-streak').style.strokeDashoffset = offset; }, 300);

  renderNextWorkout();
  renderProgressionAlerts();
  renderRecentSessions();

  // Show rest day button if 3+ consecutive days
  const restBtn2 = document.getElementById('rest-day-btn');
  if (restBtn2) {
    const cons = state.recuperacao?.diasConsecutivos || 0;
    restBtn2.style.display = cons >= 3 ? '' : 'none';
  }
}

function getTodayMessage() {
  // Modo iniciante badge
  if (state.modoIniciante?.ativo) {
    const weeks = state.modoIniciante.semanasRestantes;
    return `ğŸŒ± Modo Iniciante ativo â€” ${weeks} semana${weeks !== 1 ? 's' : ''} restante${weeks !== 1 ? 's' : ''}`;
  }
  // Recovery warning
  const rec = getRecoveryStatus();
  if (rec.recuperacao !== 'normal' && rec.mensagem) return rec.mensagem;
  if (state.sessions.length === 0) return 'Registre seu primeiro treino hoje!';
  const last = state.sessions[state.sessions.length - 1];
  const daysSince = Math.floor((Date.now() - last.date) / 86400000);
  if (daysSince === 0) return 'Ã“timo trabalho hoje! Descanse bem.';
  if (daysSince === 1) return 'VocÃª treinou ontem. Bora continuar!';
  if (daysSince <= 3) return 'EstÃ¡ na hora de treinar!';
  return `Faz ${daysSince} dias sem treinar. Que tal hoje?`;
}

function calcStreak() {
  if (state.sessions.length === 0) return 0;
  // FIX12: count CONSECUTIVE weeks with at least 1 session â€” no gaps allowed
  const sorted = [...state.sessions].sort((a, b) => a.date - b.date);
  // Get unique weeks that have sessions
  const weeks = [...new Set(sorted.map(s => getWeekNumber(new Date(s.date))))].sort((a,b) => a - b);
  if (weeks.length === 0) return 0;
  // Walk backwards from most recent week counting consecutive weeks
  let streak = 1;
  for (let i = weeks.length - 1; i > 0; i--) {
    if (weeks[i] - weeks[i-1] === 1) {
      streak++;
    } else {
      break; // gap found â€” stop counting
    }
  }
  return streak;
}

function getWeekNumber(d) {
  d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

function countProgressions() {
  return state.sessions.reduce((acc, s) => acc + (s.progressions || 0), 0);
}

function renderNextWorkout() {
  const el = document.getElementById('next-workout-content');
  if (state.workoutPlans.length === 0) {
    el.innerHTML = '<p style="color:var(--muted2);font-size:14px;">Crie seu primeiro treino para comeÃ§ar!</p>';
    return;
  }

  const planLastDone = state.workoutPlans.map(p => {
    const sessions = state.sessions.filter(s => s.planId === p.id);
    const last = sessions.length ? Math.max(...sessions.map(s => s.date)) : 0;
    return { plan: p, last };
  });
  planLastDone.sort((a, b) => a.last - b.last);
  const next = planLastDone[0].plan;

  const exercises = next.exercises.map(id => state.exercises.find(e => e.id === id)).filter(Boolean);

  el.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <div>
        <div style="font-weight:700; font-size:16px;">${next.name}</div>
        <div style="font-size:13px; color:var(--muted2);">${next.day} Â· ${exercises.length} exercÃ­cios</div>
      </div>
      <span class="tag tag-orange">${next.day}</span>
    </div>
    <div style="display:flex; flex-wrap:wrap; gap:6px;">
      ${exercises.map(e => `<span class="tag tag-blue">${e.name}</span>`).join('')}
    </div>
  `;

  document.getElementById('start-workout-btn').onclick = () => startWorkoutWithPlan(next);

  // Add rest day button
  const restBtn = document.getElementById('rest-day-btn');
  if (restBtn) restBtn.style.display = '';
}

function renderProgressionAlerts() {
  const el = document.getElementById('progression-alerts');
  const alerts = [];

  state.exercises.forEach(ex => {
    const sessions = state.sessions.filter(s => s.exercises?.some(e => e.exerciseId === ex.id));
    if (sessions.length < 2) return;

    const recent = sessions.slice(-3);
    const maxRep = parseInt(ex.reps.split('-')[1]);

    const lastSession = recent[recent.length - 1];
    const lastExData = lastSession.exercises?.find(e => e.exerciseId === ex.id);
    if (!lastExData) return;

    const avgReps = lastExData.sets?.reduce((a, s) => a + (parseInt(s.reps) || 0), 0) / (lastExData.sets?.length || 1);

    if (avgReps >= maxRep) {
      alerts.push(`<div class="suggestion-box" style="margin-bottom:10px;">
        <div style="display:flex; align-items:center; gap:8px;">
          <span style="font-size:20px;">ğŸ”¥</span>
          <div>
            <div style="font-weight:700; color:var(--green);">Hora de subir o peso!</div>
            <div style="font-size:13px; color:var(--muted2);">${ex.name} â€” VocÃª atingiu ${maxRep} reps. Aumente 5-10% no prÃ³ximo treino.</div>
          </div>
        </div>
      </div>`);
    }

    if (sessions.length >= 3) {
      const weights = recent.map(s => s.exercises?.find(e => e.exerciseId === ex.id)?.weight || 0);
      const repsAvg = recent.map(s => {
        const exData = s.exercises?.find(e => e.exerciseId === ex.id);
        return exData?.sets?.reduce((a, s) => a + (parseInt(s.reps) || 0), 0) / (exData?.sets?.length || 1) || 0;
      });
      if (weights[0] === weights[1] && weights[1] === weights[2] && weights[0] > 0) {
        const repStagnation = repsAvg[0] === repsAvg[1] && repsAvg[1] === repsAvg[2];
        if (repStagnation) {
          alerts.push(`<div class="card card-sm" style="border-color:var(--yellow); margin-bottom:10px;">
            <div style="display:flex; align-items:center; gap:8px;">
              <span style="font-size:18px;">âš ï¸</span>
              <div>
                <div style="font-weight:700; color:var(--yellow);">PlatÃ´ detectado</div>
                <div style="font-size:13px; color:var(--muted2);">${ex.name} â€” 3 sessÃµes com ${weights[0]}kg e reps estagnadas. Tente microcarga (+0.5kg) ou adicione 1 sÃ©rie.</div>
              </div>
            </div>
          </div>`);
        }
      }
    }
  });

  // Cardio alerts
  const cardioAlertas = gerarAlertasCardio();
  cardioAlertas.forEach(a => alerts.unshift(a.html));

  if (state.sessions.length >= 5) {
    const last7days = state.sessions.filter(s => Date.now() - s.date < 7 * 86400000 && !s.isRestDay && !s.isCardio);
    if (last7days.length >= 5) {
      alerts.unshift(`<div class="card card-sm" style="border-color:var(--red); margin-bottom:10px;">
        <div style="display:flex; align-items:center; gap:10px;">
          <span style="font-size:24px;">ğŸ˜´</span>
          <div>
            <div style="font-weight:700; color:var(--red);">Fadiga acumulada detectada!</div>
            <div style="font-size:13px; color:var(--muted2);">VocÃª treinou ${last7days.length}x nos Ãºltimos 7 dias. Considere 1-2 dias de descanso ou uma semana de deload (50% da carga).</div>
          </div>
        </div>
      </div>`);
    }

    const sortedDates = state.sessions.slice(-5).map(s => new Date(s.date).toDateString());
    const uniqueDays = new Set(sortedDates);
    if (uniqueDays.size >= 5) {
      const dayDiffs = state.sessions.slice(-5).map(s => s.date).sort();
      let consecutive = true;
      for (let i = 1; i < dayDiffs.length; i++) {
        if (dayDiffs[i] - dayDiffs[i-1] > 2 * 86400000) { consecutive = false; break; }
      }
      if (consecutive && !alerts.some(a => a.includes('Fadiga'))) {
        alerts.unshift(`<div class="card card-sm" style="border-color:var(--yellow); margin-bottom:10px;">
          <div style="display:flex; align-items:center; gap:10px;">
            <span style="font-size:24px;">âš¡</span>
            <div>
              <div style="font-weight:700; color:var(--yellow);">5 treinos sem dia de descanso</div>
              <div style="font-size:13px; color:var(--muted2);">O descanso Ã© parte do treino. MÃºsculos crescem na recuperaÃ§Ã£o, nÃ£o na academia.</div>
            </div>
          </div>
        </div>`);
      }
    }
  }

  el.innerHTML = alerts.length ? `<div class="section-title">ALERTAS DE PROGRESSÃƒO</div>${alerts.join('')}` : '';
}

function renderRecentSessions() {
  const el = document.getElementById('recent-sessions');
  if (state.sessions.length === 0) {
    el.innerHTML = `<div style="color:var(--muted2); font-size:14px; padding:16px; text-align:center; background:var(--card); border-radius:12px; border:1px solid var(--border);">
      Nenhuma sessÃ£o registrada ainda.<br>Inicie seu primeiro treino!
    </div>`;
    return;
  }

  const recent = [...state.sessions].reverse().slice(0, 5);
  el.innerHTML = recent.map(s => {
    const plan = state.workoutPlans.find(p => p.id === s.planId);
    const date = new Date(s.date).toLocaleDateString('pt-BR');
    const exCount = s.exercises?.length || 0;
    const vol = calcVolume(s);
    const progs = s.progressions || 0;
    return `<div class="card card-sm" style="margin-bottom:8px; display:flex; align-items:center; justify-content:space-between;">
      <div>
        <div style="font-weight:600; font-size:14px;">${plan?.name || 'Treino'}</div>
        <div style="font-size:12px; color:var(--muted2); margin-top:2px;">${date} Â· ${exCount} exercÃ­cios Â· ${vol}kg volume</div>
      </div>
      <div style="display:flex; gap:6px;">
        ${progs > 0 ? `<span class="tag tag-green">â†‘ ${progs} prog.</span>` : ''}
        <span class="tag tag-orange">âœ“</span>
      </div>
    </div>`;
  }).join('');
}

function calcVolume(session) {
  if (!session.exercises) return 0;
  return session.exercises.reduce((total, ex) => {
    const sets = ex.sets || [];
    return total + sets.reduce((st, s) => st + (parseFloat(s.weight) || 0) * (parseInt(s.reps) || 0), 0);
  }, 0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WORKOUT PLANS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let wb = { step: 1, selectedDays: [], selectedExIds: [], filter: 'Todos' };

function openWorkoutBuilder() {
  wb = { step: 1, selectedDays: [], selectedExIds: [], filter: 'Todos' };
  document.getElementById('plan-name').value = '';
  document.querySelectorAll('.day-pill').forEach(p => p.classList.remove('selected'));
  document.getElementById('wb-new-ex-panel').style.display = 'none';
  wbGoTo(1);
  openModal('workout-plan-modal');
}

function toggleDay(btn) {
  btn.classList.toggle('selected');
  const day = btn.dataset.day;
  if (wb.selectedDays.includes(day)) wb.selectedDays = wb.selectedDays.filter(d => d !== day);
  else wb.selectedDays.push(day);
}

function wbGoTo(step) {
  [1,2,3].forEach(s => {
    document.getElementById(`wb-step-${s}`).style.display = s === step ? 'block' : 'none';
    const ind = document.getElementById(`wbi-${s}`);
    ind.classList.remove('active','done');
    if (s === step) ind.classList.add('active');
    else if (s < step) ind.classList.add('done');
  });
  [1,2].forEach(l => {
    const line = document.getElementById(`wbl-${l}`);
    line.classList.toggle('done', l < step);
  });
  wb.step = step;
  if (step === 2) wbRenderExercises();
  if (step === 3) wbRenderConfirm();
}

function wbNext(step) {
  if (step === 1) {
    const name = document.getElementById('plan-name').value.trim();
    if (!name) { showNotif('âš ï¸', 'AtenÃ§Ã£o', 'Digite o nome do treino', 'warning'); return; }
    if (wb.selectedDays.length === 0) { showNotif('âš ï¸', 'AtenÃ§Ã£o', 'Selecione pelo menos um dia', 'warning'); return; }
  }
  if (step === 2 && wb.selectedExIds.length === 0) {
    showNotif('âš ï¸', 'AtenÃ§Ã£o', 'Adicione pelo menos 1 exercÃ­cio', 'warning'); return;
  }
  wbGoTo(step + 1);
}

function wbBack(step) { wbGoTo(step - 1); }

function wbFilter(group) {
  wb.filter = group;
  document.querySelectorAll('#wb-group-filters .btn').forEach(b => {
    b.classList.toggle('btn-primary', b.textContent.trim().replace(/[^ -~]/g,'').trim() === group || b.textContent.trim() === group);
    b.classList.toggle('btn-ghost', !(b.textContent.trim().replace(/[^ -~]/g,'').trim() === group || b.textContent.trim() === group));
  });
  wbRenderExercises();
}

function wbRenderExercises() {
  const list = document.getElementById('wb-exercise-list');
  const filtered = wb.filter === 'Todos' ? state.exercises : state.exercises.filter(e => e.group === wb.filter);
  if (filtered.length === 0) {
    list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--muted2); font-size:13px;">Nenhum exercÃ­cio nesta categoria.<br>Crie um novo abaixo!</div>`;
    return;
  }
  list.innerHTML = filtered.map(ex => {
    const sel = wb.selectedExIds.includes(ex.id);
    return `<div class="wb-ex-row ${sel ? 'selected' : ''}" onclick="wbToggleEx('${ex.id}', this)">
      <div class="wb-ex-check">${sel ? 'âœ“' : ''}</div>
      <div style="font-size:18px;">${groupEmoji(ex.group)}</div>
      <div style="flex:1;">
        <div style="font-weight:600; font-size:13px;">${ex.name}</div>
        <div style="font-size:11px; color:var(--muted2);">${ex.group} Â· ${ex.equip} Â· ${ex.sets}x${ex.reps} Â· ${ex.weight}kg</div>
      </div>
    </div>`;
  }).join('');
  wbUpdateSelectedPreview();
}

function wbToggleEx(id, row) {
  if (wb.selectedExIds.includes(id)) {
    wb.selectedExIds = wb.selectedExIds.filter(i => i !== id);
    row.classList.remove('selected');
    row.querySelector('.wb-ex-check').textContent = '';
  } else {
    wb.selectedExIds.push(id);
    row.classList.add('selected');
    row.querySelector('.wb-ex-check').textContent = 'âœ“';
  }
  wbUpdateSelectedPreview();
}

function wbUpdateSelectedPreview() {
  const count = document.getElementById('wb-selected-count');
  const tags = document.getElementById('wb-selected-tags');
  count.textContent = wb.selectedExIds.length;
  if (wb.selectedExIds.length === 0) {
    tags.innerHTML = `<span style="color:var(--muted); font-size:13px; font-style:italic;">Nenhum exercÃ­cio selecionado</span>`;
    return;
  }
  tags.innerHTML = wb.selectedExIds.map(id => {
    const ex = state.exercises.find(e => e.id === id);
    return ex ? `<span class="tag tag-orange" style="cursor:pointer;" onclick="wbToggleEx('${id}', document.querySelector('[onclick*=\"${id}\"]')?.closest('.wb-ex-row'))">${ex.name} âœ•</span>` : '';
  }).join('');
}

function toggleNewExPanel() {
  const panel = document.getElementById('wb-new-ex-panel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function wbCreateAndAdd() {
  const name = document.getElementById('wb-ex-name').value.trim();
  if (!name) { showNotif('âš ï¸', 'AtenÃ§Ã£o', 'Digite o nome do exercÃ­cio', 'warning'); return; }
  const ex = {
    id: uid(), name,
    group: document.getElementById('wb-ex-group').value,
    equip: document.getElementById('wb-ex-equip').value,
    weight: parseFloat(document.getElementById('wb-ex-weight').value) || 20,
    reps: document.getElementById('wb-ex-reps').value,
    sets: parseInt(document.getElementById('wb-ex-sets').value) || 3,
    rest: parseInt(document.getElementById('wb-ex-rest').value) || 90,
    increment: parseFloat(document.getElementById('wb-ex-increment').value) || 2,
    execution: document.getElementById('wb-execution').value || 'livre',
  };
  state.exercises.push(ex);
  wb.selectedExIds.push(ex.id);
  document.getElementById('wb-ex-name').value = '';
  toggleNewExPanel();
  wbRenderExercises();
  renderExercises();
  showNotif('ğŸ’ª', 'ExercÃ­cio criado!', ex.name + ' adicionado ao treino', 'success');
}

function wbRenderConfirm() {
  const name = document.getElementById('plan-name').value.trim();
  const days = wb.selectedDays;
  const exs = wb.selectedExIds.map(id => state.exercises.find(e => e.id === id)).filter(Boolean);
  document.getElementById('wb-confirm-content').innerHTML = `
    <div class="card card-sm" style="margin-bottom:12px; background:var(--orange-dim); border-color:var(--orange-mid);">
      <div style="font-weight:700; font-size:18px; margin-bottom:4px;">${name}</div>
      <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:8px;">
        ${days.map(d => `<span class="tag tag-orange">${d}</span>`).join('')}
      </div>
    </div>
    <div class="section-title" style="margin-bottom:10px;">${exs.length} EXERCÃCIOS</div>
    ${exs.map((e,i) => `<div style="display:flex; align-items:center; gap:10px; padding:10px 12px; background:var(--card2); border-radius:10px; margin-bottom:6px;">
      <div style="font-size:16px;">${groupEmoji(e.group)}</div>
      <div style="flex:1;">
        <div style="font-weight:600; font-size:13px;">${e.name}</div>
        <div style="font-size:11px; color:var(--muted2);">${e.sets} sÃ©ries Â· ${e.reps} reps Â· ${e.weight}kg</div>
      </div>
      <span class="tag tag-blue">${i+1}</span>
    </div>`).join('')}
  `;
}

function saveWorkoutPlan() {
  const name = document.getElementById('plan-name').value.trim();
  if (!name) { showNotif('âš ï¸', 'AtenÃ§Ã£o', 'Digite o nome do treino', 'warning'); return; }
  state.workoutPlans.push({ id: uid(), name, day: wb.selectedDays.join(', '), exercises: [...wb.selectedExIds] });
  save();
  closeModal('workout-plan-modal');
  renderWorkoutPlans();
  updateDashboard();
  showNotif('âœ…', 'Treino criado!', `"${name}" com ${wb.selectedExIds.length} exercÃ­cios`, 'success');
}

function openEditWorkout(planId) {
  const plan = state.workoutPlans.find(p => p.id === planId);
  if (!plan) return;
  document.getElementById('edit-plan-id').value = plan.id;
  document.getElementById('edit-plan-name').value = plan.name;
  const days = plan.day ? plan.day.split(', ') : [];
  document.querySelectorAll('#edit-day-selector .day-pill').forEach(btn => {
    btn.classList.toggle('selected', days.includes(btn.dataset.day));
  });
  openModal('edit-workout-modal');
}

function updateWorkoutPlan() {
  const id = document.getElementById('edit-plan-id').value;
  const plan = state.workoutPlans.find(p => p.id === id);
  if (!plan) return;
  plan.name = document.getElementById('edit-plan-name').value.trim();
  const selectedDays = [];
  document.querySelectorAll('#edit-day-selector .day-pill.selected').forEach(btn => selectedDays.push(btn.dataset.day));
  plan.day = selectedDays.join(', ');
  save();
  closeModal('edit-workout-modal');
  renderWorkoutPlans();
  showNotif('âœï¸', 'Treino atualizado', '', 'success');
}

function renderWorkoutPlans() {
  const el = document.getElementById('workout-plans-list');
  if (state.workoutPlans.length === 0) {
    el.innerHTML = `<div style="color:var(--muted2); font-size:14px; padding:24px; text-align:center; background:var(--card); border-radius:12px; border:1px dashed var(--border2);">
      <div style="font-size:32px; margin-bottom:8px;">ğŸ“‹</div>
      Nenhum treino criado ainda.<br>Clique em "+ Novo Treino" para comeÃ§ar!
    </div>`;
    return;
  }

  el.innerHTML = state.workoutPlans.map(plan => {
    const exs = plan.exercises.map(id => state.exercises.find(e => e.id === id)).filter(Boolean);
    const sessions = state.sessions.filter(s => s.planId === plan.id);
    const days = plan.day ? plan.day.split(', ') : [];
    return `<div class="card" id="plan-${plan.id}" style="margin-bottom:16px;">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:14px;">
        <div>
          <div style="font-weight:700; font-size:17px;">${plan.name}</div>
          <div style="display:flex; gap:5px; margin-top:6px; flex-wrap:wrap;">
            ${days.map(d => `<span class="tag tag-orange">${d}</span>`).join('')}
            <span style="color:var(--muted2); font-size:12px; align-self:center;">${sessions.length} sessÃµes</span>
          </div>
        </div>
        <div style="display:flex; gap:6px;">
          <button class="btn btn-primary" onclick="startWorkoutWithPlan(state.workoutPlans.find(p=>p.id==='${plan.id}'))">â–¶ Iniciar</button>
          <button class="btn btn-ghost" onclick="openEditWorkout('${plan.id}')" title="Editar treino">âœï¸</button>
          <button class="btn btn-ghost" onclick="deletePlan('${plan.id}')" title="Excluir treino">ğŸ—‘</button>
        </div>
      </div>

      <div style="display:flex; flex-direction:column; gap:6px;">
        ${exs.length === 0
          ? `<div style="color:var(--muted); font-size:13px; padding:12px; text-align:center; background:var(--card2); border-radius:8px; border:1px dashed var(--border2);">Nenhum exercÃ­cio neste treino</div>`
          : exs.map((e, idx) => `<div style="display:flex; align-items:center; gap:10px; padding:10px 12px; background:var(--card2); border-radius:10px; border:1px solid var(--border);">
            <div style="font-size:18px;">${groupEmoji(e.group)}</div>
            <div style="flex:1;">
              <div style="font-weight:600; font-size:13px;">${e.name}</div>
              <div style="font-size:11px; color:var(--muted2); margin-top:2px; display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
                <span>${e.sets}x${e.reps} Â· ${e.weight}kg</span>
                <span class="tag" style="font-size:9px; background:${e.execution==='maquina'?'var(--blue-dim)':'var(--orange-dim)'}; color:${e.execution==='maquina'?'var(--blue)':'var(--orange)'}; padding:2px 6px;">${e.execution==='maquina'?'âš™ï¸ MÃ¡quina':'ğŸ‹ï¸ Livre'}</span>
                <span style="color:var(--muted2);">${e.equip}</span>
                <span style="color:var(--orange);">+${e.increment||2}kg</span>
              </div>
            </div>
            <div style="display:flex; gap:4px; align-items:center;">
              ${getSuggestion(e, plan.id)}
              <button class="btn btn-ghost" style="padding:5px 9px; font-size:12px;" onclick="removeExerciseFromPlan('${plan.id}','${e.id}')" title="Remover">âœ•</button>
              <button class="btn btn-ghost" style="padding:5px 9px; font-size:12px;" onclick="moveExercise('${plan.id}', ${idx}, 'up')" ${idx === 0 ? 'disabled' : ''}>â†‘</button>
              <button class="btn btn-ghost" style="padding:5px 9px; font-size:12px;" onclick="moveExercise('${plan.id}', ${idx}, 'down')" ${idx === exs.length-1 ? 'disabled' : ''}>â†“</button>
            </div>
          </div>`).join('')}
      </div>

      <div style="border-top:1px solid var(--border); margin-top:14px; padding-top:12px; display:flex; gap:8px; align-items:center;">
        <select id="add-ex-${plan.id}" style="flex:1; font-size:13px;">
          <option value="">+ Adicionar exercÃ­cio...</option>
          ${state.exercises.filter(e => !plan.exercises.includes(e.id)).map(e => `<option value="${e.id}">${groupEmoji(e.group)} ${e.name} (${e.weight}kg)</option>`).join('')}
        </select>
        <button class="btn btn-ghost" style="white-space:nowrap;" onclick="addExerciseToPlan('${plan.id}')">Adicionar</button>
      </div>
    </div>`;
  }).join('');
}

function moveExercise(planId, index, direction) {
  const plan = state.workoutPlans.find(p => p.id === planId);
  if (!plan) return;
  const newIndex = direction === 'up' ? index - 1 : index + 1;
  if (newIndex < 0 || newIndex >= plan.exercises.length) return;
  [plan.exercises[index], plan.exercises[newIndex]] = [plan.exercises[newIndex], plan.exercises[index]];
  save();
  renderWorkoutPlans();
}

function getSuggestion(ex, planId) {
  const sessions = state.sessions.filter(s => s.planId === planId && s.exercises?.some(e => e.exerciseId === ex.id));
  if (sessions.length === 0) return '';
  const last = sessions[sessions.length - 1];
  const lastEx = last.exercises?.find(e => e.exerciseId === ex.id);
  if (!lastEx) return '';
  const maxRep = parseInt(ex.reps.split('-')[1]);
  const avgReps = lastEx.sets?.reduce((a, s) => a + (parseInt(s.reps) || 0), 0) / (lastEx.sets?.length || 1);
  if (avgReps >= maxRep) return `<span class="tag tag-green">â†‘ Subir peso!</span>`;
  return `<span class="tag tag-blue">${Math.round(avgReps)} reps</span>`;
}

function addExerciseToPlan(planId) {
  const sel = document.getElementById(`add-ex-${planId}`);
  if (!sel || !sel.value) return;
  const plan = state.workoutPlans.find(p => p.id === planId);
  if (!plan.exercises.includes(sel.value)) {
    plan.exercises.push(sel.value);
    save();
    renderWorkoutPlans();
  }
}

function removeExerciseFromPlan(planId, exId) {
  if (!confirm('Remover este exercÃ­cio do treino?')) return;
  const plan = state.workoutPlans.find(p => p.id === planId);
  plan.exercises = plan.exercises.filter(id => id !== exId);
  save();
  renderWorkoutPlans();
}

function deletePlan(id) {
  if (!confirm('Tem certeza que deseja excluir este treino?')) return;
  state.workoutPlans = state.workoutPlans.filter(p => p.id !== id);
  save();
  renderWorkoutPlans();
  showNotif('ğŸ—‘', 'Treino removido', '', '');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXERCISES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let activeFilter = 'all';

function saveExercise() {
  const name = document.getElementById('ex-name').value.trim();
  if (!name) { showNotif('âš ï¸', 'AtenÃ§Ã£o', 'Digite o nome do exercÃ­cio', 'warning'); return; }

  const ex = {
    id: uid(),
    name,
    group: document.getElementById('ex-group').value,
    equip: document.getElementById('ex-equip').value,
    weight: parseFloat(document.getElementById('ex-weight').value) || 20,
    reps: document.getElementById('ex-reps').value,
    sets: parseInt(document.getElementById('ex-sets').value) || 3,
    rest: parseInt(document.getElementById('ex-rest').value) || 90,
    increment: parseFloat(document.getElementById('ex-increment').value) || 2,
    execution: document.getElementById('ex-execution').value || 'livre',
  };

  state.exercises.push(ex);
  save();
  closeModal('exercise-modal');
  renderExercises();
  renderWorkoutPlans();
  showNotif('ğŸ’ª', 'ExercÃ­cio adicionado!', ex.name, 'success');
  document.getElementById('ex-name').value = '';
}

function openEditExercise(exId) {
  const ex = state.exercises.find(e => e.id === exId);
  if (!ex) return;
  document.getElementById('edit-ex-id').value = ex.id;
  document.getElementById('edit-ex-name').value = ex.name;
  document.getElementById('edit-ex-group').value = ex.group;
  document.getElementById('edit-ex-equip').value = ex.equip;
  document.getElementById('edit-ex-weight').value = ex.weight;
  document.getElementById('edit-ex-reps').value = ex.reps;
  document.getElementById('edit-ex-sets').value = ex.sets;
  document.getElementById('edit-ex-rest').value = ex.rest;
  document.getElementById('edit-ex-increment').value = ex.increment;
  setExecution(ex.execution, 'edit');
  openModal('edit-exercise-modal');
}

function updateExercise() {
  const id = document.getElementById('edit-ex-id').value;
  const ex = state.exercises.find(e => e.id === id);
  if (!ex) return;
  ex.name = document.getElementById('edit-ex-name').value.trim();
  ex.group = document.getElementById('edit-ex-group').value;
  ex.equip = document.getElementById('edit-ex-equip').value;
  ex.weight = parseFloat(document.getElementById('edit-ex-weight').value) || 20;
  ex.reps = document.getElementById('edit-ex-reps').value;
  ex.sets = parseInt(document.getElementById('edit-ex-sets').value) || 3;
  ex.rest = parseInt(document.getElementById('edit-ex-rest').value) || 90;
  ex.increment = parseFloat(document.getElementById('edit-ex-increment').value) || 2;
  ex.execution = document.getElementById('edit-ex-execution').value || 'livre';
  save();
  closeModal('edit-exercise-modal');
  renderExercises();
  renderWorkoutPlans();
  showNotif('âœï¸', 'ExercÃ­cio atualizado', ex.name, 'success');
}

function filterExercises(group) {
  activeFilter = group;
  renderExercises();
}

function renderExercises() {
  const groups = [...new Set(state.exercises.map(e => e.group))];
  const filterEl = document.getElementById('muscle-filters');
  filterEl.innerHTML = `
    <button class="btn ${activeFilter === 'all' ? 'btn-primary' : 'btn-ghost'}" style="font-size:12px;" onclick="filterExercises('all')">Todos (${state.exercises.length})</button>
    ${groups.map(g => `<button class="btn ${activeFilter === g ? 'btn-primary' : 'btn-ghost'}" style="font-size:12px;" onclick="filterExercises('${g}')">${groupEmoji(g)} ${g}</button>`).join('')}
  `;

  const filtered = activeFilter === 'all' ? state.exercises : state.exercises.filter(e => e.group === activeFilter);
  const el = document.getElementById('exercises-list');

  if (filtered.length === 0) {
    el.innerHTML = `<div style="text-align:center; padding:32px; color:var(--muted2);">
      <div style="font-size:32px; margin-bottom:8px;">ğŸ’ª</div>
      Nenhum exercÃ­cio nesta categoria
    </div>`;
    return;
  }

  el.innerHTML = filtered.map(ex => {
    const sessions = state.sessions.filter(s => s.exercises?.some(e => e.exerciseId === ex.id));
    const pr = getPR(ex.id);
    return `<div class="exercise-row" style="cursor:default; margin-bottom:8px;">
      <div class="exercise-icon">${groupEmoji(ex.group)}</div>
      <div style="flex:1;">
        <div class="exercise-name">${ex.name}</div>
        <div class="exercise-meta">${ex.group} Â· ${ex.equip} Â· ${ex.sets}x${ex.reps}</div>
      </div>
      <div style="text-align:right; flex-shrink:0;">
        <div style="font-family:'DM Mono'; font-weight:700; color:var(--orange);">${ex.weight}kg</div>
        ${pr > ex.weight ? `<div style="font-size:11px; color:var(--green);">PR: ${pr}kg ğŸ†</div>` : ''}
        <span class="tag" style="font-size:9px; margin-top:4px; background:${ex.execution==='maquina'?'var(--blue-dim)':'var(--orange-dim)'}; color:${ex.execution==='maquina'?'var(--blue)':'var(--orange)'}; padding:2px 6px; border-radius:4px;">${ex.execution==='maquina'?'âš™ï¸ MÃ¡q':'ğŸ‹ï¸ Livre'}</span>
        <div style="font-size:11px; color:var(--orange); margin-top:2px;">+${ex.increment||2}kg/inc</div>
        <div style="font-size:11px; color:var(--muted);">${sessions.length} sessÃµes</div>
      </div>
      <button class="btn btn-ghost" style="padding:5px;" onclick="openEditExercise('${ex.id}')" title="Editar">âœï¸</button>
    </div>`;
  }).join('');
}

function getPR(exId) {
  let max = 0;
  state.sessions.forEach(s => {
    const exData = s.exercises?.find(e => e.exerciseId === exId);
    if (exData?.sets) {
      exData.sets.forEach(set => { if ((parseFloat(set.weight) || 0) > max) max = parseFloat(set.weight); });
    }
  });
  return max;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PRÃ‰-TREINO â€” ExecuÃ§Ã£o + Tipo de Carga
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pwmState = { exIdx: 0, exec: null, load: null, pendingWorkout: null };

const LOAD_OPTIONS = {
  maquina: [
    { key: 'barra',   label: 'Barra',   emoji: 'ğŸ‹ï¸', inc: 2.5 },
    { key: 'anilha',  label: 'Anilha',  emoji: 'â­•', inc: 5   },
    { key: 'pino',    label: 'Pino',    emoji: 'ğŸ”¢', inc: 5   },
  ],
  livre: [
    { key: 'halter',  label: 'Haltere', emoji: 'ğŸ¥Š', inc: 2   },
    { key: 'dubles',  label: 'Dubles',  emoji: 'ğŸ’ª', inc: 2   },
    { key: 'anilha',  label: 'Anilha',  emoji: 'â­•', inc: 2.5 },
  ],
};

function openPreWorkoutModal(pendingWorkout) {
  pwmState = { exIdx: 0, exec: null, load: null, pendingWorkout };
  showNextPreWorkoutEx();
}

function showNextPreWorkoutEx() {
  const workout = pwmState.pendingWorkout;
  if (pwmState.exIdx >= workout.exercises.length) {
    finishPreWorkout();
    return;
  }
  const ex = workout.exercises[pwmState.exIdx];
  pwmState.exec = null;
  pwmState.load = null;

  document.getElementById('pwm-ex-name').textContent = ex.name.toUpperCase();
  document.getElementById('pwm-ex-sub').textContent =
    `ExercÃ­cio ${pwmState.exIdx + 1} de ${workout.exercises.length}`;
  document.getElementById('pwm-weight-display').textContent = `${ex.weight}kg`;
  document.getElementById('pwm-inc-display').textContent = `+${ex.increment || 2}kg`;
  document.getElementById('pwm-confirm-btn').disabled = true;

  document.querySelectorAll('.pwm-option').forEach(b => b.classList.remove('selected'));
  document.getElementById('pwm-load-options').innerHTML = '';

  openModal('pre-workout-modal');
}

function selectExec(btn) {
  document.querySelectorAll('.pwm-option').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  pwmState.exec = btn.dataset.exec;
  pwmState.load = null;

  const opts = LOAD_OPTIONS[pwmState.exec] || [];
  document.getElementById('pwm-load-options').innerHTML = opts.map(o =>
    `<button class="pwm-load-btn" data-key="${o.key}" data-inc="${o.inc}" onclick="selectLoad(this)">
      <div style="font-size:22px; margin-bottom:5px;">${o.emoji}</div>
      <div style="font-weight:600;">${o.label}</div>
    </button>`
  ).join('');
  document.getElementById('pwm-confirm-btn').disabled = true;
}

function selectLoad(btn) {
  document.querySelectorAll('.pwm-load-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  pwmState.load = btn.dataset.key;

  const inc = parseFloat(btn.dataset.inc);
  const ex = pwmState.pendingWorkout.exercises[pwmState.exIdx];
  ex.execType = pwmState.exec;
  ex.loadType = pwmState.load;
  ex.customIncrement = inc; // store for later use in suggestion
  ex.increment = inc; // override for this session

  document.getElementById('pwm-inc-display').textContent = `+${ex.increment}kg`;
  document.getElementById('pwm-confirm-btn').disabled = false;

  // Auto-advance after a short delay
  setTimeout(() => {
    if (document.getElementById('pre-workout-modal').classList.contains('open')) {
      confirmPreWorkout();
    }
  }, 600);
}

function skipPreWorkout() {
  pwmState.exIdx++;
  if (pwmState.exIdx >= pwmState.pendingWorkout.exercises.length) {
    closeModal('pre-workout-modal');
    finishPreWorkout();
  } else {
    showNextPreWorkoutEx();
  }
}

function confirmPreWorkout() {
  pwmState.exIdx++;
  if (pwmState.exIdx >= pwmState.pendingWorkout.exercises.length) {
    closeModal('pre-workout-modal');
    finishPreWorkout();
  } else {
    showNextPreWorkoutEx();
  }
}

function finishPreWorkout() {
  const workout = pwmState.pendingWorkout;
  state.activeWorkout = workout;
  state.activeWorkout.exercises.forEach(ex => {
    ex._originalWeight = ex.weight; // FIX1: snapshot for progression count
    // FIX3: use selectedLoad increment if available, fall back to exercise increment
    if (ex.selectedLoad && ex.selectedLoad.inc) {
      ex.increment = ex.selectedLoad.inc;
    }
    ex.increment = ex.increment || 2; // FIX4: ensure never undefined
  });
  state.workoutStartTime = Date.now();
  document.getElementById('active-workout-title').textContent =
    state.workoutPlans.find(p => p.id === workout.planId)?.name.toUpperCase() || 'TREINO';
  startWorkoutTimer();
  renderActiveWorkout();
  switchView('workout-active');
}

function confirmProgression(exIdx) {
  if (!state.activeWorkout) return;
  const activeEx = state.activeWorkout.exercises[exIdx];
  if (!activeEx || !activeEx.suggestedWeight) return;

  const confirmed = activeEx.suggestedWeight;
  activeEx.weight = confirmed;
  activeEx.currentWeight = confirmed;
  activeEx._progressionConfirmed = true; // FIX1: for finishWorkout counter
  activeEx.suggestedWeight = null;

  activeEx.sets.forEach(set => {
    if (!set.done) set.weight = confirmed;
  });

  const exDef = state.exercises.find(e => e.id === activeEx.exerciseId);
  if (exDef) {
    exDef.weight = confirmed;
    save();
  }

  renderActiveWorkout();
  showNotif('ğŸ”¥', `ProgressÃ£o confirmada!`, `${activeEx.name}: ${confirmed}kg`, 'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOTOR DE PROGRESSÃƒO REAL â€” PROGRESSAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getMuzyPhase(level) {
  if (level === 'beginner') return 'execucao';
  if (level === 'intermediate') return 'carga';
  return 'volume';
}

function getExerciseHistory(exId, planId) {
  return state.sessions
    .filter(s => s.planId === planId && s.exercises?.some(e => e.exerciseId === exId))
    .map(s => {
      const exData = s.exercises.find(e => e.exerciseId === exId);
      const doneSets = exData?.sets?.filter(set => set.done !== false && parseInt(set.reps) > 0) || [];
      const weights = doneSets.map(set => parseFloat(set.weight) || 0);
      const reps = doneSets.map(set => parseInt(set.reps) || 0);
      return {
        date: s.date,
        weight: weights.length ? Math.max(...weights) : 0,
        avgReps: reps.length ? reps.reduce((a,b) => a+b, 0) / reps.length : 0,
        allSets: doneSets,
        allHitMax: (maxRep) => reps.length > 0 && reps.every(r => r >= maxRep),
      };
    })
    .filter(h => h.weight > 0);
}

function hasPerformanceDrop(history, n = 2) {
  if (history.length < n) return false;
  const recent = history.slice(-n);
  for (let i = 1; i < recent.length; i++) {
    if (recent[i].avgReps < recent[i-1].avgReps - 1) return true;
  }
  return false;
}

function hasSignificantDrop(history) {
  if (history.length < 3) return false;
  const recent = history.slice(-3);
  return recent[2].avgReps < recent[1].avgReps && recent[1].avgReps < recent[0].avgReps;
}

function getWeightSuggestion(ex, planId, customIncrement = null) {
  const repRange = ex.reps.split('-');
  const minRep = parseInt(repRange[0]);
  const maxRep = parseInt(repRange[1]);
  const increment = customIncrement !== null ? customIncrement : (ex.increment || 2);
  const level = state.user?.level || 'intermediate';
  const phase = getMuzyPhase(level);

  const history = getExerciseHistory(ex.id, planId);

  if (history.length === 0) {
    return {
      weight: ex.weight, minRep, maxRep, phase,
      increment,
      tip: { type: 'info', msg: `Primeira sessÃ£o! Foco em executar com tÃ©cnica. Meta: ${minRep}â€“${maxRep} reps com ${ex.weight}kg.` },
      progressionBlocked: false,
      suggestedWeight: null,
    };
  }

  const last = history[history.length - 1];
  const currentWeight = last.weight;
  const lastHitMax = last.allHitMax(maxRep);
  const performanceDrop = hasPerformanceDrop(history, 2);
  const significantDrop = hasSignificantDrop(history);

  if (significantDrop) {
    const deloadWeight = currentWeight - increment;
    return {
      weight: currentWeight, minRep, maxRep, phase, increment,
      progressionBlocked: true,
      suggestedWeight: deloadWeight > 0 ? deloadWeight : currentWeight,
      tip: {
        type: 'deload',
        msg: `Queda de performance em 3 sessÃµes seguidas. Deload recomendado: reduza para ${deloadWeight > 0 ? deloadWeight : currentWeight}kg por 1 semana.`
      }
    };
  }

  if (performanceDrop) {
    return {
      weight: currentWeight, minRep, maxRep, phase, increment,
      progressionBlocked: true,
      suggestedWeight: null,
      tip: {
        type: 'warning',
        msg: `Performance caindo. Mantenha ${currentWeight}kg e foque em atingir ${maxRep} reps em todas as sÃ©ries antes de subir.`
      }
    };
  }

  let suggestedWeight = null;
  let tip = null;

  if (phase === 'execucao') {
    const last2 = history.slice(-2);
    const bothHitMax = last2.length >= 2 && last2.every(h => h.allHitMax(maxRep));

    if (bothHitMax) {
      suggestedWeight = currentWeight + increment;
      tip = {
        type: 'up',
        msg: `VocÃª atingiu o topo da faixa. PrÃ³xima carga sugerida: ${suggestedWeight}kg (+${increment}kg)`
      };
    } else if (lastHitMax) {
      tip = {
        type: 'info',
        msg: `Ã“timo! Repita ${currentWeight}kg com tÃ©cnica perfeita mais uma vez antes de subir.`
      };
    } else {
      tip = {
        type: 'info',
        msg: `Foco na execuÃ§Ã£o. Atinja ${maxRep} reps em todas as sÃ©ries antes de aumentar a carga.`
      };
    }

  } else if (phase === 'carga') {
    if (lastHitMax) {
      suggestedWeight = currentWeight + increment;
      tip = {
        type: 'up',
        msg: `VocÃª atingiu o topo da faixa. PrÃ³xima carga sugerida: ${suggestedWeight}kg (+${increment}kg). Volte para ${minRep} reps.`
      };
    } else {
      tip = {
        type: 'info',
        msg: `Tente atingir ${maxRep} reps em todas as sÃ©ries para subir a carga.`
      };
    }

  } else {
    const last3 = history.slice(-3);
    const consolidated = last3.length >= 3 && last3.every(h => h.allHitMax(maxRep));

    if (consolidated) {
      suggestedWeight = currentWeight + increment;
      tip = {
        type: 'up',
        msg: `Volume dominado em 3 sessÃµes! PrÃ³xima carga sugerida: ${suggestedWeight}kg (+${increment}kg).`
      };
    } else if (lastHitMax) {
      tip = {
        type: 'volume',
        msg: `Tente adicionar +1 sÃ©rie antes de subir o peso. Volume primeiro!`
      };
    } else {
      tip = {
        type: 'info',
        msg: `Construa consistÃªncia. Complete todas as sÃ©ries com qualidade.`
      };
    }
  }

  // Cardio impact check â€” override tip if high recent cardio load
  const cardioImpact = calcularImpactoCardioRecente(2);
  if (cardioImpact > 5 && suggestedWeight && suggestedWeight > currentWeight) {
    // High cardio load: suppress weight increase this session
    suggestedWeight = null;
    tip = {
      type: 'warning',
      msg: `ğŸƒ Cardio intenso recente (impacto: ${cardioImpact.toFixed(1)}). Mantenha ${currentWeight}kg hoje e foque em qualidade de execuÃ§Ã£o.`
    };
  } else if (cardioImpact > 3 && tip?.type === 'up') {
    // Moderate cardio: warn but allow progression
    tip = { ...tip, msg: tip.msg + ` âš ï¸ AtenÃ§Ã£o: cardio recente pode afetar desempenho.` };
  }

  return {
    weight: currentWeight,
    minRep, maxRep, phase, increment,
    progressionBlocked: false,
    suggestedWeight,
    tip,
  };
}

function startWorkoutWithPlan(plan) {
  if (!plan || plan.exercises.length === 0) {
    showNotif('âš ï¸', 'Treino vazio', 'Adicione exercÃ­cios a este treino', 'warning');
    return;
  }

  // Check recovery / frequency
  const freqCheck = checkWorkoutFrequency();
  if (freqCheck.bloqueado) {
    if (!confirm(freqCheck.mensagem + '\n\nDeseja treinar mesmo assim?')) return;
  } else {
    const recovery = getRecoveryStatus();
    if (recovery.recuperacao === 'critica') {
      if (!confirm(recovery.mensagem + '\n\nDeseja treinar mesmo assim?')) return;
    } else if (recovery.recuperacao === 'atencao') {
      showNotif('âš ï¸', 'AtenÃ§Ã£o', recovery.mensagem, 'warning');
    }
  }

  const exercises = plan.exercises.map(id => state.exercises.find(e => e.id === id)).filter(Boolean);

  state.activeWorkout = {
    planId: plan.id,
    exercises: exercises.map(ex => {
      const suggestion = getWeightSuggestion(ex, plan.id);
      return {
        exerciseId: ex.id,
        name: ex.name,
        currentWeight: suggestion.weight,
        suggestedWeight: suggestion.suggestedWeight,
        suggestedReps: suggestion.minRep,
        targetMaxRep: suggestion.maxRep,
        phase: suggestion.phase,
        increment: suggestion.increment,
        tip: suggestion.tip,
        progressionBlocked: suggestion.progressionBlocked,
        weight: suggestion.weight,
        sets: Array.from({ length: ex.sets }, (_, i) => ({ set: i + 1, weight: suggestion.weight || ex.weight, reps: '', done: false }))
      };
    })
  };

  openPreWorkoutModal(state.activeWorkout);
}

function renderActiveWorkout() {
  const el = document.getElementById('active-exercises');
  if (!state.activeWorkout) return;

  el.innerHTML = state.activeWorkout.exercises.map((ex, exIdx) => {
    const exercise = state.exercises.find(e => e.id === ex.exerciseId);
    const isUpgrade = ex.suggestedWeight > (exercise?.weight || 0);
    const restSecs = exercise?.rest || 90;
    return `<div class="card" id="ex-card-${exIdx}" style="margin-bottom:16px;">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px;">
        <div style="flex:1;">
          <div style="font-weight:700; font-size:18px;">${ex.name}</div>
          <div style="display:flex; align-items:center; gap:8px; margin-top:6px; flex-wrap:wrap;">
            <span style="font-size:13px; color:var(--muted2);">${ex.currentWeight}kg Â· meta ${ex.targetMaxRep} reps</span>
            <span class="tag tag-orange" style="cursor:pointer; user-select:none;" onclick="quickChangeRest(${exIdx})" title="Clique para alterar descanso">
              â± ${formatRest(restSecs)}
            </span>
            <span class="tag" style="background:var(--border); color:var(--muted2); font-size:9px;">+${ex.increment || 2}kg/incremento</span>
          </div>
        </div>
        <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
          ${ex.tip?.type==='up' ? '<span class="tag tag-green">â†‘ Subir!</span>' : ex.tip?.type==='volume' ? '<span class="tag tag-blue">+ Volume</span>' : '<span class="tag tag-blue">Manter</span>'}
          ${ex.phase ? '<span class="tag" style="background:var(--border);color:var(--muted2);font-size:9px;">' + (ex.phase==='execucao'?'ğŸ“ EXECUÃ‡ÃƒO':ex.phase==='carga'?'âš–ï¸ CARGA':'ğŸ“¦ VOLUME') + '</span>' : ''}
        </div>
      </div>

      ${ex.tip ? (() => {
        const tc = ex.tip.type==='up'      ? {bg:'var(--green-dim)',  bd:'var(--green)',      tx:'var(--green)',  ic:'ğŸ”¥'} :
                   ex.tip.type==='volume'  ? {bg:'var(--blue-dim)',   bd:'var(--blue)',       tx:'var(--blue)',   ic:'ğŸ“¦'} :
                   ex.tip.type==='deload'  ? {bg:'var(--red-dim)',    bd:'var(--red)',        tx:'var(--red)',    ic:'ğŸ˜´'} :
                   ex.tip.type==='warning' ? {bg:'rgba(255,215,64,0.1)',bd:'var(--yellow)',   tx:'var(--yellow)', ic:'âš ï¸'} :
                                            {bg:'var(--orange-dim)', bd:'var(--orange-mid)', tx:'var(--orange)', ic:'ğŸ’¡'};
        const confirmBtn = ex.suggestedWeight && !ex.progressionBlocked
          ? '<button onclick="confirmProgression('+exIdx+')" style="margin-top:10px; background:var(--green); border:none; color:#000; font-weight:700; font-size:12px; padding:7px 14px; border-radius:8px; cursor:pointer; font-family:DM Sans,sans-serif;">âœ“ Confirmar progressÃ£o para '+ex.suggestedWeight+'kg</button>'
          : '';
        return '<div style="background:'+tc.bg+'; border:1px solid '+tc.bd+'; border-radius:10px; padding:12px 16px; margin-bottom:14px; color:'+tc.tx+'"><div style="display:flex; gap:8px; align-items:flex-start; font-size:13px;"><span>'+tc.ic+'</span><span>'+ex.tip.msg+'</span></div>'+confirmBtn+'</div>';
      })() : ''}

      <div style="display:grid; grid-template-columns:36px 1fr 1fr 44px; gap:6px; margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid var(--border);">
        <div style="font-size:10px; color:var(--muted); text-align:center;">SÃ‰R.</div>
        <div style="font-size:10px; color:var(--muted); text-align:center;">PESO (kg)</div>
        <div style="font-size:10px; color:var(--muted); text-align:center;">REPS</div>
        <div></div>
      </div>

      ${ex.sets.map((set, setIdx) => `
        <div class="set-row" id="set-${exIdx}-${setIdx}" style="grid-template-columns:36px 1fr 1fr 44px; gap:6px;">
          <div class="set-number ${set.done ? 'done' : ''}" id="set-num-${exIdx}-${setIdx}">${set.set}</div>
          <div class="num-input-wrap" style="position:relative;">
            <button class="num-btn" onclick="adjustWeight(${exIdx},${setIdx},-0.5)" aria-label="Diminuir peso">âˆ’</button>
            <div style="display:flex; flex-direction:column; align-items:center; flex:1; min-width:0;">
              ${setIdx > 0 && state.activeWorkout.exercises[exIdx].sets[setIdx-1].reps ? `<div style="font-size:9px; color:var(--muted2); line-height:1;">ant: ${state.activeWorkout.exercises[exIdx].sets[setIdx-1].weight}kg</div>` : ''}
              <input type="number" value="${set.weight || ex.weight}" step="0.5" min="0" id="w-${exIdx}-${setIdx}"
                oninput="updateSet(${exIdx},${setIdx},'weight',this.value)"
                style="border:none; background:transparent; text-align:center; width:100%; font-family:'DM Mono',monospace; font-size:15px; font-weight:700; color:var(--orange); padding:0;">
            </div>
            <button class="num-btn" onclick="adjustWeight(${exIdx},${setIdx},0.5)" aria-label="Aumentar peso">+</button>
          </div>
          <div class="num-input-wrap" style="position:relative;">
            <button class="num-btn" onclick="adjustReps(${exIdx},${setIdx},-1)" aria-label="Diminuir repetiÃ§Ãµes">âˆ’</button>
            <div style="display:flex; flex-direction:column; align-items:center; flex:1; min-width:0;">
              ${setIdx > 0 && state.activeWorkout.exercises[exIdx].sets[setIdx-1].reps ? `<div style="font-size:9px; color:var(--muted2); line-height:1;">ant: ${state.activeWorkout.exercises[exIdx].sets[setIdx-1].reps} reps</div>` : `<div style="font-size:9px; color:var(--muted2); line-height:1;">meta: ${ex.targetMaxRep}</div>`}
              <input type="number" value="${set.reps || ''}" min="0" max="50" id="r-${exIdx}-${setIdx}"
                oninput="updateSet(${exIdx},${setIdx},'reps',this.value)"
                placeholder="0"
                style="border:none; background:transparent; text-align:center; width:100%; font-family:'DM Mono',monospace; font-size:15px; font-weight:700; color:var(--text); padding:0;">
            </div>
            <button class="num-btn" onclick="adjustReps(${exIdx},${setIdx},1)" aria-label="Aumentar repetiÃ§Ãµes">+</button>
          </div>
          <button class="btn ${set.done ? 'btn-success' : 'btn-ghost'}" style="padding:6px 10px; font-size:14px; width:40px;"
            onclick="toggleSetDone(${exIdx},${setIdx})" aria-label="${set.done ? 'Desmarcar sÃ©rie' : 'Marcar sÃ©rie como concluÃ­da'}">
            ${set.done ? 'âœ“' : 'â—‹'}
          </button>
        </div>
      `).join('')}
    <div style="display:flex; gap:8px; margin-top:14px; padding-top:12px; border-top:1px solid var(--border);">
      <button class="btn btn-ghost" style="flex:1; font-size:12px;" onclick="openCoach(${exIdx})">
        ğŸ¤– Coach
      </button>
      <button class="btn" style="flex:2; font-size:13px; background:var(--orange-dim); border:1px solid var(--orange); color:var(--orange);" onclick="nextExerciseFromCard(${exIdx})">
        PrÃ³ximo exercÃ­cio â†’
      </button>
    </div>
    </div>`;
  }).join('');
}

function nextExerciseFromCard(exIdx) {
  const card = document.getElementById('ex-card-' + exIdx);
  if (card) {
    card.style.opacity = '0.5';
    card.style.pointerEvents = 'none';
    setTimeout(() => {
      card.style.opacity = '';
      card.style.pointerEvents = '';
    }, 300);
  }
  const next = document.getElementById('ex-card-' + (exIdx + 1));
  if (next) next.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function adjustWeight(exIdx, setIdx, delta) {
  const input = document.getElementById(`w-${exIdx}-${setIdx}`);
  const newVal = Math.max(0, parseFloat(input.value || 0) + delta);
  input.value = newVal;
  updateSet(exIdx, setIdx, 'weight', newVal);
}

function adjustReps(exIdx, setIdx, delta) {
  const input = document.getElementById(`r-${exIdx}-${setIdx}`);
  const newVal = Math.max(0, parseInt(input.value || 0) + delta);
  input.value = newVal;
  updateSet(exIdx, setIdx, 'reps', newVal);
}

function updateSet(exIdx, setIdx, field, value) {
  if (state.activeWorkout) {
    state.activeWorkout.exercises[exIdx].sets[setIdx][field] = value;
  }
}

function toggleSetDone(exIdx, setIdx) {
  if (!state.activeWorkout) return;
  const activeEx = state.activeWorkout.exercises[exIdx];
  const set = activeEx.sets[setIdx];

  const wInput = document.getElementById('w-' + exIdx + '-' + setIdx);
  const rInput = document.getElementById('r-' + exIdx + '-' + setIdx);
  if (wInput) set.weight = parseFloat(wInput.value) || set.weight;
  if (rInput) set.reps  = parseInt(rInput.value) || 0;

  if (!set.done) {
    if (!set.reps || set.reps <= 0) {
      if (rInput) {
        rInput.focus();
        rInput.style.outline = '2px solid var(--orange)';
        rInput.style.borderRadius = '6px';
        rInput.style.boxShadow = '0 0 0 3px rgba(255,92,0,0.25)';
        // FIX11: clear on first keystroke OR after 4s
        const _clearRepsHint = () => {
          rInput.style.outline = '';
          rInput.style.boxShadow = '';
          rInput.removeEventListener('input', _clearRepsHint);
        };
        rInput.addEventListener('input', _clearRepsHint);
        setTimeout(_clearRepsHint, 4000);
      }
      showNotif('âœï¸', 'Quantas reps vocÃª fez?', 'Preencha as repetiÃ§Ãµes antes de confirmar', 'warning');
      return;
    }
  }

  set.done = !set.done;
  renderActiveWorkout();

  if (set.done) {
    const exDef = state.exercises.find(e => e.id === activeEx.exerciseId);
    const restSecs = exDef?.rest || 90;
    const totalSets = activeEx.sets.length;
    const serieInfo = setIdx + 1 < totalSets
      ? `SÃ©rie ${setIdx + 1} concluÃ­da â€” prÃ³xima: sÃ©rie ${setIdx + 2} de ${totalSets}`
      : `Ãšltima sÃ©rie concluÃ­da! ğŸ’ª`;
    startRestTimer(restSecs, activeEx.name.toUpperCase(), serieInfo);
  } else {
    skipTimer();
  }
}

function startWorkoutTimer() {
  if (state.workoutTimerInterval) clearInterval(state.workoutTimerInterval);
  state.workoutTimerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - state.workoutStartTime) / 1000);
    const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
    const s = String(elapsed % 60).padStart(2, '0');
    const el = document.getElementById('active-workout-timer');
    if (el) el.textContent = `${m}:${s} â€” Em andamento`;
  }, 1000);
}

function cancelWorkout() {
  clearInterval(state.workoutTimerInterval);
  state.activeWorkout = null;
  switchView('dashboard');
}

function finishWorkout() {
  if (!state.activeWorkout) return;

  let progressions = 0;
  state.activeWorkout.exercises.forEach(ex => {
    const doneSets = ex.sets?.filter(s => s.done) || [];
    const maxWeightUsed = doneSets.length ? Math.max(...doneSets.map(s => parseFloat(s.weight)||0)) : 0;
    if (maxWeightUsed > 0) checkAndShowPR(ex.exerciseId, maxWeightUsed);
    // FIX1: compare max weight actually used vs original weight at session start
    const originalW = ex._originalWeight || 0;
    if (maxWeightUsed > 0 && maxWeightUsed > originalW) {
      progressions++;
    } else if (ex._progressionConfirmed) {
      // Also count if user hit the confirm progression button
      progressions++;
    }
  });

  state.activeWorkout.exercises.forEach(ex => {
    const weights = ex.sets.filter(s => s.done && s.weight).map(s => parseFloat(s.weight));
    ex.weight = weights.length ? weights[weights.length - 1] : ex.suggestedWeight;
  });

  const session = {
    id: uid(),
    planId: state.activeWorkout.planId,
    date: Date.now(),
    duration: Math.floor((Date.now() - state.workoutStartTime) / 1000),
    exercises: state.activeWorkout.exercises,
    progressions
  };

  state.sessions.push(session);
  clearInterval(state.workoutTimerInterval);
  state.activeWorkout = null;
  state.workoutStartTime = null;

  save();

  if (progressions > 0) {
    showNotif('ğŸ”¥', `${progressions} progressÃ£o(Ãµes)!`, 'VocÃª aumentou a carga! Continue assim!', 'success');
  } else {
    showNotif('âœ…', 'Treino finalizado!', 'Registrado com sucesso. Descanse bem!', 'success');
  }

  // Update consecutive days counter
  updateRecoveryAfterWorkout();

  // Update modo iniciante weeks remaining
  if (state.modoIniciante?.ativo && state.modoIniciante.dataFim) {
    const msLeft = state.modoIniciante.dataFim - Date.now();
    state.modoIniciante.semanasRestantes = Math.max(0, Math.ceil(msLeft / (7 * 86400000)));
    if (msLeft <= 0) {
      state.modoIniciante.ativo = false;
      if (state.user) state.user.level = 'intermediate';
      showNotif('ğŸ‰', 'Modo iniciante concluÃ­do!', 'VocÃª evoluiu para IntermediÃ¡rio. Continue progredindo!', 'success');
    }
    save();
  }

  updateDashboard();
  renderExercises();
  renderHistorySelect();
  renderAllSessions();
  switchView('dashboard');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REST TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let restTotalSeconds = 90;

function startRestTimer(seconds, exName = '', serieInfo = '') {
  restTotalSeconds = seconds;
  state.restSecondsLeft = seconds;
  updateTimerDisplay();
  updateRestRing();

  document.getElementById('rest-ex-name').textContent = exName || 'DESCANSO';
  document.getElementById('rest-serie-info').textContent = serieInfo || 'PrÃ³xima sÃ©rie em breve';

  document.querySelectorAll('.rest-preset-btn').forEach(b => b.classList.remove('active'));
  const presetMap = { 45: 0, 60: 1, 90: 2, 120: 3, 180: 4 };
  const idx = presetMap[seconds];
  const presets = document.querySelectorAll('.rest-preset-btn');
  if (idx !== undefined && presets[idx]) presets[idx].classList.add('active');

  document.getElementById('rest-modal').classList.add('open');
  if (state.restTimerInterval) clearInterval(state.restTimerInterval);
  state.restTimerInterval = setInterval(() => {
    state.restSecondsLeft--;
    updateTimerDisplay();
    updateRestRing();
    if (state.restSecondsLeft <= 0) {
      skipTimer();
      if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
      showNotif('ğŸ””', 'Descanse encerrado!', 'Hora da prÃ³xima sÃ©rie!', 'success');
    }
  }, 1000);
}

function setRestTimer(seconds) {
  restTotalSeconds = seconds;
  state.restSecondsLeft = seconds;
  clearInterval(state.restTimerInterval);
  updateTimerDisplay();
  updateRestRing();

  document.querySelectorAll('.rest-preset-btn').forEach(b => b.classList.remove('active'));
  const presetMap = { 45: 0, 60: 1, 90: 2, 120: 3, 180: 4 };
  const idx = presetMap[seconds];
  const presets = document.querySelectorAll('.rest-preset-btn');
  if (idx !== undefined && presets[idx]) presets[idx].classList.add('active');

  state.restTimerInterval = setInterval(() => {
    state.restSecondsLeft--;
    updateTimerDisplay();
    updateRestRing();
    if (state.restSecondsLeft <= 0) {
      skipTimer();
      if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
      showNotif('ğŸ””', 'Descanse encerrado!', 'Hora da prÃ³xima sÃ©rie!', 'success');
    }
  }, 1000);
}

function updateTimerDisplay() {
  const secs = Math.max(0, state.restSecondsLeft);
  const m = String(Math.floor(secs / 60)).padStart(2, '0');
  const s = String(secs % 60).padStart(2, '0');
  const el = document.getElementById('timer-display');
  if (el) el.textContent = `${m}:${s}`;
  if (el) el.style.color = secs <= 10 ? 'var(--red)' : 'var(--orange)';
}

function updateRestRing() {
  const ring = document.getElementById('rest-ring');
  if (!ring) return;
  const circ = 427;
  const progress = Math.max(0, state.restSecondsLeft) / restTotalSeconds;
  ring.style.strokeDashoffset = circ * (1 - progress);
  ring.style.stroke = state.restSecondsLeft <= 10 ? 'var(--red)' : 'var(--orange)';
}

function skipTimer() {
  clearInterval(state.restTimerInterval);
  document.getElementById('rest-modal').classList.remove('open');
}

function addTime(secs) {
  state.restSecondsLeft = Math.max(0, state.restSecondsLeft + secs);
  restTotalSeconds = Math.max(restTotalSeconds, state.restSecondsLeft);
  updateTimerDisplay();
  updateRestRing();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistorySelect() {
  const sel = document.getElementById('history-exercise-select');
  sel.innerHTML = '<option value="">Selecione um exercÃ­cio...</option>' +
    state.exercises.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
}

let chartInstance = null;

function renderHistoryChart() {
  const exId = document.getElementById('history-exercise-select').value;
  const placeholder = document.getElementById('chart-placeholder');
  const canvas = document.getElementById('progress-chart');
  const stats = document.getElementById('chart-stats');

  if (!exId) {
    placeholder.style.display = 'block';
    canvas.style.display = 'none';
    stats.style.display = 'none';
    return;
  }

  const ex = state.exercises.find(e => e.id === exId);
  const sessions = state.sessions.filter(s => s.exercises?.some(e => e.exerciseId === exId));

  if (sessions.length === 0) {
    placeholder.innerHTML = '<div style="text-align:center; padding:32px; color:var(--muted2);">Nenhum dado ainda para este exercÃ­cio.<br>Realize um treino primeiro!</div>';
    placeholder.style.display = 'block';
    canvas.style.display = 'none';
    stats.style.display = 'none';
    return;
  }

  const labels = sessions.map(s => new Date(s.date).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
  const weights = sessions.map(s => {
    const exData = s.exercises?.find(e => e.exerciseId === exId);
    if (!exData?.sets?.length) return exData?.weight || 0;
    const doneSets = exData.sets.filter(set => set.done !== false);
    const w = doneSets.map(set => parseFloat(set.weight) || 0);
    return w.length ? Math.max(...w) : exData?.weight || 0;
  });
  const reps = sessions.map(s => {
    const exData = s.exercises?.find(e => e.exerciseId === exId);
    if (!exData?.sets?.length) return 0;
    const done = exData.sets.filter(set => set.done !== false && parseInt(set.reps) > 0);
    return done.length ? Math.round(done.reduce((a, s) => a + parseInt(s.reps || 0), 0) / done.length) : 0;
  });

  placeholder.style.display = 'none';
  canvas.style.display = 'block';
  stats.style.display = 'grid';

  if (chartInstance) chartInstance.destroy();

  const ctx = canvas.getContext('2d');
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Peso MÃ¡ximo (kg)',
        data: weights,
        borderColor: '#FF5C00',
        backgroundColor: 'rgba(255,92,0,0.1)',
        borderWidth: 2,
        pointBackgroundColor: '#FF5C00',
        pointRadius: 5,
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, tooltip: {
        backgroundColor: '#111',
        borderColor: '#333',
        borderWidth: 1,
        titleColor: '#fff',
        bodyColor: '#888',
        callbacks: { label: ctx => `${ctx.parsed.y}kg` }
      }},
      scales: {
        x: { grid: { color: '#1A1A1A' }, ticks: { color: '#666' } },
        y: { grid: { color: '#1A1A1A' }, ticks: { color: '#666' } }
      }
    }
  });

  const maxWeight = Math.max(...weights);
  const minWeight = Math.min(...weights.filter(w => w > 0));
  const totalIncrease = maxWeight - minWeight;
  const avgReps = reps.length ? Math.round(reps.reduce((a, b) => a + b, 0) / reps.length) : 0;

  stats.innerHTML = `
    <div class="card card-sm" style="text-align:center;">
      <div style="font-family:'Bebas Neue'; font-size:28px; color:var(--orange);">${maxWeight}kg</div>
      <div style="font-size:11px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px;">MÃ¡ximo</div>
    </div>
    <div class="card card-sm" style="text-align:center;">
      <div style="font-family:'Bebas Neue'; font-size:28px; color:var(--green);">+${totalIncrease.toFixed(1)}kg</div>
      <div style="font-size:11px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px;">EvoluÃ§Ã£o total</div>
    </div>
    <div class="card card-sm" style="text-align:center;">
      <div style="font-family:'Bebas Neue'; font-size:28px; color:var(--blue);">${sessions.length}</div>
      <div style="font-size:11px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px;">SessÃµes</div>
    </div>
  `;
}

function renderAllSessions() {
  const el = document.getElementById('all-sessions-list');
  if (state.sessions.length === 0) {
    el.innerHTML = `<div style="text-align:center; padding:32px; color:var(--muted2);">
      <div style="font-size:32px; margin-bottom:8px;">ğŸ“…</div>
      Nenhuma sessÃ£o ainda. Comece a treinar!
    </div>`;
    return;
  }

  const sorted = [...state.sessions].reverse();
  el.innerHTML = sorted.map(s => {
    const date = new Date(s.date).toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' });

    // REST DAY
    if (s.isRestDay) {
      return `<div class="card card-sm" style="margin-bottom:8px; border-color:var(--blue);">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div style="font-weight:600; font-size:15px;">ğŸ˜´ Dia de Descanso</div>
            <div style="font-size:12px; color:var(--muted2); margin-top:2px; text-transform:capitalize;">${date}</div>
          </div>
          <span class="tag" style="background:var(--blue-dim); color:var(--blue);">RecuperaÃ§Ã£o</span>
        </div>
      </div>`;
    }

    // CARDIO SESSION
    if (s.isCardio && s.exercises?.[0]?.cardio) {
      const c = s.exercises[0];
      const dur = s.duration ? Math.floor(s.duration / 60) : c.tempo;
      return `<div class="card card-sm" style="margin-bottom:8px; border-color:var(--green);">
        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
          <div>
            <div style="font-weight:600; font-size:15px;">${getCardioIcon(c.name)} ${c.name}</div>
            <div style="font-size:12px; color:var(--muted2); margin-top:2px; text-transform:capitalize;">${date}</div>
            <div style="display:flex; gap:6px; margin-top:8px; flex-wrap:wrap;">
              <span class="tag tag-orange">â± ${dur}min</span>
              <span class="tag" style="background:var(--green-dim); color:var(--green);">${getIntensidadeIcon(c.intensidade)} ${c.intensidade}</span>
              ${c.distancia ? `<span class="tag tag-blue">ğŸ“ ${c.distancia}km</span>` : ''}
            </div>
          </div>
          <span class="tag" style="background:var(--green-dim); color:var(--green);">Cardio</span>
        </div>
      </div>`;
    }

    // REGULAR WORKOUT
    const plan = state.workoutPlans.find(p => p.id === s.planId);
    const dur = s.duration ? `${Math.floor(s.duration / 60)}min` : 'â€”';
    const vol = calcVolume(s);
    return `<div class="card card-sm" style="margin-bottom:8px;">
      <div style="display:flex; justify-content:space-between; align-items:flex-start;">
        <div>
          <div style="font-weight:600; font-size:15px;">${plan?.name || 'Treino'}</div>
          <div style="font-size:12px; color:var(--muted2); margin-top:2px; text-transform:capitalize;">${date}</div>
          <div style="display:flex; gap:6px; margin-top:8px; flex-wrap:wrap;">
            <span class="tag tag-orange">${dur}</span>
            ${vol > 0 ? `<span class="tag tag-blue">${vol.toLocaleString('pt-BR')}kg vol.</span>` : ''}
            ${(s.progressions || 0) > 0 ? `<span class="tag tag-green">â†‘ ${s.progressions} prog.</span>` : ''}
          </div>
        </div>
        <span class="tag tag-green" style="font-size:16px;">âœ“</span>
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROFILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateProfile() {
  if (!state.user) return;
  document.getElementById('profile-name').textContent = state.user.name;
  const levelMap = { beginner: 'Iniciante ğŸŒ±', intermediate: 'IntermediÃ¡rio ğŸ’ª', advanced: 'AvanÃ§ado ğŸ”¥' };
  const goalMap = { hypertrophy: 'Hipertrofia muscular', strength: 'ForÃ§a mÃ¡xima', endurance: 'ResistÃªncia muscular' };
  document.getElementById('profile-level').textContent = levelMap[state.user.level] || 'â€”';
  document.getElementById('profile-goal').textContent = goalMap[state.user.goal] || 'â€”';
  // Render cardio stats
  const statsEl = document.getElementById('cardio-stats-content');
  if (statsEl) statsEl.innerHTML = renderCardioStats();
  // Modo iniciante badge
  if (state.modoIniciante?.ativo) {
    const weeks = state.modoIniciante.semanasRestantes || 0;
    const badge = document.createElement('div');
    badge.style.cssText = 'background:var(--green-dim); border:1px solid var(--green); border-radius:10px; padding:10px 14px; margin-top:12px; font-size:13px; color:var(--green);';
    badge.innerHTML = `ğŸŒ± <strong>Modo Iniciante ativo</strong> â€” ${weeks} semana${weeks !== 1 ? 's' : ''} restante${weeks !== 1 ? 's' : ''} para concluir a fase de adaptaÃ§Ã£o.`;
    const existing = document.getElementById('iniciante-badge-profile');
    if (!existing) {
      badge.id = 'iniciante-badge-profile';
      document.getElementById('cardio-stats-card')?.before(badge);
    }
  }
}

function resetApp() {
  if (!confirm('Tem certeza? Todos os dados serÃ£o apagados.')) return;
  localStorage.removeItem('progressar_state');
  location.reload();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODALS & NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});

let notifTimeout;
function showNotif(icon, title, msg, type) {
  const el = document.getElementById('notification');
  document.getElementById('notif-icon').textContent = icon;
  document.getElementById('notif-title').textContent = title;
  document.getElementById('notif-msg').textContent = msg;
  el.className = `notification ${type} show`;
  clearTimeout(notifTimeout);
  notifTimeout = setTimeout(() => el.classList.remove('show'), 3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHART.JS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadChartJs(cb) {
  if (window.Chart) { cb(); return; }
  const s = document.createElement('script');
  s.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js';
  s.onload = cb;
  s.onerror = () => {
    // FIX10: friendly fallback
    const placeholder = document.getElementById('chart-placeholder');
    if (placeholder) placeholder.innerHTML = `
      <div style="text-align:center; padding:32px; color:var(--muted2);">
        <div style="font-size:36px; margin-bottom:10px;">ğŸ“Š</div>
        <div style="font-weight:700; color:var(--text); margin-bottom:6px;">GrÃ¡fico indisponÃ­vel</div>
        <div style="font-size:13px;">Verifique sua conexÃ£o com a internet e</div>
        <button class="btn btn-ghost" style="margin-top:12px;" onclick="location.reload()">â†º Recarregar pÃ¡gina</button>
      </div>`;
  };
  document.head.appendChild(s);
}

const _origRenderChart = renderHistoryChart;
window.renderHistoryChart = function() { loadChartJs(_origRenderChart); };

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODO FOCO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let focoState = { planId: null, exIdx: 0, setIdx: 0, exercises: [], startTime: null, timerInterval: null, currentWeight: 0, currentReps: 0 };

function startFocoMode() {
  const el = document.getElementById('foco-plan-select');
  el.innerHTML = state.workoutPlans.map(p => `
    <button class="btn btn-ghost btn-full" style="justify-content:space-between;" onclick="initFoco('${p.id}')">
      <span>${p.name}</span>
      <span class="tag tag-orange">${p.day}</span>
    </button>`).join('') || '<p style="color:var(--muted2); font-size:13px;">Crie um treino primeiro</p>';
}

function initFoco(planId) {
  const plan = state.workoutPlans.find(p => p.id === planId);
  if (!plan || !plan.exercises.length) { showNotif('âš ï¸','Treino vazio','Adicione exercÃ­cios ao treino','warning'); return; }

  const exercises = plan.exercises.map(id => state.exercises.find(e => e.id === id)).filter(Boolean);
  focoState = { planId, exIdx: 0, setIdx: 0, startTime: Date.now(), timerInterval: null, currentWeight: 0, currentReps: 0,
    exercises: exercises.map(ex => ({ ...ex, sets: Array.from({length: ex.sets}, (_,i) => ({set:i+1, weight: ex.weight, reps: 0, done: false})) }))
  };

  document.getElementById('foco-idle').style.display = 'none';
  document.getElementById('foco-active').style.display = 'block';
  document.getElementById('foco-workout-name').textContent = plan.name.toUpperCase();

  focoState.timerInterval = setInterval(() => {
    const e = Math.floor((Date.now() - focoState.startTime) / 1000);
    const m = String(Math.floor(e/60)).padStart(2,'0'), s = String(e%60).padStart(2,'0');
    const el = document.getElementById('foco-timer-label');
    if (el) el.textContent = `${m}:${s} em andamento`;
  }, 1000);

  focoRender();
}

function focoRender() {
  const ex = focoState.exercises[focoState.exIdx];
  if (!ex) { focoShowFinish(); return; }

  document.getElementById('foco-ex-emoji').textContent = groupEmoji(ex.group);
  document.getElementById('foco-ex-name').textContent = ex.name.toUpperCase();
  document.getElementById('foco-ex-meta').textContent = `${ex.sets.length} sÃ©ries Â· ${ex.reps} reps Â· â± ${formatRest(ex.rest||90)}`;

  focoState.currentWeight = ex.sets[focoState.setIdx]?.weight || ex.weight;
  focoState.currentReps = ex.sets[focoState.setIdx]?.reps || 0;
  document.getElementById('foco-weight').textContent = focoState.currentWeight;
  document.getElementById('foco-reps').textContent = focoState.currentReps;

  document.getElementById('foco-set-label').textContent = `SÃ‰RIE ${focoState.setIdx+1} DE ${ex.sets.length}`;

  const exDots = document.getElementById('foco-ex-dots');
  exDots.innerHTML = focoState.exercises.map((e,i) =>
    `<div style="width:${i===focoState.exIdx?'20px':'8px'}; height:8px; border-radius:99px; background:${i===focoState.exIdx?'var(--orange)':i<focoState.exIdx?'var(--green)':'var(--border2)'}; transition:all 0.3s;"></div>`
  ).join('');

  const setDots = document.getElementById('foco-set-dots');
  setDots.innerHTML = ex.sets.map((s,i) =>
    `<div style="width:${i===focoState.setIdx?'32px':'12px'}; height:12px; border-radius:99px; background:${i===focoState.setIdx?'var(--orange)':s.done?'var(--green)':'var(--border2)'}; transition:all 0.3s; cursor:pointer;" onclick="focoGoToSet(${i})"></div>`
  ).join('');
}

function focoAdjust(field, delta) {
  if (field === 'weight') {
    focoState.currentWeight = Math.max(0, parseFloat(focoState.currentWeight) + delta);
    document.getElementById('foco-weight').textContent = focoState.currentWeight;
  } else {
    focoState.currentReps = Math.max(0, parseInt(focoState.currentReps) + delta);
    document.getElementById('foco-reps').textContent = focoState.currentReps;
  }
}

function focoGoToSet(idx) { focoState.setIdx = idx; focoRender(); }

function focoNextSet() {
  const ex = focoState.exercises[focoState.exIdx];
  ex.sets[focoState.setIdx].weight = focoState.currentWeight;
  ex.sets[focoState.setIdx].reps = focoState.currentReps;
  ex.sets[focoState.setIdx].done = true;

  checkAndShowPR(ex.id, focoState.currentWeight);

  const restSecs = ex.rest || 90;
  startRestTimer(restSecs, ex.name.toUpperCase(), `SÃ©rie ${focoState.setIdx+1} concluÃ­da`);

  focoState.setIdx++;
  if (focoState.setIdx >= ex.sets.length) { focoNextExercise(); return; }
  focoRender();
}

function focoNextExercise() {
  focoState.exIdx++;
  focoState.setIdx = 0;
  if (focoState.exIdx >= focoState.exercises.length) { focoShowFinish(); return; }
  skipTimer();
  focoRender();
}

function focoShowFinish() {
  clearInterval(focoState.timerInterval);
  skipTimer();
  document.getElementById('foco-active').style.display = 'none';
  const finish = document.getElementById('foco-finish');
  finish.style.display = 'flex';
  const totalSets = focoState.exercises.reduce((a,e) => a + e.sets.filter(s=>s.done).length, 0);
  const dur = Math.floor((Date.now() - focoState.startTime) / 60000);
  document.getElementById('foco-summary').textContent = `${focoState.exercises.length} exercÃ­cios Â· ${totalSets} sÃ©ries Â· ${dur} minutos`;
}

function focoFinish() {
  const session = {
    id: uid(), planId: focoState.planId, date: Date.now(),
    duration: Math.floor((Date.now() - focoState.startTime) / 1000),
    exercises: focoState.exercises.map(ex => ({ exerciseId: ex.id, weight: ex.weight, sets: ex.sets })),
    progressions: 0
  };
  state.sessions.push(session);
  save();
  updateDashboard();
  document.getElementById('foco-finish').style.display = 'none';
  document.getElementById('foco-idle').style.display = 'flex';
  switchView('dashboard');
  showNotif('âœ…','Treino salvo!','Ã“timo trabalho no modo foco!','success');
}

function exitFoco() {
  clearInterval(focoState.timerInterval);
  skipTimer();
  document.getElementById('foco-active').style.display = 'none';
  document.getElementById('foco-finish').style.display = 'none';
  document.getElementById('foco-idle').style.display = 'flex';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMPARTILHAMENTO DE PR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkAndShowPR(exId, weight) {
  const ex = state.exercises.find(e => e.id === exId);
  if (!ex) return;
  const oldPR = getPR(exId);
  if (weight > oldPR && oldPR > 0) {
    setTimeout(() => showPRCard(ex.name, weight, oldPR), 1500);
  }
}

function showPRCard(exName, newWeight, oldWeight) {
  const increase = ((newWeight - oldWeight) / oldWeight * 100).toFixed(1);
  const existing = document.getElementById('pr-overlay');
  if (existing) existing.remove();

  const overlay = document.createElement('div');
  overlay.id = 'pr-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9000;display:flex;align-items:center;justify-content:center;padding:24px;';
  overlay.innerHTML = `
    <div style="background:var(--card);border:1px solid var(--orange);border-radius:24px;padding:32px;max-width:360px;width:100%;text-align:center;animation:slideUp 0.4s ease;">
      <div style="font-size:56px;margin-bottom:8px;">ğŸ†</div>
      <div style="font-family:'Bebas Neue';font-size:48px;color:var(--orange);letter-spacing:3px;line-height:1;">NOVO PR!</div>
      <div style="font-size:14px;color:var(--muted2);margin:8px 0 24px;">${exName}</div>
      <div style="display:flex;gap:12px;justify-content:center;align-items:center;margin-bottom:24px;">
        <div style="text-align:center;">
          <div style="font-size:12px;color:var(--muted2);margin-bottom:4px;">ANTES</div>
          <div style="font-family:'Bebas Neue';font-size:32px;color:var(--muted2);">${oldWeight}kg</div>
        </div>
        <div style="font-size:28px;color:var(--orange);">â†’</div>
        <div style="text-align:center;">
          <div style="font-size:12px;color:var(--muted2);margin-bottom:4px;">AGORA</div>
          <div style="font-family:'Bebas Neue';font-size:40px;color:var(--orange);">${newWeight}kg</div>
        </div>
      </div>
      <div style="background:var(--green-dim);border:1px solid var(--green);border-radius:10px;padding:10px;margin-bottom:24px;">
        <div style="font-family:'Bebas Neue';font-size:24px;color:var(--green);">+${increase}% de evoluÃ§Ã£o</div>
      </div>
      <div id="pr-share-preview" style="background:linear-gradient(135deg,#1A0800,#0A0A0A);border:1px solid var(--orange-mid);border-radius:16px;padding:20px;margin-bottom:20px;">
        <div style="font-family:'Bebas Neue';font-size:28px;color:var(--orange);letter-spacing:3px;">PROGRESSAR</div>
        <div style="font-size:13px;color:var(--muted2);margin:4px 0 12px;">ProgressÃ£o de Carga Inteligente</div>
        <div style="font-weight:700;font-size:16px;margin-bottom:4px;">${exName}</div>
        <div style="font-family:'Bebas Neue';font-size:36px;color:var(--orange);">${newWeight}kg ğŸ†</div>
        <div style="font-size:12px;color:var(--green);">+${increase}% desde o inÃ­cio</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-ghost" style="flex:1;" onclick="document.getElementById('pr-overlay').remove()">Fechar</button>
        <button class="btn btn-primary" style="flex:1;" onclick="sharePR('${exName}','${newWeight}','${increase}')">ğŸ“¤ Compartilhar</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
}

function sharePR(exName, weight, increase) {
  const text = `ğŸ† Novo PR no PROGRESSAR!

${exName}: ${weight}kg (+${increase}%)

ProgressÃ£o de carga inteligente com o mÃ©todo Muzy ğŸ”¥

#Progressar #Treino #PR #ProgressaoDeCarga`;
  if (navigator.share) {
    navigator.share({ title: 'Novo PR no PROGRESSAR!', text }).catch(() => {});
  } else {
    navigator.clipboard?.writeText(text);
    showNotif('ğŸ“‹','Copiado!','Cole no seu story ou post','success');
  }
  document.getElementById('pr-overlay')?.remove();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COACH VIRTUAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const TECNICAS = {
  iniciante: {
    any: {
      nome: 'PONTO ZERO',
      icon: 'ğŸ¯',
      porque: 'Manter a contraÃ§Ã£o no ponto de maior tensÃ£o por 2 segundos aumenta o tempo sob tensÃ£o muscular sem precisar adicionar carga. Estudos mostram que isso potencializa o crescimento muscular mesmo para iniciantes.',
      como: '1. Execute a repetiÃ§Ã£o normalmente.\n2. No ponto de maior tensÃ£o (geralmente no encurtamento do mÃºsculo), <b>pause por 2 segundos</b>.\n3. Mantenha a respiraÃ§Ã£o controlada durante a pausa.\n4. FaÃ§a isso em todas as reps da Ãºltima sÃ©rie.',
    }
  },
  intermediario: {
    maquina: {
      nome: 'DROP SET',
      icon: 'ğŸ“‰',
      porque: 'O drop set recruta fibras musculares adicionais que nÃ£o foram atingidas nas sÃ©ries normais. Ao reduzir a carga imediatamente e continuar atÃ© a falha, vocÃª estende o estÃ­mulo alÃ©m do limite usual.',
      como: '1. Finalize sua Ãºltima sÃ©rie normalmente.\n2. <b>Imediatamente</b> (sem descanso) reduza 2 placas/pinos.\n3. Execute mais repetiÃ§Ãµes atÃ© a falha tÃ©cnica.\n4. Opcional: repita reduzindo mais 2 placas para um triplo drop set.',
    },
    livre: {
      nome: 'REST-PAUSE',
      icon: 'â¸ï¸',
      porque: 'O rest-pause permite acumular mais volume com o mesmo peso, criando um estÃ­mulo extra de hipertrofia. Ã‰ especialmente eficaz com peso livre pois a instabilidade jÃ¡ recruta fibras estabilizadoras.',
      como: '1. Finalize sua Ãºltima sÃ©rie normalmente.\n2. Descanse <b>15 segundos</b> (conte em voz alta).\n3. Pegue o mesmo peso e faÃ§a mais <b>5 repetiÃ§Ãµes</b>.\n4. Descanse mais 15 segundos e tente mais 3-5 reps.\n5. Foco total na execuÃ§Ã£o â€” sem sacrificar a tÃ©cnica.',
    }
  },
  avancado: {
    maquina: {
      nome: 'DROP SET DUPLO',
      icon: 'ğŸ’¥',
      porque: 'VariaÃ§Ã£o mais intensa do drop set. Ao reduzir duas vezes consecutivas, vocÃª recruta praticamente todas as fibras disponÃ­veis do mÃºsculo, criando um estÃ­mulo metabÃ³lico mÃ¡ximo.',
      como: '1. Ãšltima sÃ©rie normal atÃ© a falha.\n2. Reduz 2 placas â†’ atÃ© a falha.\n3. Reduz mais 2 placas â†’ atÃ© a falha novamente.\n4. NÃ£o descanse entre as reduÃ§Ãµes.\n5. Reserve 2-3 minutos de descanso apÃ³s essa sÃ©rie.',
    },
    livre: {
      nome: 'REST-PAUSE INTENSO',
      icon: 'âš¡',
      porque: 'VersÃ£o avanÃ§ada do rest-pause para quem jÃ¡ tem base sÃ³lida. O estÃ­mulo combinado de falha + descanso curto + nova falha cria pico hormonal elevado e recrutamento mÃ¡ximo de unidades motoras.',
      como: '1. Execute atÃ© a falha tÃ©cnica.\n2. Descanse <b>10 segundos</b>.\n3. Continue com mais reps atÃ© nova falha.\n4. Descanse mais 10 segundos.\n5. Finalize com mais reps atÃ© a terceira falha.\n6. Total: 3 mini-sÃ©ries com descansos de 10s.',
    }
  }
};

let coachState = { exIdx: null, exName: '', effort: null, equip: '', level: '' };

function openCoach(exIdx) {
  const activeEx = state.activeWorkout?.exercises[exIdx];
  const exDef = state.exercises.find(e => e.id === activeEx?.exerciseId);
  if (!activeEx || !exDef) return;

  coachState = {
    exIdx,
    exName: activeEx.name,
    effort: null,
    equip: exDef.execution === 'maquina' ? 'maquina' : 'livre',
    level: state.user?.level || 'intermediate',
  };

  document.getElementById('coach-ex-name').textContent = activeEx.name;
  document.getElementById('coach-suggestion').style.display = 'none';
  document.getElementById('coach-tecnica-invite').style.display = 'none';
  document.querySelectorAll('.effort-btn').forEach(b => b.className = 'effort-btn');
  openModal('coach-modal');
}

function selectEffort(effort) {
  coachState.effort = effort;
  document.querySelectorAll('.effort-btn').forEach(b => {
    b.className = 'effort-btn';
    if (b.dataset.effort === effort) b.classList.add('selected-' + effort);
  });

  const activeEx = state.activeWorkout?.exercises[coachState.exIdx];
  const exDef = state.exercises.find(e => e.id === activeEx?.exerciseId);
  if (!activeEx || !exDef) return;

  const currentWeight = activeEx.currentWeight || exDef.weight;
  const increment = exDef.increment || 2;
  const equip = exDef.execution === 'maquina' ? 'maquina' : 'livre';
  const equipName = exDef.equip || '';

  let nextWeight = currentWeight;
  let reason = '';

  if (effort === 'facil') {
    if (equip === 'livre') {
      if (equipName.toLowerCase().includes('halter') || equipName.toLowerCase().includes('dumb') || coachState.loadKey === 'halter') {
        // FIX5: next even number above current â€” works for any weight (10, 20, 40, 80kg+)
        nextWeight = Math.ceil((currentWeight + 0.01) / 2) * 2;
        if (nextWeight === currentWeight) nextWeight += 2; // safety
        reason = `PrÃ³ximo par de halteres (+${nextWeight - currentWeight}kg)`;
      } else {
        nextWeight = currentWeight + 4;
        reason = `+2kg de cada lado na barra (+4kg total)`;
      }
    } else {
      nextWeight = currentWeight + increment;
      reason = `+1 placa no pino (+${increment}kg)`;
    }

    document.getElementById('coach-next-weight').textContent = `Use ${nextWeight}kg`;
    document.getElementById('coach-reason').textContent = reason;

    // Extra context for anilhas
    const eq2 = exDef?.equip || '';
    if (eq2.includes('Anilhas') && nextWeight !== currentWeight) {
      const diff = nextWeight - currentWeight;
      const porLado = diff / 2;
      document.getElementById('coach-reason').textContent = reason +
        ` â€” adicione ${porLado}kg de cada lado da barra`;
    }
    document.getElementById('coach-suggestion').style.display = 'block';
    document.getElementById('coach-tecnica-invite').style.display = 'block';

    if (activeEx) activeEx.coachSuggestedWeight = nextWeight;

  } else if (effort === 'certo') {
    document.getElementById('coach-next-weight').textContent = `Mantenha ${currentWeight}kg`;
    document.getElementById('coach-reason').textContent = 'Peso ideal! Continue evoluindo as reps antes de subir a carga.';
    document.getElementById('coach-suggestion').style.display = 'block';
    document.getElementById('coach-tecnica-invite').style.display = 'none';
  } else {
    document.getElementById('coach-next-weight').textContent = `Mantenha ou reduza`;
    document.getElementById('coach-reason').textContent = `Considere ${Math.max(currentWeight - increment, increment)}kg na prÃ³xima sessÃ£o para recuperar a qualidade das reps.`;
    document.getElementById('coach-suggestion').style.display = 'block';
    document.getElementById('coach-tecnica-invite').style.display = 'none';
  }
}

function showTecnica() {
  closeModal('coach-modal');
  const level = coachState.level;
  const equip = coachState.equip;

  let tecnica = null;
  if (level === 'beginner') {
    tecnica = TECNICAS.iniciante.any;
    document.getElementById('tecnica-nivel').textContent = 'Iniciante';
  } else if (level === 'intermediate') {
    tecnica = TECNICAS.intermediario[equip] || TECNICAS.intermediario.livre;
    document.getElementById('tecnica-nivel').textContent = 'IntermediÃ¡rio';
  } else {
    tecnica = TECNICAS.avancado[equip] || TECNICAS.avancado.livre;
    document.getElementById('tecnica-nivel').textContent = 'AvanÃ§ado';
  }

  if (!tecnica) return;
  document.getElementById('tecnica-nome').textContent = tecnica.nome;
  document.getElementById('tecnica-icon').textContent = tecnica.icon;
  document.getElementById('tecnica-porque').innerHTML = tecnica.porque;
  document.getElementById('tecnica-como').innerHTML = tecnica.como.replace(/\n/g, '<br>');
  openModal('tecnica-modal');
}

function closeCoach() {
  closeModal('coach-modal');

  const activeEx = state.activeWorkout?.exercises[coachState.exIdx];
  if (activeEx?.coachSuggestedWeight && coachState.effort === 'facil') {
    const exDef = state.exercises.find(e => e.id === activeEx.exerciseId);
    if (exDef) {
      exDef.weight = activeEx.coachSuggestedWeight;
      save();
      showNotif('ğŸ“‹', 'SugestÃ£o salva!', `PrÃ³ximo treino: ${activeEx.coachSuggestedWeight}kg`, 'success');
    }
  }
}

function closeTecnica() { closeModal('tecnica-modal'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXECUTION TYPE SELECTOR (reutilizado)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EQUIP_LIVRE   = ['Halteres (1-10kg)', 'Dumbbells (12kg+)', 'Anilhas (barra)'];
const EQUIP_MAQUINA = ['Barra com pino', 'Cabo / Polia', 'Smith (barra guiada)'];
const INCREMENT_BY_EQUIP = {
  'Halteres (1-10kg)':  1,    // fixos de 1 em 1kg atÃ© 10kg
  'Dumbbells (12kg+)':  2,    // pares de 2 em 2kg a partir de 12kg
  'Anilhas (barra)':    1,    // combinaÃ§Ã£o de placas â€” cÃ¡lculo especial
  'Barra livre':        2.5,
  'Barra com pino':     5,
  'Cabo / Polia':       2.5,
  'Smith (barra guiada)': 2.5,
};

// Placas disponÃ­veis por lado (academia padrÃ£o)
const PLACAS_DISPONIVEIS = [0.5, 1, 1.25, 2.5, 5, 10, 15, 20, 25];

// Retorna o menor peso >= target usando combinaÃ§Ã£o de placas
// LÃ³gica: a barra pesa ~10kg, mas aqui trabalhamos com peso total jÃ¡ informado pelo usuÃ¡rio
function proximoAnilha(currentWeight) {
  // Tenta encontrar a prÃ³xima carga possÃ­vel acima do peso atual
  // usando combinaÃ§Ãµes de placas de cada lado
  // Simplificado: incremento mÃ­nimo real com anilhas Ã© 1kg (0.5kg cada lado)
  // Busca o menor incremento possÃ­vel com as placas disponÃ­veis
  const incrementosPossiveis = [1, 2, 2.5, 5, 10]; // combinaÃ§Ãµes reais comuns
  for (const inc of incrementosPossiveis) {
    const candidato = currentWeight + inc;
    // Verifica se Ã© atingÃ­vel: peso total / 2 (cada lado) deve ser combinaÃ§Ã£o vÃ¡lida de placas
    const pesoLadoAtual = currentWeight / 2;
    const pesoLadoNovo  = candidato / 2;
    const diferenca = pesoLadoNovo - pesoLadoAtual;
    // Verifica se a diferenÃ§a Ã© uma placa disponÃ­vel ou soma de placas
    if (PLACAS_DISPONIVEIS.includes(diferenca) || diferenca % 0.5 === 0) {
      return { peso: candidato, incremento: inc, descricao: `+${diferenca}kg cada lado (+${inc}kg total)` };
    }
  }
  return { peso: currentWeight + 2.5, incremento: 2.5, descricao: '+1.25kg cada lado (+2.5kg total)' };
}

// Retorna o prÃ³ximo haltere disponÃ­vel (fixos 1-10kg, step 1kg)
function proximoHaltere(currentWeight) {
  if (currentWeight >= 10) return { peso: currentWeight, incremento: 0, descricao: 'MÃ¡ximo de haltere fixo (10kg). Considere dumbbells.' };
  const next = Math.min(Math.ceil(currentWeight + 0.01), 10);
  return { peso: next, incremento: next - currentWeight, descricao: `+${next - currentWeight}kg (prÃ³ximo haltere fixo)` };
}

// Retorna o prÃ³ximo par de dumbbells (12, 14, 16, 18... step 2kg)
function proximoDumbbell(currentWeight) {
  let base = Math.max(12, currentWeight);
  // Arredonda para par de 2kg acima do atual
  const next = Math.ceil((base + 0.01) / 2) * 2;
  if (next <= base) return { peso: base + 2, incremento: 2, descricao: '+2kg (prÃ³ximo par de dumbbell)' };
  return { peso: next, incremento: next - currentWeight, descricao: `+${next - currentWeight}kg (prÃ³ximo par: ${next}kg)` };
}

function setExecution(type, prefix) {
  const lBtn = document.getElementById(`${prefix}-exec-livre`);
  const mBtn = document.getElementById(`${prefix}-exec-maquina`);
  const hidden = document.getElementById(`${prefix}-execution`);
  const equipSel = document.getElementById(`${prefix === 'ex' || prefix === 'edit' ? (prefix + '-ex-equip') : 'wb-ex-equip'}`);
  const incSel = document.getElementById(`${prefix === 'ex' || prefix === 'edit' ? (prefix + '-ex-increment') : 'wb-ex-increment'}`);

  if (!lBtn || !mBtn || !hidden || !equipSel) return;

  lBtn.classList.toggle('active', type === 'livre');
  mBtn.classList.toggle('active', type === 'maquina');
  hidden.value = type;

  const options = type === 'livre' ? EQUIP_LIVRE : EQUIP_MAQUINA;
  equipSel.innerHTML = options.map((o, i) => {
    const icons = type === 'livre' ? ['ğŸ‹ï¸','ğŸ’ª','ğŸ”´'] : ['ğŸ“Œ','ã€°ï¸','ğŸ”©'];
    return `<option value="${o}">${icons[i]} ${o}</option>`;
  }).join('');

  if (incSel) {
    const defaultInc = INCREMENT_BY_EQUIP[options[0]] || 2;
    const found = Array.from(incSel.options).find(o => parseFloat(o.value) === defaultInc);
    if (found) {
      incSel.value = defaultInc;
    } else {
      const opt = document.createElement('option');
      opt.value = defaultInc;
      opt.textContent = `${defaultInc} kg`;
      incSel.appendChild(opt);
      incSel.value = defaultInc;
    }
  }

  equipSel.onchange = () => {
    const inc = INCREMENT_BY_EQUIP[equipSel.value];
    if (incSel && inc) {
      const opt = Array.from(incSel.options).find(o => parseFloat(o.value) === inc);
      if (opt) incSel.value = inc;
    }
  };
}

function quickChangeRest(exIdx) {
  const activeEx = state.activeWorkout?.exercises[exIdx];
  if (!activeEx) return;
  const exDef = state.exercises.find(e => e.id === activeEx.exerciseId);
  if (!exDef) return;

  const options = [45, 60, 90, 120, 180, 240];
  const current = exDef.rest || 90;
  const currentIdx = options.indexOf(current);
  const nextIdx = (currentIdx + 1) % options.length;
  exDef.rest = options[nextIdx];
  save();
  renderActiveWorkout();
  showNotif('â±', 'Descanso alterado', `${exDef.name}: ${formatRest(exDef.rest)}`, '');
}

function formatRest(secs) {
  if (!secs) return '1:30';
  const m = Math.floor(secs / 60);
  const s = secs % 60;
  return m > 0 ? (s > 0 ? `${m}:${String(s).padStart(2,'0')}` : `${m}min`) : `${s}s`;
}

function groupEmoji(group) {
  const map = { 'Peito': 'ğŸ’ª', 'Costas': 'ğŸ¦º', 'Ombro': 'ğŸ”º', 'BÃ­ceps': 'ğŸ’ª', 'TrÃ­ceps': 'ğŸ”±', 'Perna': 'ğŸ¦µ', 'GlÃºteo': 'ğŸ‘', 'AbdÃ´men': 'ğŸ”¥' };
  return map[group] || 'ğŸ‹ï¸';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CARDIO â€” FUNÃ‡Ã•ES AUXILIARES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function getCardioIcon(tipo) {
  const icons = {
    'Esteira': 'ğŸƒ', 'esteira': 'ğŸƒ',
    'Bike': 'ğŸš´', 'bike': 'ğŸš´',
    'Escada': 'ğŸªœ', 'escada': 'ğŸªœ',
    'Corrida externa': 'ğŸŒ³', 'corrida': 'ğŸŒ³',
    'Pular corda': 'ğŸª¢', 'corda': 'ğŸª¢',
    'NataÃ§Ã£o': 'ğŸŠ', 'natacao': 'ğŸŠ',
    'Remo': 'ğŸš£', 'remo': 'ğŸš£',
  };
  return icons[tipo] || 'ğŸƒ';
}

function getIntensidadeIcon(intensidade) {
  return { 'leve': 'ğŸ˜Œ', 'moderado': 'ğŸ˜Š', 'intenso': 'ğŸ¥µ' }[intensidade] || 'ğŸ˜Š';
}

function calcularImpactoCardio(sessao) {
  const pontos = { 'leve': 1, 'moderado': 2, 'intenso': 3 }[sessao.intensidade] || 1;
  const fatorTempo = Math.min((sessao.tempo || 20) / 30, 2);
  return pontos * fatorTempo;
}

function calcularImpactoCardioRecente(dias = 2) {
  const limite = Date.now() - (dias * 86400000);
  const recente = (state.cardio?.historico || []).filter(c => c.data > limite);
  return recente.reduce((acc, c) => acc + calcularImpactoCardio(c), 0);
}

function calcularMediaIntensidade() {
  const hist = state.cardio?.historico || [];
  if (!hist.length) return 'â€”';
  const vals = { 'leve': 1, 'moderado': 2, 'intenso': 3 };
  const avg = hist.reduce((a, c) => a + (vals[c.intensidade] || 1), 0) / hist.length;
  if (avg < 1.5) return 'ğŸ˜Œ Leve';
  if (avg < 2.5) return 'ğŸ˜Š Moderado';
  return 'ğŸ¥µ Intenso';
}

function gerarAlertasCardio() {
  const alertas = [];
  const hist = state.cardio?.historico || [];
  if (!hist.length) return alertas;

  const hoje = Date.now();
  const ontem = hoje - 86400000;
  const ultimoCardio = hist[hist.length - 1];

  // Alerta 1: cardio intenso nas Ãºltimas 24h
  if (ultimoCardio?.intensidade === 'intenso' && ultimoCardio.data > ontem) {
    alertas.push({
      tipo: 'cardio_intenso',
      html: `<div class="card card-sm" style="border-color:var(--yellow); margin-bottom:10px;">
        <div style="display:flex; align-items:center; gap:10px;">
          <span style="font-size:22px;">ğŸƒ</span>
          <div>
            <div style="font-weight:700; color:var(--yellow);">Cardio intenso recente</div>
            <div style="font-size:13px; color:var(--muted2);">Seu cardio de ontem pode afetar o desempenho. Considere treino mais leve ou foque em grupos musculares diferentes.</div>
          </div>
        </div>
      </div>`
    });
  }

  // Alerta 2: 3+ cardios intensos na semana
  const intensosSemana = hist.filter(c => hoje - c.data < 7 * 86400000 && c.intensidade === 'intenso');
  if (intensosSemana.length >= 3) {
    alertas.push({
      tipo: 'cardio_frequencia',
      html: `<div class="card card-sm" style="border-color:var(--orange); margin-bottom:10px;">
        <div style="display:flex; align-items:center; gap:10px;">
          <span style="font-size:22px;">ğŸ”¥</span>
          <div>
            <div style="font-weight:700; color:var(--orange);">${intensosSemana.length}x cardio intenso esta semana</div>
            <div style="font-size:13px; color:var(--muted2);">Alterne com sessÃµes moderadas para melhor recuperaÃ§Ã£o e preservar ganhos musculares.</div>
          </div>
        </div>
      </div>`
    });
  }

  // Alerta 3: impacto alto nas Ãºltimas 48h
  const impacto = calcularImpactoCardioRecente(2);
  if (impacto > 5) {
    alertas.push({
      tipo: 'cardio_impacto',
      html: `<div class="card card-sm" style="border-color:var(--blue); margin-bottom:10px;">
        <div style="display:flex; align-items:center; gap:10px;">
          <span style="font-size:22px;">âš¡</span>
          <div>
            <div style="font-weight:700; color:var(--blue);">Alto volume de cardio recente</div>
            <div style="font-size:13px; color:var(--muted2);">Carga reduzida sugerida hoje. Foco em qualidade de execuÃ§Ã£o, nÃ£o em bater recordes de carga.</div>
          </div>
        </div>
      </div>`
    });
  }

  return alertas;
}

// EstatÃ­sticas de cardio para o perfil
function renderCardioStats() {
  const hist = state.cardio?.historico || [];
  const totalMin = hist.reduce((a, c) => a + (c.tempo || 0), 0);
  const totalKM  = hist.reduce((a, c) => a + (c.distancia || 0), 0);
  const intensos  = hist.filter(c => c.intensidade === 'intenso').length;
  const moderados = hist.filter(c => c.intensidade === 'moderado').length;
  const leves     = hist.filter(c => c.intensidade === 'leve').length;

  if (!hist.length) {
    return `<div style="text-align:center; padding:24px; color:var(--muted2); font-size:13px;">
      <div style="font-size:28px; margin-bottom:8px;">ğŸƒ</div>
      Nenhuma sessÃ£o de cardio ainda.<br>Registre sua primeira sessÃ£o!
    </div>`;
  }

  return `
    <div class="grid-2" style="gap:10px; margin-bottom:12px;">
      <div style="background:var(--card2); border-radius:10px; padding:12px; text-align:center;">
        <div style="font-size:22px; font-weight:700; color:var(--orange); font-family:'Bebas Neue';">${hist.length}</div>
        <div style="font-size:11px; color:var(--muted2); text-transform:uppercase;">SessÃµes</div>
      </div>
      <div style="background:var(--card2); border-radius:10px; padding:12px; text-align:center;">
        <div style="font-size:22px; font-weight:700; color:var(--orange); font-family:'Bebas Neue';">${totalMin}min</div>
        <div style="font-size:11px; color:var(--muted2); text-transform:uppercase;">Tempo total</div>
      </div>
      ${totalKM > 0 ? `<div style="background:var(--card2); border-radius:10px; padding:12px; text-align:center;">
        <div style="font-size:22px; font-weight:700; color:var(--orange); font-family:'Bebas Neue';">${totalKM.toFixed(1)}km</div>
        <div style="font-size:11px; color:var(--muted2); text-transform:uppercase;">DistÃ¢ncia</div>
      </div>` : ''}
      <div style="background:var(--card2); border-radius:10px; padding:12px; text-align:center;">
        <div style="font-size:18px; font-weight:700; color:var(--orange);">${calcularMediaIntensidade()}</div>
        <div style="font-size:11px; color:var(--muted2); text-transform:uppercase;">Intensidade mÃ©dia</div>
      </div>
    </div>
    <div style="display:flex; gap:6px; flex-wrap:wrap;">
      ${leves > 0 ? `<span class="tag" style="background:var(--blue-dim); color:var(--blue);">ğŸ˜Œ ${leves}x leve</span>` : ''}
      ${moderados > 0 ? `<span class="tag tag-green">ğŸ˜Š ${moderados}x moderado</span>` : ''}
      ${intensos > 0 ? `<span class="tag" style="background:var(--red-dim); color:var(--red);">ğŸ¥µ ${intensos}x intenso</span>` : ''}
    </div>
    <div style="margin-top:12px; border-top:1px solid var(--border); padding-top:12px;">
      <div style="font-size:12px; font-weight:700; color:var(--muted2); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">Ãšltimas sessÃµes</div>
      ${hist.slice(-5).reverse().map(c => `
        <div style="display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid var(--border);">
          <span style="font-size:18px;">${getCardioIcon(c.tipo)}</span>
          <div style="flex:1;">
            <div style="font-size:13px; font-weight:600;">${c.tipo}</div>
            <div style="font-size:11px; color:var(--muted2);">${new Date(c.data).toLocaleDateString('pt-BR')}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:12px;">${getIntensidadeIcon(c.intensidade)} ${c.intensidade}</div>
            <div style="font-size:11px; color:var(--muted2);">â± ${c.tempo}min${c.distancia ? ` Â· ${c.distancia}km` : ''}</div>
          </div>
        </div>`).join('')}
    </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODO INICIANTE + RECUPERAÃ‡ÃƒO + CARDIO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setUserLevel(level) {
  state.user = state.user || {};
  // Update hidden input
  const inp = document.getElementById('user-level');
  if (inp) inp.value = level;
  // Update button styles
  ['beginner','intermediate','advanced'].forEach(l => {
    const btn = document.getElementById('lvl-' + l);
    if (btn) btn.classList.toggle('selected', l === level);
  });
  // Activate modo iniciante
  if (level === 'beginner') {
    state.modoIniciante = {
      ativo: true,
      dataInicio: Date.now(),
      dataFim: Date.now() + (28 * 24 * 60 * 60 * 1000),
      semanasRestantes: 4
    };
  } else {
    state.modoIniciante = { ativo: false, dataInicio: null, dataFim: null, semanasRestantes: 0 };
  }
}

// â”€â”€ RECUPERAÃ‡ÃƒO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function getRecoveryStatus() {
  const hoje = Date.now();
  const ontem = hoje - (24 * 60 * 60 * 1000);
  // Cardio intenso nas Ãºltimas 24h
  if (state.cardio?.ultimoCardioIntenso && state.cardio.ultimoCardioIntenso > ontem) {
    return { recuperacao: 'baixa', mensagem: 'ğŸƒ Cardio intenso recente. Considere treino mais leve hoje.' };
  }
  // Dias consecutivos
  const cons = state.recuperacao?.diasConsecutivos || 0;
  if (cons >= 5) {
    return { recuperacao: 'critica', mensagem: `ğŸ˜´ ${cons} dias seguidos de treino. RecuperaÃ§Ã£o Ã© parte do mÃ©todo!` };
  }
  if (cons >= 3) {
    return { recuperacao: 'atencao', mensagem: `âš ï¸ ${cons} dias seguidos. Monitore seu desempenho.` };
  }
  return { recuperacao: 'normal', mensagem: null };
}

function updateRecoveryAfterWorkout() {
  const hoje = new Date().toDateString();
  const ultimo = state.recuperacao?.ultimoTreinoData
    ? new Date(state.recuperacao.ultimoTreinoData).toDateString()
    : null;
  if (ultimo === hoje) return; // jÃ¡ treinou hoje
  const ontem = new Date(Date.now() - 86400000).toDateString();
  if (ultimo === ontem) {
    state.recuperacao.diasConsecutivos = (state.recuperacao.diasConsecutivos || 0) + 1;
  } else {
    state.recuperacao.diasConsecutivos = 1;
  }
  state.recuperacao.ultimoTreinoData = Date.now();
}

function checkWorkoutFrequency() {
  const hoje = Date.now();
  const ultimos7 = state.sessions.filter(s => hoje - s.date < 7 * 86400000 && !s.isRestDay);
  const diasUnicos = new Set(ultimos7.map(s => new Date(s.date).toDateString())).size;
  if (diasUnicos >= 7) {
    return { bloqueado: true, motivo: '7 dias seguidos', mensagem: 'ğŸš« 7 dias seguidos de treino! Seu corpo precisa de pelo menos 1 dia de descanso por semana.' };
  }
  if (diasUnicos >= 5 && state.modoIniciante?.ativo) {
    return { bloqueado: true, motivo: 'alta_frequencia_iniciante', mensagem: 'ğŸŒ± Modo iniciante: mÃ¡ximo recomendado Ã© 4 dias/semana. Descanso Ã© quando o mÃºsculo cresce!' };
  }
  return { bloqueado: false };
}

function addRestDay() {
  state.sessions.push({ id: uid(), planId: 'rest', date: Date.now(), duration: 0, exercises: [], progressions: 0, isRestDay: true });
  state.recuperacao.diasConsecutivos = 0;
  save();
  showNotif('ğŸ˜´', 'Dia de descanso registrado!', 'RecuperaÃ§Ã£o Ã© parte do mÃ©todo Muzy', 'success');
  updateDashboard();
}

// â”€â”€ CARDIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let newExerciseType = 'musculacao';

function setExerciseType(type) {
  newExerciseType = type;
  // Toggle ALL type-btn groups in the page
  document.querySelectorAll('.type-btn').forEach(b => {
    if (b.dataset.type === type) b.classList.add('active');
    else b.classList.remove('active');
  });
  // Show/hide cardio fields
  document.querySelectorAll('#cardio-extra-fields').forEach(el => {
    el.style.display = type === 'cardio' ? 'block' : 'none';
  });
  // Show/hide musculacao fields
  document.querySelectorAll('#musculacao-fields').forEach(el => {
    el.style.display = type === 'musculacao' ? 'block' : 'none';
  });
  // Update hidden input
  const inp = document.getElementById('ex-type');
  if (inp) inp.value = type;
}

function saveCardioExercise() {
  const tipo    = document.getElementById('cardio-tipo')?.value || 'esteira';
  const tempo   = parseInt(document.getElementById('cardio-tempo')?.value) || 20;
  const intens  = document.getElementById('cardio-intensidade')?.value || 'moderado';
  const dist    = parseFloat(document.getElementById('cardio-distancia')?.value) || null;

  const cardio = { id: uid(), data: Date.now(), tipo, tempo, intensidade: intens, distancia: dist };
  state.cardio.historico.push(cardio);
  if (intens === 'intenso') state.cardio.ultimoCardioIntenso = cardio.data;

  // Also add as a session entry so it appears in history
  state.sessions.push({
    id: uid(), planId: 'cardio', date: Date.now(), duration: tempo * 60,
    exercises: [{ name: tipo, cardio: true, tempo, intensidade: intens, distancia: dist }],
    progressions: 0, isCardio: true
  });

  save();
  closeModal('exercise-modal');
  showNotif('ğŸƒ', 'Cardio registrado!', `${tempo}min de ${tipo} (${intens})`, 'success');
  updateDashboard();
  renderAllSessions();
}

function checkMuscleGroupVolume(plan, newExercise) {
  if (!state.modoIniciante?.ativo) return true;
  const exsInPlan = plan.exercises.map(id => state.exercises.find(e => e.id === id)).filter(Boolean);
  const countByGroup = {};
  exsInPlan.forEach(ex => { countByGroup[ex.group] = (countByGroup[ex.group] || 0) + 1; });
  if (newExercise) countByGroup[newExercise.group] = (countByGroup[newExercise.group] || 0) + 1;
  for (let g in countByGroup) {
    if (countByGroup[g] > 3) {
      showNotif('ğŸŒ±', 'Limite iniciante', `MÃ¡ximo 3 exercÃ­cios para ${g} no modo iniciante`, 'warning');
      return false;
    }
  }
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CARDIO VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function abrirRegistroCardio() {
  document.getElementById('cardio-form-card').style.display = 'block';
  document.getElementById('cardio-form-card').scrollIntoView({ behavior: 'smooth' });
}

function fecharRegistroCardio() {
  document.getElementById('cardio-form-card').style.display = 'none';
}

function salvarCardioView() {
  const tipo     = document.getElementById('cardio-tipo-v').value;
  const tempo    = parseInt(document.getElementById('cardio-tempo-v').value) || 20;
  const intens   = document.getElementById('cardio-intensidade-v').value;
  const dist     = parseFloat(document.getElementById('cardio-distancia-v').value) || null;

  const cardio = { id: uid(), data: Date.now(), tipo, tempo, intensidade: intens, distancia: dist };
  if (!state.cardio) state.cardio = { historico: [], ultimoCardioIntenso: null };
  state.cardio.historico.push(cardio);
  if (intens === 'intenso') state.cardio.ultimoCardioIntenso = cardio.data;

  // Also push to sessions for history view
  state.sessions.push({
    id: uid(), planId: 'cardio', date: Date.now(), duration: tempo * 60,
    exercises: [{ name: tipo, cardio: true, tempo, intensidade: intens, distancia: dist }],
    progressions: 0, isCardio: true
  });

  save();
  fecharRegistroCardio();
  showNotif('ğŸƒ', 'Cardio registrado!', `${tempo}min de ${tipo} (${intens})`, 'success');
  renderCardioView();
  updateDashboard();
  renderAllSessions();
}

const CARDIO_POR_OBJETIVO = {
  hypertrophy: {
    icon: 'ğŸ’ª',
    recomendado: 'Moderado 20â€“30min, 2â€“3x/semana, preferencialmente pÃ³s-treino',
    evitar: 'Cardio intenso antes de treino de pernas â€” aumenta catabolismo'
  },
  strength: {
    icon: 'ğŸ‹ï¸',
    recomendado: 'Apenas leve, em dias separados do treino principal',
    evitar: 'Qualquer cardio intenso perto do dia de treino pesado'
  },
  endurance: {
    icon: 'ğŸš´',
    recomendado: 'Moderado/Intenso, atÃ© 4x/semana, variando intensidade',
    evitar: 'Volume excessivo sem dias de recuperaÃ§Ã£o ativa'
  },
};

function renderCardioView() {
  // Dica por objetivo
  const goal = state.user?.goal || 'hypertrophy';
  const dica = CARDIO_POR_OBJETIVO[goal];
  const dicaEl = document.getElementById('cardio-dica-objetivo');
  if (dicaEl && dica) {
    dicaEl.innerHTML = `
      <div style="display:flex; align-items:flex-start; gap:12px;">
        <span style="font-size:28px;">${dica.icon}</span>
        <div>
          <div style="font-weight:700; font-size:14px; margin-bottom:6px;">Cardio para seu objetivo</div>
          <div style="font-size:13px; color:var(--green); margin-bottom:4px;">âœ… ${dica.recomendado}</div>
          <div style="font-size:13px; color:var(--red);">â›” ${dica.evitar}</div>
        </div>
      </div>`;
  }

  // Alertas
  const alertasEl = document.getElementById('cardio-alertas-view');
  if (alertasEl) {
    const alertas = gerarAlertasCardio();
    alertasEl.innerHTML = alertas.map(a => a.html).join('');
  }

  // Stats
  const statsEl = document.getElementById('cardio-stats-view');
  if (statsEl) statsEl.innerHTML = renderCardioStats();

  // HistÃ³rico
  const histEl = document.getElementById('cardio-historico-view');
  if (histEl) {
    const hist = [...(state.cardio?.historico || [])].reverse();
    if (!hist.length) {
      histEl.innerHTML = `<div style="text-align:center; padding:24px; color:var(--muted2); font-size:13px;">
        <div style="font-size:32px; margin-bottom:8px;">ğŸƒ</div>
        Nenhuma sessÃ£o ainda.<br>Clique em "+ Registrar" para comeÃ§ar!
      </div>`;
    } else {
      histEl.innerHTML = hist.map(c => `
        <div style="display:flex; align-items:center; gap:12px; padding:10px 0; border-bottom:1px solid var(--border);">
          <span style="font-size:28px;">${getCardioIcon(c.tipo)}</span>
          <div style="flex:1;">
            <div style="font-weight:600; font-size:14px;">${c.tipo}</div>
            <div style="font-size:12px; color:var(--muted2);">${new Date(c.data).toLocaleDateString('pt-BR', { weekday:'short', day:'2-digit', month:'short' })}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:13px; font-weight:600;">${getIntensidadeIcon(c.intensidade)} ${c.intensidade}</div>
            <div style="font-size:12px; color:var(--muted2);">â± ${c.tempo}min${c.distancia ? ` Â· ğŸ“ ${c.distancia}km` : ''}</div>
          </div>
        </div>`).join('');
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EBOOKS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const EBOOKS = {
  ectomorfa: {
    title: 'O GUIA DA ECTOMORFA',
    emoji: 'ğŸŒ¿',
    color: '#7c3aed',
    chapters: [
      {
        tag: 'CapÃ­tulo 1 â€” GRÃTIS',
        title: 'Entendendo o Corpo Ectomorfo',
        free: true,
        body: `<p>Se vocÃª sempre foi chamada de "magrinha", "espicha fÃ¡cil" ou ouviu que "tem sorte de nÃ£o engordar" â€” este guia foi escrito para vocÃª.</p>
        <p>O <strong>biotipo ectomorfo</strong> Ã© caracterizado por:</p>
        <ul>
          <li>Metabolismo acelerado â€” vocÃª queima calorias em repouso mais rÃ¡pido que outros biotipos</li>
          <li>Estrutura Ã³ssea mais fina e delicada</li>
          <li>Dificuldade em reter massa muscular, mesmo treinando pesado</li>
          <li>TendÃªncia a digestÃ£o mais sensÃ­vel e apetite naturalmente menor</li>
          <li>Temperatura corporal ligeiramente mais elevada</li>
        </ul>
        <p>E a <strong>boa notÃ­cia real</strong>: ectomorfas tÃªm excelente saÃºde cardiovascular, menor risco de diabetes tipo 2 e maior longevidade mÃ©dia que outros biotipos â€” quando bem nutridas.</p>
        <p>O problema nÃ£o Ã© seu metabolismo. Ã‰ que <strong>ninguÃ©m te ensinou a comer e treinar para o seu corpo.</strong></p>`
      },
      {
        tag: 'CapÃ­tulo 2 â€” GRÃTIS',
        title: 'A Armadilha Hormonal da Magra',
        free: true,
        body: `<p>Este Ã© o capÃ­tulo que mais mulheres precisam ler. Porque existe um ciclo silencioso que sabota a evoluÃ§Ã£o de muitas ectomorfas:</p>
        <p><strong>Come pouco â†’ treina muito â†’ cortisol alto â†’ gordura na barriga â†’ se sente "gorda" â†’ come menos â†’ ciclo piora.</strong></p>
        <p>O ciclo menstrual afeta tudo â€” e o impacto no biotipo ectomorfo Ã© intenso:</p>
        <ul>
          <li><strong>Fase folicular (dias 1â€“14):</strong> mais energia, forÃ§a e disposiÃ§Ã£o. Ideal para treinos mais pesados e progressÃ£o de carga.</li>
          <li><strong>Fase lÃºtea (dias 15â€“28):</strong> queda de energia, aumento do apetite (ouÃ§a seu corpo!), retenÃ§Ã£o hÃ­drica natural â€” nÃ£o Ã© gordura.</li>
          <li><strong>Amenorreia:</strong> se seu ciclo sumiu ou ficou irregular, seu corpo estÃ¡ em modo de sobrevivÃªncia. Comer mais pode ser a soluÃ§Ã£o mais importante da sua vida agora.</li>
        </ul>
        <p>A relaÃ§Ã£o entre baixo percentual de gordura (abaixo de 16-18%) e interrupÃ§Ã£o do ciclo menstrual Ã© direta e comprovada. <strong>Menstruar regularmente Ã© sinal de saÃºde, nÃ£o de fraqueza.</strong></p>`
      },
      {
        tag: 'CapÃ­tulo 3 â€” PREMIUM',
        title: 'NutriÃ§Ã£o EstratÃ©gica para Ganhar Massa',
        free: false,
        body: `<p>Aqui estÃ¡ a verdade que ninguÃ©m te conta: ectomorfas precisam de <strong>superÃ¡vit calÃ³rico real</strong> para crescer. E nÃ£o, comer arroz e frango a mais nÃ£o vai funcionar se a quantidade total de calorias ainda for insuficiente.</p>
        <p><strong>ProporÃ§Ã£o ideal de macros para ectomorfa que treina forÃ§a 4-5x/semana:</strong></p>
        <ul>
          <li>Carboidratos: 50â€“55% â€” seu melhor amigo para energia e armazenamento de glicogÃªnio muscular</li>
          <li>ProteÃ­nas: 25â€“30% â€” mÃ­nimo de 1,8g por kg de peso corporal</li>
          <li>Gorduras: 20â€“25% â€” essencial para produÃ§Ã£o hormonal</li>
        </ul>
        <p><strong>Alimentos-chave para ectomorfa com digestÃ£o sensÃ­vel:</strong></p>
        <ul>
          <li>Batata doce, arroz branco, aveia (carboidratos de fÃ¡cil digestÃ£o)</li>
          <li>Ovos inteiros, frango, salmÃ£o, atum</li>
          <li>Amendoim, pasta de amendoim, abacate (calorias densas, volume pequeno)</li>
          <li>Leite integral, iogurte grego, queijo cottage</li>
        </ul>
        <p><strong>EstratÃ©gia para quem nÃ£o sente fome:</strong> divida as refeiÃ§Ãµes em 5-6 menores, use vitaminas com leite + pasta de amendoim + banana ao invÃ©s de refeiÃ§Ãµes sÃ³lidas quando o apetite estiver baixo. Nunca pule o cafÃ© da manhÃ£.</p>`
      },
      {
        tag: 'CapÃ­tulo 4 â€” PREMIUM',
        title: 'O Treino que Cria Curvas',
        free: false,
        body: `<p>A ectomorfa nÃ£o deve treinar como uma atleta de resistÃªncia. Cardio excessivo Ã© o maior sabotador do seu progresso.</p>
        <p><strong>FrequÃªncia ideal:</strong> 3 a 4 dias de musculaÃ§Ã£o por semana â€” com pelo menos 48h de recuperaÃ§Ã£o para cada grupo muscular. Mais nÃ£o Ã© melhor para vocÃª.</p>
        <p><strong>Cardio:</strong> mÃ¡ximo 20-25min de cardio moderado, 2x por semana, preferencialmente em dias separados do treino de forÃ§a. HIIT intenso? Apenas 1x por semana no mÃ¡ximo.</p>
        <p><strong>DivisÃ£o semanal sugerida para iniciante ectomorfa (foco glÃºteo e harmonia):</strong></p>
        <ul>
          <li>Segunda: GlÃºteo + Posterior de coxa</li>
          <li>TerÃ§a: Peito + Ombro (criar largura)</li>
          <li>Quarta: Descanso ativo ou cardio leve</li>
          <li>Quinta: Costas + BÃ­ceps</li>
          <li>Sexta: QuadrÃ­ceps + Panturrilha</li>
          <li>SÃ¡bado: Descanso ou cardio leve</li>
        </ul>
        <p><strong>ProgressÃ£o de carga:</strong> adicione peso a cada 2 semanas, nÃ£o toda semana. Priorize chegar ao topo da faixa de reps com tÃ©cnica perfeita antes de subir a carga.</p>`
      },
      {
        tag: 'CapÃ­tulo 5 â€” PREMIUM',
        title: 'PsicolÃ³gico e PercepÃ§Ã£o do Progresso',
        free: false,
        body: `<p>Nas primeiras semanas comendo mais e treinando certo, vocÃª vai se sentir "estufada" ou "maior". Isso Ã© <strong>100% normal e Ã© sinal de progresso.</strong></p>
        <p>O que estÃ¡ acontecendo no seu corpo:</p>
        <ul>
          <li><strong>GlicogÃªnio muscular:</strong> cada 1g de carboidrato armazena ~3g de Ã¡gua no mÃºsculo. Seus mÃºsculos estÃ£o cheios â€” isso Ã© definiÃ§Ã£o futura acontecendo agora.</li>
          <li><strong>Ãgua intramuscular:</strong> mÃºsculos mais trabalhados retÃªm mais Ã¡gua temporariamente. Isso passa em 4-6 semanas.</li>
          <li><strong>InflamaÃ§Ã£o anabÃ³lica:</strong> microlesÃµes musculares que causam crescimento. Dor muscular = trabalho sendo feito.</li>
        </ul>
        <p><strong>Tempo realista para ver resultados visÃ­veis:</strong></p>
        <ul>
          <li>4-6 semanas: melhora de forÃ§a e postura</li>
          <li>3-4 meses: mudanÃ§as visÃ­veis em fotos</li>
          <li>6-12 meses: curvas reais e consistentes</li>
        </ul>
        <p><strong>SuplementaÃ§Ã£o que realmente funciona para ectomorfa:</strong></p>
        <ul>
          <li><strong>Creatina monoidratada (3-5g/dia):</strong> aumenta forÃ§a, volume muscular e recuperaÃ§Ã£o. A mais estudada e comprovada.</li>
          <li><strong>Whey protein:</strong> praticidade para bater proteÃ­na quando o apetite estÃ¡ baixo.</li>
          <li><strong>Ã”mega-3 (2g/dia):</strong> reduz inflamaÃ§Ã£o, melhora sensibilidade insulÃ­nica e saÃºde hormonal.</li>
        </ul>`
      }
    ]
  },

  mesomorfa: {
    title: 'O GUIA DA MESOMORFA',
    emoji: 'ğŸ’ª',
    color: '#16a34a',
    chapters: [
      {
        tag: 'CapÃ­tulo 1 â€” GRÃTIS',
        title: 'O Dom e o Desafio da Mesomorfa',
        free: true,
        body: `<p>VocÃª ganha mÃºsculo rÃ¡pido, perde gordura quando se dedica â€” mas tambÃ©m acumula peso com facilidade nos perÃ­odos de descuido. Bem-vinda ao biotipo mais "responsivo" da natureza.</p>
        <p>CaracterÃ­sticas do <strong>biotipo mesomorfo feminino:</strong></p>
        <ul>
          <li>Estrutura Ã³ssea mÃ©dia a larga, ombros e quadril proporcionais</li>
          <li>Metabolismo moderado e equilibrado</li>
          <li>Alta responsividade ao treino â€” ganha forÃ§a e massa muscular mais rÃ¡pido que os outros biotipos</li>
          <li>TendÃªncia a acumular gordura rapidamente em perÃ­odos de excessos</li>
          <li>Boa capacidade cardiovascular natural</li>
        </ul>
        <p>A armadilha da mesomorfa Ã© justamente esse potencial: <strong>como resultado vem rÃ¡pido, Ã© fÃ¡cil se acomodar. E quando para, regride tambÃ©m mais rÃ¡pido.</strong> ConsistÃªncia Ã© a sua palavra-chave.</p>`
      },
      {
        tag: 'CapÃ­tulo 2 â€” GRÃTIS',
        title: 'HormÃ´nios e o Ciclo da Mesomorfa',
        free: true,
        body: `<p>A mesomorfa tem uma relaÃ§Ã£o mais equilibrada com os hormÃ´nios que os outros biotipos â€” mas isso nÃ£o significa que o ciclo menstrual nÃ£o afeta o treino.</p>
        <p><strong>Como o ciclo impacta a mesomorfa:</strong></p>
        <ul>
          <li><strong>Fase folicular:</strong> pico de estrogÃªnio = mÃ¡xima forÃ§a, resistÃªncia e motivaÃ§Ã£o. Ã‰ o momento de treinar mais pesado e buscar recordes.</li>
          <li><strong>OvulaÃ§Ã£o:</strong> pico de testosterona = maior sÃ­ntese proteica. Use esse dia para treino de forÃ§a mÃ¡xima.</li>
          <li><strong>Fase lÃºtea:</strong> progesterona alta = mais catabolismo, retenÃ§Ã£o hÃ­drica e apetite aumentado. Reduza o cardio intenso e aumente levemente as proteÃ­nas.</li>
        </ul>
        <p><strong>AtenÃ§Ã£o:</strong> a mesomorfa tem maior tendÃªncia a desenvolver <strong>sÃ­ndrome dos ovÃ¡rios policÃ­sticos (SOP)</strong> quando aliada a uma dieta de alto Ã­ndice glicÃªmico e excesso de carboidratos refinados. Prefira sempre carboidratos complexos e mantenha o Ã­ndice glicÃªmico sob controle.</p>`
      },
      {
        tag: 'CapÃ­tulo 3 â€” PREMIUM',
        title: 'NutriÃ§Ã£o para ComposiÃ§Ã£o Corporal Ideal',
        free: false,
        body: `<p>A nutriÃ§Ã£o da mesomorfa precisa ser precisa â€” nem restrita demais (perda de mÃºsculo) nem excessiva demais (acÃºmulo de gordura).</p>
        <p><strong>Macros para mesomorfa com objetivo de composiÃ§Ã£o (perder gordura + manter mÃºsculo):</strong></p>
        <ul>
          <li>ProteÃ­nas: 30â€“35% â€” prioridade mÃ¡xima para preservar massa magra</li>
          <li>Carboidratos: 35â€“40% â€” prefira complexos: batata doce, arroz integral, quinoa</li>
          <li>Gorduras: 25â€“30% â€” azeite, abacate, oleaginosas</li>
        </ul>
        <p><strong>EstratÃ©gia de ciclagem calÃ³rica:</strong> nos dias de treino pesado, aumente carboidratos em 20%. Nos dias de descanso, reduza carboidratos e aumente gorduras boas. Isso otimiza composiÃ§Ã£o corporal sem sacrificar desempenho.</p>`
      },
      {
        tag: 'CapÃ­tulo 4 â€” PREMIUM',
        title: 'Treino para DefiniÃ§Ã£o e ProporÃ§Ã£o',
        free: false,
        body: `<p>A mesomorfa responde bem a praticamente qualquer tipo de treino â€” o desafio Ã© escolher o certo para o objetivo atual.</p>
        <p><strong>Para composiÃ§Ã£o corporal (mais comum para mesomorfas):</strong></p>
        <ul>
          <li>4-5 dias de treino de forÃ§a com faixa de 8-15 reps</li>
          <li>2-3 sessÃµes de cardio moderado de 25-35 min (nÃ£o HIIT todos os dias)</li>
          <li>Priorize grupos que vocÃª quer desenvolver: para a mesomorfa feminina, costas largas + glÃºteos altos = silhueta ideal</li>
        </ul>
        <p><strong>O erro mais comum da mesomorfa:</strong> fazer cardio demais achando que vai "secar mais rÃ¡pido". Resultado: perde mÃºsculo, fica "flat" e o metabolismo desacelera. <strong>MÃºsculo Ã© o que cria forma. Cardio apenas cria dÃ©ficit.</strong></p>`
      },
      {
        tag: 'CapÃ­tulo 5 â€” PREMIUM',
        title: 'Mantendo os Resultados a Longo Prazo',
        free: false,
        body: `<p>A mesomorfa tem o maior potencial de transformaÃ§Ã£o â€” mas tambÃ©m Ã© a que mais sofre com o efeito sanfona quando nÃ£o mantÃ©m consistÃªncia.</p>
        <p><strong>EstratÃ©gias para manutenÃ§Ã£o permanente:</strong></p>
        <ul>
          <li>Nunca fique mais de 2 semanas sem treinar â€” a perda de massa muscular comeÃ§a rÃ¡pido</li>
          <li>Tenha um plano de manutenÃ§Ã£o (nÃ£o de emagrecimento) como base</li>
          <li>Ciclos de 3 meses: 2 meses de volume + 1 mÃªs de definiÃ§Ã£o funcionam muito bem para esse biotipo</li>
        </ul>
        <p><strong>SuplementaÃ§Ã£o ideal para mesomorfa:</strong></p>
        <ul>
          <li><strong>Creatina (5g/dia):</strong> mantÃ©m forÃ§a e volume muscular durante fases de dÃ©ficit calÃ³rico</li>
          <li><strong>ProteÃ­na do soro (whey):</strong> praticidade pÃ³s-treino</li>
          <li><strong>MagnÃ©sio glicinato (300-400mg Ã  noite):</strong> melhora qualidade do sono, reduz cortisol e ajuda no equilÃ­brio hormonal â€” especialmente importante na fase lÃºtea</li>
        </ul>`
      }
    ]
  },

  endomorfa: {
    title: 'O GUIA DA ENDOMORFA',
    emoji: 'ğŸ”¥',
    color: '#ea580c',
    chapters: [
      {
        tag: 'CapÃ­tulo 1 â€” GRÃTIS',
        title: 'Entendendo o Biotipo Endomorfo',
        free: true,
        body: `<p>Se vocÃª sente que engorda olhando para um pedaÃ§o de bolo, mas luta para perder os mesmos quilos com meses de dieta â€” vocÃª nÃ£o estÃ¡ exagerando. O metabolismo endomorfo Ã© real, comprovado e tem caracterÃ­sticas muito especÃ­ficas.</p>
        <p><strong>CaracterÃ­sticas do biotipo endomorfo feminino:</strong></p>
        <ul>
          <li>Metabolismo mais lento â€” menor taxa metabÃ³lica basal em repouso</li>
          <li>Alta eficiÃªncia em armazenar energia (especialmente como gordura)</li>
          <li>Estrutura Ã³ssea mais larga, quadril proeminente</li>
          <li>Boa capacidade de ganhar massa muscular (vantagem real!)</li>
          <li>Maior sensibilidade Ã  insulina â€” carboidratos viram gordura mais facilmente</li>
        </ul>
        <p><strong>A boa notÃ­cia que ninguÃ©m te conta:</strong> a endomorfa tem <strong>excelente potencial muscular</strong>. Quando o foco muda de "emagrecer" para "construir mÃºsculo", o corpo muda de composiÃ§Ã£o naturalmente â€” e de forma duradoura.</p>`
      },
      {
        tag: 'CapÃ­tulo 2 â€” GRÃTIS',
        title: 'Insulina, HormÃ´nios e o Ciclo da Endomorfa',
        free: true,
        body: `<p>O grande diferencial da endomorfa Ã© a <strong>sensibilidade Ã  insulina</strong> â€” o hormÃ´nio que decide se o que vocÃª come vira energia ou gordura.</p>
        <p><strong>Como o ciclo menstrual afeta a endomorfa de forma Ãºnica:</strong></p>
        <ul>
          <li><strong>Fase folicular:</strong> maior sensibilidade Ã  insulina â€” os carboidratos sÃ£o melhor utilizados. Aproveite para os treinos mais pesados e refeiÃ§Ãµes mais ricas em carboidratos.</li>
          <li><strong>Fase lÃºtea:</strong> queda da sensibilidade Ã  insulina + aumento do apetite. Reduza carboidratos, aumente proteÃ­nas e gorduras boas. O craving por doce Ã© hormonal â€” nÃ£o fraqueza sua.</li>
        </ul>
        <p><strong>SÃ­ndrome dos OvÃ¡rios PolicÃ­sticos (SOP):</strong> endomorfas tÃªm maior predisposiÃ§Ã£o. Os sintomas (ciclo irregular, acne, dificuldade em emagrecer) pioram com excesso de aÃ§Ãºcar e carboidratos refinados. A abordagem nutricional correta pode reverter muitos desses sintomas â€” sem medicamento.</p>
        <p><strong>TireÃ³ide:</strong> o hipotireoidismo Ã© mais comum em endomorfas. Se vocÃª sente cansaÃ§o extremo, queda de cabelo e nÃ£o consegue emagrecer mesmo em dÃ©ficit, peÃ§a exame de TSH, T3 e T4 livre ao mÃ©dico.</p>`
      },
      {
        tag: 'CapÃ­tulo 3 â€” PREMIUM',
        title: 'NutriÃ§Ã£o EstratÃ©gica: Menos NÃ£o Ã‰ Sempre Melhor',
        free: false,
        body: `<p>O erro mais comum da endomorfa Ã© cortar calorias demais. O resultado: perde mÃºsculo, o metabolismo desacelera ainda mais, e o reganho de peso vem com forÃ§a total.</p>
        <p><strong>Macros ideais para endomorfa com objetivo de definiÃ§Ã£o:</strong></p>
        <ul>
          <li>ProteÃ­nas: 35â€“40% â€” alto consumo proteico preserva mÃºsculo e aumenta saciedade</li>
          <li>Gorduras boas: 30â€“35% â€” azeite, abacate, oleaginosas, ovos inteiros</li>
          <li>Carboidratos: 25â€“30% â€” APENAS complexos: batata doce, arroz integral, legumes</li>
        </ul>
        <p><strong>Timing de carboidratos:</strong> concentre 80% dos carboidratos do dia nas refeiÃ§Ãµes prÃ© e pÃ³s-treino. Nos outros momentos, prefira proteÃ­nas e gorduras. Essa estratÃ©gia simples pode acelerar resultados sem necessidade de dieta muito restrita.</p>
        <p><strong>Elimine da dieta (pelo menos por 30 dias):</strong> aÃ§Ãºcar refinado, farinhas brancas, refrigerante, suco de caixinha, Ã¡lcool frequente. NÃ£o Ã© sobre "nunca mais" â€” Ã© sobre ver como seu corpo responde sem esses sabotadores.</p>`
      },
      {
        tag: 'CapÃ­tulo 4 â€” PREMIUM',
        title: 'O Treino que Transforma a Endomorfa',
        free: false,
        body: `<p>A endomorfa responde melhor a uma combinaÃ§Ã£o especÃ­fica de treino â€” e mais nÃ£o Ã© mais nesse caso.</p>
        <p><strong>EstratÃ©gia de treino para mÃ¡xima transformaÃ§Ã£o:</strong></p>
        <ul>
          <li><strong>MusculaÃ§Ã£o:</strong> 4 dias/semana, faixa de 10-15 reps com cargas moderadas a pesadas. Prioridade para grandes grupos: costas, glÃºteos, quadrÃ­ceps.</li>
          <li><strong>Cardio:</strong> 2-3x por semana de cardio moderado (30-40min). HIIT pode ser incluÃ­do 1x por semana para aumentar o metabolismo pÃ³s-treino (efeito EPOC).</li>
          <li><strong>Descanso:</strong> ao contrÃ¡rio do que parece, a endomorfa precisa de bom descanso. PrivaÃ§Ã£o de sono eleva cortisol â†’ aumenta retenÃ§Ã£o de gordura abdominal.</li>
        </ul>
        <p><strong>ProgressÃ£o de carga:</strong> a endomorfa tem excelente forÃ§a natural. Use isso a seu favor â€” progrida na carga regularmente. MÃºsculo constrÃ³i metabolismo. Mais mÃºsculo = mais calorias queimadas em repouso.</p>`
      },
      {
        tag: 'CapÃ­tulo 5 â€” PREMIUM',
        title: 'SaÃºde Hormonal e Resultados Duradouros',
        free: false,
        body: `<p>Para a endomorfa, a transformaÃ§Ã£o Ã© mais lenta â€” mas Ã© mais permanente quando feita do jeito certo. O segredo estÃ¡ na saÃºde hormonal de longo prazo.</p>
        <p><strong>Checklist semanal da endomorfa:</strong></p>
        <ul>
          <li>âœ… Bateu a proteÃ­na hoje? (mÃ­nimo 1.8g por kg de peso)</li>
          <li>âœ… Carboidratos concentrados no prÃ© e pÃ³s-treino?</li>
          <li>âœ… Dormiu 7-8 horas?</li>
          <li>âœ… Treinou com progressÃ£o de carga esta semana?</li>
          <li>âœ… Fez pelo menos 8.000 passos por dia (NEAT)?</li>
          <li>âœ… IngestÃ£o de Ã¡gua adequada? (mÃ­nimo 35ml por kg de peso)</li>
        </ul>
        <p><strong>SuplementaÃ§Ã£o para endomorfa:</strong></p>
        <ul>
          <li><strong>Creatina (5g/dia):</strong> aumenta forÃ§a, potencializa ganho muscular e melhora composiÃ§Ã£o corporal</li>
          <li><strong>Ã”mega-3 (2-3g/dia):</strong> melhora sensibilidade Ã  insulina, reduz inflamaÃ§Ã£o crÃ´nica</li>
          <li><strong>Inositol (2g 2x ao dia):</strong> estudos mostram melhora significativa na sensibilidade Ã  insulina e regulaÃ§Ã£o do ciclo â€” especialmente para quem tem SOP</li>
        </ul>
        <p><strong>Tempo realista para resultados:</strong> 3-4 meses para mudanÃ§as visÃ­veis na composiÃ§Ã£o. 6-8 meses para transformaÃ§Ã£o real e sustentÃ¡vel. A endomorfa que persiste Ã© a que mais impressiona â€” porque cada kg conquistado de mÃºsculo Ã© permanente.</p>`
      }
    ]
  }
};

let currentEbook = null;
let ebookUnlocked = false; // toggle to true when user pays

function openEbook(id) {
  currentEbook = id;
  const book = EBOOKS[id];
  if (!book) return;

  document.getElementById('reader-title').textContent = book.title;

  const freeChapters = book.chapters.filter(c => c.free);
  const premiumChapters = book.chapters.filter(c => !c.free);

  let html = '';

  // Free chapters
  freeChapters.forEach(ch => {
    html += `<div class="reader-chapter">
      <div class="reader-ch-tag">${ch.tag}</div>
      <div class="reader-ch-title">${ch.title}</div>
      <div class="reader-ch-body">${ch.body}</div>
    </div>`;
  });

  if (!ebookUnlocked) {
    // Teaser: first premium chapter faded out
    const first = premiumChapters[0];
    html += `<div class="reader-chapter" style="position:relative; max-height:200px; overflow:hidden; opacity:0.4;">
      <div class="reader-ch-tag">${first.tag}</div>
      <div class="reader-ch-title">${first.title}</div>
      <div class="reader-ch-body">${first.body}</div>
    </div>`;

    html += `<div class="reader-paywall">
      <div class="reader-paywall-card">
        <div style="font-size:32px; margin-bottom:12px;">ğŸ”’</div>
        <div style="font-family:'Bebas Neue'; font-size:22px; letter-spacing:1px; margin-bottom:8px;">DESBLOQUEIE O GUIA COMPLETO</div>
        <div style="font-size:13px; color:var(--muted2); margin-bottom:20px; line-height:1.6;">Mais 3 capÃ­tulos completos: NutriÃ§Ã£o EstratÃ©gica, Treino Ideal e SuplementaÃ§Ã£o.</div>
        <button class="btn btn-primary btn-full" onclick="unlockEbook()" style="margin-bottom:10px;">ğŸ’š Apoiar e desbloquear â€” R$ 9,90/mÃªs</button>
        <button class="btn btn-ghost btn-full" onclick="unlockEbookPix()">ğŸ“± Pix avulso (qualquer valor)</button>
        <div style="font-size:11px; color:var(--muted2); margin-top:12px;">ApÃ³s o apoio, toque em "JÃ¡ apoiei" para desbloquear</div>
        <button class="btn btn-ghost btn-full" style="margin-top:8px; font-size:12px; border-color:var(--green); color:var(--green);" onclick="unlockTemporary()">âœ“ JÃ¡ apoiei â€” desbloquear</button>
      </div>
    </div>`;
  } else {
    premiumChapters.forEach(ch => {
      html += `<div class="reader-chapter">
        <div class="reader-ch-tag">${ch.tag}</div>
        <div class="reader-ch-title">${ch.title}</div>
        <div class="reader-ch-body">${ch.body}</div>
      </div>`;
    });
  }

  document.getElementById('reader-content').innerHTML = html;
  document.getElementById('ebook-reader').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeEbook() {
  document.getElementById('ebook-reader').classList.remove('open');
  document.body.style.overflow = '';
}

function unlockEbook() {
  // Link to subscription page
  showNotif('ğŸ’š', 'Assinatura', 'VocÃª serÃ¡ redirecionado para a pÃ¡gina de assinatura', 'success');
  // window.open('https://seulink.apoia.se', '_blank');
}

function unlockEbookPix() {
  showNotif('ğŸ“±', 'Pix', 'Copie a chave Pix e volte aqui para desbloquear', 'success');
}

function unlockTemporary() {
  ebookUnlocked = true;
  if (currentEbook) openEbook(currentEbook);
  showNotif('ğŸ‰', 'Desbloqueado!', 'Obrigado pelo apoio! ConteÃºdo completo liberado.', 'success');
}

function downloadCurrentPDF() {
  if (currentEbook) downloadEbookPDF(currentEbook);
}

function downloadEbookPDF(id) {
  const book = EBOOKS[id];
  if (!book) return;

  if (!ebookUnlocked) {
    showNotif('ğŸ”’', 'ConteÃºdo premium', 'Apoie o projeto para baixar o PDF completo', 'warning');
    return;
  }

  // Generate printable HTML and trigger print-to-PDF
  const chapters = book.chapters;
  let printHTML = `<!DOCTYPE html><html lang="pt-BR"><head>
    <meta charset="UTF-8">
    <style>
      body { font-family: Georgia, serif; max-width: 680px; margin: 40px auto; padding: 0 20px; color: #1a1a1a; line-height: 1.8; }
      h1 { font-size: 36px; margin-bottom: 4px; }
      .sub { color: #888; font-size: 14px; margin-bottom: 48px; }
      h2 { font-size: 11px; letter-spacing: 3px; text-transform: uppercase; color: #e85c00; margin-bottom: 4px; margin-top: 40px; }
      h3 { font-size: 24px; margin-bottom: 16px; }
      p { margin-bottom: 12px; }
      ul { padding-left: 20px; margin-bottom: 12px; }
      li { margin-bottom: 6px; }
      hr { border: none; border-top: 1px solid #eee; margin: 40px 0; }
    </style></head><body>
    <h1>${book.emoji} ${book.title}</h1>
    <div class="sub">Guia Completo Â· Biotipos Femininos Â· PROGRESSAR</div>`;

  chapters.forEach((ch, i) => {
    printHTML += `<h2>${ch.tag}</h2><h3>${ch.title}</h3>${ch.body}${i < chapters.length - 1 ? '<hr>' : ''}`;
  });

  printHTML += '</body></html>';

  const w = window.open('', '_blank');
  w.document.write(printHTML);
  w.document.close();
  w.focus();
  setTimeout(() => w.print(), 500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
load();

if (state.user) {
  document.getElementById('onboarding-screen').style.display = 'none';
  document.getElementById('app-screen').style.display = 'flex';
  initApp();
}
</script>
  <!-- PWA Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('SW registrado:', reg.scope))
          .catch(err => console.log('SW erro:', err));
      });
    }

    // Install prompt â€” mostra botÃ£o "Instalar app" quando disponÃ­vel
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      const btn = document.getElementById('install-btn');
      if (btn) btn.style.display = 'flex';
    });

    window.addEventListener('appinstalled', () => {
      deferredPrompt = null;
      const btn = document.getElementById('install-btn');
      if (btn) btn.style.display = 'none';
      showNotif('ğŸ‰', 'App instalado!', 'PROGRESSAR foi adicionado Ã  sua tela inicial', 'success');
    });

    function installApp() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(choice => {
          deferredPrompt = null;
        });
      }
    }
  </script>
</body>
</html>