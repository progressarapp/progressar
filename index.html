<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PROGRESSAR ‚Äî Progress√£o de Carga Inteligente</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="PROGRESSAR">
  <link rel="apple-touch-icon" href="icons/icon-192.svg">
  <meta name="theme-color" content="#FF5C00">
  <meta name="description" content="App de progress√£o de carga baseado no M√©todo Paulo Muzy. Sem planilha, sem achismo.">
  <meta property="og:title" content="PROGRESSAR ‚Äî Progress√£o Inteligente">
  <meta property="og:description" content="Coach virtual, cardio inteligente, modo iniciante e progress√£o autom√°tica.">
  <meta property="og:type" content="website">
<style>
  /* (mesmo estilo do original, sem altera√ß√µes) */
  :root {
    --orange: #FF5C00;
    --orange-dim: #FF5C0022;
    --orange-mid: #FF5C0055;
    --dark: #0A0A0A;
    --darker: #060606;
    --card: #111111;
    --card2: #161616;
    --border: #222222;
    --border2: #2A2A2A;
    --text: #F0F0F0;
    --muted: #666666;
    --muted2: #888888;
    --green: #00E676;
    --green-dim: #00E67622;
    --blue: #448AFF;
    --blue-dim: #448AFF22;
    --red: #FF5252;
    --red-dim: #FF525222;
    --yellow: #FFD740;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--darker);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 9999;
    opacity: 0.4;
  }

  .app { display: flex; height: 100vh; }

  .sidebar {
    width: 68px;
    background: var(--card);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 0;
    gap: 8px;
    position: fixed;
    left: 0; top: 0; bottom: 0;
    z-index: 200;
  }

  .logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    color: var(--orange);
    writing-mode: vertical-rl;
    transform: rotate(180deg);
    letter-spacing: 4px;
    margin-bottom: 24px;
    cursor: pointer;
  }

  .nav-btn {
    width: 44px; height: 44px;
    border-radius: 12px;
    border: 1px solid transparent;
    background: transparent;
    color: var(--muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s;
    position: relative;
  }

  .nav-btn:hover { background: var(--border); color: var(--text); }
  .nav-btn.active {
    background: var(--orange-dim);
    border-color: var(--orange-mid);
    color: var(--orange);
  }

  .nav-btn .tooltip {
    position: absolute;
    left: 54px;
    background: var(--card2);
    border: 1px solid var(--border2);
    color: var(--text);
    font-size: 12px;
    padding: 4px 10px;
    border-radius: 6px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s;
  }

  .nav-btn:hover .tooltip { opacity: 1; }

  .main {
    margin-left: 68px;
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .view { display: none; animation: fadeIn 0.3s ease; }
  .view.active { display: block; }

  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  .page-header {
    padding: 32px 32px 0;
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
  }

  .page-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 48px;
    color: var(--text);
    letter-spacing: 2px;
    line-height: 1;
  }

  .page-subtitle { font-size: 14px; color: var(--muted2); margin-top: 4px; }

  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 20px;
  }

  .card-sm { padding: 16px; border-radius: 12px; }

  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px; }

  .btn {
    font-family: 'DM Sans', sans-serif;
    font-weight: 600;
    font-size: 14px;
    padding: 10px 20px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
  }

  .btn-primary {
    background: var(--orange);
    color: white;
  }
  .btn-primary:hover { background: #FF7020; transform: translateY(-1px); box-shadow: 0 4px 20px var(--orange-mid); }

  .btn-ghost {
    background: transparent;
    border: 1px solid var(--border2);
    color: var(--muted2);
  }
  .btn-ghost:hover { background: var(--card2); color: var(--text); }

  .btn-success {
    background: var(--green-dim);
    border: 1px solid var(--green);
    color: var(--green);
  }
  .btn-success:hover { background: var(--green); color: var(--dark); }

  .btn-full { width: 100%; justify-content: center; }
  .btn-lg { padding: 14px 28px; font-size: 16px; border-radius: 14px; }

  .tag {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    font-weight: 600;
    padding: 3px 8px;
    border-radius: 6px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .tag-orange { background: var(--orange-dim); color: var(--orange); border: 1px solid var(--orange-mid); }
  .tag-green { background: var(--green-dim); color: var(--green); }
  .tag-blue { background: var(--blue-dim); color: var(--blue); }
  .tag-red { background: var(--red-dim); color: var(--red); }

  input, select {
    background: var(--card2);
    border: 1px solid var(--border2);
    border-radius: 10px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    padding: 10px 14px;
    width: 100%;
    outline: none;
    transition: border-color 0.2s;
  }

  input:focus, select:focus { border-color: var(--orange); }
  input[type=number] { font-family: 'DM Mono', monospace; }

  select option { background: var(--card2); }

  label { font-size: 12px; color: var(--muted2); font-weight: 500; margin-bottom: 6px; display: block; }

  .sep { border: none; border-top: 1px solid var(--border); margin: 24px 0; }

  .stat-number {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 52px;
    color: var(--orange);
    line-height: 1;
  }

  .stat-label { font-size: 12px; color: var(--muted2); text-transform: uppercase; letter-spacing: 1px; margin-top: 4px; }

  .progress-bar {
    height: 6px;
    background: var(--border2);
    border-radius: 99px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--orange);
    border-radius: 99px;
    transition: width 0.5s ease;
  }

  .progress-fill.green { background: var(--green); }

  .exercise-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }

  .exercise-row:hover { border-color: var(--orange-mid); background: #1A1A1A; }
  .exercise-row.selected { border-color: var(--orange); background: var(--orange-dim); }

  .exercise-icon {
    width: 40px; height: 40px;
    background: var(--border);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    flex-shrink: 0;
  }

  .exercise-name { font-weight: 600; font-size: 14px; }
  .exercise-meta { font-size: 12px; color: var(--muted2); margin-top: 2px; }

  .set-row {
    display: grid;
    grid-template-columns: 36px 1fr 1fr 40px;
    gap: 8px;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }

  .set-number {
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    color: var(--muted);
    text-align: center;
    background: var(--border);
    border-radius: 6px;
    padding: 4px 0;
  }

  .set-number.done { background: var(--green-dim); color: var(--green); }

  .chart-container {
    position: relative;
    width: 100%;
    height: 160px;
  }

  canvas { width: 100% !important; }

  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: var(--card);
    border: 1px solid var(--border2);
    border-radius: 14px;
    padding: 14px 18px;
    max-width: 320px;
    z-index: 9998;
    transform: translateX(400px);
    transition: transform 0.3s ease;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }

  .notification.show { transform: translateX(0); }
  .notification-icon { font-size: 22px; }
  .notification-title { font-weight: 700; font-size: 14px; margin-bottom: 2px; }
  .notification-msg { font-size: 13px; color: var(--muted2); }
  .notification.success { border-color: var(--green); }
  .notification.warning { border-color: var(--yellow); }

  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.78);
    backdrop-filter: blur(4px);
    z-index: 9999;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 20px 14px;
    box-sizing: border-box;
  }
  .modal-overlay.open { display: flex; }

  /* Bottom sheet ‚Äî apenas coach, tecnica e rest */
  #coach-modal.open,
  #tecnica-modal.open,
  #rest-modal.open {
    align-items: flex-end;
    padding: 0;
  }

  .modal {
    background: var(--card);
    border: 1px solid var(--border2);
    border-radius: 20px;
    padding: 24px 22px;
    width: 100%;
    max-width: 500px;
    max-height: 85vh;
    overflow-y: auto;
    margin: 0 auto;
    box-sizing: border-box;
    animation: slideUp 0.25s ease;
  }

  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  .modal-title { font-family: 'Bebas Neue', sans-serif; font-size: 28px; margin-bottom: 20px; letter-spacing: 1px; }

  .timer-display {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 64px;
    color: var(--orange);
    text-align: center;
    letter-spacing: 4px;
    line-height: 1;
  }

  .timer-label { text-align: center; font-size: 12px; color: var(--muted2); text-transform: uppercase; letter-spacing: 2px; margin-top: 4px; }

  .workout-header {
    background: linear-gradient(135deg, #1A0800 0%, #0F0F0F 100%);
    border-bottom: 1px solid var(--border);
    padding: 20px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .progress-arrow {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    font-size: 13px;
    font-weight: 700;
  }

  .progress-arrow.up { color: var(--green); }
  .progress-arrow.same { color: var(--yellow); }
  .progress-arrow.down { color: var(--red); }

  .suggestion-box {
    background: linear-gradient(135deg, #1A0D00 0%, #111111 100%);
    border: 1px solid var(--orange-mid);
    border-radius: 16px;
    padding: 20px;
  }

  .suggestion-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    color: var(--orange);
    letter-spacing: 1px;
    margin-bottom: 12px;
  }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 99px; }

  .section { padding: 24px 32px; }

  .section-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    color: var(--muted2);
    letter-spacing: 2px;
    margin-bottom: 16px;
  }

  .onboarding-bg {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: radial-gradient(ellipse at 30% 50%, #1A0D00 0%, var(--darker) 60%);
    padding: 32px;
  }

  .onboarding-card {
    background: var(--card);
    border: 1px solid var(--border2);
    border-radius: 24px;
    padding: 40px;
    max-width: 440px;
    width: 100%;
    text-align: center;
  }

  .onboarding-logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 56px;
    color: var(--orange);
    letter-spacing: 6px;
    margin-bottom: 8px;
  }

  .step { display: none; }
  .step.active { display: block; }

  .step-dots {
    display: flex;
    gap: 6px;
    justify-content: center;
    margin-bottom: 28px;
  }

  .dot {
    width: 6px; height: 6px;
    border-radius: 99px;
    background: var(--border2);
    transition: all 0.3s;
  }
  .dot.active { background: var(--orange); width: 20px; }

  .muscle-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }

  .muscle-btn {
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 10px;
    cursor: pointer;
    transition: all 0.2s;
    text-align: center;
    font-size: 12px;
    color: var(--muted2);
  }

  .muscle-btn:hover, .muscle-btn.active {
    background: var(--orange-dim);
    border-color: var(--orange);
    color: var(--orange);
  }

  .muscle-btn .emoji { font-size: 20px; display: block; margin-bottom: 4px; }

  .ring-chart {
    position: relative;
    width: 80px; height: 80px;
    flex-shrink: 0;
  }

  .ring-chart svg { transform: rotate(-90deg); }
  .ring-chart .ring-value {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    color: var(--orange);
  }

  @media (max-width: 768px) {
    .sidebar {
      width: 100% !important;
      height: 60px !important;
      top: auto !important;
      bottom: 0 !important;
      left: 0 !important;
      right: 0 !important;
      flex-direction: row !important;
      justify-content: space-around !important;
      align-items: center !important;
      padding: 0 8px !important;
      border-right: none !important;
      border-top: 1px solid var(--border) !important;
      gap: 0 !important;
      z-index: 1000 !important;
    }

    .sidebar .logo { display: none !important; }

    .main {
      margin-left: 0 !important;
      margin-bottom: 60px !important;
      width: 100% !important;
    }

    .nav-btn .tooltip { display: none !important; }

    .nav-btn {
      width: 48px !important;
      height: 48px !important;
      border-radius: 12px !important;
      font-size: 20px !important;
    }

    .grid-2, .grid-3 { grid-template-columns: 1fr !important; }

    .section { padding: 16px !important; }
    .page-header { padding: 16px 16px 0 !important; }

    .page-title { font-size: 36px !important; }

    #active-workout-view .card { margin-left: 0 !important; margin-right: 0 !important; }

    .modal-overlay {
      padding: 12px !important;
      align-items: center !important;
    }

    /* Bottom sheets ‚Äî coach, tecnica, rest ficam na base */
    #coach-modal,
    #tecnica-modal,
    #rest-modal {
      padding: 0 !important;
      align-items: flex-end !important;
    }
    #coach-modal > div,
    #tecnica-modal > div,
    #rest-modal > div {
      width: 100% !important;
      border-radius: 22px 22px 0 0 !important;
      max-height: 90vh !important;
      overflow-y: auto !important;
      padding-bottom: 32px !important;
    }

    .modal {
      width: 100% !important;
      max-width: 100% !important;
      max-height: 80vh !important;
      overflow-y: auto !important;
      border-radius: 16px !important;
      padding: 18px 14px 22px !important;
    }

    .grid-2 { grid-template-columns: 1fr 1fr !important; }
    .execution-btn { font-size: 11px !important; padding: 9px 4px !important; }
    .num-input-wrap input { font-size: 16px !important; }
    .num-btn { width: 38px !important; height: 42px !important; font-size: 17px !important; }
  }

  @keyframes pulse-orange {
    0%, 100% { box-shadow: 0 0 0 0 var(--orange-mid); }
    50% { box-shadow: 0 0 0 8px transparent; }
  }

  .pulse { animation: pulse-orange 2s infinite; }

  .num-input-wrap {
    display: flex;
    align-items: center;
    gap: 0;
    background: var(--card2);
    border: 1px solid var(--border2);
    border-radius: 10px;
    overflow: hidden;
  }

  .num-input-wrap input {
    border: none;
    border-radius: 0;
    text-align: center;
    background: transparent;
  }

  .num-btn {
    width: 36px;
    height: 40px;
    background: var(--border);
    border: none;
    color: var(--text);
    font-size: 18px;
    cursor: pointer;
    transition: background 0.2s;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .num-btn:hover { background: var(--border2); }

  .wb-step-indicator { display:flex; flex-direction:column; align-items:center; gap:4px; flex-shrink:0; }
  .wb-step-circle { width:28px; height:28px; border-radius:50%; background:var(--border2); color:var(--muted); font-size:13px; font-weight:700; display:flex; align-items:center; justify-content:center; transition:all 0.3s; }
  .wb-step-indicator.active .wb-step-circle { background:var(--orange); color:white; }
  .wb-step-indicator.done .wb-step-circle { background:var(--green); color:var(--dark); }
  .wb-step-label { font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; white-space:nowrap; }
  .wb-step-indicator.active .wb-step-label { color:var(--orange); }
  .wb-step-indicator.done .wb-step-label { color:var(--green); }
  .wb-step-line { flex:1; height:2px; background:var(--border2); margin:0 8px; margin-bottom:14px; transition:background 0.3s; }
  .wb-step-line.done { background:var(--green); }
  .day-pill { background:var(--card2); border:1px solid var(--border2); border-radius:8px; color:var(--muted2); font-size:11px; font-weight:600; padding:8px 4px; cursor:pointer; transition:all 0.2s; font-family:'DM Sans',sans-serif; text-align:center; }
  .day-pill:hover { border-color:var(--orange-mid); color:var(--text); }
  .day-pill.selected { background:var(--orange); border-color:var(--orange); color:white; }
  .wb-ex-row { display:flex; align-items:center; gap:10px; padding:10px 12px; background:var(--card2); border:1px solid var(--border); border-radius:10px; cursor:pointer; transition:all 0.15s; user-select:none; }
  .wb-ex-row:hover { border-color:var(--orange-mid); }
  .wb-ex-row.selected { border-color:var(--orange); background:var(--orange-dim); }
  .wb-ex-check { width:20px; height:20px; border-radius:6px; border:2px solid var(--border2); display:flex; align-items:center; justify-content:center; font-size:12px; flex-shrink:0; transition:all 0.15s; }
  .wb-ex-row.selected .wb-ex-check { background:var(--orange); border-color:var(--orange); color:white; }

  /* ‚îÄ‚îÄ BIBLIOTECA / DB CSS ‚îÄ‚îÄ */
  .musculo-card {
    background: var(--card2);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .musculo-card:hover { border-color: var(--orange-mid); background: var(--orange-dim); }

  .ex-db-card {
    background: var(--card);
    border: 1px solid var(--border2);
    border-radius: 14px;
    padding: 16px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .ex-db-card:hover { border-color: var(--orange-mid); transform: translateX(3px); }
  .ex-db-card.expanded { border-color: var(--orange); }

  .ex-ficha {
    overflow: hidden;
    max-height: 0;
    transition: max-height 0.35s ease;
  }
  .ex-ficha.open { max-height: 600px; }

  .overlap-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: rgba(255,200,0,0.1);
    color: var(--yellow);
    border-radius: 6px;
    padding: 2px 7px;
    font-size: 11px;
    font-weight: 700;
  }

  .filter-tabs {
    display: flex;
    gap: 6px;
    overflow-x: auto;
    padding-bottom: 4px;
    margin-bottom: 16px;
    scrollbar-width: none;
  }
  .filter-tabs::-webkit-scrollbar { display: none; }
  .filter-tab {
    flex-shrink: 0;
    background: var(--card2);
    border: 1px solid var(--border2);
    border-radius: 20px;
    padding: 6px 14px;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted2);
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }
  .filter-tab.active { background: var(--orange); border-color: var(--orange); color: white; }

  /* ‚îÄ‚îÄ EBOOK COMPONENTS ‚îÄ‚îÄ */
  .ebook-card {
    background: var(--card);
    border: 1px solid var(--border2);
    border-radius: 20px;
    overflow: hidden;
    margin-bottom: 16px;
    transition: all 0.25s;
  }
  .ebook-card:hover { border-color: var(--orange-mid); transform: translateY(-2px); box-shadow: 0 12px 32px rgba(0,0,0,0.4); }

  .ebook-cover {
    width: 100%;
    height: 160px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    font-family: 'Bebas Neue', sans-serif;
    letter-spacing: 2px;
    position: relative;
    overflow: hidden;
  }
  .ebook-cover::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(to bottom, transparent 40%, rgba(0,0,0,0.6));
  }

  .ebook-cover-emoji { font-size: 48px; margin-bottom: 8px; position: relative; z-index: 1; }
  .ebook-cover-title { font-size: 18px; color: white; position: relative; z-index: 1; text-shadow: 0 2px 8px rgba(0,0,0,0.5); }
  .ebook-cover-sub { font-size: 11px; color: rgba(255,255,255,0.7); position: relative; z-index: 1; letter-spacing: 3px; font-family: 'DM Sans', sans-serif; font-weight: 600; }

  .ebook-body { padding: 16px; }
  .ebook-title { font-weight: 700; font-size: 16px; margin-bottom: 4px; }
  .ebook-desc { font-size: 13px; color: var(--muted2); margin-bottom: 14px; line-height: 1.5; }
  .ebook-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 14px; }
  .ebook-lock { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--muted2); }

  /* Reader */
  .ebook-reader {
    position: fixed;
    inset: 0;
    background: var(--darker);
    z-index: 500;
    display: flex;
    flex-direction: column;
    transform: translateY(100%);
    transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
  }
  .ebook-reader.open { transform: translateY(0); }

  .reader-header {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-shrink: 0;
  }
  .reader-title { font-family: 'Bebas Neue', sans-serif; font-size: 18px; letter-spacing: 1px; flex: 1; }
  .reader-content { flex: 1; overflow-y: auto; padding: 24px 20px; max-width: 680px; margin: 0 auto; width: 100%; }

  .reader-chapter {
    margin-bottom: 32px;
    padding-bottom: 32px;
    border-bottom: 1px solid var(--border);
  }
  .reader-chapter:last-child { border-bottom: none; }

  .reader-ch-tag { font-size: 10px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--orange); margin-bottom: 6px; }
  .reader-ch-title { font-family: 'Bebas Neue', sans-serif; font-size: 24px; letter-spacing: 1px; margin-bottom: 14px; }
  .reader-ch-body { font-size: 14px; line-height: 1.8; color: var(--muted2); }
  .reader-ch-body p { margin-bottom: 12px; }
  .reader-ch-body strong { color: var(--text); }
  .reader-ch-body ul { padding-left: 18px; margin-bottom: 12px; }
  .reader-ch-body li { margin-bottom: 6px; }

  .reader-paywall {
    background: linear-gradient(to bottom, transparent, var(--darker) 40%);
    position: sticky;
    bottom: 0;
    padding: 60px 20px 24px;
    text-align: center;
    margin-top: -80px;
  }
  .reader-paywall-card {
    background: var(--card);
    border: 1px solid var(--orange-mid);
    border-radius: 16px;
    padding: 24px 20px;
    max-width: 400px;
    margin: 0 auto;
  }

  /* ‚îÄ‚îÄ LEVEL BUTTONS (onboarding) ‚îÄ‚îÄ */
  .level-btn {
    display: flex; align-items: center; gap: 14px; padding: 16px;
    background: var(--card2); border: 2px solid var(--border2);
    border-radius: 14px; cursor: pointer; transition: all 0.2s;
    width: 100%; text-align: left; font-family: 'DM Sans', sans-serif; color: var(--text);
  }
  .level-btn:hover { border-color: var(--orange-mid); background: var(--orange-dim); }
  .level-btn.selected { border-color: var(--orange); background: var(--orange-dim); }
  .level-btn .level-title { font-weight: 700; font-size: 15px; }
  .level-btn .level-desc  { font-size: 12px; color: var(--muted2); margin-top: 2px; }

  .type-btn {
    display: flex; flex-direction: column; align-items: center; gap: 5px;
    padding: 14px 8px; background: var(--card2); border: 2px solid var(--border2);
    border-radius: 12px; cursor: pointer; transition: all 0.2s;
    font-family: 'DM Sans', sans-serif; color: var(--muted2); font-size: 13px; font-weight: 600;
  }
  .type-btn:hover { border-color: var(--orange-mid); }
  .type-btn.active { border-color: var(--orange); background: var(--orange-dim); color: var(--orange); }

  .cardio-fields {
    background: var(--card2); border-radius: 12px; padding: 14px;
    margin-top: 8px; border: 1px solid var(--border); animation: fadeIn 0.2s ease;
  }

  .effort-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 14px 8px;
    background: var(--card2);
    border: 1.5px solid var(--border2);
    border-radius: 14px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    font-size: 12px;
    font-weight: 700;
    color: var(--muted2);
    transition: all 0.2s;
    width: 100%;
  }
  .effort-btn:hover { border-color: var(--orange-mid); color: var(--text); }
  .effort-btn.selected-facil  { background: var(--green-dim);  border-color: var(--green);  color: var(--green); }
  .effort-btn.selected-certo  { background: var(--orange-dim); border-color: var(--orange); color: var(--orange); }
  .effort-btn.selected-pesado { background: rgba(255,82,82,0.12); border-color: var(--red); color: var(--red); }

  .execution-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    padding: 12px 8px;
    background: var(--card2);
    border: 1.5px solid var(--border2);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'DM Sans', sans-serif;
    color: var(--muted2);
    width: 100%;
  }
  .execution-btn:hover { border-color: var(--orange-mid); color: var(--text); }
  .execution-btn.active {
    background: var(--orange-dim);
    border-color: var(--orange);
    color: var(--orange);
  }
  .execution-btn.active span:last-child { color: var(--orange) !important; opacity: 0.8; }

  .rest-preset-btn {
    background: var(--card2);
    border: 1px solid var(--border2);
    border-radius: 8px;
    color: var(--muted2);
    font-size: 12px;
    font-weight: 600;
    padding: 7px 12px;
    cursor: pointer;
    font-family: 'DM Mono', monospace;
    transition: all 0.15s;
  }
  .rest-preset-btn:hover { border-color: var(--orange-mid); color: var(--text); }
  .rest-preset-btn.active { background: var(--orange-dim); border-color: var(--orange); color: var(--orange); }

  #pre-workout-modal {
    align-items: flex-end;
    padding-bottom: 0;
  }
  .pwm-option {
    background: var(--card2);
    border: 2px solid var(--border2);
    border-radius: 14px;
    padding: 16px 10px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'DM Sans', sans-serif;
    color: var(--text);
    text-align: center;
  }
  .pwm-option:hover { border-color: var(--orange-mid); }
  .pwm-option.selected { border-color: var(--orange); background: var(--orange-dim); }

  .pwm-load-btn {
    background: var(--card2);
    border: 2px solid var(--border2);
    border-radius: 12px;
    padding: 12px 8px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    color: var(--text);
    text-align: center;
    transition: all 0.2s;
    font-size: 12px;
  }
  .pwm-load-btn:hover { border-color: var(--orange-mid); }
  .pwm-load-btn.selected { border-color: var(--orange); background: var(--orange-dim); color: var(--orange); font-weight: 700; }

  .set-row {
    display: grid;
    grid-template-columns: 36px 1fr 1fr 44px;
    gap: 8px;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }
  .set-num {
    width: 36px; height: 36px;
    border-radius: 50%;
    background: var(--border);
    display: flex; align-items: center; justify-content: center;
    font-family: 'DM Mono', monospace;
    font-size: 13px;
    font-weight: 700;
    transition: all 0.2s;
    flex-shrink: 0;
  }
  .set-num.done { background: var(--green); color: var(--dark); }
  .set-done-btn {
    width: 44px; height: 44px;
    border-radius: 10px;
    border: 2px solid var(--border2);
    background: transparent;
    color: var(--muted2);
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex; align-items: center; justify-content: center;
  }
  .set-done-btn.done { background: var(--green); border-color: var(--green); color: var(--dark); }
</style>
</head>
<body>

<!-- NOTIFICATION -->
<div class="notification" id="notification">
  <div class="notification-icon" id="notif-icon">üéØ</div>
  <div>
    <div class="notification-title" id="notif-title">T√≠tulo</div>
    <div class="notification-msg" id="notif-msg">Mensagem</div>
  </div>
</div>

<!-- COACH VIRTUAL MODAL -->
<div class="modal-overlay" id="coach-modal" style="align-items:flex-end; padding-bottom:0;">
  <div style="background:var(--card); border:1px solid var(--border2); border-radius:24px 24px 0 0; padding:28px 24px 40px; width:100%; max-width:480px;">
    <div style="width:40px; height:4px; background:var(--border2); border-radius:99px; margin:0 auto 20px;"></div>
    <div style="display:flex; align-items:center; gap:12px; margin-bottom:16px;">
      <div style="font-size:36px;">ü§ñ</div>
      <div>
        <div style="font-family:'Bebas Neue'; font-size:22px; letter-spacing:1px; color:var(--orange);">COACH VIRTUAL</div>
        <div style="font-size:12px; color:var(--muted2);" id="coach-ex-name">Exerc√≠cio</div>
      </div>
    </div>

    <div style="font-size:13px; color:var(--muted2); margin-bottom:10px; text-transform:uppercase; letter-spacing:1px; font-weight:700;">Como foi esse exerc√≠cio?</div>
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:20px;">
      <button class="effort-btn" data-effort="facil" onclick="selectEffort('facil')" aria-label="F√°cil">
        <span style="font-size:22px;">üòä</span>
        <span>F√°cil</span>
      </button>
      <button class="effort-btn" data-effort="certo" onclick="selectEffort('certo')" aria-label="Certo">
        <span style="font-size:22px;">üí™</span>
        <span>Certo</span>
      </button>
      <button class="effort-btn" data-effort="pesado" onclick="selectEffort('pesado')" aria-label="Pesado">
        <span style="font-size:22px;">üî•</span>
        <span>Pesado</span>
      </button>
    </div>

    <div id="coach-suggestion" style="display:none; background:var(--orange-dim); border:1px solid var(--orange-mid); border-radius:14px; padding:16px; margin-bottom:16px;">
      <div style="font-size:11px; font-weight:800; color:var(--orange); letter-spacing:2px; margin-bottom:6px;">PR√ìXIMO TREINO</div>
      <div style="font-size:20px; font-weight:800; color:var(--white);" id="coach-next-weight">Use Xkg</div>
      <div style="font-size:12px; color:var(--muted2); margin-top:4px;" id="coach-reason"></div>
    </div>

    <div id="coach-tecnica-invite" style="display:none; background:var(--card2); border:1px solid var(--border2); border-radius:14px; padding:16px; margin-bottom:16px;">
      <div style="font-size:14px; font-weight:700; color:var(--text); margin-bottom:12px; line-height:1.5;">
        ‚ö° Voc√™ est√° com energia! Quer fechar com uma <span style="color:var(--orange);">T√©cnica Avan√ßada</span> para acelerar os ganhos?
      </div>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-ghost" style="flex:1;" onclick="closeCoach()">N√£o, obrigado</button>
        <button class="btn btn-primary" style="flex:1;" onclick="showTecnica()" id="coach-sim-btn">Sim, quero! ‚Üí</button>
      </div>
    </div>

    <button class="btn btn-ghost btn-full" style="margin-top:4px;" onclick="closeCoach()">Fechar</button>
  </div>
</div>

<!-- T√âCNICA AVAN√áADA MODAL -->
<div class="modal-overlay" id="tecnica-modal" style="align-items:flex-end; padding-bottom:0;">
  <div style="background:var(--card); border:1px solid var(--border2); border-radius:24px 24px 0 0; padding:28px 24px 40px; width:100%; max-width:480px; max-height:85vh; overflow-y:auto;">
    <div style="width:40px; height:4px; background:var(--border2); border-radius:99px; margin:0 auto 20px;"></div>
    <div style="display:flex; align-items:center; gap:12px; margin-bottom:20px;">
      <div style="font-size:36px;" id="tecnica-icon">‚ö°</div>
      <div>
        <div style="font-family:'Bebas Neue'; font-size:22px; letter-spacing:1px; color:var(--orange);" id="tecnica-nome">T√âCNICA</div>
        <div style="font-size:12px; color:var(--muted2);">T√©cnica avan√ßada ¬∑ N√≠vel <span id="tecnica-nivel"></span></div>
      </div>
    </div>

    <div style="background:var(--green-dim); border:1px solid var(--green); border-radius:12px; padding:14px; margin-bottom:14px;">
      <div style="font-size:10px; font-weight:800; color:var(--green); letter-spacing:2px; margin-bottom:6px;">POR QU√ä FUNCIONA</div>
      <div style="font-size:13px; color:var(--text); line-height:1.6;" id="tecnica-porque"></div>
    </div>

    <div style="background:var(--blue-dim); border:1px solid var(--blue); border-radius:12px; padding:14px; margin-bottom:20px;">
      <div style="font-size:10px; font-weight:800; color:var(--blue); letter-spacing:2px; margin-bottom:6px;">COMO EXECUTAR</div>
      <div id="tecnica-como" style="font-size:13px; color:var(--text); line-height:1.6;"></div>
    </div>

    <button class="btn btn-primary btn-full btn-lg" onclick="closeTecnica()">Entendido! Vou aplicar üí™</button>
    <button class="btn btn-ghost btn-full" style="margin-top:8px;" onclick="closeTecnica()">Pular desta vez</button>
  </div>
</div>

<!-- BOT√ÉO FLUTUANTE APOIAR -->
<div id="fab-wrapper" style="position:fixed; bottom:72px; right:16px; z-index:900; display:flex; align-items:center; gap:6px;">
  <button onclick="document.getElementById('fab-wrapper').style.display='none'"
    style="background:rgba(0,0,0,0.6); border:1px solid var(--border2); color:var(--muted2); border-radius:99px; width:24px; height:24px; cursor:pointer; font-size:11px; display:flex; align-items:center; justify-content:center; padding:0;" aria-label="Fechar">‚úï</button>
  <a id="fab-support" href="https://wa.me/?text=Quero%20apoiar%20o%20PROGRESSAR!" target="_blank"
     style="background:var(--orange); color:white; border-radius:99px; padding:11px 16px; font-family:'DM Sans',sans-serif; font-size:12px; font-weight:700; text-decoration:none; display:flex; align-items:center; gap:6px; box-shadow:0 4px 20px rgba(255,92,0,0.4); white-space:nowrap;">
    üíö Apoiar o Projeto
  </a>
</div>

<!-- MODAL REST TIMER -->
<div class="modal-overlay" id="rest-modal" style="align-items:flex-end; padding-bottom:0;">
  <div style="background:var(--card); border:1px solid var(--border2); border-radius:24px 24px 0 0; padding:32px 28px 36px; width:100%; max-width:480px; text-align:center; animation:slideUp 0.3s ease;">
    <div style="width:48px; height:4px; background:var(--border2); border-radius:99px; margin:0 auto 24px;"></div>
    <div style="font-size:12px; color:var(--muted2); text-transform:uppercase; letter-spacing:2px; margin-bottom:4px;" id="rest-ex-name">DESCANSO</div>
    <div style="font-size:14px; color:var(--muted2); margin-bottom:20px;" id="rest-serie-info">Pr√≥xima s√©rie em breve</div>

    <div style="position:relative; width:160px; height:160px; margin:0 auto 24px;">
      <svg width="160" height="160" viewBox="0 0 160 160" style="transform:rotate(-90deg);">
        <circle cx="80" cy="80" r="68" fill="none" stroke="var(--border2)" stroke-width="8"/>
        <circle cx="80" cy="80" r="68" fill="none" stroke="var(--orange)" stroke-width="8"
          stroke-dasharray="427" id="rest-ring" stroke-dashoffset="0" stroke-linecap="round"
          style="transition:stroke-dashoffset 1s linear;"/>
      </svg>
      <div style="position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div class="timer-display" id="timer-display" style="font-size:52px;">01:30</div>
        <div style="font-size:11px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px;">restando</div>
      </div>
    </div>

    <div style="display:flex; gap:6px; justify-content:center; margin-bottom:20px;" id="rest-presets">
      <button class="rest-preset-btn" onclick="setRestTimer(45)">45s</button>
      <button class="rest-preset-btn" onclick="setRestTimer(60)">1min</button>
      <button class="rest-preset-btn active" onclick="setRestTimer(90)" id="preset-active">1:30</button>
      <button class="rest-preset-btn" onclick="setRestTimer(120)">2min</button>
      <button class="rest-preset-btn" onclick="setRestTimer(180)">3min</button>
    </div>

    <div style="display:flex; gap:8px;">
      <button class="btn btn-ghost" style="flex:1;" onclick="addTime(-15)">‚àí15s</button>
      <button class="btn btn-primary" style="flex:2;" onclick="skipTimer()">Pular descanso ‚Üí</button>
      <button class="btn btn-ghost" style="flex:1;" onclick="addTime(15)">+15s</button>
    </div>
  </div>
</div>

<!-- MODAL PR√â-TREINO: Execu√ß√£o + Tipo de Carga -->
<div class="modal-overlay" id="pre-workout-modal">
  <div style="background:var(--card); border:1px solid var(--border2); border-radius:24px 24px 0 0; padding:28px 24px 36px; width:100%; max-width:520px; margin-top:auto; animation:slideUp 0.3s ease;">
    <div style="width:40px; height:4px; background:var(--border2); border-radius:99px; margin:0 auto 20px;"></div>
    <div style="font-family:'Bebas Neue'; font-size:22px; letter-spacing:2px; margin-bottom:4px;" id="pwm-ex-name">EXERC√çCIO</div>
    <div style="font-size:13px; color:var(--muted2); margin-bottom:24px;" id="pwm-ex-sub">Configure antes de come√ßar</div>

    <div style="margin-bottom:20px;">
      <div style="font-size:11px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;">Como vai executar?</div>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;" id="pwm-exec-options">
        <button class="pwm-option" data-exec="maquina" onclick="selectExec(this)" aria-label="M√°quina">
          <div style="font-size:28px; margin-bottom:6px;">üèãÔ∏è</div>
          <div style="font-weight:700; font-size:14px;">M√°quina</div>
          <div style="font-size:11px; color:var(--muted2); margin-top:3px;">Guiado, fixo</div>
        </button>
        <button class="pwm-option" data-exec="livre" onclick="selectExec(this)" aria-label="Livre">
          <div style="font-size:28px; margin-bottom:6px;">üí™</div>
          <div style="font-weight:700; font-size:14px;">Livre</div>
          <div style="font-size:11px; color:var(--muted2); margin-top:3px;">Amplitude livre</div>
        </button>
      </div>
    </div>

    <div style="margin-bottom:24px;">
      <div style="font-size:11px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px; margin-bottom:10px;">Tipo de carga</div>
      <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px;" id="pwm-load-options">
        <!-- Preenchido dinamicamente -->
      </div>
    </div>

    <div style="background:var(--card2); border-radius:12px; padding:14px 16px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
      <div>
        <div style="font-size:11px; color:var(--muted2); margin-bottom:4px;">PESO DE IN√çCIO</div>
        <div style="font-family:'Bebas Neue'; font-size:28px; color:var(--orange);" id="pwm-weight-display">20kg</div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:11px; color:var(--muted2); margin-bottom:4px;">INCREMENTO</div>
        <div style="font-family:'Bebas Neue'; font-size:20px; color:var(--muted2);" id="pwm-inc-display">+2kg</div>
      </div>
    </div>

    <div style="display:flex; gap:8px;">
      <button class="btn btn-ghost" style="flex:1;" onclick="skipPreWorkout()">Pular</button>
      <button class="btn btn-primary btn-lg" style="flex:2;" id="pwm-confirm-btn" onclick="confirmPreWorkout()" disabled>
        Iniciar exerc√≠cio ‚Üí
      </button>
    </div>
  </div>
</div>

<!-- MODAL NOVO EXERC√çCIO -->
<div class="modal-overlay" id="exercise-modal">
  <div class="modal">
    <div class="modal-title">NOVO EXERC√çCIO</div>
    <div style="display:flex; flex-direction:column; gap:14px;">

      <!-- Seletor: Muscula√ß√£o ou Cardio -->
      <div>
        <label style="margin-bottom:8px; display:block;">Tipo de exerc√≠cio</label>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
          <button type="button" class="type-btn active" data-type="musculacao" onclick="setExerciseType('musculacao')">
            <span style="font-size:20px;">üí™</span><span>Muscula√ß√£o</span>
          </button>
          <button type="button" class="type-btn" data-type="cardio" onclick="setExerciseType('cardio')">
            <span style="font-size:20px;">üèÉ</span><span>Cardio</span>
          </button>
        </div>
        <input type="hidden" id="ex-type" value="musculacao">
      </div>

      <!-- ‚ïê‚ïê CAMPOS CARDIO ‚ïê‚ïê -->
      <div id="cardio-extra-fields" style="display:none;">
        <div class="cardio-fields">
          <div class="grid-2">
            <div>
              <label>Tipo de cardio</label>
              <select id="cardio-tipo">
                <option value="Esteira">üèÉ Esteira</option>
                <option value="Bike">üö¥ Bike</option>
                <option value="Escada">ü™ú Escada</option>
                <option value="Corrida externa">üå≥ Corrida</option>
                <option value="Pular corda">ü™¢ Pular corda</option>
                <option value="Nata√ß√£o">üèä Nata√ß√£o</option>
                <option value="Remo">üö£ Remo</option>
              </select>
            </div>
            <div>
              <label>Dura√ß√£o (min)</label>
              <input type="number" id="cardio-tempo" value="20" min="5" step="5">
            </div>
          </div>
          <div class="grid-2" style="margin-top:10px;">
            <div>
              <label>Intensidade</label>
              <select id="cardio-intensidade">
                <option value="leve">üòå Leve</option>
                <option value="moderado" selected>üòä Moderado</option>
                <option value="intenso">ü•µ Intenso</option>
              </select>
            </div>
            <div>
              <label>Dist√¢ncia (km, opcional)</label>
              <input type="number" id="cardio-distancia" placeholder="0.0" step="0.1" min="0">
            </div>
          </div>
        </div>
        <div style="display:flex; gap:8px; margin-top:14px;">
          <button class="btn btn-ghost btn-full" onclick="closeModal('exercise-modal')">Cancelar</button>
          <button class="btn btn-primary btn-full" onclick="saveCardioExercise()">üèÉ Registrar Cardio</button>
        </div>
      </div>

      <!-- ‚ïê‚ïê CAMPOS MUSCULA√á√ÉO ‚ïê‚ïê -->
      <div id="musculacao-fields">
        <!-- Linha 1: Nome -->
        <div style="margin-bottom:14px;">
          <label>Nome do exerc√≠cio</label>
          <input type="text" id="ex-name" placeholder="Ex: Supino Reto com Barra" 
            oninput="(function(){ const plan = state.plans?.find(p=>p.id===state.currentPlanId); if(plan) renderOverlapAlerts(plan.id, this.value); }).call(this)">
        </div>

        <!-- Linha 2: Grupo muscular -->
        <div style="margin-bottom:14px;">
          <label>Grupo muscular</label>
          <select id="ex-group">
            <option value="Peito">üí™ Peito</option>
            <option value="Costas">ü¶∫ Costas</option>
            <option value="Ombro">üî∫ Ombro</option>
            <option value="B√≠ceps">üí™ B√≠ceps</option>
            <option value="Tr√≠ceps">üí™ Tr√≠ceps</option>
            <option value="Perna">ü¶µ Perna</option>
            <option value="Gl√∫teo">üçë Gl√∫teo</option>
            <option value="Abd√¥men">üî• Abd√¥men</option>
          </select>
        </div>

        <!-- Linha 3: Livre ou M√°quina -->
        <div style="margin-bottom:14px;">
          <label>Tipo de execu√ß√£o</label>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:6px;">
            <button type="button" class="execution-btn active" id="ex-exec-livre" onclick="setExecution('livre', 'ex')">
              <span style="font-size:20px;">üèãÔ∏è</span>
              <span style="font-weight:700; font-size:13px;">Livre</span>
              <span style="font-size:10px; color:var(--muted2);">Haltere ¬∑ Anilha ¬∑ Barra</span>
            </button>
            <button type="button" class="execution-btn" id="ex-exec-maquina" onclick="setExecution('maquina', 'ex')">
              <span style="font-size:20px;">‚öôÔ∏è</span>
              <span style="font-weight:700; font-size:13px;">M√°quina</span>
              <span style="font-size:10px; color:var(--muted2);">Guiado ¬∑ Cabo ¬∑ Polia</span>
            </button>
          </div>
          <input type="hidden" id="ex-execution" value="livre">
        </div>

        <!-- Linha 4: Equipamento -->
        <div style="margin-bottom:14px;">
          <label>Equipamento</label>
          <select id="ex-equip">
            <option value="Halteres (1-10kg)">üèãÔ∏è Halteres (fixos 1‚Äì10kg)</option>
            <option value="Dumbbells (12kg+)">üí™ Dumbbells (12, 14, 16kg...)</option>
            <option value="Anilhas (barra)">üî¥ Anilhas (combina√ß√£o de placas)</option>
          </select>
        </div>

        <!-- Linha 5: Peso + Reps -->
        <div class="grid-2" style="margin-bottom:14px;">
          <div>
            <label>Peso inicial (kg)</label>
            <input type="number" id="ex-weight" value="20" min="0" step="0.5">
          </div>
          <div>
            <label>Faixa de reps</label>
            <select id="ex-reps">
              <option value="6-10">6‚Äì10 (For√ßa)</option>
              <option value="8-12" selected>8‚Äì12 (Hipertrofia)</option>
              <option value="10-15">10‚Äì15 (Volume)</option>
              <option value="12-20">12‚Äì20 (Resist√™ncia)</option>
            </select>
          </div>
        </div>

        <!-- Linha 6: S√©ries + Descanso -->
        <div class="grid-2" style="margin-bottom:14px;">
          <div>
            <label>S√©ries</label>
            <select id="ex-sets">
              <option value="2">2 s√©ries</option>
              <option value="3" selected>3 s√©ries</option>
              <option value="4">4 s√©ries</option>
              <option value="5">5 s√©ries</option>
            </select>
          </div>
          <div>
            <label>Descanso</label>
            <select id="ex-rest">
              <option value="45">45 seg</option>
              <option value="60">1 min</option>
              <option value="90" selected>1 min 30s</option>
              <option value="120">2 min</option>
              <option value="180">3 min</option>
              <option value="240">4 min</option>
            </select>
          </div>
        </div>

        <!-- Linha 7: Incremento -->
        <div style="margin-bottom:14px;">
          <label>Incremento m√≠nimo (kg) ‚ö°</label>
          <select id="ex-increment">
            <option value="0.5">0.5 kg ‚Äî Eleva√ß√£o lateral</option>
            <option value="1">1 kg ‚Äî Haltere fixo</option>
            <option value="2" selected>2 kg ‚Äî Dumbbell</option>
            <option value="2.5">2.5 kg ‚Äî Barra livre / Anilha</option>
            <option value="5">5 kg ‚Äî Barra com pino</option>
            <option value="10">10 kg ‚Äî Pino pesado</option>
          </select>
        </div>

        <!-- Overlap alerts -->
        <div id="overlap-alerts-modal"></div>

        <!-- Bot√µes -->
        <div style="display:flex; gap:8px;">
          <button class="btn btn-ghost btn-full" onclick="closeModal('exercise-modal')">Cancelar</button>
          <button class="btn btn-primary btn-full" onclick="saveExercise()">Salvar Exerc√≠cio</button>
        </div>
      </div><!-- /musculacao-fields -->

    </div>
  </div>
</div>

<!-- MODAL EDITAR EXERC√çCIO -->
<div class="modal-overlay" id="edit-exercise-modal">
  <div class="modal">
    <div class="modal-title">EDITAR EXERC√çCIO</div>
    <div style="display:flex; flex-direction:column; gap:14px;">
      <input type="hidden" id="edit-ex-id">
      <div>
        <label>Nome do exerc√≠cio</label>
        <input type="text" id="edit-ex-name" placeholder="Ex: Supino Reto com Barra">
      </div>
      <div class="grid-2">
        <div>
          <label>Grupo muscular</label>
          <select id="edit-ex-group">
            <option value="Peito">üí™ Peito</option>
            <option value="Costas">ü¶∫ Costas</option>
            <option value="Ombro">üî∫ Ombro</option>
            <option value="B√≠ceps">üí™ B√≠ceps</option>
            <option value="Tr√≠ceps">üí™ Tr√≠ceps</option>
            <option value="Perna">ü¶µ Perna</option>
            <option value="Gl√∫teo">üçë Gl√∫teo</option>
            <option value="Abd√¥men">üî• Abd√¥men</option>
          </select>
        </div>
        <div>
          <label>Tipo de execu√ß√£o</label>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:4px;">
            <button type="button" class="execution-btn active" id="edit-ex-exec-livre" onclick="setExecution('livre', 'edit')">
              <span style="font-size:20px;">üèãÔ∏è</span>
              <span style="font-weight:700; font-size:13px;">Livre</span>
              <span style="font-size:10px; color:var(--muted2);">Haltere ¬∑ Anilha ¬∑ Barra livre</span>
            </button>
            <button type="button" class="execution-btn" id="edit-ex-exec-maquina" onclick="setExecution('maquina', 'edit')">
              <span style="font-size:20px;">‚öôÔ∏è</span>
              <span style="font-weight:700; font-size:13px;">M√°quina</span>
              <span style="font-size:10px; color:var(--muted2);">Guiado ¬∑ Cabo ¬∑ Polia</span>
            </button>
          </div>
          <input type="hidden" id="edit-ex-execution" value="livre">
        </div>
        <div>
          <label>Equipamento</label>
          <select id="edit-ex-equip">
            <option value="Halteres (1-10kg)">üèãÔ∏è Halteres (fixos 1‚Äì10kg)</option>
            <option value="Dumbbells (12kg+)">üí™ Dumbbells (12, 14, 16kg...)</option>
            <option value="Anilhas (barra)">üî¥ Anilhas (combina√ß√£o de placas)</option>
          </select>
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>Peso inicial (kg)</label>
          <input type="number" id="edit-ex-weight" value="20" min="0" step="0.5">
        </div>
        <div>
          <label>Faixa de reps</label>
          <select id="edit-ex-reps">
            <option value="6-10">6‚Äì10</option>
            <option value="8-12" selected>8‚Äì12</option>
            <option value="10-15">10‚Äì15</option>
            <option value="12-20">12‚Äì20</option>
          </select>
        </div>
      </div>
      <div class="grid-2">
        <div>
          <label>S√©ries</label>
          <select id="edit-ex-sets">
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="4">4</option>
            <option value="5">5</option>
          </select>
        </div>
        <div>
          <label>Descanso</label>
          <select id="edit-ex-rest">
            <option value="45">45s</option>
            <option value="60">1 min</option>
            <option value="90" selected>1:30</option>
            <option value="120">2 min</option>
            <option value="180">3 min</option>
            <option value="240">4 min</option>
          </select>
        </div>
        <div>
          <label>Incremento (kg)</label>
          <select id="edit-ex-increment">
            <option value="0.5">0.5</option>
            <option value="1">1</option>
            <option value="2" selected>2</option>
            <option value="2.5">2.5</option>
            <option value="5">5</option>
            <option value="10">10</option>
          </select>
        </div>
      </div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button class="btn btn-ghost btn-full" onclick="closeModal('edit-exercise-modal')">Cancelar</button>
        <button class="btn btn-primary btn-full" onclick="updateExercise()">Salvar altera√ß√µes</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL NOVO TREINO ‚Äî MULTI-STEP -->
<div class="modal-overlay" id="workout-plan-modal">
  <div class="modal" style="max-width:520px; width:100%; max-height:85vh; overflow-y:auto;">

    <div style="display:flex; align-items:center; gap:0; margin-bottom:24px;">
      <div class="wb-step-indicator active" id="wbi-1">
        <div class="wb-step-circle" id="wbc-1">1</div>
        <div class="wb-step-label">Informa√ß√µes</div>
      </div>
      <div class="wb-step-line" id="wbl-1"></div>
      <div class="wb-step-indicator" id="wbi-2">
        <div class="wb-step-circle" id="wbc-2">2</div>
        <div class="wb-step-label">Exerc√≠cios</div>
      </div>
      <div class="wb-step-line" id="wbl-2"></div>
      <div class="wb-step-indicator" id="wbi-3">
        <div class="wb-step-circle" id="wbc-3">3</div>
        <div class="wb-step-label">Confirmar</div>
      </div>
    </div>

    <div id="wb-step-1" class="wb-step">
      <div class="modal-title">NOVO TREINO</div>
      <p style="color:var(--muted2); font-size:13px; margin-bottom:20px;">D√™ um nome e escolha o dia da semana para este treino.</p>
      <div style="display:flex; flex-direction:column; gap:16px;">
        <div>
          <label>Nome do treino</label>
          <input type="text" id="plan-name" placeholder="Ex: Treino A ‚Äî Peito e Tr√≠ceps">
        </div>
        <div>
          <label>Dias da semana</label>
          <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-top:4px;" id="day-selector">
            <button class="day-pill" data-day="Dom" onclick="toggleDay(this)">Dom</button>
            <button class="day-pill" data-day="Seg" onclick="toggleDay(this)">Seg</button>
            <button class="day-pill" data-day="Ter" onclick="toggleDay(this)">Ter</button>
            <button class="day-pill" data-day="Qua" onclick="toggleDay(this)">Qua</button>
            <button class="day-pill" data-day="Qui" onclick="toggleDay(this)">Qui</button>
            <button class="day-pill" data-day="Sex" onclick="toggleDay(this)">Sex</button>
            <button class="day-pill" data-day="S√°b" onclick="toggleDay(this)">S√°b</button>
          </div>
        </div>
      </div>
      <div style="display:flex; gap:8px; margin-top:24px;">
        <button class="btn btn-ghost btn-full" onclick="closeModal('workout-plan-modal')">Cancelar</button>
        <button class="btn btn-primary btn-full" onclick="wbNext(1)">Pr√≥ximo ‚Üí</button>
      </div>
    </div>

    <div id="wb-step-2" class="wb-step" style="display:none;">
      <div class="modal-title">ADICIONAR EXERC√çCIOS</div>
      <p style="color:var(--muted2); font-size:13px; margin-bottom:16px;">Selecione dos exerc√≠cios pr√©-definidos ou crie novos.</p>

      <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:12px;" id="wb-group-filters">
        <button class="btn btn-primary" style="font-size:11px; padding:5px 10px;" onclick="wbFilter('Todos')">Todos</button>
        <button class="btn btn-ghost" style="font-size:11px; padding:5px 10px;" onclick="wbFilter('Peito')">üí™ Peito</button>
        <button class="btn btn-ghost" style="font-size:11px; padding:5px 10px;" onclick="wbFilter('Costas')">ü¶∫ Costas</button>
        <button class="btn btn-ghost" style="font-size:11px; padding:5px 10px;" onclick="wbFilter('Ombro')">üî∫ Ombro</button>
        <button class="btn btn-ghost" style="font-size:11px; padding:5px 10px;" onclick="wbFilter('Perna')">ü¶µ Perna</button>
        <button class="btn btn-ghost" style="font-size:11px; padding:5px 10px;" onclick="wbFilter('B√≠ceps')">üí™ B√≠ceps</button>
        <button class="btn btn-ghost" style="font-size:11px; padding:5px 10px;" onclick="wbFilter('Tr√≠ceps')">üî± Tr√≠ceps</button>
      </div>

      <div id="wb-exercise-list" style="max-height:260px; overflow-y:auto; display:flex; flex-direction:column; gap:6px; margin-bottom:12px;"></div>

      <div id="wb-new-ex-panel" style="display:none; background:var(--card2); border:1px solid var(--border2); border-radius:12px; padding:14px; margin-bottom:12px;">
        <div style="font-weight:700; font-size:14px; margin-bottom:12px; color:var(--orange);">+ Novo exerc√≠cio</div>
        <div style="display:flex; flex-direction:column; gap:10px;">
          <input type="text" id="wb-ex-name" placeholder="Nome do exerc√≠cio">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
            <select id="wb-ex-group">
              <option value="Peito">üí™ Peito</option>
              <option value="Costas">ü¶∫ Costas</option>
              <option value="Ombro">üî∫ Ombro</option>
              <option value="B√≠ceps">üí™ B√≠ceps</option>
              <option value="Tr√≠ceps">üî± Tr√≠ceps</option>
              <option value="Perna">ü¶µ Perna</option>
              <option value="Gl√∫teo">üçë Gl√∫teo</option>
              <option value="Abd√¥men">üî• Abd√¥men</option>
            </select>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-top:2px;">
              <button type="button" class="execution-btn active" id="wb-exec-livre" onclick="setExecution('livre','wb')" style="padding:8px 6px;">
                <span style="font-size:16px;">üèãÔ∏è</span>
                <span style="font-weight:700; font-size:11px;">Livre</span>
              </button>
              <button type="button" class="execution-btn" id="wb-exec-maquina" onclick="setExecution('maquina','wb')" style="padding:8px 6px;">
                <span style="font-size:16px;">‚öôÔ∏è</span>
                <span style="font-weight:700; font-size:11px;">M√°quina</span>
              </button>
            </div>
            <input type="hidden" id="wb-execution" value="livre">
            <select id="wb-ex-equip" style="margin-top:6px;">
              <option value="Halteres (1-10kg)">üèãÔ∏è Halteres (fixos 1‚Äì10kg)</option>
              <option value="Dumbbells (12kg+)">üí™ Dumbbells (12, 14, 16kg...)</option>
              <option value="Anilhas (barra)">üî¥ Anilhas (combina√ß√£o de placas)</option>
            </select>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
            <div>
              <label style="font-size:11px;">Peso inicial (kg)</label>
              <input type="number" id="wb-ex-weight" value="20" min="0" step="0.5">
            </div>
            <div>
              <label style="font-size:11px;">Faixa de reps</label>
              <select id="wb-ex-reps">
                <option value="6-10">6‚Äì10</option>
                <option value="8-12" selected>8‚Äì12</option>
                <option value="10-15">10‚Äì15</option>
                <option value="12-20">12‚Äì20</option>
              </select>
            </div>
            <div>
              <label style="font-size:11px;">S√©ries</label>
              <select id="wb-ex-sets">
                <option value="2">2</option>
                <option value="3" selected>3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>
            <div>
              <label style="font-size:11px;">Descanso</label>
              <select id="wb-ex-rest">
                <option value="45">45s</option>
                <option value="60">1 min</option>
                <option value="90" selected>1:30</option>
                <option value="120">2 min</option>
                <option value="180">3 min</option>
                <option value="240">4 min</option>
              </select>
            </div>
            <div>
              <label style="font-size:11px;">Incremento (kg)</label>
              <select id="wb-ex-increment">
                <option value="0.5">0.5 kg</option>
                <option value="1">1 kg</option>
                <option value="2" selected>2 kg</option>
                <option value="2.5">2.5 kg</option>
                <option value="5">5 kg</option>
                <option value="10">10 kg</option>
              </select>
            </div>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-ghost" style="flex:1;" onclick="toggleNewExPanel()">Cancelar</button>
            <button class="btn btn-primary" style="flex:1;" onclick="wbCreateAndAdd()">Criar e adicionar</button>
          </div>
        </div>
      </div>

      <button class="btn btn-ghost btn-full" style="border-style:dashed; margin-bottom:16px;" onclick="toggleNewExPanel()">
        + Criar novo exerc√≠cio
      </button>

      <div id="wb-selected-preview" style="background:var(--card2); border-radius:10px; padding:12px; min-height:48px;">
        <div style="font-size:12px; color:var(--muted2); margin-bottom:8px;">SELECIONADOS (<span id="wb-selected-count">0</span>)</div>
        <div id="wb-selected-tags" style="display:flex; flex-wrap:wrap; gap:6px;">
          <span style="color:var(--muted); font-size:13px; font-style:italic;">Nenhum exerc√≠cio selecionado</span>
        </div>
      </div>

      <div style="display:flex; gap:8px; margin-top:16px;">
        <button class="btn btn-ghost btn-full" onclick="wbBack(2)">‚Üê Voltar</button>
        <button class="btn btn-primary btn-full" onclick="wbNext(2)">Revisar ‚Üí</button>
      </div>
    </div>

    <div id="wb-step-3" class="wb-step" style="display:none;">
      <div class="modal-title">CONFIRMAR TREINO</div>
      <div id="wb-confirm-content" style="margin-bottom:20px;"></div>
      <div style="display:flex; gap:8px;">
        <button class="btn btn-ghost btn-full" onclick="wbBack(3)">‚Üê Voltar</button>
        <button class="btn btn-primary btn-full btn-lg" onclick="saveWorkoutPlan()">‚úì Criar treino</button>
      </div>
    </div>

  </div>
</div>

<!-- MODAL EDITAR TREINO -->
<div class="modal-overlay" id="edit-workout-modal">
  <div class="modal">
    <div class="modal-title">EDITAR TREINO</div>
    <input type="hidden" id="edit-plan-id">
    <div style="display:flex; flex-direction:column; gap:16px;">
      <div>
        <label>Nome do treino</label>
        <input type="text" id="edit-plan-name" placeholder="Ex: Treino A">
      </div>
      <div>
        <label>Dias da semana</label>
        <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:6px;" id="edit-day-selector">
          <button class="day-pill" data-day="Dom">Dom</button>
          <button class="day-pill" data-day="Seg">Seg</button>
          <button class="day-pill" data-day="Ter">Ter</button>
          <button class="day-pill" data-day="Qua">Qua</button>
          <button class="day-pill" data-day="Qui">Qui</button>
          <button class="day-pill" data-day="Sex">Sex</button>
          <button class="day-pill" data-day="S√°b">S√°b</button>
        </div>
      </div>
    </div>
    <div style="display:flex; gap:8px; margin-top:24px;">
      <button class="btn btn-ghost btn-full" onclick="closeModal('edit-workout-modal')">Cancelar</button>
      <button class="btn btn-primary btn-full" onclick="updateWorkoutPlan()">Salvar</button>
    </div>
  </div>
</div>

<!-- ONBOARDING -->
<div id="onboarding-screen" class="onboarding-bg">
  <div class="onboarding-card">
    <div class="onboarding-logo">PROGRESSAR</div>
    <p style="color: var(--muted2); font-size:14px; margin-bottom:32px;">O app que pensa na sua progress√£o por voc√™</p>

    <div class="step-dots">
      <div class="dot active" id="dot-0"></div>
      <div class="dot" id="dot-1"></div>
      <div class="dot" id="dot-2"></div>
    </div>

    <div class="step active" id="step-0">
      <div style="font-size:48px; margin-bottom:16px;">üèãÔ∏è</div>
      <h2 style="font-family:'Bebas Neue'; font-size:28px; margin-bottom:8px; letter-spacing:1px;">Evolua com m√©todo</h2>
      <p style="color:var(--muted2); font-size:14px; line-height:1.6; margin-bottom:28px;">Baseado no m√©todo de Paulo Muzy, o PROGRESSAR automatiza sua progress√£o de carga ‚Äî sem planilha, sem c√°lculo, sem estagna√ß√£o.</p>
      <button class="btn btn-primary btn-full btn-lg" onclick="nextStep()">Come√ßar ‚Üí</button>
    </div>

    <div class="step" id="step-1">
      <h2 style="font-family:'Bebas Neue'; font-size:28px; margin-bottom:16px; letter-spacing:1px;">SOBRE VOC√ä</h2>
      <div style="display:flex; flex-direction:column; gap:14px; text-align:left;">
        <div>
          <label>Seu nome</label>
          <input type="text" id="user-name" placeholder="Como voc√™ quer ser chamado?">
        </div>
        <div>
          <label style="margin-bottom:8px; display:block;">Qual seu n√≠vel de treino?</label>
          <div style="display:flex; flex-direction:column; gap:8px;">
            <button type="button" class="level-btn" id="lvl-beginner" onclick="setUserLevel('beginner')">
              <span style="font-size:28px;">üå±</span>
              <div>
                <div class="level-title">Iniciante</div>
                <div class="level-desc">At√© 6 meses de treino ‚Äî foco na t√©cnica e adapta√ß√£o</div>
              </div>
            </button>
            <button type="button" class="level-btn selected" id="lvl-intermediate" onclick="setUserLevel('intermediate')">
              <span style="font-size:28px;">üí™</span>
              <div>
                <div class="level-title">Intermedi√°rio</div>
                <div class="level-desc">6 meses a 2 anos ‚Äî evoluindo cargas progressivamente</div>
              </div>
            </button>
            <button type="button" class="level-btn" id="lvl-advanced" onclick="setUserLevel('advanced')">
              <span style="font-size:28px;">üî•</span>
              <div>
                <div class="level-title">Avan√ßado</div>
                <div class="level-desc">Mais de 2 anos ‚Äî volume e t√©cnicas avan√ßadas</div>
              </div>
            </button>
          </div>
          <input type="hidden" id="user-level" value="intermediate">
        </div>
        <div>
          <label>Objetivo principal</label>
          <select id="user-goal">
            <option value="hypertrophy" selected>Hipertrofia muscular</option>
            <option value="strength">For√ßa m√°xima</option>
            <option value="endurance">Resist√™ncia muscular</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary btn-full btn-lg" style="margin-top:20px;" onclick="nextStep()">Continuar ‚Üí</button>
    </div>

    <div class="step" id="step-2">
      <div style="font-size:48px; margin-bottom:16px;">üéØ</div>
      <h2 style="font-family:'Bebas Neue'; font-size:28px; margin-bottom:8px; letter-spacing:1px;">TUDO PRONTO!</h2>
      <p style="color:var(--muted2); font-size:14px; line-height:1.6; margin-bottom:28px;">Vamos configurar seus primeiros treinos e voc√™ j√° come√ßa a registrar sua evolu√ß√£o hoje.</p>
      <button class="btn btn-primary btn-full btn-lg" onclick="finishOnboarding()">Entrar no app üöÄ</button>
    </div>
  </div>
</div>

<!-- APP -->
<div class="app" id="app-screen" style="display:none;">

  <nav class="sidebar">
    <div class="logo" onclick="switchView('dashboard')" aria-label="Dashboard">P</div>
    <button class="nav-btn active" id="nav-dashboard" onclick="switchView('dashboard')" aria-label="Dashboard">
      üè† <span class="tooltip">Dashboard</span>
    </button>
    <button class="nav-btn" id="nav-treinos" onclick="switchView('treinos')" aria-label="Meus Treinos">
      üìã <span class="tooltip">Meus Treinos</span>
    </button>
    <button class="nav-btn" id="nav-exercicios" onclick="switchView('exercicios')" aria-label="Exerc√≠cios">
      üí™ <span class="tooltip">Exerc√≠cios</span>
    </button>
    <button class="nav-btn" id="nav-historico" onclick="switchView('historico')" aria-label="Hist√≥rico">
      üìà <span class="tooltip">Hist√≥rico</span>
    </button>
    <button class="nav-btn" id="nav-cardio" onclick="switchView('cardio')" aria-label="Cardio">
      üèÉ <span class="tooltip">Cardio</span>
    </button>
    <button class="nav-btn" id="nav-biblioteca" onclick="switchView('biblioteca')" aria-label="Biblioteca">
      üß¨ <span class="tooltip">Biblioteca</span>
    </button>
    <div style="flex:1;"></div>
    <button class="nav-btn" id="nav-ebooks" onclick="switchView('ebooks')" aria-label="Ebooks">
      üìö <span class="tooltip">Ebooks</span>
    </button>
    <button class="nav-btn" id="nav-foco" onclick="switchView('foco')" aria-label="Modo Foco">
      üéØ <span class="tooltip">Modo Foco</span>
    </button>
    <button class="nav-btn" id="nav-perfil" onclick="switchView('perfil')" aria-label="Perfil">
      üë§ <span class="tooltip">Perfil</span>
    </button>
  </nav>

  <main class="main">

    <div class="view active" id="view-dashboard">
      <div class="page-header">
        <div>
          <div class="page-title" id="dash-greeting">BOM DIA!</div>
          <div class="page-subtitle" id="dash-subtitle">Carregando...</div>
        </div>
        <button class="btn btn-primary btn-lg pulse" id="start-workout-btn" onclick="startWorkout()">
          ‚ñ∂ Iniciar Treino
        </button>
      </div>

      <div class="section">
        <div class="grid-3" style="margin-bottom:20px;">
          <div class="card" style="display:flex; align-items:center; gap:16px;">
            <div class="ring-chart">
              <svg width="80" height="80" viewBox="0 0 80 80">
                <circle cx="40" cy="40" r="32" fill="none" stroke="#222" stroke-width="8"/>
                <circle cx="40" cy="40" r="32" fill="none" stroke="var(--orange)" stroke-width="8"
                  stroke-dasharray="201" id="ring-streak" stroke-dashoffset="201" stroke-linecap="round"/>
              </svg>
              <div class="ring-value" id="ring-streak-val">0</div>
            </div>
            <div>
              <div class="stat-number" style="font-size:36px;" id="stat-streak">0</div>
              <div class="stat-label">Semanas seguidas</div>
            </div>
          </div>
          <div class="card">
            <div class="stat-number" id="stat-sessions">0</div>
            <div class="stat-label">Treinos realizados</div>
          </div>
          <div class="card">
            <div class="stat-number" id="stat-progressions">0</div>
            <div class="stat-label">Progress√µes feitas</div>
          </div>
        </div>

        <div class="suggestion-box" style="margin-bottom:20px;">
          <div class="suggestion-title">‚ö° PR√ìXIMO TREINO SUGERIDO</div>
          <div id="next-workout-content">
            <p style="color:var(--muted2); font-size:14px;">Crie seu primeiro treino para come√ßar!</p>
          </div>
        </div>

        <div id="progression-alerts" style="margin-bottom:20px;"></div>

        <div class="section-title">√öLTIMAS SESS√ïES</div>
        <div id="recent-sessions">
          <div style="color:var(--muted2); font-size:14px; padding:16px; text-align:center; background:var(--card); border-radius:12px; border:1px solid var(--border);">
            Nenhuma sess√£o registrada ainda.<br>Inicie seu primeiro treino!
          </div>
        </div>
      </div>
    </div>

    <div class="view" id="view-treinos">
      <div class="page-header">
        <div>
          <div class="page-title">TREINOS</div>
          <div class="page-subtitle">Gerencie suas fichas de treino</div>
        </div>
        <button class="btn btn-primary" onclick="openWorkoutBuilder()">+ Novo Treino</button>
      </div>

      <div class="section">
        <div id="workout-plans-list">
          <div style="color:var(--muted2); font-size:14px; padding:24px; text-align:center; background:var(--card); border-radius:12px; border:1px dashed var(--border2);">
            <div style="font-size:32px; margin-bottom:8px;">üìã</div>
            Nenhum treino criado ainda.<br>Crie seu primeiro treino acima!
          </div>
        </div>
      </div>
    </div>

    <div class="view" id="view-exercicios">
      <div class="page-header">
        <div>
          <div class="page-title">EXERC√çCIOS</div>
          <div class="page-subtitle">Seu banco de exerc√≠cios pessoal</div>
        </div>
        <button class="btn btn-primary" onclick="openModal('exercise-modal'); setExerciseType('musculacao')">+ Novo Exerc√≠cio</button>
      </div>

      <div class="section">
        <div style="margin-bottom:16px; display:flex; gap:8px; flex-wrap:wrap;" id="muscle-filters">
          <button class="btn btn-primary" style="font-size:12px;" onclick="filterExercises('all')">Todos (0)</button>
        </div>
        <div id="exercises-list"></div>
      </div>
    </div>

    <div class="view" id="view-historico">
      <div class="page-header">
        <div>
          <div class="page-title">HIST√ìRICO</div>
          <div class="page-subtitle">Sua evolu√ß√£o ao longo do tempo</div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">EVOLU√á√ÉO POR EXERC√çCIO</div>
        <div style="margin-bottom:16px;">
          <select id="history-exercise-select" onchange="renderHistoryChart()" style="max-width:300px;">
            <option value="">Selecione um exerc√≠cio...</option>
          </select>
        </div>

        <div class="card" style="margin-bottom:20px;">
          <div id="chart-placeholder" style="text-align:center; padding:32px; color:var(--muted2);">
            <div style="font-size:32px; margin-bottom:8px;">üìä</div>
            Selecione um exerc√≠cio para ver a evolu√ß√£o
          </div>
          <canvas id="progress-chart" style="display:none;"></canvas>
          <div id="chart-stats" style="display:none; margin-top:16px;" class="grid-3"></div>
        </div>

        <div class="section-title">TODAS AS SESS√ïES</div>
        <div id="all-sessions-list"></div>
      </div>
    </div>

    <div class="view" id="view-workout-active">
      <div class="workout-header">
        <div>
          <div style="font-family:'Bebas Neue'; font-size:28px; letter-spacing:1px;" id="active-workout-title">TREINO</div>
          <div style="font-size:13px; color:var(--muted2);" id="active-workout-timer">00:00</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-ghost" onclick="cancelWorkout()">Cancelar</button>
          <button class="btn btn-success btn-lg" onclick="finishWorkout()">‚úì Finalizar</button>
        </div>
      </div>

      <div class="section">
        <div id="active-exercises"></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <!-- CARDIO VIEW                                     -->
    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="view" id="view-cardio">
      <div class="page-header" style="display:flex; justify-content:space-between; align-items:center;">
        <div class="page-title">CARDIO</div>
        <button class="btn btn-primary" onclick="abrirRegistroCardio()">+ Registrar</button>
      </div>
      <div class="section">

        <!-- Registro r√°pido -->
        <div class="card" id="cardio-form-card" style="margin-bottom:16px; display:none;">
          <div style="font-family:'Bebas Neue'; font-size:20px; letter-spacing:1px; margin-bottom:16px;">üèÉ NOVA SESS√ÉO DE CARDIO</div>
          <div class="grid-2" style="gap:10px;">
            <div>
              <label>Tipo de cardio</label>
              <select id="cardio-tipo-v">
                <option value="Esteira">üèÉ Esteira</option>
                <option value="Bike">üö¥ Bike</option>
                <option value="Escada">ü™ú Escada</option>
                <option value="Corrida externa">üå≥ Corrida</option>
                <option value="Pular corda">ü™¢ Pular corda</option>
                <option value="Nata√ß√£o">üèä Nata√ß√£o</option>
                <option value="Remo">üö£ Remo</option>
              </select>
            </div>
            <div>
              <label>Dura√ß√£o (min)</label>
              <input type="number" id="cardio-tempo-v" value="20" min="5" step="5">
            </div>
          </div>
          <div class="grid-2" style="gap:10px; margin-top:10px;">
            <div>
              <label>Intensidade</label>
              <select id="cardio-intensidade-v">
                <option value="leve">üòå Leve</option>
                <option value="moderado" selected>üòä Moderado</option>
                <option value="intenso">ü•µ Intenso</option>
              </select>
            </div>
            <div>
              <label>Dist√¢ncia (km, opcional)</label>
              <input type="number" id="cardio-distancia-v" placeholder="0.0" step="0.1" min="0">
            </div>
          </div>
          <div style="display:flex; gap:8px; margin-top:14px;">
            <button class="btn btn-ghost btn-full" onclick="fecharRegistroCardio()">Cancelar</button>
            <button class="btn btn-primary btn-full" onclick="salvarCardioView()">‚úì Salvar sess√£o</button>
          </div>
        </div>

        <!-- Regras por objetivo -->
        <div class="card" style="margin-bottom:16px;" id="cardio-dica-objetivo"></div>

        <!-- Alertas cardio -->
        <div id="cardio-alertas-view" style="margin-bottom:8px;"></div>

        <!-- Stats r√°pidas -->
        <div class="card" style="margin-bottom:16px;">
          <div class="section-title" style="margin-bottom:14px;">üìä ESTAT√çSTICAS</div>
          <div id="cardio-stats-view"><!-- filled by JS --></div>
        </div>

        <!-- Hist√≥rico cardio -->
        <div class="card">
          <div class="section-title" style="margin-bottom:14px;">üìÖ HIST√ìRICO</div>
          <div id="cardio-historico-view"><!-- filled by JS --></div>
        </div>

      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BIBLIOTECA VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="view" id="view-biblioteca">
      <div class="page-header">
        <div class="page-title">üß¨ BIBLIOTECA ADN</div>
      </div>
      <div class="section">

        <!-- Info card -->
        <div class="card" style="margin-bottom:16px; background:linear-gradient(135deg,#1a0800,#0a0a0a);">
          <div style="display:flex; gap:12px; align-items:flex-start;">
            <span style="font-size:28px;">üß†</span>
            <div>
              <div style="font-weight:700; font-size:14px; margin-bottom:6px;">Entenda seu corpo por dentro</div>
              <div style="font-size:12px; color:var(--muted2); line-height:1.7;">
                Toque num grupo muscular ‚Üí escolha a por√ß√£o ‚Üí veja os exerc√≠cios ideais.<br>
                <span style="color:var(--orange); font-weight:700;">üîó Composto</span> = m√∫ltiplas articula√ß√µes, alta energia. &nbsp;
                <span style="color:#60a5fa; font-weight:700;">üéØ Isolamento</span> = um m√∫sculo, foco total.
              </div>
            </div>
          </div>
        </div>

        <!-- Muscle tree list -->
        <div id="biblioteca-lista"><!-- filled by JS --></div>

      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EBOOKS VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="view" id="view-ebooks">
      <div class="page-header">
        <div class="page-title">üìö EBOOKS</div>
      </div>
      <div class="section">

        <div style="background:var(--orange-dim); border:1px solid var(--orange-mid); border-radius:14px; padding:14px 16px; margin-bottom:20px; font-size:13px; color:var(--muted2); line-height:1.6;">
          üéÅ <strong style="color:var(--text);">Cap√≠tulos 1 e 2 s√£o gratuitos.</strong> Desbloqueie o conte√∫do completo com uma contribui√ß√£o via Pix ou assinatura mensal.
        </div>

        <!-- EBOOK 1: ECTOMORFA -->
        <div class="ebook-card">
          <div class="ebook-cover" style="background: linear-gradient(135deg, #1a0a2e 0%, #2d1b4e 50%, #0a0a0a 100%);">
            <div class="ebook-cover-emoji">üåø</div>
            <div class="ebook-cover-title">ECTOMORFA</div>
            <div class="ebook-cover-sub">Guia Completo ¬∑ Biotipo Feminino</div>
          </div>
          <div class="ebook-body">
            <div class="ebook-title">O Guia da Ectomorfa</div>
            <div class="ebook-desc">Para a mulher que tem dificuldade em ganhar massa, entende por que voc√™ √© assim e o que fazer de diferente.</div>
            <div class="ebook-tags">
              <span class="tag tag-blue">Nutri√ß√£o</span>
              <span class="tag tag-green">Treino</span>
              <span class="tag" style="background:rgba(180,120,255,0.1);color:#b478ff;">Horm√¥nios</span>
              <span class="tag tag-orange">Mindset</span>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-primary btn-full" onclick="openEbook('ectomorfa')">üìñ Ler agora</button>
              <button class="btn btn-ghost" onclick="downloadEbookPDF('ectomorfa')" style="white-space:nowrap;">‚¨á PDF</button>
            </div>
          </div>
        </div>

        <!-- EBOOK 2: MESOMORFA -->
        <div class="ebook-card">
          <div class="ebook-cover" style="background: linear-gradient(135deg, #0a1a0a 0%, #1a3a1a 50%, #0a0a0a 100%);">
            <div class="ebook-cover-emoji">üí™</div>
            <div class="ebook-cover-title">MESOMORFA</div>
            <div class="ebook-cover-sub">Guia Completo ¬∑ Biotipo Feminino</div>
          </div>
          <div class="ebook-body">
            <div class="ebook-title">O Guia da Mesomorfa</div>
            <div class="ebook-desc">Para a mulher que ganha m√∫sculo e gordura com facilidade ‚Äî como usar essa vantagem a seu favor.</div>
            <div class="ebook-tags">
              <span class="tag tag-blue">Nutri√ß√£o</span>
              <span class="tag tag-green">Treino</span>
              <span class="tag" style="background:rgba(180,120,255,0.1);color:#b478ff;">Horm√¥nios</span>
              <span class="tag tag-orange">Mindset</span>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-primary btn-full" onclick="openEbook('mesomorfa')">üìñ Ler agora</button>
              <button class="btn btn-ghost" onclick="downloadEbookPDF('mesomorfa')" style="white-space:nowrap;">‚¨á PDF</button>
            </div>
          </div>
        </div>

        <!-- EBOOK 3: ENDOMORFA -->
        <div class="ebook-card">
          <div class="ebook-cover" style="background: linear-gradient(135deg, #1a0a00 0%, #3a1a00 50%, #0a0a0a 100%);">
            <div class="ebook-cover-emoji">üî•</div>
            <div class="ebook-cover-title">ENDOMORFA</div>
            <div class="ebook-cover-sub">Guia Completo ¬∑ Biotipo Feminino</div>
          </div>
          <div class="ebook-body">
            <div class="ebook-title">O Guia da Endomorfa</div>
            <div class="ebook-desc">Para a mulher que acumula gordura com facilidade ‚Äî estrat√©gias espec√≠ficas para defini√ß√£o e sa√∫de hormonal.</div>
            <div class="ebook-tags">
              <span class="tag tag-blue">Nutri√ß√£o</span>
              <span class="tag tag-green">Treino</span>
              <span class="tag" style="background:rgba(180,120,255,0.1);color:#b478ff;">Horm√¥nios</span>
              <span class="tag tag-orange">Mindset</span>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-primary btn-full" onclick="openEbook('endomorfa')">üìñ Ler agora</button>
              <button class="btn btn-ghost" onclick="downloadEbookPDF('endomorfa')" style="white-space:nowrap;">‚¨á PDF</button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EBOOK READER (full screen) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="ebook-reader" id="ebook-reader">
      <div class="reader-header">
        <button class="btn btn-ghost" style="padding:8px 12px; font-size:18px;" onclick="closeEbook()">‚Üê</button>
        <div class="reader-title" id="reader-title">EBOOK</div>
        <button class="btn btn-ghost" style="padding:8px 12px; font-size:13px;" onclick="downloadCurrentPDF()">‚¨á PDF</button>
      </div>
      <div class="reader-content" id="reader-content">
        <!-- filled by JS -->
      </div>
    </div>

    <div class="view" id="view-perfil">
      <div class="page-header">
        <div class="page-title">PERFIL</div>
      </div>
      <div class="section">
        <div class="card" style="margin-bottom:16px;">
          <div style="display:flex; align-items:center; gap:16px; margin-bottom:20px;">
            <div style="width:60px; height:60px; background:var(--orange-dim); border:2px solid var(--orange); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:24px;">üèãÔ∏è</div>
            <div>
              <div style="font-family:'Bebas Neue'; font-size:28px; letter-spacing:1px;" id="profile-name">‚Äî</div>
              <div style="font-size:13px; color:var(--muted2);" id="profile-level">‚Äî</div>
            </div>
          </div>
          <hr class="sep" style="margin:0 0 16px;">
          <div class="grid-2">
            <div>
              <div class="stat-label">M√©todo de progress√£o</div>
              <div style="font-weight:600; margin-top:4px;">M√©todo Muzy (8‚Äì12 reps)</div>
            </div>
            <div>
              <div class="stat-label">Objetivo</div>
              <div style="font-weight:600; margin-top:4px;" id="profile-goal">‚Äî</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="section-title" style="margin-bottom:16px;">SOBRE O M√âTODO</div>
          <div style="background:var(--card2); border-radius:12px; padding:16px; border-left:3px solid var(--orange);">
            <p style="font-size:13px; color:var(--muted2); line-height:1.7;">
              <strong style="color:var(--text);">Como funciona a progress√£o autom√°tica:</strong><br>
              1. Defina um peso que voc√™ consegue fazer 8 repeti√ß√µes<br>
              2. Treine at√© conseguir 12 reps com boa t√©cnica<br>
              3. O app sugere aumentar a carga em 5‚Äì10%<br>
              4. Com o novo peso, voc√™ volta a fazer 8 reps<br>
              5. O ciclo se repete ‚Äî isso √© progresso real!
            </p>
          </div>
          <p style="font-size:12px; color:var(--muted); margin-top:12px; font-style:italic;">
            "Se n√£o h√° progress√£o de carga, n√£o h√° evolu√ß√£o no treino." ‚Äî Paulo Muzy
          </p>
        </div>

        <!-- Cardio stats card -->
        <div class="card" style="margin-top:16px;" id="cardio-stats-card">
          <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;">
            <div class="section-title" style="margin:0;">üèÉ CARDIO</div>
            <button class="btn btn-ghost" style="font-size:12px;" onclick="openModal('exercise-modal'); setTimeout(()=>setExerciseType('cardio'),100)">+ Registrar</button>
          </div>
          <div id="cardio-stats-content"><!-- filled by updateProfile --></div>
        </div>

        <div style="margin-top:16px;">
          <button class="btn btn-ghost btn-full" onclick="resetApp()" style="color:var(--red); border-color:var(--red-dim);">
            üóë Resetar todos os dados
          </button>
        </div>
      </div>
    </div>

    <div class="view" id="view-foco">
      <div id="foco-idle" style="display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:100vh; text-align:center; padding:32px;">
        <div style="font-size:64px; margin-bottom:16px;">üéØ</div>
        <div style="font-family:'Bebas Neue'; font-size:40px; letter-spacing:2px; margin-bottom:8px;">MODO FOCO</div>
        <p style="color:var(--muted2); font-size:15px; line-height:1.6; max-width:320px; margin-bottom:32px;">
          Interface minimalista para durante o treino.<br>S√≥ o essencial ‚Äî sem distra√ß√µes.
        </p>
        <button class="btn btn-primary btn-lg" onclick="startFocoMode()" aria-label="Modo Foco">Iniciar Treino em Foco</button>
        <p style="color:var(--muted); font-size:12px; margin-top:12px;">Selecione um treino para come√ßar</p>
        <div id="foco-plan-select" style="margin-top:16px; display:flex; flex-direction:column; gap:8px; width:100%; max-width:320px;"></div>
      </div>

      <div id="foco-active" style="display:none; min-height:100vh; background:var(--darker);">
        <div style="background:var(--card); border-bottom:1px solid var(--border); padding:16px 24px; display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div style="font-family:'Bebas Neue'; font-size:20px; letter-spacing:1px;" id="foco-workout-name">TREINO</div>
            <div style="font-size:12px; color:var(--muted2);" id="foco-timer-label">00:00</div>
          </div>
          <button class="btn btn-ghost" style="font-size:12px;" onclick="exitFoco()">‚úï Sair do foco</button>
        </div>

        <div style="padding:24px; max-width:480px; margin:0 auto;">
          <div style="display:flex; gap:6px; justify-content:center; margin-bottom:24px;" id="foco-ex-dots"></div>

          <div style="text-align:center; margin-bottom:32px;">
            <div style="font-size:48px; margin-bottom:8px;" id="foco-ex-emoji">üí™</div>
            <div style="font-family:'Bebas Neue'; font-size:36px; letter-spacing:1px; margin-bottom:4px;" id="foco-ex-name">EXERC√çCIO</div>
            <div style="font-size:14px; color:var(--muted2);" id="foco-ex-meta">3 s√©ries ¬∑ 8-12 reps</div>
          </div>

          <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:32px;">
            <div class="card" style="text-align:center; padding:20px;">
              <div style="font-size:12px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">PESO</div>
              <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
                <button class="num-btn" onclick="focoAdjust('weight',-0.5)" style="border-radius:8px;" aria-label="Diminuir peso">‚àí</button>
                <div style="font-family:'Bebas Neue'; font-size:40px; color:var(--orange); min-width:60px;" id="foco-weight">20</div>
                <button class="num-btn" onclick="focoAdjust('weight',0.5)" style="border-radius:8px;" aria-label="Aumentar peso">+</button>
              </div>
              <div style="font-size:12px; color:var(--muted2);">kg</div>
            </div>
            <div class="card" style="text-align:center; padding:20px;">
              <div style="font-size:12px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">REPS</div>
              <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
                <button class="num-btn" onclick="focoAdjust('reps',-1)" style="border-radius:8px;" aria-label="Diminuir repeti√ß√µes">‚àí</button>
                <div style="font-family:'Bebas Neue'; font-size:40px; color:var(--orange); min-width:40px;" id="foco-reps">0</div>
                <button class="num-btn" onclick="focoAdjust('reps',1)" style="border-radius:8px;" aria-label="Aumentar repeti√ß√µes">+</button>
              </div>
              <div style="font-size:12px; color:var(--muted2);">repeti√ß√µes</div>
            </div>
          </div>

          <div style="margin-bottom:24px;">
            <div style="font-size:12px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px; margin-bottom:10px; text-align:center;" id="foco-set-label">S√âRIE 1 DE 3</div>
            <div style="display:flex; gap:8px; justify-content:center;" id="foco-set-dots"></div>
          </div>

          <button class="btn btn-primary btn-full btn-lg" style="font-size:18px; padding:18px; border-radius:16px;" id="foco-action-btn" onclick="focoNextSet()">
            ‚úì S√©rie conclu√≠da
          </button>

          <button class="btn btn-ghost btn-full" style="margin-top:10px;" onclick="focoNextExercise()">
            Pr√≥ximo exerc√≠cio ‚Üí
          </button>
        </div>
      </div>

      <div id="foco-finish" style="display:none; min-height:100vh; display:none; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:32px;">
        <div style="font-size:64px; margin-bottom:16px;">üèÜ</div>
        <div style="font-family:'Bebas Neue'; font-size:48px; color:var(--orange); letter-spacing:2px; margin-bottom:8px;">TREINO FEITO!</div>
        <p style="color:var(--muted2); margin-bottom:32px;" id="foco-summary"></p>
        <button class="btn btn-primary btn-lg" onclick="focoFinish()">Salvar e voltar</button>
      </div>
    </div>

  </main>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let state = {
  user: null,
  exercises: [],
  workoutPlans: [],
  sessions: [],
  activeWorkout: null,
  workoutStartTime: null,
  workoutTimerInterval: null,
  restTimerInterval: null,
  restSecondsLeft: 0,
  // Modo Iniciante
  modoIniciante: {
    ativo: false,
    dataInicio: null,
    dataFim: null,
    semanasRestantes: 4
  },
  // Recupera√ß√£o
  recuperacao: {
    diasConsecutivos: 0,
    ultimoTreinoData: null,
    bloqueioProgressao: false,
    motivoBloqueio: null
  },
  // Cardio
  cardio: {
    historico: [],
    ultimoCardioIntenso: null
  }
};

function save() {
  localStorage.setItem('progressar_state', JSON.stringify(state));
}

function load() {
  const raw = localStorage.getItem('progressar_state');
  if (raw) {
    try { state = { ...state, ...JSON.parse(raw) }; } catch(e) {}
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ONBOARDING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentStep = 0;

function nextStep() {
  if (currentStep === 1) {
    const name = document.getElementById('user-name').value.trim();
    if (!name) { showNotif('‚ö†Ô∏è', 'Aten√ß√£o', 'Digite seu nome para continuar', 'warning'); return; }
  }
  document.getElementById(`step-${currentStep}`).classList.remove('active');
  document.getElementById(`dot-${currentStep}`).classList.remove('active');
  currentStep++;
  document.getElementById(`step-${currentStep}`).classList.add('active');
  document.getElementById(`dot-${currentStep}`).classList.add('active');
}

function finishOnboarding() {
  const name = document.getElementById('user-name').value.trim() || 'Atleta';
  const level = document.getElementById('user-level').value;
  const goal = document.getElementById('user-goal').value;

  state.user = { name, level, goal };
  state.exercises = [];
  state.workoutPlans = [];

  // Activate beginner mode if selected
  if (level === 'beginner') {
    state.modoIniciante = {
      ativo: true,
      dataInicio: Date.now(),
      dataFim: Date.now() + (28 * 86400000),
      semanasRestantes: 4
    };
  }

  save();
  document.getElementById('onboarding-screen').style.display = 'none';
  document.getElementById('app-screen').style.display = 'flex';
  initApp();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initApp() {
  updateDashboard();
  renderWorkoutPlans();
  renderExercises();
  renderHistorySelect();
  renderAllSessions();
  updateProfile();
}

function uid() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchView(view) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(`view-${view}`).classList.add('active');
  const nb = document.getElementById(`nav-${view}`);
  if (nb) nb.classList.add('active');
  // Refresh views when navigating
  if (view === 'perfil') updateProfile();
  if (view === 'cardio') renderCardioView();
  if (view === 'biblioteca') renderBiblioteca();
  if (view === 'dashboard') updateDashboard();
  // ebooks view needs no JS refresh ‚Äî static
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateDashboard() {
  if (!state.user) return;

  const hour = new Date().getHours();
  const greet = hour < 12 ? 'BOM DIA' : hour < 18 ? 'BOA TARDE' : 'BOA NOITE';
  document.getElementById('dash-greeting').textContent = `${greet}, ${state.user.name.toUpperCase()}!`;

  // Show install button if PWA prompt available
  const installBtn = document.getElementById('install-btn');
  if (installBtn && window.deferredPrompt) installBtn.style.display = 'flex';
  document.getElementById('dash-subtitle').textContent = getTodayMessage();

  document.getElementById('stat-sessions').textContent = state.sessions.length;
  document.getElementById('stat-progressions').textContent = countProgressions();
  const streak = calcStreak();
  document.getElementById('stat-streak').textContent = streak;
  document.getElementById('ring-streak-val').textContent = streak;

  const circ = 201;
  const maxStreak = 8;
  const offset = circ - (Math.min(streak, maxStreak) / maxStreak) * circ;
  setTimeout(() => { document.getElementById('ring-streak').style.strokeDashoffset = offset; }, 300);

  renderNextWorkout();
  renderProgressionAlerts();
  renderRecentSessions();

  // Show rest day button if 3+ consecutive days
  const restBtn2 = document.getElementById('rest-day-btn');
  if (restBtn2) {
    const cons = state.recuperacao?.diasConsecutivos || 0;
    restBtn2.style.display = cons >= 3 ? '' : 'none';
  }
}

function getTodayMessage() {
  // Modo iniciante badge
  if (state.modoIniciante?.ativo) {
    const weeks = state.modoIniciante.semanasRestantes;
    return `üå± Modo Iniciante ativo ‚Äî ${weeks} semana${weeks !== 1 ? 's' : ''} restante${weeks !== 1 ? 's' : ''}`;
  }
  // Recovery warning
  const rec = getRecoveryStatus();
  if (rec.recuperacao !== 'normal' && rec.mensagem) return rec.mensagem;
  if (state.sessions.length === 0) return 'Registre seu primeiro treino hoje!';
  const last = state.sessions[state.sessions.length - 1];
  const daysSince = Math.floor((Date.now() - last.date) / 86400000);
  if (daysSince === 0) return '√ìtimo trabalho hoje! Descanse bem.';
  if (daysSince === 1) return 'Voc√™ treinou ontem. Bora continuar!';
  if (daysSince <= 3) return 'Est√° na hora de treinar!';
  return `Faz ${daysSince} dias sem treinar. Que tal hoje?`;
}

function calcStreak() {
  if (state.sessions.length === 0) return 0;
  // FIX12: count CONSECUTIVE weeks with at least 1 session ‚Äî no gaps allowed
  const sorted = [...state.sessions].sort((a, b) => a.date - b.date);
  // Get unique weeks that have sessions
  const weeks = [...new Set(sorted.map(s => getWeekNumber(new Date(s.date))))].sort((a,b) => a - b);
  if (weeks.length === 0) return 0;
  // Walk backwards from most recent week counting consecutive weeks
  let streak = 1;
  for (let i = weeks.length - 1; i > 0; i--) {
    if (weeks[i] - weeks[i-1] === 1) {
      streak++;
    } else {
      break; // gap found ‚Äî stop counting
    }
  }
  return streak;
}

function getWeekNumber(d) {
  d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
  return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

function countProgressions() {
  return state.sessions.reduce((acc, s) => acc + (s.progressions || 0), 0);
}

function renderNextWorkout() {
  const el = document.getElementById('next-workout-content');
  if (state.workoutPlans.length === 0) {
    el.innerHTML = '<p style="color:var(--muted2);font-size:14px;">Crie seu primeiro treino para come√ßar!</p>';
    return;
  }

  const planLastDone = state.workoutPlans.map(p => {
    const sessions = state.sessions.filter(s => s.planId === p.id);
    const last = sessions.length ? Math.max(...sessions.map(s => s.date)) : 0;
    return { plan: p, last };
  });
  planLastDone.sort((a, b) => a.last - b.last);
  const next = planLastDone[0].plan;

  const exercises = next.exercises.map(id => state.exercises.find(e => e.id === id)).filter(Boolean);

  el.innerHTML = `
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
      <div>
        <div style="font-weight:700; font-size:16px;">${next.name}</div>
        <div style="font-size:13px; color:var(--muted2);">${next.day} ¬∑ ${exercises.length} exerc√≠cios</div>
      </div>
      <span class="tag tag-orange">${next.day}</span>
    </div>
    <div style="display:flex; flex-wrap:wrap; gap:6px;">
      ${exercises.map(e => `<span class="tag tag-blue">${e.name}</span>`).join('')}
    </div>
  `;

  document.getElementById('start-workout-btn').onclick = () => startWorkoutWithPlan(next);

  // Add rest day button
  const restBtn = document.getElementById('rest-day-btn');
  if (restBtn) restBtn.style.display = '';
}

function renderProgressionAlerts() {
  const el = document.getElementById('progression-alerts');
  const alerts = [];

  state.exercises.forEach(ex => {
    const sessions = state.sessions.filter(s => s.exercises?.some(e => e.exerciseId === ex.id));
    if (sessions.length < 2) return;

    const recent = sessions.slice(-3);
    const maxRep = parseInt(ex.reps.split('-')[1]);

    const lastSession = recent[recent.length - 1];
    const lastExData = lastSession.exercises?.find(e => e.exerciseId === ex.id);
    if (!lastExData) return;

    const avgReps = lastExData.sets?.reduce((a, s) => a + (parseInt(s.reps) || 0), 0) / (lastExData.sets?.length || 1);

    if (avgReps >= maxRep) {
      alerts.push(`<div class="suggestion-box" style="margin-bottom:10px;">
        <div style="display:flex; align-items:center; gap:8px;">
          <span style="font-size:20px;">üî•</span>
          <div>
            <div style="font-weight:700; color:var(--green);">Hora de subir o peso!</div>
            <div style="font-size:13px; color:var(--muted2);">${ex.name} ‚Äî Voc√™ atingiu ${maxRep} reps. Aumente 5-10% no pr√≥ximo treino.</div>
          </div>
        </div>
      </div>`);
    }

    if (sessions.length >= 3) {
      const weights = recent.map(s => s.exercises?.find(e => e.exerciseId === ex.id)?.weight || 0);
      const repsAvg = recent.map(s => {
        const exData = s.exercises?.find(e => e.exerciseId === ex.id);
        return exData?.sets?.reduce((a, s) => a + (parseInt(s.reps) || 0), 0) / (exData?.sets?.length || 1) || 0;
      });
      if (weights[0] === weights[1] && weights[1] === weights[2] && weights[0] > 0) {
        const repStagnation = repsAvg[0] === repsAvg[1] && repsAvg[1] === repsAvg[2];
        if (repStagnation) {
          alerts.push(`<div class="card card-sm" style="border-color:var(--yellow); margin-bottom:10px;">
            <div style="display:flex; align-items:center; gap:8px;">
              <span style="font-size:18px;">‚ö†Ô∏è</span>
              <div>
                <div style="font-weight:700; color:var(--yellow);">Plat√¥ detectado</div>
                <div style="font-size:13px; color:var(--muted2);">${ex.name} ‚Äî 3 sess√µes com ${weights[0]}kg e reps estagnadas. Tente microcarga (+0.5kg) ou adicione 1 s√©rie.</div>
              </div>
            </div>
          </div>`);
        }
      }
    }
  });

  // Cardio alerts
  const cardioAlertas = gerarAlertasCardio();
  cardioAlertas.forEach(a => alerts.unshift(a.html));

  if (state.sessions.length >= 5) {
    const last7days = state.sessions.filter(s => Date.now() - s.date < 7 * 86400000 && !s.isRestDay && !s.isCardio);
    if (last7days.length >= 5) {
      alerts.unshift(`<div class="card card-sm" style="border-color:var(--red); margin-bottom:10px;">
        <div style="display:flex; align-items:center; gap:10px;">
          <span style="font-size:24px;">üò¥</span>
          <div>
            <div style="font-weight:700; color:var(--red);">Fadiga acumulada detectada!</div>
            <div style="font-size:13px; color:var(--muted2);">Voc√™ treinou ${last7days.length}x nos √∫ltimos 7 dias. Considere 1-2 dias de descanso ou uma semana de deload (50% da carga).</div>
          </div>
        </div>
      </div>`);
    }

    const sortedDates = state.sessions.slice(-5).map(s => new Date(s.date).toDateString());
    const uniqueDays = new Set(sortedDates);
    if (uniqueDays.size >= 5) {
      const dayDiffs = state.sessions.slice(-5).map(s => s.date).sort();
      let consecutive = true;
      for (let i = 1; i < dayDiffs.length; i++) {
        if (dayDiffs[i] - dayDiffs[i-1] > 2 * 86400000) { consecutive = false; break; }
      }
      if (consecutive && !alerts.some(a => a.includes('Fadiga'))) {
        alerts.unshift(`<div class="card card-sm" style="border-color:var(--yellow); margin-bottom:10px;">
          <div style="display:flex; align-items:center; gap:10px;">
            <span style="font-size:24px;">‚ö°</span>
            <div>
              <div style="font-weight:700; color:var(--yellow);">5 treinos sem dia de descanso</div>
              <div style="font-size:13px; color:var(--muted2);">O descanso √© parte do treino. M√∫sculos crescem na recupera√ß√£o, n√£o na academia.</div>
            </div>
          </div>
        </div>`);
      }
    }
  }

  el.innerHTML = alerts.length ? `<div class="section-title">ALERTAS DE PROGRESS√ÉO</div>${alerts.join('')}` : '';
}

function renderRecentSessions() {
  const el = document.getElementById('recent-sessions');
  if (state.sessions.length === 0) {
    el.innerHTML = `<div style="color:var(--muted2); font-size:14px; padding:16px; text-align:center; background:var(--card); border-radius:12px; border:1px solid var(--border);">
      Nenhuma sess√£o registrada ainda.<br>Inicie seu primeiro treino!
    </div>`;
    return;
  }

  const recent = [...state.sessions].reverse().slice(0, 5);
  el.innerHTML = recent.map(s => {
    const plan = state.workoutPlans.find(p => p.id === s.planId);
    const date = new Date(s.date).toLocaleDateString('pt-BR');
    const exCount = s.exercises?.length || 0;
    const vol = calcVolume(s);
    const progs = s.progressions || 0;
    return `<div class="card card-sm" style="margin-bottom:8px; display:flex; align-items:center; justify-content:space-between;">
      <div>
        <div style="font-weight:600; font-size:14px;">${plan?.name || 'Treino'}</div>
        <div style="font-size:12px; color:var(--muted2); margin-top:2px;">${date} ¬∑ ${exCount} exerc√≠cios ¬∑ ${vol}kg volume</div>
      </div>
      <div style="display:flex; gap:6px;">
        ${progs > 0 ? `<span class="tag tag-green">‚Üë ${progs} prog.</span>` : ''}
        <span class="tag tag-orange">‚úì</span>
      </div>
    </div>`;
  }).join('');
}

function calcVolume(session) {
  if (!session.exercises) return 0;
  return session.exercises.reduce((total, ex) => {
    const sets = ex.sets || [];
    return total + sets.reduce((st, s) => st + (parseFloat(s.weight) || 0) * (parseInt(s.reps) || 0), 0);
  }, 0);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WORKOUT PLANS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let wb = { step: 1, selectedDays: [], selectedExIds: [], filter: 'Todos' };

function openWorkoutBuilder() {
  wb = { step: 1, selectedDays: [], selectedExIds: [], filter: 'Todos' };
  document.getElementById('plan-name').value = '';
  document.querySelectorAll('.day-pill').forEach(p => p.classList.remove('selected'));
  document.getElementById('wb-new-ex-panel').style.display = 'none';
  wbGoTo(1);
  openModal('workout-plan-modal');
}

function toggleDay(btn) {
  btn.classList.toggle('selected');
  const day = btn.dataset.day;
  if (wb.selectedDays.includes(day)) wb.selectedDays = wb.selectedDays.filter(d => d !== day);
  else wb.selectedDays.push(day);
}

function wbGoTo(step) {
  [1,2,3].forEach(s => {
    document.getElementById(`wb-step-${s}`).style.display = s === step ? 'block' : 'none';
    const ind = document.getElementById(`wbi-${s}`);
    ind.classList.remove('active','done');
    if (s === step) ind.classList.add('active');
    else if (s < step) ind.classList.add('done');
  });
  [1,2].forEach(l => {
    const line = document.getElementById(`wbl-${l}`);
    line.classList.toggle('done', l < step);
  });
  wb.step = step;
  if (step === 2) wbRenderExercises();
  if (step === 3) wbRenderConfirm();
}

function wbNext(step) {
  if (step === 1) {
    const name = document.getElementById('plan-name').value.trim();
    if (!name) { showNotif('‚ö†Ô∏è', 'Aten√ß√£o', 'Digite o nome do treino', 'warning'); return; }
    if (wb.selectedDays.length === 0) { showNotif('‚ö†Ô∏è', 'Aten√ß√£o', 'Selecione pelo menos um dia', 'warning'); return; }
  }
  if (step === 2 && wb.selectedExIds.length === 0) {
    showNotif('‚ö†Ô∏è', 'Aten√ß√£o', 'Adicione pelo menos 1 exerc√≠cio', 'warning'); return;
  }
  wbGoTo(step + 1);
}

function wbBack(step) { wbGoTo(step - 1); }

function wbFilter(group) {
  wb.filter = group;
  document.querySelectorAll('#wb-group-filters .btn').forEach(b => {
    b.classList.toggle('btn-primary', b.textContent.trim().replace(/[^ -~]/g,'').trim() === group || b.textContent.trim() === group);
    b.classList.toggle('btn-ghost', !(b.textContent.trim().replace(/[^ -~]/g,'').trim() === group || b.textContent.trim() === group));
  });
  wbRenderExercises();
}

function wbRenderExercises() {
  const list = document.getElementById('wb-exercise-list');
  const filtered = wb.filter === 'Todos' ? state.exercises : state.exercises.filter(e => e.group === wb.filter);
  if (filtered.length === 0) {
    list.innerHTML = `<div style="text-align:center; padding:20px; color:var(--muted2); font-size:13px;">Nenhum exerc√≠cio nesta categoria.<br>Crie um novo abaixo!</div>`;
    return;
  }
  list.innerHTML = filtered.map(ex => {
    const sel = wb.selectedExIds.includes(ex.id);
    return `<div class="wb-ex-row ${sel ? 'selected' : ''}" onclick="wbToggleEx('${ex.id}', this)">
      <div class="wb-ex-check">${sel ? '‚úì' : ''}</div>
      <div style="font-size:18px;">${groupEmoji(ex.group)}</div>
      <div style="flex:1;">
        <div style="font-weight:600; font-size:13px;">${ex.name}</div>
        <div style="font-size:11px; color:var(--muted2);">${ex.group} ¬∑ ${ex.equip} ¬∑ ${ex.sets}x${ex.reps} ¬∑ ${ex.weight}kg</div>
      </div>
    </div>`;
  }).join('');
  wbUpdateSelectedPreview();
}

function wbToggleEx(id, row) {
  if (wb.selectedExIds.includes(id)) {
    wb.selectedExIds = wb.selectedExIds.filter(i => i !== id);
    row.classList.remove('selected');
    row.querySelector('.wb-ex-check').textContent = '';
  } else {
    wb.selectedExIds.push(id);
    row.classList.add('selected');
    row.querySelector('.wb-ex-check').textContent = '‚úì';
  }
  wbUpdateSelectedPreview();
}

function wbUpdateSelectedPreview() {
  const count = document.getElementById('wb-selected-count');
  const tags = document.getElementById('wb-selected-tags');
  count.textContent = wb.selectedExIds.length;
  if (wb.selectedExIds.length === 0) {
    tags.innerHTML = `<span style="color:var(--muted); font-size:13px; font-style:italic;">Nenhum exerc√≠cio selecionado</span>`;
    return;
  }
  tags.innerHTML = wb.selectedExIds.map(id => {
    const ex = state.exercises.find(e => e.id === id);
    return ex ? `<span class="tag tag-orange" style="cursor:pointer;" onclick="wbToggleEx('${id}', document.querySelector('[onclick*=\"${id}\"]')?.closest('.wb-ex-row'))">${ex.name} ‚úï</span>` : '';
  }).join('');
}

function toggleNewExPanel() {
  const panel = document.getElementById('wb-new-ex-panel');
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function wbCreateAndAdd() {
  const name = document.getElementById('wb-ex-name').value.trim();
  if (!name) { showNotif('‚ö†Ô∏è', 'Aten√ß√£o', 'Digite o nome do exerc√≠cio', 'warning'); return; }
  const ex = {
    id: uid(), name,
    group: document.getElementById('wb-ex-group').value,
    equip: document.getElementById('wb-ex-equip').value,
    weight: parseFloat(document.getElementById('wb-ex-weight').value) || 20,
    reps: document.getElementById('wb-ex-reps').value,
    sets: parseInt(document.getElementById('wb-ex-sets').value) || 3,
    rest: parseInt(document.getElementById('wb-ex-rest').value) || 90,
    increment: parseFloat(document.getElementById('wb-ex-increment').value) || 2,
    execution: document.getElementById('wb-execution').value || 'livre',
  };
  state.exercises.push(ex);
  wb.selectedExIds.push(ex.id);
  document.getElementById('wb-ex-name').value = '';
  toggleNewExPanel();
  wbRenderExercises();
  renderExercises();
  showNotif('üí™', 'Exerc√≠cio criado!', ex.name + ' adicionado ao treino', 'success');
}

function wbRenderConfirm() {
  const name = document.getElementById('plan-name').value.trim();
  const days = wb.selectedDays;
  const exs = wb.selectedExIds.map(id => state.exercises.find(e => e.id === id)).filter(Boolean);
  document.getElementById('wb-confirm-content').innerHTML = `
    <div class="card card-sm" style="margin-bottom:12px; background:var(--orange-dim); border-color:var(--orange-mid);">
      <div style="font-weight:700; font-size:18px; margin-bottom:4px;">${name}</div>
      <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:8px;">
        ${days.map(d => `<span class="tag tag-orange">${d}</span>`).join('')}
      </div>
    </div>
    <div class="section-title" style="margin-bottom:10px;">${exs.length} EXERC√çCIOS</div>
    ${exs.map((e,i) => `<div style="display:flex; align-items:center; gap:10px; padding:10px 12px; background:var(--card2); border-radius:10px; margin-bottom:6px;">
      <div style="font-size:16px;">${groupEmoji(e.group)}</div>
      <div style="flex:1;">
        <div style="font-weight:600; font-size:13px;">${e.name}</div>
        <div style="font-size:11px; color:var(--muted2);">${e.sets} s√©ries ¬∑ ${e.reps} reps ¬∑ ${e.weight}kg</div>
      </div>
      <span class="tag tag-blue">${i+1}</span>
    </div>`).join('')}
  `;
}

function saveWorkoutPlan() {
  const name = document.getElementById('plan-name').value.trim();
  if (!name) { showNotif('‚ö†Ô∏è', 'Aten√ß√£o', 'Digite o nome do treino', 'warning'); return; }
  state.workoutPlans.push({ id: uid(), name, day: wb.selectedDays.join(', '), exercises: [...wb.selectedExIds] });
  save();
  closeModal('workout-plan-modal');
  renderWorkoutPlans();
  updateDashboard();
  showNotif('‚úÖ', 'Treino criado!', `"${name}" com ${wb.selectedExIds.length} exerc√≠cios`, 'success');
}

function openEditWorkout(planId) {
  const plan = state.workoutPlans.find(p => p.id === planId);
  if (!plan) return;
  document.getElementById('edit-plan-id').value = plan.id;
  document.getElementById('edit-plan-name').value = plan.name;
  const days = plan.day ? plan.day.split(', ') : [];
  document.querySelectorAll('#edit-day-selector .day-pill').forEach(btn => {
    btn.classList.toggle('selected', days.includes(btn.dataset.day));
  });
  openModal('edit-workout-modal');
}

function updateWorkoutPlan() {
  const id = document.getElementById('edit-plan-id').value;
  const plan = state.workoutPlans.find(p => p.id === id);
  if (!plan) return;
  plan.name = document.getElementById('edit-plan-name').value.trim();
  const selectedDays = [];
  document.querySelectorAll('#edit-day-selector .day-pill.selected').forEach(btn => selectedDays.push(btn.dataset.day));
  plan.day = selectedDays.join(', ');
  save();
  closeModal('edit-workout-modal');
  renderWorkoutPlans();
  showNotif('‚úèÔ∏è', 'Treino atualizado', '', 'success');
}

function renderWorkoutPlans() {
  const el = document.getElementById('workout-plans-list');
  if (state.workoutPlans.length === 0) {
    el.innerHTML = `<div style="color:var(--muted2); font-size:14px; padding:24px; text-align:center; background:var(--card); border-radius:12px; border:1px dashed var(--border2);">
      <div style="font-size:32px; margin-bottom:8px;">üìã</div>
      Nenhum treino criado ainda.<br>Clique em "+ Novo Treino" para come√ßar!
    </div>`;
    return;
  }

  el.innerHTML = state.workoutPlans.map(plan => {
    const exs = plan.exercises.map(id => state.exercises.find(e => e.id === id)).filter(Boolean);
    const sessions = state.sessions.filter(s => s.planId === plan.id);
    const days = plan.day ? plan.day.split(', ') : [];
    return `<div class="card" id="plan-${plan.id}" style="margin-bottom:16px;">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:14px;">
        <div>
          <div style="font-weight:700; font-size:17px;">${plan.name}</div>
          <div style="display:flex; gap:5px; margin-top:6px; flex-wrap:wrap;">
            ${days.map(d => `<span class="tag tag-orange">${d}</span>`).join('')}
            <span style="color:var(--muted2); font-size:12px; align-self:center;">${sessions.length} sess√µes</span>
          </div>
        </div>
        <div style="display:flex; gap:6px;">
          <button class="btn btn-primary" onclick="startWorkoutWithPlan(state.workoutPlans.find(p=>p.id==='${plan.id}'))">‚ñ∂ Iniciar</button>
          <button class="btn btn-ghost" onclick="openEditWorkout('${plan.id}')" title="Editar treino">‚úèÔ∏è</button>
          <button class="btn btn-ghost" onclick="deletePlan('${plan.id}')" title="Excluir treino">üóë</button>
        </div>
      </div>

      <div style="display:flex; flex-direction:column; gap:6px;">
        ${exs.length === 0
          ? `<div style="color:var(--muted); font-size:13px; padding:12px; text-align:center; background:var(--card2); border-radius:8px; border:1px dashed var(--border2);">Nenhum exerc√≠cio neste treino</div>`
          : exs.map((e, idx) => `<div style="display:flex; align-items:center; gap:10px; padding:10px 12px; background:var(--card2); border-radius:10px; border:1px solid var(--border);">
            <div style="font-size:18px;">${groupEmoji(e.group)}</div>
            <div style="flex:1;">
              <div style="font-weight:600; font-size:13px;">${e.name}</div>
              <div style="font-size:11px; color:var(--muted2); margin-top:2px; display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
                <span>${e.sets}x${e.reps} ¬∑ ${e.weight}kg</span>
                <span class="tag" style="font-size:9px; background:${e.execution==='maquina'?'var(--blue-dim)':'var(--orange-dim)'}; color:${e.execution==='maquina'?'var(--blue)':'var(--orange)'}; padding:2px 6px;">${e.execution==='maquina'?'‚öôÔ∏è M√°quina':'üèãÔ∏è Livre'}</span>
                <span style="color:var(--muted2);">${e.equip}</span>
                <span style="color:var(--orange);">+${e.increment||2}kg</span>
              </div>
            </div>
            <div style="display:flex; gap:4px; align-items:center;">
              ${getSuggestion(e, plan.id)}
              <button class="btn btn-ghost" style="padding:5px 9px; font-size:12px;" onclick="removeExerciseFromPlan('${plan.id}','${e.id}')" title="Remover">‚úï</button>
              <button class="btn btn-ghost" style="padding:5px 9px; font-size:12px;" onclick="moveExercise('${plan.id}', ${idx}, 'up')" ${idx === 0 ? 'disabled' : ''}>‚Üë</button>
              <button class="btn btn-ghost" style="padding:5px 9px; font-size:12px;" onclick="moveExercise('${plan.id}', ${idx}, 'down')" ${idx === exs.length-1 ? 'disabled' : ''}>‚Üì</button>
            </div>
          </div>`).join('')}
      </div>

      <div style="border-top:1px solid var(--border); margin-top:14px; padding-top:12px; display:flex; gap:8px; align-items:center;">
        <select id="add-ex-${plan.id}" style="flex:1; font-size:13px;">
          <option value="">+ Adicionar exerc√≠cio...</option>
          ${state.exercises.filter(e => !plan.exercises.includes(e.id)).map(e => `<option value="${e.id}">${groupEmoji(e.group)} ${e.name} (${e.weight}kg)</option>`).join('')}
        </select>
        <button class="btn btn-ghost" style="white-space:nowrap;" onclick="addExerciseToPlan('${plan.id}')">Adicionar</button>
      </div>
    </div>`;
  }).join('');
}

function moveExercise(planId, index, direction) {
  const plan = state.workoutPlans.find(p => p.id === planId);
  if (!plan) return;
  const newIndex = direction === 'up' ? index - 1 : index + 1;
  if (newIndex < 0 || newIndex >= plan.exercises.length) return;
  [plan.exercises[index], plan.exercises[newIndex]] = [plan.exercises[newIndex], plan.exercises[index]];
  save();
  renderWorkoutPlans();
}

function getSuggestion(ex, planId) {
  const sessions = state.sessions.filter(s => s.planId === planId && s.exercises?.some(e => e.exerciseId === ex.id));
  if (sessions.length === 0) return '';
  const last = sessions[sessions.length - 1];
  const lastEx = last.exercises?.find(e => e.exerciseId === ex.id);
  if (!lastEx) return '';
  const maxRep = parseInt(ex.reps.split('-')[1]);
  const avgReps = lastEx.sets?.reduce((a, s) => a + (parseInt(s.reps) || 0), 0) / (lastEx.sets?.length || 1);
  if (avgReps >= maxRep) return `<span class="tag tag-green">‚Üë Subir peso!</span>`;
  return `<span class="tag tag-blue">${Math.round(avgReps)} reps</span>`;
}

function addExerciseToPlan(planId) {
  const sel = document.getElementById(`add-ex-${planId}`);
  if (!sel || !sel.value) return;
  const plan = state.workoutPlans.find(p => p.id === planId);
  if (!plan.exercises.includes(sel.value)) {
    plan.exercises.push(sel.value);
    save();
    renderWorkoutPlans();
  }
}

function removeExerciseFromPlan(planId, exId) {
  if (!confirm('Remover este exerc√≠cio do treino?')) return;
  const plan = state.workoutPlans.find(p => p.id === planId);
  plan.exercises = plan.exercises.filter(id => id !== exId);
  save();
  renderWorkoutPlans();
}

function deletePlan(id) {
  if (!confirm('Tem certeza que deseja excluir este treino?')) return;
  state.workoutPlans = state.workoutPlans.filter(p => p.id !== id);
  save();
  renderWorkoutPlans();
  showNotif('üóë', 'Treino removido', '', '');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXERCISES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeFilter = 'all';

function saveExercise() {
  const name = document.getElementById('ex-name').value.trim();
  if (!name) { showNotif('‚ö†Ô∏è', 'Aten√ß√£o', 'Digite o nome do exerc√≠cio', 'warning'); return; }

  const ex = {
    id: uid(),
    name,
    group: document.getElementById('ex-group').value,
    equip: document.getElementById('ex-equip').value,
    weight: parseFloat(document.getElementById('ex-weight').value) || 20,
    reps: document.getElementById('ex-reps').value,
    sets: parseInt(document.getElementById('ex-sets').value) || 3,
    rest: parseInt(document.getElementById('ex-rest').value) || 90,
    increment: parseFloat(document.getElementById('ex-increment').value) || 2,
    execution: document.getElementById('ex-execution').value || 'livre',
  };

  state.exercises.push(ex);
  save();
  closeModal('exercise-modal');
  renderExercises();
  renderWorkoutPlans();
  showNotif('üí™', 'Exerc√≠cio adicionado!', ex.name, 'success');
  document.getElementById('ex-name').value = '';
}

function openEditExercise(exId) {
  const ex = state.exercises.find(e => e.id === exId);
  if (!ex) return;
  document.getElementById('edit-ex-id').value = ex.id;
  document.getElementById('edit-ex-name').value = ex.name;
  document.getElementById('edit-ex-group').value = ex.group;
  document.getElementById('edit-ex-equip').value = ex.equip;
  document.getElementById('edit-ex-weight').value = ex.weight;
  document.getElementById('edit-ex-reps').value = ex.reps;
  document.getElementById('edit-ex-sets').value = ex.sets;
  document.getElementById('edit-ex-rest').value = ex.rest;
  document.getElementById('edit-ex-increment').value = ex.increment;
  setExecution(ex.execution, 'edit');
  openModal('edit-exercise-modal');
}

function updateExercise() {
  const id = document.getElementById('edit-ex-id').value;
  const ex = state.exercises.find(e => e.id === id);
  if (!ex) return;
  ex.name = document.getElementById('edit-ex-name').value.trim();
  ex.group = document.getElementById('edit-ex-group').value;
  ex.equip = document.getElementById('edit-ex-equip').value;
  ex.weight = parseFloat(document.getElementById('edit-ex-weight').value) || 20;
  ex.reps = document.getElementById('edit-ex-reps').value;
  ex.sets = parseInt(document.getElementById('edit-ex-sets').value) || 3;
  ex.rest = parseInt(document.getElementById('edit-ex-rest').value) || 90;
  ex.increment = parseFloat(document.getElementById('edit-ex-increment').value) || 2;
  ex.execution = document.getElementById('edit-ex-execution').value || 'livre';
  save();
  closeModal('edit-exercise-modal');
  renderExercises();
  renderWorkoutPlans();
  showNotif('‚úèÔ∏è', 'Exerc√≠cio atualizado', ex.name, 'success');
}

function filterExercises(group) {
  activeFilter = group;
  renderExercises();
}

function renderExercises() {
  const groups = [...new Set(state.exercises.map(e => e.group))];
  const filterEl = document.getElementById('muscle-filters');
  filterEl.innerHTML = `
    <button class="btn ${activeFilter === 'all' ? 'btn-primary' : 'btn-ghost'}" style="font-size:12px;" onclick="filterExercises('all')">Todos (${state.exercises.length})</button>
    ${groups.map(g => `<button class="btn ${activeFilter === g ? 'btn-primary' : 'btn-ghost'}" style="font-size:12px;" onclick="filterExercises('${g}')">${groupEmoji(g)} ${g}</button>`).join('')}
  `;

  const filtered = activeFilter === 'all' ? state.exercises : state.exercises.filter(e => e.group === activeFilter);
  const el = document.getElementById('exercises-list');

  if (filtered.length === 0) {
    el.innerHTML = `<div style="text-align:center; padding:32px; color:var(--muted2);">
      <div style="font-size:32px; margin-bottom:8px;">üí™</div>
      Nenhum exerc√≠cio nesta categoria
    </div>`;
    return;
  }

  el.innerHTML = filtered.map(ex => {
    const sessions = state.sessions.filter(s => s.exercises?.some(e => e.exerciseId === ex.id));
    const pr = getPR(ex.id);
    return `<div class="exercise-row" style="cursor:default; margin-bottom:8px;">
      <div class="exercise-icon">${groupEmoji(ex.group)}</div>
      <div style="flex:1;">
        <div class="exercise-name">${ex.name}</div>
        <div class="exercise-meta">${ex.group} ¬∑ ${ex.equip} ¬∑ ${ex.sets}x${ex.reps}</div>
      </div>
      <div style="text-align:right; flex-shrink:0;">
        <div style="font-family:'DM Mono'; font-weight:700; color:var(--orange);">${ex.weight}kg</div>
        ${pr > ex.weight ? `<div style="font-size:11px; color:var(--green);">PR: ${pr}kg üèÜ</div>` : ''}
        <span class="tag" style="font-size:9px; margin-top:4px; background:${ex.execution==='maquina'?'var(--blue-dim)':'var(--orange-dim)'}; color:${ex.execution==='maquina'?'var(--blue)':'var(--orange)'}; padding:2px 6px; border-radius:4px;">${ex.execution==='maquina'?'‚öôÔ∏è M√°q':'üèãÔ∏è Livre'}</span>
        <div style="font-size:11px; color:var(--orange); margin-top:2px;">+${ex.increment||2}kg/inc</div>
        <div style="font-size:11px; color:var(--muted);">${sessions.length} sess√µes</div>
      </div>
      <button class="btn btn-ghost" style="padding:5px;" onclick="openEditExercise('${ex.id}')" title="Editar">‚úèÔ∏è</button>
    </div>`;
  }).join('');
}

function getPR(exId) {
  let max = 0;
  state.sessions.forEach(s => {
    const exData = s.exercises?.find(e => e.exerciseId === exId);
    if (exData?.sets) {
      exData.sets.forEach(set => { if ((parseFloat(set.weight) || 0) > max) max = parseFloat(set.weight); });
    }
  });
  return max;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PR√â-TREINO ‚Äî Execu√ß√£o + Tipo de Carga
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pwmState = { exIdx: 0, exec: null, load: null, pendingWorkout: null };

const LOAD_OPTIONS = {
  maquina: [
    { key: 'barra',   label: 'Barra',   emoji: 'üèãÔ∏è', inc: 2.5 },
    { key: 'anilha',  label: 'Anilha',  emoji: '‚≠ï', inc: 5   },
    { key: 'pino',    label: 'Pino',    emoji: 'üî¢', inc: 5   },
  ],
  livre: [
    { key: 'halter',  label: 'Haltere', emoji: 'ü•ä', inc: 2   },
    { key: 'dubles',  label: 'Dubles',  emoji: 'üí™', inc: 2   },
    { key: 'anilha',  label: 'Anilha',  emoji: '‚≠ï', inc: 2.5 },
  ],
};

function openPreWorkoutModal(pendingWorkout) {
  pwmState = { exIdx: 0, exec: null, load: null, pendingWorkout };
  showNextPreWorkoutEx();
}

function showNextPreWorkoutEx() {
  const workout = pwmState.pendingWorkout;
  if (pwmState.exIdx >= workout.exercises.length) {
    finishPreWorkout();
    return;
  }
  const ex = workout.exercises[pwmState.exIdx];
  pwmState.exec = null;
  pwmState.load = null;

  document.getElementById('pwm-ex-name').textContent = ex.name.toUpperCase();
  document.getElementById('pwm-ex-sub').textContent =
    `Exerc√≠cio ${pwmState.exIdx + 1} de ${workout.exercises.length}`;
  document.getElementById('pwm-weight-display').textContent = `${ex.weight}kg`;
  document.getElementById('pwm-inc-display').textContent = `+${ex.increment || 2}kg`;
  document.getElementById('pwm-confirm-btn').disabled = true;

  document.querySelectorAll('.pwm-option').forEach(b => b.classList.remove('selected'));
  document.getElementById('pwm-load-options').innerHTML = '';

  openModal('pre-workout-modal');
}

function selectExec(btn) {
  document.querySelectorAll('.pwm-option').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  pwmState.exec = btn.dataset.exec;
  pwmState.load = null;

  const opts = LOAD_OPTIONS[pwmState.exec] || [];
  document.getElementById('pwm-load-options').innerHTML = opts.map(o =>
    `<button class="pwm-load-btn" data-key="${o.key}" data-inc="${o.inc}" onclick="selectLoad(this)">
      <div style="font-size:22px; margin-bottom:5px;">${o.emoji}</div>
      <div style="font-weight:600;">${o.label}</div>
    </button>`
  ).join('');
  document.getElementById('pwm-confirm-btn').disabled = true;
}

function selectLoad(btn) {
  document.querySelectorAll('.pwm-load-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  pwmState.load = btn.dataset.key;

  const inc = parseFloat(btn.dataset.inc);
  const ex = pwmState.pendingWorkout.exercises[pwmState.exIdx];
  ex.execType = pwmState.exec;
  ex.loadType = pwmState.load;
  ex.customIncrement = inc; // store for later use in suggestion
  ex.increment = inc; // override for this session

  document.getElementById('pwm-inc-display').textContent = `+${ex.increment}kg`;
  document.getElementById('pwm-confirm-btn').disabled = false;

  // Auto-advance after a short delay
  setTimeout(() => {
    if (document.getElementById('pre-workout-modal').classList.contains('open')) {
      confirmPreWorkout();
    }
  }, 600);
}

function skipPreWorkout() {
  pwmState.exIdx++;
  if (pwmState.exIdx >= pwmState.pendingWorkout.exercises.length) {
    closeModal('pre-workout-modal');
    finishPreWorkout();
  } else {
    showNextPreWorkoutEx();
  }
}

function confirmPreWorkout() {
  pwmState.exIdx++;
  if (pwmState.exIdx >= pwmState.pendingWorkout.exercises.length) {
    closeModal('pre-workout-modal');
    finishPreWorkout();
  } else {
    showNextPreWorkoutEx();
  }
}

function finishPreWorkout() {
  const workout = pwmState.pendingWorkout;
  state.activeWorkout = workout;
  state.activeWorkout.exercises.forEach(ex => {
    ex._originalWeight = ex.weight; // FIX1: snapshot for progression count
    // FIX3: use selectedLoad increment if available, fall back to exercise increment
    if (ex.selectedLoad && ex.selectedLoad.inc) {
      ex.increment = ex.selectedLoad.inc;
    }
    ex.increment = ex.increment || 2; // FIX4: ensure never undefined
  });
  state.workoutStartTime = Date.now();
  document.getElementById('active-workout-title').textContent =
    state.workoutPlans.find(p => p.id === workout.planId)?.name.toUpperCase() || 'TREINO';
  startWorkoutTimer();
  renderActiveWorkout();
  switchView('workout-active');
}

function confirmProgression(exIdx) {
  if (!state.activeWorkout) return;
  const activeEx = state.activeWorkout.exercises[exIdx];
  if (!activeEx || !activeEx.suggestedWeight) return;

  const confirmed = activeEx.suggestedWeight;
  activeEx.weight = confirmed;
  activeEx.currentWeight = confirmed;
  activeEx._progressionConfirmed = true; // FIX1: for finishWorkout counter
  activeEx.suggestedWeight = null;

  activeEx.sets.forEach(set => {
    if (!set.done) set.weight = confirmed;
  });

  const exDef = state.exercises.find(e => e.id === activeEx.exerciseId);
  if (exDef) {
    exDef.weight = confirmed;
    save();
  }

  renderActiveWorkout();
  showNotif('üî•', `Progress√£o confirmada!`, `${activeEx.name}: ${confirmed}kg`, 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MOTOR DE PROGRESS√ÉO REAL ‚Äî PROGRESSAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getMuzyPhase(level) {
  if (level === 'beginner') return 'execucao';
  if (level === 'intermediate') return 'carga';
  return 'volume';
}

function getExerciseHistory(exId, planId) {
  return state.sessions
    .filter(s => s.planId === planId && s.exercises?.some(e => e.exerciseId === exId))
    .map(s => {
      const exData = s.exercises.find(e => e.exerciseId === exId);
      const doneSets = exData?.sets?.filter(set => set.done !== false && parseInt(set.reps) > 0) || [];
      const weights = doneSets.map(set => parseFloat(set.weight) || 0);
      const reps = doneSets.map(set => parseInt(set.reps) || 0);
      return {
        date: s.date,
        weight: weights.length ? Math.max(...weights) : 0,
        avgReps: reps.length ? reps.reduce((a,b) => a+b, 0) / reps.length : 0,
        allSets: doneSets,
        allHitMax: (maxRep) => reps.length > 0 && reps.every(r => r >= maxRep),
      };
    })
    .filter(h => h.weight > 0);
}

function hasPerformanceDrop(history, n = 2) {
  if (history.length < n) return false;
  const recent = history.slice(-n);
  for (let i = 1; i < recent.length; i++) {
    if (recent[i].avgReps < recent[i-1].avgReps - 1) return true;
  }
  return false;
}

function hasSignificantDrop(history) {
  if (history.length < 3) return false;
  const recent = history.slice(-3);
  return recent[2].avgReps < recent[1].avgReps && recent[1].avgReps < recent[0].avgReps;
}

function getWeightSuggestion(ex, planId, customIncrement = null) {
  const repRange = ex.reps.split('-');
  const minRep = parseInt(repRange[0]);
  const maxRep = parseInt(repRange[1]);
  const increment = customIncrement !== null ? customIncrement : (ex.increment || 2);
  const level = state.user?.level || 'intermediate';
  const phase = getMuzyPhase(level);

  const history = getExerciseHistory(ex.id, planId);

  if (history.length === 0) {
    return {
      weight: ex.weight, minRep, maxRep, phase,
      increment,
      tip: { type: 'info', msg: `Primeira sess√£o! Foco em executar com t√©cnica. Meta: ${minRep}‚Äì${maxRep} reps com ${ex.weight}kg.` },
      progressionBlocked: false,
      suggestedWeight: null,
    };
  }

  const last = history[history.length - 1];
  const currentWeight = last.weight;
  const lastHitMax = last.allHitMax(maxRep);
  const performanceDrop = hasPerformanceDrop(history, 2);
  const significantDrop = hasSignificantDrop(history);

  if (significantDrop) {
    const deloadWeight = currentWeight - increment;
    return {
      weight: currentWeight, minRep, maxRep, phase, increment,
      progressionBlocked: true,
      suggestedWeight: deloadWeight > 0 ? deloadWeight : currentWeight,
      tip: {
        type: 'deload',
        msg: `Queda de performance em 3 sess√µes seguidas. Deload recomendado: reduza para ${deloadWeight > 0 ? deloadWeight : currentWeight}kg por 1 semana.`
      }
    };
  }

  if (performanceDrop) {
    return {
      weight: currentWeight, minRep, maxRep, phase, increment,
      progressionBlocked: true,
      suggestedWeight: null,
      tip: {
        type: 'warning',
        msg: `Performance caindo. Mantenha ${currentWeight}kg e foque em atingir ${maxRep} reps em todas as s√©ries antes de subir.`
      }
    };
  }

  let suggestedWeight = null;
  let tip = null;

  if (phase === 'execucao') {
    const last2 = history.slice(-2);
    const bothHitMax = last2.length >= 2 && last2.every(h => h.allHitMax(maxRep));

    if (bothHitMax) {
      suggestedWeight = currentWeight + increment;
      tip = {
        type: 'up',
        msg: `Voc√™ atingiu o topo da faixa. Pr√≥xima carga sugerida: ${suggestedWeight}kg (+${increment}kg)`
      };
    } else if (lastHitMax) {
      tip = {
        type: 'info',
        msg: `√ìtimo! Repita ${currentWeight}kg com t√©cnica perfeita mais uma vez antes de subir.`
      };
    } else {
      tip = {
        type: 'info',
        msg: `Foco na execu√ß√£o. Atinja ${maxRep} reps em todas as s√©ries antes de aumentar a carga.`
      };
    }

  } else if (phase === 'carga') {
    if (lastHitMax) {
      suggestedWeight = currentWeight + increment;
      tip = {
        type: 'up',
        msg: `Voc√™ atingiu o topo da faixa. Pr√≥xima carga sugerida: ${suggestedWeight}kg (+${increment}kg). Volte para ${minRep} reps.`
      };
    } else {
      tip = {
        type: 'info',
        msg: `Tente atingir ${maxRep} reps em todas as s√©ries para subir a carga.`
      };
    }

  } else {
    const last3 = history.slice(-3);
    const consolidated = last3.length >= 3 && last3.every(h => h.allHitMax(maxRep));

    if (consolidated) {
      suggestedWeight = currentWeight + increment;
      tip = {
        type: 'up',
        msg: `Volume dominado em 3 sess√µes! Pr√≥xima carga sugerida: ${suggestedWeight}kg (+${increment}kg).`
      };
    } else if (lastHitMax) {
      tip = {
        type: 'volume',
        msg: `Tente adicionar +1 s√©rie antes de subir o peso. Volume primeiro!`
      };
    } else {
      tip = {
        type: 'info',
        msg: `Construa consist√™ncia. Complete todas as s√©ries com qualidade.`
      };
    }
  }

  // Cardio impact check ‚Äî override tip if high recent cardio load
  const cardioImpact = calcularImpactoCardioRecente(2);
  if (cardioImpact > 5 && suggestedWeight && suggestedWeight > currentWeight) {
    // High cardio load: suppress weight increase this session
    suggestedWeight = null;
    tip = {
      type: 'warning',
      msg: `üèÉ Cardio intenso recente (impacto: ${cardioImpact.toFixed(1)}). Mantenha ${currentWeight}kg hoje e foque em qualidade de execu√ß√£o.`
    };
  } else if (cardioImpact > 3 && tip?.type === 'up') {
    // Moderate cardio: warn but allow progression
    tip = { ...tip, msg: tip.msg + ` ‚ö†Ô∏è Aten√ß√£o: cardio recente pode afetar desempenho.` };
  }

  return {
    weight: currentWeight,
    minRep, maxRep, phase, increment,
    progressionBlocked: false,
    suggestedWeight,
    tip,
  };
}

function startWorkoutWithPlan(plan) {
  if (!plan || plan.exercises.length === 0) {
    showNotif('‚ö†Ô∏è', 'Treino vazio', 'Adicione exerc√≠cios a este treino', 'warning');
    return;
  }

  // Check recovery / frequency
  const freqCheck = checkWorkoutFrequency();
  if (freqCheck.bloqueado) {
    if (!confirm(freqCheck.mensagem + '\n\nDeseja treinar mesmo assim?')) return;
  } else {
    const recovery = getRecoveryStatus();
    if (recovery.recuperacao === 'critica') {
      if (!confirm(recovery.mensagem + '\n\nDeseja treinar mesmo assim?')) return;
    } else if (recovery.recuperacao === 'atencao') {
      showNotif('‚ö†Ô∏è', 'Aten√ß√£o', recovery.mensagem, 'warning');
    }
  }

  const exercises = plan.exercises.map(id => state.exercises.find(e => e.id === id)).filter(Boolean);

  state.activeWorkout = {
    planId: plan.id,
    exercises: exercises.map(ex => {
      const suggestion = getWeightSuggestion(ex, plan.id);
      return {
        exerciseId: ex.id,
        name: ex.name,
        currentWeight: suggestion.weight,
        suggestedWeight: suggestion.suggestedWeight,
        suggestedReps: suggestion.minRep,
        targetMaxRep: suggestion.maxRep,
        phase: suggestion.phase,
        increment: suggestion.increment,
        tip: suggestion.tip,
        progressionBlocked: suggestion.progressionBlocked,
        weight: suggestion.weight,
        sets: Array.from({ length: ex.sets }, (_, i) => ({ set: i + 1, weight: suggestion.weight || ex.weight, reps: '', done: false }))
      };
    })
  };

  openPreWorkoutModal(state.activeWorkout);
}

function renderActiveWorkout() {
  const el = document.getElementById('active-exercises');
  if (!state.activeWorkout) return;

  el.innerHTML = state.activeWorkout.exercises.map((ex, exIdx) => {
    const exercise = state.exercises.find(e => e.id === ex.exerciseId);
    const isUpgrade = ex.suggestedWeight > (exercise?.weight || 0);
    const restSecs = exercise?.rest || 90;
    return `<div class="card" id="ex-card-${exIdx}" style="margin-bottom:16px;">
      <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px;">
        <div style="flex:1;">
          <div style="font-weight:700; font-size:18px;">${ex.name}</div>
          <div style="display:flex; align-items:center; gap:8px; margin-top:6px; flex-wrap:wrap;">
            <span style="font-size:13px; color:var(--muted2);">${ex.currentWeight}kg ¬∑ meta ${ex.targetMaxRep} reps</span>
            <span class="tag tag-orange" style="cursor:pointer; user-select:none;" onclick="quickChangeRest(${exIdx})" title="Clique para alterar descanso">
              ‚è± ${formatRest(restSecs)}
            </span>
            <span class="tag" style="background:var(--border); color:var(--muted2); font-size:9px;">+${ex.increment || 2}kg/incremento</span>
          </div>
        </div>
        <div style="display:flex; flex-direction:column; gap:4px; align-items:flex-end;">
          ${ex.tip?.type==='up' ? '<span class="tag tag-green">‚Üë Subir!</span>' : ex.tip?.type==='volume' ? '<span class="tag tag-blue">+ Volume</span>' : '<span class="tag tag-blue">Manter</span>'}
          ${ex.phase ? '<span class="tag" style="background:var(--border);color:var(--muted2);font-size:9px;">' + (ex.phase==='execucao'?'üìê EXECU√á√ÉO':ex.phase==='carga'?'‚öñÔ∏è CARGA':'üì¶ VOLUME') + '</span>' : ''}
        </div>
      </div>

      ${ex.tip ? (() => {
        const tc = ex.tip.type==='up'      ? {bg:'var(--green-dim)',  bd:'var(--green)',      tx:'var(--green)',  ic:'üî•'} :
                   ex.tip.type==='volume'  ? {bg:'var(--blue-dim)',   bd:'var(--blue)',       tx:'var(--blue)',   ic:'üì¶'} :
                   ex.tip.type==='deload'  ? {bg:'var(--red-dim)',    bd:'var(--red)',        tx:'var(--red)',    ic:'üò¥'} :
                   ex.tip.type==='warning' ? {bg:'rgba(255,215,64,0.1)',bd:'var(--yellow)',   tx:'var(--yellow)', ic:'‚ö†Ô∏è'} :
                                            {bg:'var(--orange-dim)', bd:'var(--orange-mid)', tx:'var(--orange)', ic:'üí°'};
        const confirmBtn = ex.suggestedWeight && !ex.progressionBlocked
          ? '<button onclick="confirmProgression('+exIdx+')" style="margin-top:10px; background:var(--green); border:none; color:#000; font-weight:700; font-size:12px; padding:7px 14px; border-radius:8px; cursor:pointer; font-family:DM Sans,sans-serif;">‚úì Confirmar progress√£o para '+ex.suggestedWeight+'kg</button>'
          : '';
        return '<div style="background:'+tc.bg+'; border:1px solid '+tc.bd+'; border-radius:10px; padding:12px 16px; margin-bottom:14px; color:'+tc.tx+'"><div style="display:flex; gap:8px; align-items:flex-start; font-size:13px;"><span>'+tc.ic+'</span><span>'+ex.tip.msg+'</span></div>'+confirmBtn+'</div>';
      })() : ''}

      <div style="display:grid; grid-template-columns:36px 1fr 1fr 44px; gap:6px; margin-bottom:8px; padding-bottom:8px; border-bottom:1px solid var(--border);">
        <div style="font-size:10px; color:var(--muted); text-align:center;">S√âR.</div>
        <div style="font-size:10px; color:var(--muted); text-align:center;">PESO (kg)</div>
        <div style="font-size:10px; color:var(--muted); text-align:center;">REPS</div>
        <div></div>
      </div>

      ${ex.sets.map((set, setIdx) => `
        <div class="set-row" id="set-${exIdx}-${setIdx}" style="grid-template-columns:36px 1fr 1fr 44px; gap:6px;">
          <div class="set-number ${set.done ? 'done' : ''}" id="set-num-${exIdx}-${setIdx}">${set.set}</div>
          <div class="num-input-wrap" style="position:relative;">
            <button class="num-btn" onclick="adjustWeight(${exIdx},${setIdx},-0.5)" aria-label="Diminuir peso">‚àí</button>
            <div style="display:flex; flex-direction:column; align-items:center; flex:1; min-width:0;">
              ${setIdx > 0 && state.activeWorkout.exercises[exIdx].sets[setIdx-1].reps ? `<div style="font-size:9px; color:var(--muted2); line-height:1;">ant: ${state.activeWorkout.exercises[exIdx].sets[setIdx-1].weight}kg</div>` : ''}
              <input type="number" value="${set.weight || ex.weight}" step="0.5" min="0" id="w-${exIdx}-${setIdx}"
                oninput="updateSet(${exIdx},${setIdx},'weight',this.value)"
                style="border:none; background:transparent; text-align:center; width:100%; font-family:'DM Mono',monospace; font-size:15px; font-weight:700; color:var(--orange); padding:0;">
            </div>
            <button class="num-btn" onclick="adjustWeight(${exIdx},${setIdx},0.5)" aria-label="Aumentar peso">+</button>
          </div>
          <div class="num-input-wrap" style="position:relative;">
            <button class="num-btn" onclick="adjustReps(${exIdx},${setIdx},-1)" aria-label="Diminuir repeti√ß√µes">‚àí</button>
            <div style="display:flex; flex-direction:column; align-items:center; flex:1; min-width:0;">
              ${setIdx > 0 && state.activeWorkout.exercises[exIdx].sets[setIdx-1].reps ? `<div style="font-size:9px; color:var(--muted2); line-height:1;">ant: ${state.activeWorkout.exercises[exIdx].sets[setIdx-1].reps} reps</div>` : `<div style="font-size:9px; color:var(--muted2); line-height:1;">meta: ${ex.targetMaxRep}</div>`}
              <input type="number" value="${set.reps || ''}" min="0" max="50" id="r-${exIdx}-${setIdx}"
                oninput="updateSet(${exIdx},${setIdx},'reps',this.value)"
                placeholder="0"
                style="border:none; background:transparent; text-align:center; width:100%; font-family:'DM Mono',monospace; font-size:15px; font-weight:700; color:var(--text); padding:0;">
            </div>
            <button class="num-btn" onclick="adjustReps(${exIdx},${setIdx},1)" aria-label="Aumentar repeti√ß√µes">+</button>
          </div>
          <button class="btn ${set.done ? 'btn-success' : 'btn-ghost'}" style="padding:6px 10px; font-size:14px; width:40px;"
            onclick="toggleSetDone(${exIdx},${setIdx})" aria-label="${set.done ? 'Desmarcar s√©rie' : 'Marcar s√©rie como conclu√≠da'}">
            ${set.done ? '‚úì' : '‚óã'}
          </button>
        </div>
      `).join('')}
    <div style="display:flex; gap:8px; margin-top:14px; padding-top:12px; border-top:1px solid var(--border);">
      <button class="btn btn-ghost" style="flex:1; font-size:12px;" onclick="openCoach(${exIdx})">
        ü§ñ Coach
      </button>
      <button class="btn" style="flex:2; font-size:13px; background:var(--orange-dim); border:1px solid var(--orange); color:var(--orange);" onclick="nextExerciseFromCard(${exIdx})">
        Pr√≥ximo exerc√≠cio ‚Üí
      </button>
    </div>
    </div>`;
  }).join('');
}

function nextExerciseFromCard(exIdx) {
  const card = document.getElementById('ex-card-' + exIdx);
  if (card) {
    card.style.opacity = '0.5';
    card.style.pointerEvents = 'none';
    setTimeout(() => {
      card.style.opacity = '';
      card.style.pointerEvents = '';
    }, 300);
  }
  const next = document.getElementById('ex-card-' + (exIdx + 1));
  if (next) next.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function adjustWeight(exIdx, setIdx, delta) {
  const input = document.getElementById(`w-${exIdx}-${setIdx}`);
  const newVal = Math.max(0, parseFloat(input.value || 0) + delta);
  input.value = newVal;
  updateSet(exIdx, setIdx, 'weight', newVal);
}

function adjustReps(exIdx, setIdx, delta) {
  const input = document.getElementById(`r-${exIdx}-${setIdx}`);
  const newVal = Math.max(0, parseInt(input.value || 0) + delta);
  input.value = newVal;
  updateSet(exIdx, setIdx, 'reps', newVal);
}

function updateSet(exIdx, setIdx, field, value) {
  if (state.activeWorkout) {
    state.activeWorkout.exercises[exIdx].sets[setIdx][field] = value;
  }
}

function toggleSetDone(exIdx, setIdx) {
  if (!state.activeWorkout) return;
  const activeEx = state.activeWorkout.exercises[exIdx];
  const set = activeEx.sets[setIdx];

  const wInput = document.getElementById('w-' + exIdx + '-' + setIdx);
  const rInput = document.getElementById('r-' + exIdx + '-' + setIdx);
  if (wInput) set.weight = parseFloat(wInput.value) || set.weight;
  if (rInput) set.reps  = parseInt(rInput.value) || 0;

  if (!set.done) {
    if (!set.reps || set.reps <= 0) {
      if (rInput) {
        rInput.focus();
        rInput.style.outline = '2px solid var(--orange)';
        rInput.style.borderRadius = '6px';
        rInput.style.boxShadow = '0 0 0 3px rgba(255,92,0,0.25)';
        // FIX11: clear on first keystroke OR after 4s
        const _clearRepsHint = () => {
          rInput.style.outline = '';
          rInput.style.boxShadow = '';
          rInput.removeEventListener('input', _clearRepsHint);
        };
        rInput.addEventListener('input', _clearRepsHint);
        setTimeout(_clearRepsHint, 4000);
      }
      showNotif('‚úèÔ∏è', 'Quantas reps voc√™ fez?', 'Preencha as repeti√ß√µes antes de confirmar', 'warning');
      return;
    }
  }

  set.done = !set.done;
  renderActiveWorkout();

  if (set.done) {
    const exDef = state.exercises.find(e => e.id === activeEx.exerciseId);
    const restSecs = exDef?.rest || 90;
    const totalSets = activeEx.sets.length;
    const serieInfo = setIdx + 1 < totalSets
      ? `S√©rie ${setIdx + 1} conclu√≠da ‚Äî pr√≥xima: s√©rie ${setIdx + 2} de ${totalSets}`
      : `√öltima s√©rie conclu√≠da! üí™`;
    startRestTimer(restSecs, activeEx.name.toUpperCase(), serieInfo);
  } else {
    skipTimer();
  }
}

function startWorkoutTimer() {
  if (state.workoutTimerInterval) clearInterval(state.workoutTimerInterval);
  state.workoutTimerInterval = setInterval(() => {
    const elapsed = Math.floor((Date.now() - state.workoutStartTime) / 1000);
    const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
    const s = String(elapsed % 60).padStart(2, '0');
    const el = document.getElementById('active-workout-timer');
    if (el) el.textContent = `${m}:${s} ‚Äî Em andamento`;
  }, 1000);
}

function cancelWorkout() {
  clearInterval(state.workoutTimerInterval);
  state.activeWorkout = null;
  switchView('dashboard');
}

function finishWorkout() {
  if (!state.activeWorkout) return;

  let progressions = 0;
  state.activeWorkout.exercises.forEach(ex => {
    const doneSets = ex.sets?.filter(s => s.done) || [];
    const maxWeightUsed = doneSets.length ? Math.max(...doneSets.map(s => parseFloat(s.weight)||0)) : 0;
    if (maxWeightUsed > 0) checkAndShowPR(ex.exerciseId, maxWeightUsed);
    // FIX1: compare max weight actually used vs original weight at session start
    const originalW = ex._originalWeight || 0;
    if (maxWeightUsed > 0 && maxWeightUsed > originalW) {
      progressions++;
    } else if (ex._progressionConfirmed) {
      // Also count if user hit the confirm progression button
      progressions++;
    }
  });

  state.activeWorkout.exercises.forEach(ex => {
    const weights = ex.sets.filter(s => s.done && s.weight).map(s => parseFloat(s.weight));
    ex.weight = weights.length ? weights[weights.length - 1] : ex.suggestedWeight;
  });

  const session = {
    id: uid(),
    planId: state.activeWorkout.planId,
    date: Date.now(),
    duration: Math.floor((Date.now() - state.workoutStartTime) / 1000),
    exercises: state.activeWorkout.exercises,
    progressions
  };

  state.sessions.push(session);
  clearInterval(state.workoutTimerInterval);
  state.activeWorkout = null;
  state.workoutStartTime = null;

  save();

  if (progressions > 0) {
    showNotif('üî•', `${progressions} progress√£o(√µes)!`, 'Voc√™ aumentou a carga! Continue assim!', 'success');
  } else {
    showNotif('‚úÖ', 'Treino finalizado!', 'Registrado com sucesso. Descanse bem!', 'success');
  }

  // Update consecutive days counter
  updateRecoveryAfterWorkout();

  // Update modo iniciante weeks remaining
  if (state.modoIniciante?.ativo && state.modoIniciante.dataFim) {
    const msLeft = state.modoIniciante.dataFim - Date.now();
    state.modoIniciante.semanasRestantes = Math.max(0, Math.ceil(msLeft / (7 * 86400000)));
    if (msLeft <= 0) {
      state.modoIniciante.ativo = false;
      if (state.user) state.user.level = 'intermediate';
      showNotif('üéâ', 'Modo iniciante conclu√≠do!', 'Voc√™ evoluiu para Intermedi√°rio. Continue progredindo!', 'success');
    }
    save();
  }

  updateDashboard();
  renderExercises();
  renderHistorySelect();
  renderAllSessions();
  switchView('dashboard');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REST TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let restTotalSeconds = 90;

function startRestTimer(seconds, exName = '', serieInfo = '') {
  restTotalSeconds = seconds;
  state.restSecondsLeft = seconds;
  updateTimerDisplay();
  updateRestRing();

  document.getElementById('rest-ex-name').textContent = exName || 'DESCANSO';
  document.getElementById('rest-serie-info').textContent = serieInfo || 'Pr√≥xima s√©rie em breve';

  document.querySelectorAll('.rest-preset-btn').forEach(b => b.classList.remove('active'));
  const presetMap = { 45: 0, 60: 1, 90: 2, 120: 3, 180: 4 };
  const idx = presetMap[seconds];
  const presets = document.querySelectorAll('.rest-preset-btn');
  if (idx !== undefined && presets[idx]) presets[idx].classList.add('active');

  document.getElementById('rest-modal').classList.add('open');
  if (state.restTimerInterval) clearInterval(state.restTimerInterval);
  state.restTimerInterval = setInterval(() => {
    state.restSecondsLeft--;
    updateTimerDisplay();
    updateRestRing();
    if (state.restSecondsLeft <= 0) {
      skipTimer();
      if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
      showNotif('üîî', 'Descanse encerrado!', 'Hora da pr√≥xima s√©rie!', 'success');
    }
  }, 1000);
}

function setRestTimer(seconds) {
  restTotalSeconds = seconds;
  state.restSecondsLeft = seconds;
  clearInterval(state.restTimerInterval);
  updateTimerDisplay();
  updateRestRing();

  document.querySelectorAll('.rest-preset-btn').forEach(b => b.classList.remove('active'));
  const presetMap = { 45: 0, 60: 1, 90: 2, 120: 3, 180: 4 };
  const idx = presetMap[seconds];
  const presets = document.querySelectorAll('.rest-preset-btn');
  if (idx !== undefined && presets[idx]) presets[idx].classList.add('active');

  state.restTimerInterval = setInterval(() => {
    state.restSecondsLeft--;
    updateTimerDisplay();
    updateRestRing();
    if (state.restSecondsLeft <= 0) {
      skipTimer();
      if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
      showNotif('üîî', 'Descanse encerrado!', 'Hora da pr√≥xima s√©rie!', 'success');
    }
  }, 1000);
}

function updateTimerDisplay() {
  const secs = Math.max(0, state.restSecondsLeft);
  const m = String(Math.floor(secs / 60)).padStart(2, '0');
  const s = String(secs % 60).padStart(2, '0');
  const el = document.getElementById('timer-display');
  if (el) el.textContent = `${m}:${s}`;
  if (el) el.style.color = secs <= 10 ? 'var(--red)' : 'var(--orange)';
}

function updateRestRing() {
  const ring = document.getElementById('rest-ring');
  if (!ring) return;
  const circ = 427;
  const progress = Math.max(0, state.restSecondsLeft) / restTotalSeconds;
  ring.style.strokeDashoffset = circ * (1 - progress);
  ring.style.stroke = state.restSecondsLeft <= 10 ? 'var(--red)' : 'var(--orange)';
}

function skipTimer() {
  clearInterval(state.restTimerInterval);
  document.getElementById('rest-modal').classList.remove('open');
}

function addTime(secs) {
  state.restSecondsLeft = Math.max(0, state.restSecondsLeft + secs);
  restTotalSeconds = Math.max(restTotalSeconds, state.restSecondsLeft);
  updateTimerDisplay();
  updateRestRing();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HISTORY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHistorySelect() {
  const sel = document.getElementById('history-exercise-select');
  sel.innerHTML = '<option value="">Selecione um exerc√≠cio...</option>' +
    state.exercises.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
}

let chartInstance = null;

function renderHistoryChart() {
  const exId = document.getElementById('history-exercise-select').value;
  const placeholder = document.getElementById('chart-placeholder');
  const canvas = document.getElementById('progress-chart');
  const stats = document.getElementById('chart-stats');

  if (!exId) {
    placeholder.style.display = 'block';
    canvas.style.display = 'none';
    stats.style.display = 'none';
    return;
  }

  const ex = state.exercises.find(e => e.id === exId);
  const sessions = state.sessions.filter(s => s.exercises?.some(e => e.exerciseId === exId));

  if (sessions.length === 0) {
    placeholder.innerHTML = '<div style="text-align:center; padding:32px; color:var(--muted2);">Nenhum dado ainda para este exerc√≠cio.<br>Realize um treino primeiro!</div>';
    placeholder.style.display = 'block';
    canvas.style.display = 'none';
    stats.style.display = 'none';
    return;
  }

  const labels = sessions.map(s => new Date(s.date).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
  const weights = sessions.map(s => {
    const exData = s.exercises?.find(e => e.exerciseId === exId);
    if (!exData?.sets?.length) return exData?.weight || 0;
    const doneSets = exData.sets.filter(set => set.done !== false);
    const w = doneSets.map(set => parseFloat(set.weight) || 0);
    return w.length ? Math.max(...w) : exData?.weight || 0;
  });
  const reps = sessions.map(s => {
    const exData = s.exercises?.find(e => e.exerciseId === exId);
    if (!exData?.sets?.length) return 0;
    const done = exData.sets.filter(set => set.done !== false && parseInt(set.reps) > 0);
    return done.length ? Math.round(done.reduce((a, s) => a + parseInt(s.reps || 0), 0) / done.length) : 0;
  });

  placeholder.style.display = 'none';
  canvas.style.display = 'block';
  stats.style.display = 'grid';

  if (chartInstance) chartInstance.destroy();

  const ctx = canvas.getContext('2d');
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Peso M√°ximo (kg)',
        data: weights,
        borderColor: '#FF5C00',
        backgroundColor: 'rgba(255,92,0,0.1)',
        borderWidth: 2,
        pointBackgroundColor: '#FF5C00',
        pointRadius: 5,
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false }, tooltip: {
        backgroundColor: '#111',
        borderColor: '#333',
        borderWidth: 1,
        titleColor: '#fff',
        bodyColor: '#888',
        callbacks: { label: ctx => `${ctx.parsed.y}kg` }
      }},
      scales: {
        x: { grid: { color: '#1A1A1A' }, ticks: { color: '#666' } },
        y: { grid: { color: '#1A1A1A' }, ticks: { color: '#666' } }
      }
    }
  });

  const maxWeight = Math.max(...weights);
  const minWeight = Math.min(...weights.filter(w => w > 0));
  const totalIncrease = maxWeight - minWeight;
  const avgReps = reps.length ? Math.round(reps.reduce((a, b) => a + b, 0) / reps.length) : 0;

  stats.innerHTML = `
    <div class="card card-sm" style="text-align:center;">
      <div style="font-family:'Bebas Neue'; font-size:28px; color:var(--orange);">${maxWeight}kg</div>
      <div style="font-size:11px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px;">M√°ximo</div>
    </div>
    <div class="card card-sm" style="text-align:center;">
      <div style="font-family:'Bebas Neue'; font-size:28px; color:var(--green);">+${totalIncrease.toFixed(1)}kg</div>
      <div style="font-size:11px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px;">Evolu√ß√£o total</div>
    </div>
    <div class="card card-sm" style="text-align:center;">
      <div style="font-family:'Bebas Neue'; font-size:28px; color:var(--blue);">${sessions.length}</div>
      <div style="font-size:11px; color:var(--muted2); text-transform:uppercase; letter-spacing:1px;">Sess√µes</div>
    </div>
  `;
}

function renderAllSessions() {
  const el = document.getElementById('all-sessions-list');
  if (state.sessions.length === 0) {
    el.innerHTML = `<div style="text-align:center; padding:32px; color:var(--muted2);">
      <div style="font-size:32px; margin-bottom:8px;">üìÖ</div>
      Nenhuma sess√£o ainda. Comece a treinar!
    </div>`;
    return;
  }

  const sorted = [...state.sessions].reverse();
  el.innerHTML = sorted.map(s => {
    const date = new Date(s.date).toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long' });

    // REST DAY
    if (s.isRestDay) {
      return `<div class="card card-sm" style="margin-bottom:8px; border-color:var(--blue);">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <div style="font-weight:600; font-size:15px;">üò¥ Dia de Descanso</div>
            <div style="font-size:12px; color:var(--muted2); margin-top:2px; text-transform:capitalize;">${date}</div>
          </div>
          <span class="tag" style="background:var(--blue-dim); color:var(--blue);">Recupera√ß√£o</span>
        </div>
      </div>`;
    }

    // CARDIO SESSION
    if (s.isCardio && s.exercises?.[0]?.cardio) {
      const c = s.exercises[0];
      const dur = s.duration ? Math.floor(s.duration / 60) : c.tempo;
      return `<div class="card card-sm" style="margin-bottom:8px; border-color:var(--green);">
        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
          <div>
            <div style="font-weight:600; font-size:15px;">${getCardioIcon(c.name)} ${c.name}</div>
            <div style="font-size:12px; color:var(--muted2); margin-top:2px; text-transform:capitalize;">${date}</div>
            <div style="display:flex; gap:6px; margin-top:8px; flex-wrap:wrap;">
              <span class="tag tag-orange">‚è± ${dur}min</span>
              <span class="tag" style="background:var(--green-dim); color:var(--green);">${getIntensidadeIcon(c.intensidade)} ${c.intensidade}</span>
              ${c.distancia ? `<span class="tag tag-blue">üìè ${c.distancia}km</span>` : ''}
            </div>
          </div>
          <span class="tag" style="background:var(--green-dim); color:var(--green);">Cardio</span>
        </div>
      </div>`;
    }

    // REGULAR WORKOUT
    const plan = state.workoutPlans.find(p => p.id === s.planId);
    const dur = s.duration ? `${Math.floor(s.duration / 60)}min` : '‚Äî';
    const vol = calcVolume(s);
    return `<div class="card card-sm" style="margin-bottom:8px;">
      <div style="display:flex; justify-content:space-between; align-items:flex-start;">
        <div>
          <div style="font-weight:600; font-size:15px;">${plan?.name || 'Treino'}</div>
          <div style="font-size:12px; color:var(--muted2); margin-top:2px; text-transform:capitalize;">${date}</div>
          <div style="display:flex; gap:6px; margin-top:8px; flex-wrap:wrap;">
            <span class="tag tag-orange">${dur}</span>
            ${vol > 0 ? `<span class="tag tag-blue">${vol.toLocaleString('pt-BR')}kg vol.</span>` : ''}
            ${(s.progressions || 0) > 0 ? `<span class="tag tag-green">‚Üë ${s.progressions} prog.</span>` : ''}
          </div>
        </div>
        <span class="tag tag-green" style="font-size:16px;">‚úì</span>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateProfile() {
  if (!state.user) return;
  document.getElementById('profile-name').textContent = state.user.name;
  const levelMap = { beginner: 'Iniciante üå±', intermediate: 'Intermedi√°rio üí™', advanced: 'Avan√ßado üî•' };
  const goalMap = { hypertrophy: 'Hipertrofia muscular', strength: 'For√ßa m√°xima', endurance: 'Resist√™ncia muscular' };
  document.getElementById('profile-level').textContent = levelMap[state.user.level] || '‚Äî';
  document.getElementById('profile-goal').textContent = goalMap[state.user.goal] || '‚Äî';
  // Render cardio stats
  const statsEl = document.getElementById('cardio-stats-content');
  if (statsEl) statsEl.innerHTML = renderCardioStats();
  // Modo iniciante badge
  if (state.modoIniciante?.ativo) {
    const weeks = state.modoIniciante.semanasRestantes || 0;
    const badge = document.createElement('div');
    badge.style.cssText = 'background:var(--green-dim); border:1px solid var(--green); border-radius:10px; padding:10px 14px; margin-top:12px; font-size:13px; color:var(--green);';
    badge.innerHTML = `üå± <strong>Modo Iniciante ativo</strong> ‚Äî ${weeks} semana${weeks !== 1 ? 's' : ''} restante${weeks !== 1 ? 's' : ''} para concluir a fase de adapta√ß√£o.`;
    const existing = document.getElementById('iniciante-badge-profile');
    if (!existing) {
      badge.id = 'iniciante-badge-profile';
      document.getElementById('cardio-stats-card')?.before(badge);
    }
  }
}

function resetApp() {
  if (!confirm('Tem certeza? Todos os dados ser√£o apagados.')) return;
  localStorage.removeItem('progressar_state');
  location.reload();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODALS & NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});

let notifTimeout;
function showNotif(icon, title, msg, type) {
  const el = document.getElementById('notification');
  document.getElementById('notif-icon').textContent = icon;
  document.getElementById('notif-title').textContent = title;
  document.getElementById('notif-msg').textContent = msg;
  el.className = `notification ${type} show`;
  clearTimeout(notifTimeout);
  notifTimeout = setTimeout(() => el.classList.remove('show'), 3500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHART.JS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadChartJs(cb) {
  if (window.Chart) { cb(); return; }
  const s = document.createElement('script');
  s.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js';
  s.onload = cb;
  s.onerror = () => {
    // FIX10: friendly fallback
    const placeholder = document.getElementById('chart-placeholder');
    if (placeholder) placeholder.innerHTML = `
      <div style="text-align:center; padding:32px; color:var(--muted2);">
        <div style="font-size:36px; margin-bottom:10px;">üìä</div>
        <div style="font-weight:700; color:var(--text); margin-bottom:6px;">Gr√°fico indispon√≠vel</div>
        <div style="font-size:13px;">Verifique sua conex√£o com a internet e</div>
        <button class="btn btn-ghost" style="margin-top:12px;" onclick="location.reload()">‚Ü∫ Recarregar p√°gina</button>
      </div>`;
  };
  document.head.appendChild(s);
}

const _origRenderChart = renderHistoryChart;
window.renderHistoryChart = function() { loadChartJs(_origRenderChart); };

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODO FOCO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let focoState = { planId: null, exIdx: 0, setIdx: 0, exercises: [], startTime: null, timerInterval: null, currentWeight: 0, currentReps: 0 };

function startFocoMode() {
  const el = document.getElementById('foco-plan-select');
  el.innerHTML = state.workoutPlans.map(p => `
    <button class="btn btn-ghost btn-full" style="justify-content:space-between;" onclick="initFoco('${p.id}')">
      <span>${p.name}</span>
      <span class="tag tag-orange">${p.day}</span>
    </button>`).join('') || '<p style="color:var(--muted2); font-size:13px;">Crie um treino primeiro</p>';
}

function initFoco(planId) {
  const plan = state.workoutPlans.find(p => p.id === planId);
  if (!plan || !plan.exercises.length) { showNotif('‚ö†Ô∏è','Treino vazio','Adicione exerc√≠cios ao treino','warning'); return; }

  const exercises = plan.exercises.map(id => state.exercises.find(e => e.id === id)).filter(Boolean);
  focoState = { planId, exIdx: 0, setIdx: 0, startTime: Date.now(), timerInterval: null, currentWeight: 0, currentReps: 0,
    exercises: exercises.map(ex => ({ ...ex, sets: Array.from({length: ex.sets}, (_,i) => ({set:i+1, weight: ex.weight, reps: 0, done: false})) }))
  };

  document.getElementById('foco-idle').style.display = 'none';
  document.getElementById('foco-active').style.display = 'block';
  document.getElementById('foco-workout-name').textContent = plan.name.toUpperCase();

  focoState.timerInterval = setInterval(() => {
    const e = Math.floor((Date.now() - focoState.startTime) / 1000);
    const m = String(Math.floor(e/60)).padStart(2,'0'), s = String(e%60).padStart(2,'0');
    const el = document.getElementById('foco-timer-label');
    if (el) el.textContent = `${m}:${s} em andamento`;
  }, 1000);

  focoRender();
}

function focoRender() {
  const ex = focoState.exercises[focoState.exIdx];
  if (!ex) { focoShowFinish(); return; }

  document.getElementById('foco-ex-emoji').textContent = groupEmoji(ex.group);
  document.getElementById('foco-ex-name').textContent = ex.name.toUpperCase();
  document.getElementById('foco-ex-meta').textContent = `${ex.sets.length} s√©ries ¬∑ ${ex.reps} reps ¬∑ ‚è± ${formatRest(ex.rest||90)}`;

  focoState.currentWeight = ex.sets[focoState.setIdx]?.weight || ex.weight;
  focoState.currentReps = ex.sets[focoState.setIdx]?.reps || 0;
  document.getElementById('foco-weight').textContent = focoState.currentWeight;
  document.getElementById('foco-reps').textContent = focoState.currentReps;

  document.getElementById('foco-set-label').textContent = `S√âRIE ${focoState.setIdx+1} DE ${ex.sets.length}`;

  const exDots = document.getElementById('foco-ex-dots');
  exDots.innerHTML = focoState.exercises.map((e,i) =>
    `<div style="width:${i===focoState.exIdx?'20px':'8px'}; height:8px; border-radius:99px; background:${i===focoState.exIdx?'var(--orange)':i<focoState.exIdx?'var(--green)':'var(--border2)'}; transition:all 0.3s;"></div>`
  ).join('');

  const setDots = document.getElementById('foco-set-dots');
  setDots.innerHTML = ex.sets.map((s,i) =>
    `<div style="width:${i===focoState.setIdx?'32px':'12px'}; height:12px; border-radius:99px; background:${i===focoState.setIdx?'var(--orange)':s.done?'var(--green)':'var(--border2)'}; transition:all 0.3s; cursor:pointer;" onclick="focoGoToSet(${i})"></div>`
  ).join('');
}

function focoAdjust(field, delta) {
  if (field === 'weight') {
    focoState.currentWeight = Math.max(0, parseFloat(focoState.currentWeight) + delta);
    document.getElementById('foco-weight').textContent = focoState.currentWeight;
  } else {
    focoState.currentReps = Math.max(0, parseInt(focoState.currentReps) + delta);
    document.getElementById('foco-reps').textContent = focoState.currentReps;
  }
}

function focoGoToSet(idx) { focoState.setIdx = idx; focoRender(); }

function focoNextSet() {
  const ex = focoState.exercises[focoState.exIdx];
  ex.sets[focoState.setIdx].weight = focoState.currentWeight;
  ex.sets[focoState.setIdx].reps = focoState.currentReps;
  ex.sets[focoState.setIdx].done = true;

  checkAndShowPR(ex.id, focoState.currentWeight);

  const restSecs = ex.rest || 90;
  startRestTimer(restSecs, ex.name.toUpperCase(), `S√©rie ${focoState.setIdx+1} conclu√≠da`);

  focoState.setIdx++;
  if (focoState.setIdx >= ex.sets.length) { focoNextExercise(); return; }
  focoRender();
}

function focoNextExercise() {
  focoState.exIdx++;
  focoState.setIdx = 0;
  if (focoState.exIdx >= focoState.exercises.length) { focoShowFinish(); return; }
  skipTimer();
  focoRender();
}

function focoShowFinish() {
  clearInterval(focoState.timerInterval);
  skipTimer();
  document.getElementById('foco-active').style.display = 'none';
  const finish = document.getElementById('foco-finish');
  finish.style.display = 'flex';
  const totalSets = focoState.exercises.reduce((a,e) => a + e.sets.filter(s=>s.done).length, 0);
  const dur = Math.floor((Date.now() - focoState.startTime) / 60000);
  document.getElementById('foco-summary').textContent = `${focoState.exercises.length} exerc√≠cios ¬∑ ${totalSets} s√©ries ¬∑ ${dur} minutos`;
}

function focoFinish() {
  const session = {
    id: uid(), planId: focoState.planId, date: Date.now(),
    duration: Math.floor((Date.now() - focoState.startTime) / 1000),
    exercises: focoState.exercises.map(ex => ({ exerciseId: ex.id, weight: ex.weight, sets: ex.sets })),
    progressions: 0
  };
  state.sessions.push(session);
  save();
  updateDashboard();
  document.getElementById('foco-finish').style.display = 'none';
  document.getElementById('foco-idle').style.display = 'flex';
  switchView('dashboard');
  showNotif('‚úÖ','Treino salvo!','√ìtimo trabalho no modo foco!','success');
}

function exitFoco() {
  clearInterval(focoState.timerInterval);
  skipTimer();
  document.getElementById('foco-active').style.display = 'none';
  document.getElementById('foco-finish').style.display = 'none';
  document.getElementById('foco-idle').style.display = 'flex';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COMPARTILHAMENTO DE PR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkAndShowPR(exId, weight) {
  const ex = state.exercises.find(e => e.id === exId);
  if (!ex) return;
  const oldPR = getPR(exId);
  if (weight > oldPR && oldPR > 0) {
    setTimeout(() => showPRCard(ex.name, weight, oldPR), 1500);
  }
}

function showPRCard(exName, newWeight, oldWeight) {
  const increase = ((newWeight - oldWeight) / oldWeight * 100).toFixed(1);
  const existing = document.getElementById('pr-overlay');
  if (existing) existing.remove();

  const overlay = document.createElement('div');
  overlay.id = 'pr-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:9000;display:flex;align-items:center;justify-content:center;padding:24px;';
  overlay.innerHTML = `
    <div style="background:var(--card);border:1px solid var(--orange);border-radius:24px;padding:32px;max-width:360px;width:100%;text-align:center;animation:slideUp 0.4s ease;">
      <div style="font-size:56px;margin-bottom:8px;">üèÜ</div>
      <div style="font-family:'Bebas Neue';font-size:48px;color:var(--orange);letter-spacing:3px;line-height:1;">NOVO PR!</div>
      <div style="font-size:14px;color:var(--muted2);margin:8px 0 24px;">${exName}</div>
      <div style="display:flex;gap:12px;justify-content:center;align-items:center;margin-bottom:24px;">
        <div style="text-align:center;">
          <div style="font-size:12px;color:var(--muted2);margin-bottom:4px;">ANTES</div>
          <div style="font-family:'Bebas Neue';font-size:32px;color:var(--muted2);">${oldWeight}kg</div>
        </div>
        <div style="font-size:28px;color:var(--orange);">‚Üí</div>
        <div style="text-align:center;">
          <div style="font-size:12px;color:var(--muted2);margin-bottom:4px;">AGORA</div>
          <div style="font-family:'Bebas Neue';font-size:40px;color:var(--orange);">${newWeight}kg</div>
        </div>
      </div>
      <div style="background:var(--green-dim);border:1px solid var(--green);border-radius:10px;padding:10px;margin-bottom:24px;">
        <div style="font-family:'Bebas Neue';font-size:24px;color:var(--green);">+${increase}% de evolu√ß√£o</div>
      </div>
      <div id="pr-share-preview" style="background:linear-gradient(135deg,#1A0800,#0A0A0A);border:1px solid var(--orange-mid);border-radius:16px;padding:20px;margin-bottom:20px;">
        <div style="font-family:'Bebas Neue';font-size:28px;color:var(--orange);letter-spacing:3px;">PROGRESSAR</div>
        <div style="font-size:13px;color:var(--muted2);margin:4px 0 12px;">Progress√£o de Carga Inteligente</div>
        <div style="font-weight:700;font-size:16px;margin-bottom:4px;">${exName}</div>
        <div style="font-family:'Bebas Neue';font-size:36px;color:var(--orange);">${newWeight}kg üèÜ</div>
        <div style="font-size:12px;color:var(--green);">+${increase}% desde o in√≠cio</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-ghost" style="flex:1;" onclick="document.getElementById('pr-overlay').remove()">Fechar</button>
        <button class="btn btn-primary" style="flex:1;" onclick="sharePR('${exName}','${newWeight}','${increase}')">üì§ Compartilhar</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
}

function sharePR(exName, weight, increase) {
  const text = `üèÜ Novo PR no PROGRESSAR!

${exName}: ${weight}kg (+${increase}%)

Progress√£o de carga inteligente com o m√©todo Muzy üî•

#Progressar #Treino #PR #ProgressaoDeCarga`;
  if (navigator.share) {
    navigator.share({ title: 'Novo PR no PROGRESSAR!', text }).catch(() => {});
  } else {
    navigator.clipboard?.writeText(text);
    showNotif('üìã','Copiado!','Cole no seu story ou post','success');
  }
  document.getElementById('pr-overlay')?.remove();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COACH VIRTUAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const TECNICAS = {
  iniciante: {
    any: {
      nome: 'PONTO ZERO',
      icon: 'üéØ',
      porque: 'Manter a contra√ß√£o no ponto de maior tens√£o por 2 segundos aumenta o tempo sob tens√£o muscular sem precisar adicionar carga. Estudos mostram que isso potencializa o crescimento muscular mesmo para iniciantes.',
      como: '1. Execute a repeti√ß√£o normalmente.\n2. No ponto de maior tens√£o (geralmente no encurtamento do m√∫sculo), <b>pause por 2 segundos</b>.\n3. Mantenha a respira√ß√£o controlada durante a pausa.\n4. Fa√ßa isso em todas as reps da √∫ltima s√©rie.',
    }
  },
  intermediario: {
    maquina: {
      nome: 'DROP SET',
      icon: 'üìâ',
      porque: 'O drop set recruta fibras musculares adicionais que n√£o foram atingidas nas s√©ries normais. Ao reduzir a carga imediatamente e continuar at√© a falha, voc√™ estende o est√≠mulo al√©m do limite usual.',
      como: '1. Finalize sua √∫ltima s√©rie normalmente.\n2. <b>Imediatamente</b> (sem descanso) reduza 2 placas/pinos.\n3. Execute mais repeti√ß√µes at√© a falha t√©cnica.\n4. Opcional: repita reduzindo mais 2 placas para um triplo drop set.',
    },
    livre: {
      nome: 'REST-PAUSE',
      icon: '‚è∏Ô∏è',
      porque: 'O rest-pause permite acumular mais volume com o mesmo peso, criando um est√≠mulo extra de hipertrofia. √â especialmente eficaz com peso livre pois a instabilidade j√° recruta fibras estabilizadoras.',
      como: '1. Finalize sua √∫ltima s√©rie normalmente.\n2. Descanse <b>15 segundos</b> (conte em voz alta).\n3. Pegue o mesmo peso e fa√ßa mais <b>5 repeti√ß√µes</b>.\n4. Descanse mais 15 segundos e tente mais 3-5 reps.\n5. Foco total na execu√ß√£o ‚Äî sem sacrificar a t√©cnica.',
    }
  },
  avancado: {
    maquina: {
      nome: 'DROP SET DUPLO',
      icon: 'üí•',
      porque: 'Varia√ß√£o mais intensa do drop set. Ao reduzir duas vezes consecutivas, voc√™ recruta praticamente todas as fibras dispon√≠veis do m√∫sculo, criando um est√≠mulo metab√≥lico m√°ximo.',
      como: '1. √öltima s√©rie normal at√© a falha.\n2. Reduz 2 placas ‚Üí at√© a falha.\n3. Reduz mais 2 placas ‚Üí at√© a falha novamente.\n4. N√£o descanse entre as redu√ß√µes.\n5. Reserve 2-3 minutos de descanso ap√≥s essa s√©rie.',
    },
    livre: {
      nome: 'REST-PAUSE INTENSO',
      icon: '‚ö°',
      porque: 'Vers√£o avan√ßada do rest-pause para quem j√° tem base s√≥lida. O est√≠mulo combinado de falha + descanso curto + nova falha cria pico hormonal elevado e recrutamento m√°ximo de unidades motoras.',
      como: '1. Execute at√© a falha t√©cnica.\n2. Descanse <b>10 segundos</b>.\n3. Continue com mais reps at√© nova falha.\n4. Descanse mais 10 segundos.\n5. Finalize com mais reps at√© a terceira falha.\n6. Total: 3 mini-s√©ries com descansos de 10s.',
    }
  }
};

let coachState = { exIdx: null, exName: '', effort: null, equip: '', level: '' };

function openCoach(exIdx) {
  const activeEx = state.activeWorkout?.exercises[exIdx];
  const exDef = state.exercises.find(e => e.id === activeEx?.exerciseId);
  if (!activeEx || !exDef) return;

  coachState = {
    exIdx,
    exName: activeEx.name,
    effort: null,
    equip: exDef.execution === 'maquina' ? 'maquina' : 'livre',
    level: state.user?.level || 'intermediate',
  };

  document.getElementById('coach-ex-name').textContent = activeEx.name;
  document.getElementById('coach-suggestion').style.display = 'none';
  document.getElementById('coach-tecnica-invite').style.display = 'none';
  document.querySelectorAll('.effort-btn').forEach(b => b.className = 'effort-btn');
  openModal('coach-modal');
}

function selectEffort(effort) {
  coachState.effort = effort;
  document.querySelectorAll('.effort-btn').forEach(b => {
    b.className = 'effort-btn';
    if (b.dataset.effort === effort) b.classList.add('selected-' + effort);
  });

  const activeEx = state.activeWorkout?.exercises[coachState.exIdx];
  const exDef = state.exercises.find(e => e.id === activeEx?.exerciseId);
  if (!activeEx || !exDef) return;

  const currentWeight = activeEx.currentWeight || exDef.weight;
  const increment = exDef.increment || 2;
  const equip = exDef.execution === 'maquina' ? 'maquina' : 'livre';
  const equipName = exDef.equip || '';

  let nextWeight = currentWeight;
  let reason = '';

  if (effort === 'facil') {
    if (equip === 'livre') {
      if (equipName.toLowerCase().includes('halter') || equipName.toLowerCase().includes('dumb') || coachState.loadKey === 'halter') {
        // FIX5: next even number above current ‚Äî works for any weight (10, 20, 40, 80kg+)
        nextWeight = Math.ceil((currentWeight + 0.01) / 2) * 2;
        if (nextWeight === currentWeight) nextWeight += 2; // safety
        reason = `Pr√≥ximo par de halteres (+${nextWeight - currentWeight}kg)`;
      } else {
        nextWeight = currentWeight + 4;
        reason = `+2kg de cada lado na barra (+4kg total)`;
      }
    } else {
      nextWeight = currentWeight + increment;
      reason = `+1 placa no pino (+${increment}kg)`;
    }

    document.getElementById('coach-next-weight').textContent = `Use ${nextWeight}kg`;
    document.getElementById('coach-reason').textContent = reason;

    // Extra context for anilhas
    const eq2 = exDef?.equip || '';
    if (eq2.includes('Anilhas') && nextWeight !== currentWeight) {
      const diff = nextWeight - currentWeight;
      const porLado = diff / 2;
      document.getElementById('coach-reason').textContent = reason +
        ` ‚Äî adicione ${porLado}kg de cada lado da barra`;
    }
    document.getElementById('coach-suggestion').style.display = 'block';
    document.getElementById('coach-tecnica-invite').style.display = 'block';

    if (activeEx) activeEx.coachSuggestedWeight = nextWeight;

  } else if (effort === 'certo') {
    document.getElementById('coach-next-weight').textContent = `Mantenha ${currentWeight}kg`;
    document.getElementById('coach-reason').textContent = 'Peso ideal! Continue evoluindo as reps antes de subir a carga.';
    document.getElementById('coach-suggestion').style.display = 'block';
    document.getElementById('coach-tecnica-invite').style.display = 'none';
  } else {
    document.getElementById('coach-next-weight').textContent = `Mantenha ou reduza`;
    document.getElementById('coach-reason').textContent = `Considere ${Math.max(currentWeight - increment, increment)}kg na pr√≥xima sess√£o para recuperar a qualidade das reps.`;
    document.getElementById('coach-suggestion').style.display = 'block';
    document.getElementById('coach-tecnica-invite').style.display = 'none';
  }
}

function showTecnica() {
  closeModal('coach-modal');
  const level = coachState.level;
  const equip = coachState.equip;

  let tecnica = null;
  if (level === 'beginner') {
    tecnica = TECNICAS.iniciante.any;
    document.getElementById('tecnica-nivel').textContent = 'Iniciante';
  } else if (level === 'intermediate') {
    tecnica = TECNICAS.intermediario[equip] || TECNICAS.intermediario.livre;
    document.getElementById('tecnica-nivel').textContent = 'Intermedi√°rio';
  } else {
    tecnica = TECNICAS.avancado[equip] || TECNICAS.avancado.livre;
    document.getElementById('tecnica-nivel').textContent = 'Avan√ßado';
  }

  if (!tecnica) return;
  document.getElementById('tecnica-nome').textContent = tecnica.nome;
  document.getElementById('tecnica-icon').textContent = tecnica.icon;
  document.getElementById('tecnica-porque').innerHTML = tecnica.porque;
  document.getElementById('tecnica-como').innerHTML = tecnica.como.replace(/\n/g, '<br>');
  openModal('tecnica-modal');
}

function closeCoach() {
  closeModal('coach-modal');

  const activeEx = state.activeWorkout?.exercises[coachState.exIdx];
  if (activeEx?.coachSuggestedWeight && coachState.effort === 'facil') {
    const exDef = state.exercises.find(e => e.id === activeEx.exerciseId);
    if (exDef) {
      exDef.weight = activeEx.coachSuggestedWeight;
      save();
      showNotif('üìã', 'Sugest√£o salva!', `Pr√≥ximo treino: ${activeEx.coachSuggestedWeight}kg`, 'success');
    }
  }
}

function closeTecnica() { closeModal('tecnica-modal'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EXECUTION TYPE SELECTOR (reutilizado)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const EQUIP_LIVRE   = ['Halteres (1-10kg)', 'Dumbbells (12kg+)', 'Anilhas (barra)'];
const EQUIP_MAQUINA = ['Barra com pino', 'Cabo / Polia', 'Smith (barra guiada)'];
const INCREMENT_BY_EQUIP = {
  'Halteres (1-10kg)':  1,    // fixos de 1 em 1kg at√© 10kg
  'Dumbbells (12kg+)':  2,    // pares de 2 em 2kg a partir de 12kg
  'Anilhas (barra)':    1,    // combina√ß√£o de placas ‚Äî c√°lculo especial
  'Barra livre':        2.5,
  'Barra com pino':     5,
  'Cabo / Polia':       2.5,
  'Smith (barra guiada)': 2.5,
};

// Placas dispon√≠veis por lado (academia padr√£o)
const PLACAS_DISPONIVEIS = [0.5, 1, 1.25, 2.5, 5, 10, 15, 20, 25];

// Retorna o menor peso >= target usando combina√ß√£o de placas
// L√≥gica: a barra pesa ~10kg, mas aqui trabalhamos com peso total j√° informado pelo usu√°rio
function proximoAnilha(currentWeight) {
  // Tenta encontrar a pr√≥xima carga poss√≠vel acima do peso atual
  // usando combina√ß√µes de placas de cada lado
  // Simplificado: incremento m√≠nimo real com anilhas √© 1kg (0.5kg cada lado)
  // Busca o menor incremento poss√≠vel com as placas dispon√≠veis
  const incrementosPossiveis = [1, 2, 2.5, 5, 10]; // combina√ß√µes reais comuns
  for (const inc of incrementosPossiveis) {
    const candidato = currentWeight + inc;
    // Verifica se √© ating√≠vel: peso total / 2 (cada lado) deve ser combina√ß√£o v√°lida de placas
    const pesoLadoAtual = currentWeight / 2;
    const pesoLadoNovo  = candidato / 2;
    const diferenca = pesoLadoNovo - pesoLadoAtual;
    // Verifica se a diferen√ßa √© uma placa dispon√≠vel ou soma de placas
    if (PLACAS_DISPONIVEIS.includes(diferenca) || diferenca % 0.5 === 0) {
      return { peso: candidato, incremento: inc, descricao: `+${diferenca}kg cada lado (+${inc}kg total)` };
    }
  }
  return { peso: currentWeight + 2.5, incremento: 2.5, descricao: '+1.25kg cada lado (+2.5kg total)' };
}

// Retorna o pr√≥ximo haltere dispon√≠vel (fixos 1-10kg, step 1kg)
function proximoHaltere(currentWeight) {
  if (currentWeight >= 10) return { peso: currentWeight, incremento: 0, descricao: 'M√°ximo de haltere fixo (10kg). Considere dumbbells.' };
  const next = Math.min(Math.ceil(currentWeight + 0.01), 10);
  return { peso: next, incremento: next - currentWeight, descricao: `+${next - currentWeight}kg (pr√≥ximo haltere fixo)` };
}

// Retorna o pr√≥ximo par de dumbbells (12, 14, 16, 18... step 2kg)
function proximoDumbbell(currentWeight) {
  let base = Math.max(12, currentWeight);
  // Arredonda para par de 2kg acima do atual
  const next = Math.ceil((base + 0.01) / 2) * 2;
  if (next <= base) return { peso: base + 2, incremento: 2, descricao: '+2kg (pr√≥ximo par de dumbbell)' };
  return { peso: next, incremento: next - currentWeight, descricao: `+${next - currentWeight}kg (pr√≥ximo par: ${next}kg)` };
}

function setExecution(type, prefix) {
  const lBtn = document.getElementById(`${prefix}-exec-livre`);
  const mBtn = document.getElementById(`${prefix}-exec-maquina`);
  const hidden = document.getElementById(`${prefix}-execution`);
  const equipSel = document.getElementById(`${prefix === 'ex' || prefix === 'edit' ? (prefix + '-ex-equip') : 'wb-ex-equip'}`);
  const incSel = document.getElementById(`${prefix === 'ex' || prefix === 'edit' ? (prefix + '-ex-increment') : 'wb-ex-increment'}`);

  if (!lBtn || !mBtn || !hidden || !equipSel) return;

  lBtn.classList.toggle('active', type === 'livre');
  mBtn.classList.toggle('active', type === 'maquina');
  hidden.value = type;

  const options = type === 'livre' ? EQUIP_LIVRE : EQUIP_MAQUINA;
  equipSel.innerHTML = options.map((o, i) => {
    const icons = type === 'livre' ? ['üèãÔ∏è','üí™','üî¥'] : ['üìå','„Ä∞Ô∏è','üî©'];
    return `<option value="${o}">${icons[i]} ${o}</option>`;
  }).join('');

  if (incSel) {
    const defaultInc = INCREMENT_BY_EQUIP[options[0]] || 2;
    const found = Array.from(incSel.options).find(o => parseFloat(o.value) === defaultInc);
    if (found) {
      incSel.value = defaultInc;
    } else {
      const opt = document.createElement('option');
      opt.value = defaultInc;
      opt.textContent = `${defaultInc} kg`;
      incSel.appendChild(opt);
      incSel.value = defaultInc;
    }
  }

  equipSel.onchange = () => {
    const inc = INCREMENT_BY_EQUIP[equipSel.value];
    if (incSel && inc) {
      const opt = Array.from(incSel.options).find(o => parseFloat(o.value) === inc);
      if (opt) incSel.value = inc;
    }
  };
}

function quickChangeRest(exIdx) {
  const activeEx = state.activeWorkout?.exercises[exIdx];
  if (!activeEx) return;
  const exDef = state.exercises.find(e => e.id === activeEx.exerciseId);
  if (!exDef) return;

  const options = [45, 60, 90, 120, 180, 240];
  const current = exDef.rest || 90;
  const currentIdx = options.indexOf(current);
  const nextIdx = (currentIdx + 1) % options.length;
  exDef.rest = options[nextIdx];
  save();
  renderActiveWorkout();
  showNotif('‚è±', 'Descanso alterado', `${exDef.name}: ${formatRest(exDef.rest)}`, '');
}

function formatRest(secs) {
  if (!secs) return '1:30';
  const m = Math.floor(secs / 60);
  const s = secs % 60;
  return m > 0 ? (s > 0 ? `${m}:${String(s).padStart(2,'0')}` : `${m}min`) : `${s}s`;
}

function groupEmoji(group) {
  const map = { 'Peito': 'üí™', 'Costas': 'ü¶∫', 'Ombro': 'üî∫', 'B√≠ceps': 'üí™', 'Tr√≠ceps': 'üî±', 'Perna': 'ü¶µ', 'Gl√∫teo': 'üçë', 'Abd√¥men': 'üî•' };
  return map[group] || 'üèãÔ∏è';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CARDIO ‚Äî FUN√á√ïES AUXILIARES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getCardioIcon(tipo) {
  const icons = {
    'Esteira': 'üèÉ', 'esteira': 'üèÉ',
    'Bike': 'üö¥', 'bike': 'üö¥',
    'Escada': 'ü™ú', 'escada': 'ü™ú',
    'Corrida externa': 'üå≥', 'corrida': 'üå≥',
    'Pular corda': 'ü™¢', 'corda': 'ü™¢',
    'Nata√ß√£o': 'üèä', 'natacao': 'üèä',
    'Remo': 'üö£', 'remo': 'üö£',
  };
  return icons[tipo] || 'üèÉ';
}

function getIntensidadeIcon(intensidade) {
  return { 'leve': 'üòå', 'moderado': 'üòä', 'intenso': 'ü•µ' }[intensidade] || 'üòä';
}

function calcularImpactoCardio(sessao) {
  const pontos = { 'leve': 1, 'moderado': 2, 'intenso': 3 }[sessao.intensidade] || 1;
  const fatorTempo = Math.min((sessao.tempo || 20) / 30, 2);
  return pontos * fatorTempo;
}

function calcularImpactoCardioRecente(dias = 2) {
  const limite = Date.now() - (dias * 86400000);
  const recente = (state.cardio?.historico || []).filter(c => c.data > limite);
  return recente.reduce((acc, c) => acc + calcularImpactoCardio(c), 0);
}

function calcularMediaIntensidade() {
  const hist = state.cardio?.historico || [];
  if (!hist.length) return '‚Äî';
  const vals = { 'leve': 1, 'moderado': 2, 'intenso': 3 };
  const avg = hist.reduce((a, c) => a + (vals[c.intensidade] || 1), 0) / hist.length;
  if (avg < 1.5) return 'üòå Leve';
  if (avg < 2.5) return 'üòä Moderado';
  return 'ü•µ Intenso';
}

function gerarAlertasCardio() {
  const alertas = [];
  const hist = state.cardio?.historico || [];
  if (!hist.length) return alertas;

  const hoje = Date.now();
  const ontem = hoje - 86400000;
  const ultimoCardio = hist[hist.length - 1];

  // Alerta 1: cardio intenso nas √∫ltimas 24h
  if (ultimoCardio?.intensidade === 'intenso' && ultimoCardio.data > ontem) {
    alertas.push({
      tipo: 'cardio_intenso',
      html: `<div class="card card-sm" style="border-color:var(--yellow); margin-bottom:10px;">
        <div style="display:flex; align-items:center; gap:10px;">
          <span style="font-size:22px;">üèÉ</span>
          <div>
            <div style="font-weight:700; color:var(--yellow);">Cardio intenso recente</div>
            <div style="font-size:13px; color:var(--muted2);">Seu cardio de ontem pode afetar o desempenho. Considere treino mais leve ou foque em grupos musculares diferentes.</div>
          </div>
        </div>
      </div>`
    });
  }

  // Alerta 2: 3+ cardios intensos na semana
  const intensosSemana = hist.filter(c => hoje - c.data < 7 * 86400000 && c.intensidade === 'intenso');
  if (intensosSemana.length >= 3) {
    alertas.push({
      tipo: 'cardio_frequencia',
      html: `<div class="card card-sm" style="border-color:var(--orange); margin-bottom:10px;">
        <div style="display:flex; align-items:center; gap:10px;">
          <span style="font-size:22px;">üî•</span>
          <div>
            <div style="font-weight:700; color:var(--orange);">${intensosSemana.length}x cardio intenso esta semana</div>
            <div style="font-size:13px; color:var(--muted2);">Alterne com sess√µes moderadas para melhor recupera√ß√£o e preservar ganhos musculares.</div>
          </div>
        </div>
      </div>`
    });
  }

  // Alerta 3: impacto alto nas √∫ltimas 48h
  const impacto = calcularImpactoCardioRecente(2);
  if (impacto > 5) {
    alertas.push({
      tipo: 'cardio_impacto',
      html: `<div class="card card-sm" style="border-color:var(--blue); margin-bottom:10px;">
        <div style="display:flex; align-items:center; gap:10px;">
          <span style="font-size:22px;">‚ö°</span>
          <div>
            <div style="font-weight:700; color:var(--blue);">Alto volume de cardio recente</div>
            <div style="font-size:13px; color:var(--muted2);">Carga reduzida sugerida hoje. Foco em qualidade de execu√ß√£o, n√£o em bater recordes de carga.</div>
          </div>
        </div>
      </div>`
    });
  }

  return alertas;
}

// Estat√≠sticas de cardio para o perfil
function renderCardioStats() {
  const hist = state.cardio?.historico || [];
  const totalMin = hist.reduce((a, c) => a + (c.tempo || 0), 0);
  const totalKM  = hist.reduce((a, c) => a + (c.distancia || 0), 0);
  const intensos  = hist.filter(c => c.intensidade === 'intenso').length;
  const moderados = hist.filter(c => c.intensidade === 'moderado').length;
  const leves     = hist.filter(c => c.intensidade === 'leve').length;

  if (!hist.length) {
    return `<div style="text-align:center; padding:24px; color:var(--muted2); font-size:13px;">
      <div style="font-size:28px; margin-bottom:8px;">üèÉ</div>
      Nenhuma sess√£o de cardio ainda.<br>Registre sua primeira sess√£o!
    </div>`;
  }

  return `
    <div class="grid-2" style="gap:10px; margin-bottom:12px;">
      <div style="background:var(--card2); border-radius:10px; padding:12px; text-align:center;">
        <div style="font-size:22px; font-weight:700; color:var(--orange); font-family:'Bebas Neue';">${hist.length}</div>
        <div style="font-size:11px; color:var(--muted2); text-transform:uppercase;">Sess√µes</div>
      </div>
      <div style="background:var(--card2); border-radius:10px; padding:12px; text-align:center;">
        <div style="font-size:22px; font-weight:700; color:var(--orange); font-family:'Bebas Neue';">${totalMin}min</div>
        <div style="font-size:11px; color:var(--muted2); text-transform:uppercase;">Tempo total</div>
      </div>
      ${totalKM > 0 ? `<div style="background:var(--card2); border-radius:10px; padding:12px; text-align:center;">
        <div style="font-size:22px; font-weight:700; color:var(--orange); font-family:'Bebas Neue';">${totalKM.toFixed(1)}km</div>
        <div style="font-size:11px; color:var(--muted2); text-transform:uppercase;">Dist√¢ncia</div>
      </div>` : ''}
      <div style="background:var(--card2); border-radius:10px; padding:12px; text-align:center;">
        <div style="font-size:18px; font-weight:700; color:var(--orange);">${calcularMediaIntensidade()}</div>
        <div style="font-size:11px; color:var(--muted2); text-transform:uppercase;">Intensidade m√©dia</div>
      </div>
    </div>
    <div style="display:flex; gap:6px; flex-wrap:wrap;">
      ${leves > 0 ? `<span class="tag" style="background:var(--blue-dim); color:var(--blue);">üòå ${leves}x leve</span>` : ''}
      ${moderados > 0 ? `<span class="tag tag-green">üòä ${moderados}x moderado</span>` : ''}
      ${intensos > 0 ? `<span class="tag" style="background:var(--red-dim); color:var(--red);">ü•µ ${intensos}x intenso</span>` : ''}
    </div>
    <div style="margin-top:12px; border-top:1px solid var(--border); padding-top:12px;">
      <div style="font-size:12px; font-weight:700; color:var(--muted2); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">√öltimas sess√µes</div>
      ${hist.slice(-5).reverse().map(c => `
        <div style="display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid var(--border);">
          <span style="font-size:18px;">${getCardioIcon(c.tipo)}</span>
          <div style="flex:1;">
            <div style="font-size:13px; font-weight:600;">${c.tipo}</div>
            <div style="font-size:11px; color:var(--muted2);">${new Date(c.data).toLocaleDateString('pt-BR')}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:12px;">${getIntensidadeIcon(c.intensidade)} ${c.intensidade}</div>
            <div style="font-size:11px; color:var(--muted2);">‚è± ${c.tempo}min${c.distancia ? ` ¬∑ ${c.distancia}km` : ''}</div>
          </div>
        </div>`).join('')}
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODO INICIANTE + RECUPERA√á√ÉO + CARDIO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function setUserLevel(level) {
  state.user = state.user || {};
  // Update hidden input
  const inp = document.getElementById('user-level');
  if (inp) inp.value = level;
  // Update button styles
  ['beginner','intermediate','advanced'].forEach(l => {
    const btn = document.getElementById('lvl-' + l);
    if (btn) btn.classList.toggle('selected', l === level);
  });
  // Activate modo iniciante
  if (level === 'beginner') {
    state.modoIniciante = {
      ativo: true,
      dataInicio: Date.now(),
      dataFim: Date.now() + (28 * 24 * 60 * 60 * 1000),
      semanasRestantes: 4
    };
  } else {
    state.modoIniciante = { ativo: false, dataInicio: null, dataFim: null, semanasRestantes: 0 };
  }
}

// ‚îÄ‚îÄ RECUPERA√á√ÉO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function getRecoveryStatus() {
  const hoje = Date.now();
  const ontem = hoje - (24 * 60 * 60 * 1000);
  // Cardio intenso nas √∫ltimas 24h
  if (state.cardio?.ultimoCardioIntenso && state.cardio.ultimoCardioIntenso > ontem) {
    return { recuperacao: 'baixa', mensagem: 'üèÉ Cardio intenso recente. Considere treino mais leve hoje.' };
  }
  // Dias consecutivos
  const cons = state.recuperacao?.diasConsecutivos || 0;
  if (cons >= 5) {
    return { recuperacao: 'critica', mensagem: `üò¥ ${cons} dias seguidos de treino. Recupera√ß√£o √© parte do m√©todo!` };
  }
  if (cons >= 3) {
    return { recuperacao: 'atencao', mensagem: `‚ö†Ô∏è ${cons} dias seguidos. Monitore seu desempenho.` };
  }
  return { recuperacao: 'normal', mensagem: null };
}

function updateRecoveryAfterWorkout() {
  const hoje = new Date().toDateString();
  const ultimo = state.recuperacao?.ultimoTreinoData
    ? new Date(state.recuperacao.ultimoTreinoData).toDateString()
    : null;
  if (ultimo === hoje) return; // j√° treinou hoje
  const ontem = new Date(Date.now() - 86400000).toDateString();
  if (ultimo === ontem) {
    state.recuperacao.diasConsecutivos = (state.recuperacao.diasConsecutivos || 0) + 1;
  } else {
    state.recuperacao.diasConsecutivos = 1;
  }
  state.recuperacao.ultimoTreinoData = Date.now();
}

function checkWorkoutFrequency() {
  const hoje = Date.now();
  const ultimos7 = state.sessions.filter(s => hoje - s.date < 7 * 86400000 && !s.isRestDay);
  const diasUnicos = new Set(ultimos7.map(s => new Date(s.date).toDateString())).size;
  if (diasUnicos >= 7) {
    return { bloqueado: true, motivo: '7 dias seguidos', mensagem: 'üö´ 7 dias seguidos de treino! Seu corpo precisa de pelo menos 1 dia de descanso por semana.' };
  }
  if (diasUnicos >= 5 && state.modoIniciante?.ativo) {
    return { bloqueado: true, motivo: 'alta_frequencia_iniciante', mensagem: 'üå± Modo iniciante: m√°ximo recomendado √© 4 dias/semana. Descanso √© quando o m√∫sculo cresce!' };
  }
  return { bloqueado: false };
}

function addRestDay() {
  state.sessions.push({ id: uid(), planId: 'rest', date: Date.now(), duration: 0, exercises: [], progressions: 0, isRestDay: true });
  state.recuperacao.diasConsecutivos = 0;
  save();
  showNotif('üò¥', 'Dia de descanso registrado!', 'Recupera√ß√£o √© parte do m√©todo Muzy', 'success');
  updateDashboard();
}

// ‚îÄ‚îÄ CARDIO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let newExerciseType = 'musculacao';

function setExerciseType(type) {
  newExerciseType = type;
  // Toggle ALL type-btn groups in the page
  document.querySelectorAll('.type-btn').forEach(b => {
    if (b.dataset.type === type) b.classList.add('active');
    else b.classList.remove('active');
  });
  // Show/hide cardio fields
  document.querySelectorAll('#cardio-extra-fields').forEach(el => {
    el.style.display = type === 'cardio' ? 'block' : 'none';
  });
  // Show/hide musculacao fields
  document.querySelectorAll('#musculacao-fields').forEach(el => {
    el.style.display = type === 'musculacao' ? 'block' : 'none';
  });
  // Update hidden input
  const inp = document.getElementById('ex-type');
  if (inp) inp.value = type;
}

function saveCardioExercise() {
  const tipo    = document.getElementById('cardio-tipo')?.value || 'esteira';
  const tempo   = parseInt(document.getElementById('cardio-tempo')?.value) || 20;
  const intens  = document.getElementById('cardio-intensidade')?.value || 'moderado';
  const dist    = parseFloat(document.getElementById('cardio-distancia')?.value) || null;

  const cardio = { id: uid(), data: Date.now(), tipo, tempo, intensidade: intens, distancia: dist };
  state.cardio.historico.push(cardio);
  if (intens === 'intenso') state.cardio.ultimoCardioIntenso = cardio.data;

  // Also add as a session entry so it appears in history
  state.sessions.push({
    id: uid(), planId: 'cardio', date: Date.now(), duration: tempo * 60,
    exercises: [{ name: tipo, cardio: true, tempo, intensidade: intens, distancia: dist }],
    progressions: 0, isCardio: true
  });

  save();
  closeModal('exercise-modal');
  showNotif('üèÉ', 'Cardio registrado!', `${tempo}min de ${tipo} (${intens})`, 'success');
  updateDashboard();
  renderAllSessions();
}

function checkMuscleGroupVolume(plan, newExercise) {
  if (!state.modoIniciante?.ativo) return true;
  const exsInPlan = plan.exercises.map(id => state.exercises.find(e => e.id === id)).filter(Boolean);
  const countByGroup = {};
  exsInPlan.forEach(ex => { countByGroup[ex.group] = (countByGroup[ex.group] || 0) + 1; });
  if (newExercise) countByGroup[newExercise.group] = (countByGroup[newExercise.group] || 0) + 1;
  for (let g in countByGroup) {
    if (countByGroup[g] > 3) {
      showNotif('üå±', 'Limite iniciante', `M√°ximo 3 exerc√≠cios para ${g} no modo iniciante`, 'warning');
      return false;
    }
  }
  return true;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CARDIO VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function abrirRegistroCardio() {
  document.getElementById('cardio-form-card').style.display = 'block';
  document.getElementById('cardio-form-card').scrollIntoView({ behavior: 'smooth' });
}

function fecharRegistroCardio() {
  document.getElementById('cardio-form-card').style.display = 'none';
}

function salvarCardioView() {
  const tipo     = document.getElementById('cardio-tipo-v').value;
  const tempo    = parseInt(document.getElementById('cardio-tempo-v').value) || 20;
  const intens   = document.getElementById('cardio-intensidade-v').value;
  const dist     = parseFloat(document.getElementById('cardio-distancia-v').value) || null;

  const cardio = { id: uid(), data: Date.now(), tipo, tempo, intensidade: intens, distancia: dist };
  if (!state.cardio) state.cardio = { historico: [], ultimoCardioIntenso: null };
  state.cardio.historico.push(cardio);
  if (intens === 'intenso') state.cardio.ultimoCardioIntenso = cardio.data;

  // Also push to sessions for history view
  state.sessions.push({
    id: uid(), planId: 'cardio', date: Date.now(), duration: tempo * 60,
    exercises: [{ name: tipo, cardio: true, tempo, intensidade: intens, distancia: dist }],
    progressions: 0, isCardio: true
  });

  save();
  fecharRegistroCardio();
  showNotif('üèÉ', 'Cardio registrado!', `${tempo}min de ${tipo} (${intens})`, 'success');
  renderCardioView();
  updateDashboard();
  renderAllSessions();
}

const CARDIO_POR_OBJETIVO = {
  hypertrophy: {
    icon: 'üí™',
    recomendado: 'Moderado 20‚Äì30min, 2‚Äì3x/semana, preferencialmente p√≥s-treino',
    evitar: 'Cardio intenso antes de treino de pernas ‚Äî aumenta catabolismo'
  },
  strength: {
    icon: 'üèãÔ∏è',
    recomendado: 'Apenas leve, em dias separados do treino principal',
    evitar: 'Qualquer cardio intenso perto do dia de treino pesado'
  },
  endurance: {
    icon: 'üö¥',
    recomendado: 'Moderado/Intenso, at√© 4x/semana, variando intensidade',
    evitar: 'Volume excessivo sem dias de recupera√ß√£o ativa'
  },
};

function renderCardioView() {
  // Dica por objetivo
  const goal = state.user?.goal || 'hypertrophy';
  const dica = CARDIO_POR_OBJETIVO[goal];
  const dicaEl = document.getElementById('cardio-dica-objetivo');
  if (dicaEl && dica) {
    dicaEl.innerHTML = `
      <div style="display:flex; align-items:flex-start; gap:12px;">
        <span style="font-size:28px;">${dica.icon}</span>
        <div>
          <div style="font-weight:700; font-size:14px; margin-bottom:6px;">Cardio para seu objetivo</div>
          <div style="font-size:13px; color:var(--green); margin-bottom:4px;">‚úÖ ${dica.recomendado}</div>
          <div style="font-size:13px; color:var(--red);">‚õî ${dica.evitar}</div>
        </div>
      </div>`;
  }

  // Alertas
  const alertasEl = document.getElementById('cardio-alertas-view');
  if (alertasEl) {
    const alertas = gerarAlertasCardio();
    alertasEl.innerHTML = alertas.map(a => a.html).join('');
  }

  // Stats
  const statsEl = document.getElementById('cardio-stats-view');
  if (statsEl) statsEl.innerHTML = renderCardioStats();

  // Hist√≥rico
  const histEl = document.getElementById('cardio-historico-view');
  if (histEl) {
    const hist = [...(state.cardio?.historico || [])].reverse();
    if (!hist.length) {
      histEl.innerHTML = `<div style="text-align:center; padding:24px; color:var(--muted2); font-size:13px;">
        <div style="font-size:32px; margin-bottom:8px;">üèÉ</div>
        Nenhuma sess√£o ainda.<br>Clique em "+ Registrar" para come√ßar!
      </div>`;
    } else {
      histEl.innerHTML = hist.map(c => `
        <div style="display:flex; align-items:center; gap:12px; padding:10px 0; border-bottom:1px solid var(--border);">
          <span style="font-size:28px;">${getCardioIcon(c.tipo)}</span>
          <div style="flex:1;">
            <div style="font-weight:600; font-size:14px;">${c.tipo}</div>
            <div style="font-size:12px; color:var(--muted2);">${new Date(c.data).toLocaleDateString('pt-BR', { weekday:'short', day:'2-digit', month:'short' })}</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:13px; font-weight:600;">${getIntensidadeIcon(c.intensidade)} ${c.intensidade}</div>
            <div style="font-size:12px; color:var(--muted2);">‚è± ${c.tempo}min${c.distancia ? ` ¬∑ üìè ${c.distancia}km` : ''}</div>
          </div>
        </div>`).join('');
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EBOOKS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const EBOOKS = {
  ectomorfa: {
    title: 'O GUIA DA ECTOMORFA',
    emoji: 'üåø',
    color: '#7c3aed',
    chapters: [
      {
        tag: 'Cap√≠tulo 1 ‚Äî GR√ÅTIS',
        title: 'Entendendo o Corpo Ectomorfo',
        free: true,
        body: `<p>Se voc√™ sempre foi chamada de "magrinha", "espicha f√°cil" ou ouviu que "tem sorte de n√£o engordar" ‚Äî este guia foi escrito para voc√™.</p>
        <p>O <strong>biotipo ectomorfo</strong> √© caracterizado por:</p>
        <ul>
          <li>Metabolismo acelerado ‚Äî voc√™ queima calorias em repouso mais r√°pido que outros biotipos</li>
          <li>Estrutura √≥ssea mais fina e delicada</li>
          <li>Dificuldade em reter massa muscular, mesmo treinando pesado</li>
          <li>Tend√™ncia a digest√£o mais sens√≠vel e apetite naturalmente menor</li>
          <li>Temperatura corporal ligeiramente mais elevada</li>
        </ul>
        <p>E a <strong>boa not√≠cia real</strong>: ectomorfas t√™m excelente sa√∫de cardiovascular, menor risco de diabetes tipo 2 e maior longevidade m√©dia que outros biotipos ‚Äî quando bem nutridas.</p>
        <p>O problema n√£o √© seu metabolismo. √â que <strong>ningu√©m te ensinou a comer e treinar para o seu corpo.</strong></p>`
      },
      {
        tag: 'Cap√≠tulo 2 ‚Äî GR√ÅTIS',
        title: 'A Armadilha Hormonal da Magra',
        free: true,
        body: `<p>Este √© o cap√≠tulo que mais mulheres precisam ler. Porque existe um ciclo silencioso que sabota a evolu√ß√£o de muitas ectomorfas:</p>
        <p><strong>Come pouco ‚Üí treina muito ‚Üí cortisol alto ‚Üí gordura na barriga ‚Üí se sente "gorda" ‚Üí come menos ‚Üí ciclo piora.</strong></p>
        <p>O ciclo menstrual afeta tudo ‚Äî e o impacto no biotipo ectomorfo √© intenso:</p>
        <ul>
          <li><strong>Fase folicular (dias 1‚Äì14):</strong> mais energia, for√ßa e disposi√ß√£o. Ideal para treinos mais pesados e progress√£o de carga.</li>
          <li><strong>Fase l√∫tea (dias 15‚Äì28):</strong> queda de energia, aumento do apetite (ou√ßa seu corpo!), reten√ß√£o h√≠drica natural ‚Äî n√£o √© gordura.</li>
          <li><strong>Amenorreia:</strong> se seu ciclo sumiu ou ficou irregular, seu corpo est√° em modo de sobreviv√™ncia. Comer mais pode ser a solu√ß√£o mais importante da sua vida agora.</li>
        </ul>
        <p>A rela√ß√£o entre baixo percentual de gordura (abaixo de 16-18%) e interrup√ß√£o do ciclo menstrual √© direta e comprovada. <strong>Menstruar regularmente √© sinal de sa√∫de, n√£o de fraqueza.</strong></p>`
      },
      {
        tag: 'Cap√≠tulo 3 ‚Äî PREMIUM',
        title: 'Nutri√ß√£o Estrat√©gica para Ganhar Massa',
        free: false,
        body: `<p>Aqui est√° a verdade que ningu√©m te conta: ectomorfas precisam de <strong>super√°vit cal√≥rico real</strong> para crescer. E n√£o, comer arroz e frango a mais n√£o vai funcionar se a quantidade total de calorias ainda for insuficiente.</p>
        <p><strong>Propor√ß√£o ideal de macros para ectomorfa que treina for√ßa 4-5x/semana:</strong></p>
        <ul>
          <li>Carboidratos: 50‚Äì55% ‚Äî seu melhor amigo para energia e armazenamento de glicog√™nio muscular</li>
          <li>Prote√≠nas: 25‚Äì30% ‚Äî m√≠nimo de 1,8g por kg de peso corporal</li>
          <li>Gorduras: 20‚Äì25% ‚Äî essencial para produ√ß√£o hormonal</li>
        </ul>
        <p><strong>Alimentos-chave para ectomorfa com digest√£o sens√≠vel:</strong></p>
        <ul>
          <li>Batata doce, arroz branco, aveia (carboidratos de f√°cil digest√£o)</li>
          <li>Ovos inteiros, frango, salm√£o, atum</li>
          <li>Amendoim, pasta de amendoim, abacate (calorias densas, volume pequeno)</li>
          <li>Leite integral, iogurte grego, queijo cottage</li>
        </ul>
        <p><strong>Estrat√©gia para quem n√£o sente fome:</strong> divida as refei√ß√µes em 5-6 menores, use vitaminas com leite + pasta de amendoim + banana ao inv√©s de refei√ß√µes s√≥lidas quando o apetite estiver baixo. Nunca pule o caf√© da manh√£.</p>`
      },
      {
        tag: 'Cap√≠tulo 4 ‚Äî PREMIUM',
        title: 'O Treino que Cria Curvas',
        free: false,
        body: `<p>A ectomorfa n√£o deve treinar como uma atleta de resist√™ncia. Cardio excessivo √© o maior sabotador do seu progresso.</p>
        <p><strong>Frequ√™ncia ideal:</strong> 3 a 4 dias de muscula√ß√£o por semana ‚Äî com pelo menos 48h de recupera√ß√£o para cada grupo muscular. Mais n√£o √© melhor para voc√™.</p>
        <p><strong>Cardio:</strong> m√°ximo 20-25min de cardio moderado, 2x por semana, preferencialmente em dias separados do treino de for√ßa. HIIT intenso? Apenas 1x por semana no m√°ximo.</p>
        <p><strong>Divis√£o semanal sugerida para iniciante ectomorfa (foco gl√∫teo e harmonia):</strong></p>
        <ul>
          <li>Segunda: Gl√∫teo + Posterior de coxa</li>
          <li>Ter√ßa: Peito + Ombro (criar largura)</li>
          <li>Quarta: Descanso ativo ou cardio leve</li>
          <li>Quinta: Costas + B√≠ceps</li>
          <li>Sexta: Quadr√≠ceps + Panturrilha</li>
          <li>S√°bado: Descanso ou cardio leve</li>
        </ul>
        <p><strong>Progress√£o de carga:</strong> adicione peso a cada 2 semanas, n√£o toda semana. Priorize chegar ao topo da faixa de reps com t√©cnica perfeita antes de subir a carga.</p>`
      },
      {
        tag: 'Cap√≠tulo 5 ‚Äî PREMIUM',
        title: 'Psicol√≥gico e Percep√ß√£o do Progresso',
        free: false,
        body: `<p>Nas primeiras semanas comendo mais e treinando certo, voc√™ vai se sentir "estufada" ou "maior". Isso √© <strong>100% normal e √© sinal de progresso.</strong></p>
        <p>O que est√° acontecendo no seu corpo:</p>
        <ul>
          <li><strong>Glicog√™nio muscular:</strong> cada 1g de carboidrato armazena ~3g de √°gua no m√∫sculo. Seus m√∫sculos est√£o cheios ‚Äî isso √© defini√ß√£o futura acontecendo agora.</li>
          <li><strong>√Ågua intramuscular:</strong> m√∫sculos mais trabalhados ret√™m mais √°gua temporariamente. Isso passa em 4-6 semanas.</li>
          <li><strong>Inflama√ß√£o anab√≥lica:</strong> microles√µes musculares que causam crescimento. Dor muscular = trabalho sendo feito.</li>
        </ul>
        <p><strong>Tempo realista para ver resultados vis√≠veis:</strong></p>
        <ul>
          <li>4-6 semanas: melhora de for√ßa e postura</li>
          <li>3-4 meses: mudan√ßas vis√≠veis em fotos</li>
          <li>6-12 meses: curvas reais e consistentes</li>
        </ul>
        <p><strong>Suplementa√ß√£o que realmente funciona para ectomorfa:</strong></p>
        <ul>
          <li><strong>Creatina monoidratada (3-5g/dia):</strong> aumenta for√ßa, volume muscular e recupera√ß√£o. A mais estudada e comprovada.</li>
          <li><strong>Whey protein:</strong> praticidade para bater prote√≠na quando o apetite est√° baixo.</li>
          <li><strong>√îmega-3 (2g/dia):</strong> reduz inflama√ß√£o, melhora sensibilidade insul√≠nica e sa√∫de hormonal.</li>
        </ul>`
      }
    ]
  },

  mesomorfa: {
    title: 'O GUIA DA MESOMORFA',
    emoji: 'üí™',
    color: '#16a34a',
    chapters: [
      {
        tag: 'Cap√≠tulo 1 ‚Äî GR√ÅTIS',
        title: 'O Dom e o Desafio da Mesomorfa',
        free: true,
        body: `<p>Voc√™ ganha m√∫sculo r√°pido, perde gordura quando se dedica ‚Äî mas tamb√©m acumula peso com facilidade nos per√≠odos de descuido. Bem-vinda ao biotipo mais "responsivo" da natureza.</p>
        <p>Caracter√≠sticas do <strong>biotipo mesomorfo feminino:</strong></p>
        <ul>
          <li>Estrutura √≥ssea m√©dia a larga, ombros e quadril proporcionais</li>
          <li>Metabolismo moderado e equilibrado</li>
          <li>Alta responsividade ao treino ‚Äî ganha for√ßa e massa muscular mais r√°pido que os outros biotipos</li>
          <li>Tend√™ncia a acumular gordura rapidamente em per√≠odos de excessos</li>
          <li>Boa capacidade cardiovascular natural</li>
        </ul>
        <p>A armadilha da mesomorfa √© justamente esse potencial: <strong>como resultado vem r√°pido, √© f√°cil se acomodar. E quando para, regride tamb√©m mais r√°pido.</strong> Consist√™ncia √© a sua palavra-chave.</p>`
      },
      {
        tag: 'Cap√≠tulo 2 ‚Äî GR√ÅTIS',
        title: 'Horm√¥nios e o Ciclo da Mesomorfa',
        free: true,
        body: `<p>A mesomorfa tem uma rela√ß√£o mais equilibrada com os horm√¥nios que os outros biotipos ‚Äî mas isso n√£o significa que o ciclo menstrual n√£o afeta o treino.</p>
        <p><strong>Como o ciclo impacta a mesomorfa:</strong></p>
        <ul>
          <li><strong>Fase folicular:</strong> pico de estrog√™nio = m√°xima for√ßa, resist√™ncia e motiva√ß√£o. √â o momento de treinar mais pesado e buscar recordes.</li>
          <li><strong>Ovula√ß√£o:</strong> pico de testosterona = maior s√≠ntese proteica. Use esse dia para treino de for√ßa m√°xima.</li>
          <li><strong>Fase l√∫tea:</strong> progesterona alta = mais catabolismo, reten√ß√£o h√≠drica e apetite aumentado. Reduza o cardio intenso e aumente levemente as prote√≠nas.</li>
        </ul>
        <p><strong>Aten√ß√£o:</strong> a mesomorfa tem maior tend√™ncia a desenvolver <strong>s√≠ndrome dos ov√°rios polic√≠sticos (SOP)</strong> quando aliada a uma dieta de alto √≠ndice glic√™mico e excesso de carboidratos refinados. Prefira sempre carboidratos complexos e mantenha o √≠ndice glic√™mico sob controle.</p>`
      },
      {
        tag: 'Cap√≠tulo 3 ‚Äî PREMIUM',
        title: 'Nutri√ß√£o para Composi√ß√£o Corporal Ideal',
        free: false,
        body: `<p>A nutri√ß√£o da mesomorfa precisa ser precisa ‚Äî nem restrita demais (perda de m√∫sculo) nem excessiva demais (ac√∫mulo de gordura).</p>
        <p><strong>Macros para mesomorfa com objetivo de composi√ß√£o (perder gordura + manter m√∫sculo):</strong></p>
        <ul>
          <li>Prote√≠nas: 30‚Äì35% ‚Äî prioridade m√°xima para preservar massa magra</li>
          <li>Carboidratos: 35‚Äì40% ‚Äî prefira complexos: batata doce, arroz integral, quinoa</li>
          <li>Gorduras: 25‚Äì30% ‚Äî azeite, abacate, oleaginosas</li>
        </ul>
        <p><strong>Estrat√©gia de ciclagem cal√≥rica:</strong> nos dias de treino pesado, aumente carboidratos em 20%. Nos dias de descanso, reduza carboidratos e aumente gorduras boas. Isso otimiza composi√ß√£o corporal sem sacrificar desempenho.</p>`
      },
      {
        tag: 'Cap√≠tulo 4 ‚Äî PREMIUM',
        title: 'Treino para Defini√ß√£o e Propor√ß√£o',
        free: false,
        body: `<p>A mesomorfa responde bem a praticamente qualquer tipo de treino ‚Äî o desafio √© escolher o certo para o objetivo atual.</p>
        <p><strong>Para composi√ß√£o corporal (mais comum para mesomorfas):</strong></p>
        <ul>
          <li>4-5 dias de treino de for√ßa com faixa de 8-15 reps</li>
          <li>2-3 sess√µes de cardio moderado de 25-35 min (n√£o HIIT todos os dias)</li>
          <li>Priorize grupos que voc√™ quer desenvolver: para a mesomorfa feminina, costas largas + gl√∫teos altos = silhueta ideal</li>
        </ul>
        <p><strong>O erro mais comum da mesomorfa:</strong> fazer cardio demais achando que vai "secar mais r√°pido". Resultado: perde m√∫sculo, fica "flat" e o metabolismo desacelera. <strong>M√∫sculo √© o que cria forma. Cardio apenas cria d√©ficit.</strong></p>`
      },
      {
        tag: 'Cap√≠tulo 5 ‚Äî PREMIUM',
        title: 'Mantendo os Resultados a Longo Prazo',
        free: false,
        body: `<p>A mesomorfa tem o maior potencial de transforma√ß√£o ‚Äî mas tamb√©m √© a que mais sofre com o efeito sanfona quando n√£o mant√©m consist√™ncia.</p>
        <p><strong>Estrat√©gias para manuten√ß√£o permanente:</strong></p>
        <ul>
          <li>Nunca fique mais de 2 semanas sem treinar ‚Äî a perda de massa muscular come√ßa r√°pido</li>
          <li>Tenha um plano de manuten√ß√£o (n√£o de emagrecimento) como base</li>
          <li>Ciclos de 3 meses: 2 meses de volume + 1 m√™s de defini√ß√£o funcionam muito bem para esse biotipo</li>
        </ul>
        <p><strong>Suplementa√ß√£o ideal para mesomorfa:</strong></p>
        <ul>
          <li><strong>Creatina (5g/dia):</strong> mant√©m for√ßa e volume muscular durante fases de d√©ficit cal√≥rico</li>
          <li><strong>Prote√≠na do soro (whey):</strong> praticidade p√≥s-treino</li>
          <li><strong>Magn√©sio glicinato (300-400mg √† noite):</strong> melhora qualidade do sono, reduz cortisol e ajuda no equil√≠brio hormonal ‚Äî especialmente importante na fase l√∫tea</li>
        </ul>`
      }
    ]
  },

  endomorfa: {
    title: 'O GUIA DA ENDOMORFA',
    emoji: 'üî•',
    color: '#ea580c',
    chapters: [
      {
        tag: 'Cap√≠tulo 1 ‚Äî GR√ÅTIS',
        title: 'Entendendo o Biotipo Endomorfo',
        free: true,
        body: `<p>Se voc√™ sente que engorda olhando para um peda√ßo de bolo, mas luta para perder os mesmos quilos com meses de dieta ‚Äî voc√™ n√£o est√° exagerando. O metabolismo endomorfo √© real, comprovado e tem caracter√≠sticas muito espec√≠ficas.</p>
        <p><strong>Caracter√≠sticas do biotipo endomorfo feminino:</strong></p>
        <ul>
          <li>Metabolismo mais lento ‚Äî menor taxa metab√≥lica basal em repouso</li>
          <li>Alta efici√™ncia em armazenar energia (especialmente como gordura)</li>
          <li>Estrutura √≥ssea mais larga, quadril proeminente</li>
          <li>Boa capacidade de ganhar massa muscular (vantagem real!)</li>
          <li>Maior sensibilidade √† insulina ‚Äî carboidratos viram gordura mais facilmente</li>
        </ul>
        <p><strong>A boa not√≠cia que ningu√©m te conta:</strong> a endomorfa tem <strong>excelente potencial muscular</strong>. Quando o foco muda de "emagrecer" para "construir m√∫sculo", o corpo muda de composi√ß√£o naturalmente ‚Äî e de forma duradoura.</p>`
      },
      {
        tag: 'Cap√≠tulo 2 ‚Äî GR√ÅTIS',
        title: 'Insulina, Horm√¥nios e o Ciclo da Endomorfa',
        free: true,
        body: `<p>O grande diferencial da endomorfa √© a <strong>sensibilidade √† insulina</strong> ‚Äî o horm√¥nio que decide se o que voc√™ come vira energia ou gordura.</p>
        <p><strong>Como o ciclo menstrual afeta a endomorfa de forma √∫nica:</strong></p>
        <ul>
          <li><strong>Fase folicular:</strong> maior sensibilidade √† insulina ‚Äî os carboidratos s√£o melhor utilizados. Aproveite para os treinos mais pesados e refei√ß√µes mais ricas em carboidratos.</li>
          <li><strong>Fase l√∫tea:</strong> queda da sensibilidade √† insulina + aumento do apetite. Reduza carboidratos, aumente prote√≠nas e gorduras boas. O craving por doce √© hormonal ‚Äî n√£o fraqueza sua.</li>
        </ul>
        <p><strong>S√≠ndrome dos Ov√°rios Polic√≠sticos (SOP):</strong> endomorfas t√™m maior predisposi√ß√£o. Os sintomas (ciclo irregular, acne, dificuldade em emagrecer) pioram com excesso de a√ß√∫car e carboidratos refinados. A abordagem nutricional correta pode reverter muitos desses sintomas ‚Äî sem medicamento.</p>
        <p><strong>Tire√≥ide:</strong> o hipotireoidismo √© mais comum em endomorfas. Se voc√™ sente cansa√ßo extremo, queda de cabelo e n√£o consegue emagrecer mesmo em d√©ficit, pe√ßa exame de TSH, T3 e T4 livre ao m√©dico.</p>`
      },
      {
        tag: 'Cap√≠tulo 3 ‚Äî PREMIUM',
        title: 'Nutri√ß√£o Estrat√©gica: Menos N√£o √â Sempre Melhor',
        free: false,
        body: `<p>O erro mais comum da endomorfa √© cortar calorias demais. O resultado: perde m√∫sculo, o metabolismo desacelera ainda mais, e o reganho de peso vem com for√ßa total.</p>
        <p><strong>Macros ideais para endomorfa com objetivo de defini√ß√£o:</strong></p>
        <ul>
          <li>Prote√≠nas: 35‚Äì40% ‚Äî alto consumo proteico preserva m√∫sculo e aumenta saciedade</li>
          <li>Gorduras boas: 30‚Äì35% ‚Äî azeite, abacate, oleaginosas, ovos inteiros</li>
          <li>Carboidratos: 25‚Äì30% ‚Äî APENAS complexos: batata doce, arroz integral, legumes</li>
        </ul>
        <p><strong>Timing de carboidratos:</strong> concentre 80% dos carboidratos do dia nas refei√ß√µes pr√© e p√≥s-treino. Nos outros momentos, prefira prote√≠nas e gorduras. Essa estrat√©gia simples pode acelerar resultados sem necessidade de dieta muito restrita.</p>
        <p><strong>Elimine da dieta (pelo menos por 30 dias):</strong> a√ß√∫car refinado, farinhas brancas, refrigerante, suco de caixinha, √°lcool frequente. N√£o √© sobre "nunca mais" ‚Äî √© sobre ver como seu corpo responde sem esses sabotadores.</p>`
      },
      {
        tag: 'Cap√≠tulo 4 ‚Äî PREMIUM',
        title: 'O Treino que Transforma a Endomorfa',
        free: false,
        body: `<p>A endomorfa responde melhor a uma combina√ß√£o espec√≠fica de treino ‚Äî e mais n√£o √© mais nesse caso.</p>
        <p><strong>Estrat√©gia de treino para m√°xima transforma√ß√£o:</strong></p>
        <ul>
          <li><strong>Muscula√ß√£o:</strong> 4 dias/semana, faixa de 10-15 reps com cargas moderadas a pesadas. Prioridade para grandes grupos: costas, gl√∫teos, quadr√≠ceps.</li>
          <li><strong>Cardio:</strong> 2-3x por semana de cardio moderado (30-40min). HIIT pode ser inclu√≠do 1x por semana para aumentar o metabolismo p√≥s-treino (efeito EPOC).</li>
          <li><strong>Descanso:</strong> ao contr√°rio do que parece, a endomorfa precisa de bom descanso. Priva√ß√£o de sono eleva cortisol ‚Üí aumenta reten√ß√£o de gordura abdominal.</li>
        </ul>
        <p><strong>Progress√£o de carga:</strong> a endomorfa tem excelente for√ßa natural. Use isso a seu favor ‚Äî progrida na carga regularmente. M√∫sculo constr√≥i metabolismo. Mais m√∫sculo = mais calorias queimadas em repouso.</p>`
      },
      {
        tag: 'Cap√≠tulo 5 ‚Äî PREMIUM',
        title: 'Sa√∫de Hormonal e Resultados Duradouros',
        free: false,
        body: `<p>Para a endomorfa, a transforma√ß√£o √© mais lenta ‚Äî mas √© mais permanente quando feita do jeito certo. O segredo est√° na sa√∫de hormonal de longo prazo.</p>
        <p><strong>Checklist semanal da endomorfa:</strong></p>
        <ul>
          <li>‚úÖ Bateu a prote√≠na hoje? (m√≠nimo 1.8g por kg de peso)</li>
          <li>‚úÖ Carboidratos concentrados no pr√© e p√≥s-treino?</li>
          <li>‚úÖ Dormiu 7-8 horas?</li>
          <li>‚úÖ Treinou com progress√£o de carga esta semana?</li>
          <li>‚úÖ Fez pelo menos 8.000 passos por dia (NEAT)?</li>
          <li>‚úÖ Ingest√£o de √°gua adequada? (m√≠nimo 35ml por kg de peso)</li>
        </ul>
        <p><strong>Suplementa√ß√£o para endomorfa:</strong></p>
        <ul>
          <li><strong>Creatina (5g/dia):</strong> aumenta for√ßa, potencializa ganho muscular e melhora composi√ß√£o corporal</li>
          <li><strong>√îmega-3 (2-3g/dia):</strong> melhora sensibilidade √† insulina, reduz inflama√ß√£o cr√¥nica</li>
          <li><strong>Inositol (2g 2x ao dia):</strong> estudos mostram melhora significativa na sensibilidade √† insulina e regula√ß√£o do ciclo ‚Äî especialmente para quem tem SOP</li>
        </ul>
        <p><strong>Tempo realista para resultados:</strong> 3-4 meses para mudan√ßas vis√≠veis na composi√ß√£o. 6-8 meses para transforma√ß√£o real e sustent√°vel. A endomorfa que persiste √© a que mais impressiona ‚Äî porque cada kg conquistado de m√∫sculo √© permanente.</p>`
      }
    ]
  }
};

let currentEbook = null;
let ebookUnlocked = false; // toggle to true when user pays

function openEbook(id) {
  currentEbook = id;
  const book = EBOOKS[id];
  if (!book) return;

  document.getElementById('reader-title').textContent = book.title;

  const freeChapters = book.chapters.filter(c => c.free);
  const premiumChapters = book.chapters.filter(c => !c.free);

  let html = '';

  // Free chapters
  freeChapters.forEach(ch => {
    html += `<div class="reader-chapter">
      <div class="reader-ch-tag">${ch.tag}</div>
      <div class="reader-ch-title">${ch.title}</div>
      <div class="reader-ch-body">${ch.body}</div>
    </div>`;
  });

  if (!ebookUnlocked) {
    // Teaser: first premium chapter faded out
    const first = premiumChapters[0];
    html += `<div class="reader-chapter" style="position:relative; max-height:200px; overflow:hidden; opacity:0.4;">
      <div class="reader-ch-tag">${first.tag}</div>
      <div class="reader-ch-title">${first.title}</div>
      <div class="reader-ch-body">${first.body}</div>
    </div>`;

    html += `<div class="reader-paywall">
      <div class="reader-paywall-card">
        <div style="font-size:32px; margin-bottom:12px;">üîí</div>
        <div style="font-family:'Bebas Neue'; font-size:22px; letter-spacing:1px; margin-bottom:8px;">DESBLOQUEIE O GUIA COMPLETO</div>
        <div style="font-size:13px; color:var(--muted2); margin-bottom:20px; line-height:1.6;">Mais 3 cap√≠tulos completos: Nutri√ß√£o Estrat√©gica, Treino Ideal e Suplementa√ß√£o.</div>
        <button class="btn btn-primary btn-full" onclick="unlockEbook()" style="margin-bottom:10px;">üíö Apoiar e desbloquear ‚Äî R$ 9,90/m√™s</button>
        <button class="btn btn-ghost btn-full" onclick="unlockEbookPix()">üì± Pix avulso (qualquer valor)</button>
        <div style="font-size:11px; color:var(--muted2); margin-top:12px;">Ap√≥s o apoio, toque em "J√° apoiei" para desbloquear</div>
        <button class="btn btn-ghost btn-full" style="margin-top:8px; font-size:12px; border-color:var(--green); color:var(--green);" onclick="unlockTemporary()">‚úì J√° apoiei ‚Äî desbloquear</button>
      </div>
    </div>`;
  } else {
    premiumChapters.forEach(ch => {
      html += `<div class="reader-chapter">
        <div class="reader-ch-tag">${ch.tag}</div>
        <div class="reader-ch-title">${ch.title}</div>
        <div class="reader-ch-body">${ch.body}</div>
      </div>`;
    });
  }

  document.getElementById('reader-content').innerHTML = html;
  document.getElementById('ebook-reader').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function closeEbook() {
  document.getElementById('ebook-reader').classList.remove('open');
  document.body.style.overflow = '';
}

function unlockEbook() {
  // Link to subscription page
  showNotif('üíö', 'Assinatura', 'Voc√™ ser√° redirecionado para a p√°gina de assinatura', 'success');
  // window.open('https://seulink.apoia.se', '_blank');
}

function unlockEbookPix() {
  showNotif('üì±', 'Pix', 'Copie a chave Pix e volte aqui para desbloquear', 'success');
}

function unlockTemporary() {
  ebookUnlocked = true;
  if (currentEbook) openEbook(currentEbook);
  showNotif('üéâ', 'Desbloqueado!', 'Obrigado pelo apoio! Conte√∫do completo liberado.', 'success');
}

function downloadCurrentPDF() {
  if (currentEbook) downloadEbookPDF(currentEbook);
}

function downloadEbookPDF(id) {
  const book = EBOOKS[id];
  if (!book) return;

  if (!ebookUnlocked) {
    showNotif('üîí', 'Conte√∫do premium', 'Apoie o projeto para baixar o PDF completo', 'warning');
    return;
  }

  // Generate printable HTML and trigger print-to-PDF
  const chapters = book.chapters;
  let printHTML = `<!DOCTYPE html><html lang="pt-BR"><head>
    <meta charset="UTF-8">
    <style>
      body { font-family: Georgia, serif; max-width: 680px; margin: 40px auto; padding: 0 20px; color: #1a1a1a; line-height: 1.8; }
      h1 { font-size: 36px; margin-bottom: 4px; }
      .sub { color: #888; font-size: 14px; margin-bottom: 48px; }
      h2 { font-size: 11px; letter-spacing: 3px; text-transform: uppercase; color: #e85c00; margin-bottom: 4px; margin-top: 40px; }
      h3 { font-size: 24px; margin-bottom: 16px; }
      p { margin-bottom: 12px; }
      ul { padding-left: 20px; margin-bottom: 12px; }
      li { margin-bottom: 6px; }
      hr { border: none; border-top: 1px solid #eee; margin: 40px 0; }
    </style></head><body>
    <h1>${book.emoji} ${book.title}</h1>
    <div class="sub">Guia Completo ¬∑ Biotipos Femininos ¬∑ PROGRESSAR</div>`;

  chapters.forEach((ch, i) => {
    printHTML += `<h2>${ch.tag}</h2><h3>${ch.title}</h3>${ch.body}${i < chapters.length - 1 ? '<hr>' : ''}`;
  });

  printHTML += '</body></html>';

  const w = window.open('', '_blank');
  w.document.write(printHTML);
  w.document.close();
  w.focus();
  setTimeout(() => w.print(), 500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BANCO DE DADOS DE EXERC√çCIOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const MUSCULOS = {

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMPLEXO ANTERIOR (Frente da Coxa) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  retofemoral:  { nome: 'Reto Femoral',   partes: ['Feixe central'], icone: 'ü¶µ', grupo: 'Perna',
    desc: 'Centro da coxa. √önico do quadr√≠ceps que tamb√©m FLEXIONA o quadril ‚Äî ativo em leg press e chute.', complexo: 'Quadr√≠ceps', resposta: 'densidade' },
  vastoLat:     { nome: 'Vasto Lateral',  partes: ['Feixe externo'], icone: 'ü¶µ', grupo: 'Perna',
    desc: 'Parte EXTERNA da coxa. D√° largura e defini√ß√£o lateral. Mais ativado com p√©s pr√≥ximos no leg press.', complexo: 'Quadr√≠ceps', resposta: 'densidade' },
  vastoMed:     { nome: 'Vasto Medial',   partes: ['"Gota" do joelho'], icone: 'ü¶µ', grupo: 'Perna',
    desc: 'A famosa "gota" acima do joelho. Ativado na extens√£o FINAL ‚Äî n√£o trave o joelho, fa√ßa completo.', complexo: 'Quadr√≠ceps', resposta: 'densidade' },
  vastoInt:     { nome: 'Vasto Interm√©dio', partes: ['Feixe profundo'], icone: 'ü¶µ', grupo: 'Perna',
    desc: 'Fica por BAIXO do reto femoral ‚Äî profundo. Ativado em toda amplitude do agachamento.', complexo: 'Quadr√≠ceps', resposta: 'densidade' },
  // Alias para compatibilidade
  quad:         { nome: 'Quadr√≠ceps',     partes: ['Reto femoral','Vasto lateral','Vasto medial','Vasto interm√©dio'], icone: 'ü¶µ', grupo: 'Perna',
    desc: '4 m√∫sculos da frente da coxa. Alta carga, responde √† densidade (menor descanso).', complexo: 'Quadr√≠ceps', resposta: 'densidade' },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMPLEXO POSTERIOR (Atr√°s da Coxa) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  bicepsFemoral:{ nome: 'B√≠ceps Femoral', partes: ['Cabe√ßa longa','Cabe√ßa curta'], icone: 'ü¶µ', grupo: 'Perna',
    desc: 'O mais EXTERNO dos isquiotibiais. Trabalha em flex√£o do joelho E extens√£o do quadril.', complexo: 'Isquiotibiais', resposta: 'tensao' },
  semitendined: { nome: 'Semitend√≠neo',   partes: ['Feixe m√©dio'], icone: 'ü¶µ', grupo: 'Perna',
    desc: 'Feixe do MEIO do posterior. Responde melhor a tempo sob tens√£o ‚Äî descida lenta na mesa flexora.', complexo: 'Isquiotibiais', resposta: 'tensao' },
  semimembran:  { nome: 'Semimembran√°ceo', partes: ['Feixe interno'], icone: 'ü¶µ', grupo: 'Perna',
    desc: 'O mais INTERNO. D√° curvatura interna ao posterior. Ativado em stiff e terra romeno.', complexo: 'Isquiotibiais', resposta: 'tensao' },
  isquio:       { nome: 'Isquiotibiais',  partes: ['B√≠ceps femoral','Semitend√≠neo','Semimembran√°ceo'], icone: 'ü¶µ', grupo: 'Perna',
    desc: 'Posterior da coxa. Responde melhor a tempo sob tens√£o (cad√™ncia lenta na descida).', complexo: 'Isquiotibiais', resposta: 'tensao' },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMPLEXO GL√öTEO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  glutMax:      { nome: 'Gl√∫teo M√°ximo',  partes: ['Fibras superiores','Fibras inferiores'], icone: 'üçë', grupo: 'Gl√∫teo',
    desc: 'O MAIOR m√∫sculo do corpo. Respons√°vel pelo volume e pot√™ncia. Suporta altas cargas.', complexo: 'Gl√∫teo', resposta: 'densidade' },
  glutMed:      { nome: 'Gl√∫teo M√©dio',   partes: ['Fibras anteriores','Fibras posteriores'], icone: 'üçë', grupo: 'Gl√∫teo',
    desc: 'LATERAL do quadril. D√° largura e evita o "buraco" na lateral. Abdu√ß√£o √© essencial.', complexo: 'Gl√∫teo', resposta: 'tensao' },
  glutMin:      { nome: 'Gl√∫teo M√≠nimo',  partes: ['Fibras anteriores','Fibras posteriores'], icone: 'üçë', grupo: 'Gl√∫teo',
    desc: 'Por baixo do m√©dio. Rota√ß√£o e equil√≠brio p√©lvico. Abdu√ß√£o profunda e agachamento unilateral.', complexo: 'Gl√∫teo', resposta: 'tensao' },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMPLEXO ADUTOR (Interno da Coxa) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  adutorLongo:  { nome: 'Adutor Longo',   partes: ['Feixe longo'], icone: 'ü¶µ', grupo: 'Perna',
    desc: 'O mais vis√≠vel dos adutores. Trabalha adu√ß√£o e leve flex√£o do quadril.', complexo: 'Adutores', resposta: 'tensao' },
  adutorCurto:  { nome: 'Adutor Curto',   partes: ['Feixe curto'], icone: 'ü¶µ', grupo: 'Perna',
    desc: 'Mais profundo. Estabiliza√ß√£o do quadril em movimentos laterais.', complexo: 'Adutores', resposta: 'tensao' },
  adutorMagno:  { nome: 'Adutor Magno',   partes: ['Parte adutora','Parte isquiocond√≠lea'], icone: 'ü¶µ', grupo: 'Perna',
    desc: 'O MAIOR adutor ‚Äî quase t√£o grande quanto o gl√∫teo. Tamb√©m auxilia extens√£o de quadril.', complexo: 'Adutores', resposta: 'tensao' },
  gracil:       { nome: 'Gr√°cil',         partes: ['√önico feixe'], icone: 'ü¶µ', grupo: 'Perna',
    desc: 'Cruza joelho E quadril. Importante para estabilidade do joelho em mulheres.', complexo: 'Adutores', resposta: 'tensao' },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANTURRILHA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  gastrocnemio: { nome: 'Gastrocn√™mio',   partes: ['Cabe√ßa medial','Cabe√ßa lateral'], icone: 'ü¶µ', grupo: 'Perna',
    desc: 'As duas "cabe√ßas" VIS√çVEIS da panturrilha. Joelho estendido = mais ativa√ß√£o. Eleva o calcanhar.', complexo: 'Panturrilha', resposta: 'tensao' },
  soleo:        { nome: 'S√≥leo',          partes: ['√önico feixe'], icone: 'ü¶µ', grupo: 'Perna',
    desc: 'Por baixo do gastrocn√™mio. D√° ESPESSURA √† panturrilha. Joelho dobrado = mais s√≥leo.', complexo: 'Panturrilha', resposta: 'tensao' },
  panturrilha:  { nome: 'Panturrilha',    partes: ['Gastrocn√™mio','S√≥leo'], icone: 'ü¶µ', grupo: 'Perna',
    desc: 'Responde melhor a tempo sob tens√£o e volume alto. Descida lenta, amplitude completa.', complexo: 'Panturrilha', resposta: 'tensao' },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PEITO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  peitoSup:     { nome: 'Peitoral Superior', partes: ['Feixe clavicular'], icone: 'üí™', grupo: 'Peito',
    desc: 'Inclinado 30-45¬∞, crossover de baixo para cima. D√° "prateleira" ao peito.', resposta: 'densidade' },
  peitoMed:     { nome: 'Peitoral M√©dio',    partes: ['Feixe esternal'], icone: 'üí™', grupo: 'Peito',
    desc: 'Supino reto, crucifixo plano ‚Äî a maior parte do peito.', resposta: 'densidade' },
  peitoInf:     { nome: 'Peitoral Inferior', partes: ['Feixe abdominal'], icone: 'üí™', grupo: 'Peito',
    desc: 'Declinado, crossover de cima para baixo, mergulho. D√° curvatura inferior.', resposta: 'densidade' },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COSTAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  dorsal:       { nome: 'Grande Dorsal',  partes: ['Fibras superiores','Fibras inferiores'], icone: 'ü¶∫', grupo: 'Costas',
    desc: 'O maior m√∫sculo do tronco. Puxadas, remadas, pulldown. Define o "V" das costas.', resposta: 'densidade' },
  trapezio:     { nome: 'Trap√©zio',       partes: ['Superior','M√©dio','Inferior'], icone: 'ü¶∫', grupo: 'Costas',
    desc: 'Superior: eleva√ß√£o de ombros. M√©dio/Inferior: retra√ß√£o escapular ‚Äî postura.', resposta: 'tensao' },
  romboid:      { nome: 'Romboides',      partes: ['Maior','Menor'], icone: 'ü¶∫', grupo: 'Costas',
    desc: 'Retra√ß√£o da esc√°pula. Essencial para postura e sa√∫de dos ombros.', resposta: 'tensao' },
  eretores:     { nome: 'Eretores',       partes: ['Iliocostal','Longu√≠ssimo','Espinal'], icone: 'ü¶∫', grupo: 'Costas',
    desc: 'Sustentam a coluna. Trabalham em todos os exerc√≠cios em p√© ou curvados.', resposta: 'tensao' },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OMBRO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  deltAnt:      { nome: 'Delt√≥ide Anterior',  partes: ['Feixe anterior'], icone: 'üî∫', grupo: 'Ombro',
    desc: 'J√Å √© muito ativado em peito. Evite excessos ‚Äî trabalha em supino inclinado e cruzamento.', resposta: 'densidade',
    secundarioEm: ['Peito'] },
  deltLat:      { nome: 'Delt√≥ide Lateral',   partes: ['Feixe lateral'], icone: 'üî∫', grupo: 'Ombro',
    desc: 'Largura dos ombros. S√≥ √© isolado na eleva√ß√£o lateral ‚Äî subativado em compostos.', resposta: 'densidade' },
  deltPost:     { nome: 'Delt√≥ide Posterior', partes: ['Feixe posterior'], icone: 'üî∫', grupo: 'Ombro',
    desc: 'Muito negligenciado. Ativado em remadas altas ‚Äî trabalha em Costas tamb√©m.', resposta: 'tensao',
    secundarioEm: ['Costas'] },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê B√çCEPS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  bicepsCurto:  { nome: 'B√≠ceps Curto',   partes: ['Cabe√ßa curta'], icone: 'üí™', grupo: 'B√≠ceps',
    desc: 'Pico e largura. Rosca martelo, concentrada. TAMB√âM trabalha em puxadas e remadas.',
    secundarioEm: ['Costas'], resposta: 'tensao' },
  bicepsLongo:  { nome: 'B√≠ceps Longo',   partes: ['Cabe√ßa longa'], icone: 'üí™', grupo: 'B√≠ceps',
    desc: 'Comprimento do b√≠ceps. Rosca direta e inclinada. TAMB√âM trabalha em puxadas.',
    secundarioEm: ['Costas'], resposta: 'tensao' },
  braquial:     { nome: 'Braquial',       partes: ['√önico feixe'], icone: 'üí™', grupo: 'B√≠ceps',
    desc: 'Por baixo do b√≠ceps ‚Äî empurra o b√≠ceps para cima dando mais pico. Rosca martelo.', resposta: 'tensao' },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TR√çCEPS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  tricepsLat:   { nome: 'Tr√≠ceps Lateral', partes: ['Cabe√ßa lateral'], icone: 'üí™', grupo: 'Tr√≠ceps',
    desc: 'Mais vis√≠vel de lado. Polia com corda, tr√≠ceps testa. TAMB√âM trabalha em supino e desenvolvimento.',
    secundarioEm: ['Peito','Ombro'], resposta: 'densidade' },
  tricepsMed:   { nome: 'Tr√≠ceps Medial',  partes: ['Cabe√ßa medial'], icone: 'üí™', grupo: 'Tr√≠ceps',
    desc: 'Espessura. Mergulho, supino fechado. Muito ativado em exerc√≠cios de peito.',
    secundarioEm: ['Peito'], resposta: 'densidade' },
  tricepsLong:  { nome: 'Tr√≠ceps Longo',   partes: ['Cabe√ßa longa'], icone: 'üí™', grupo: 'Tr√≠ceps',
    desc: 'Maior parte do tr√≠ceps. Franc√™s, tr√≠ceps coice. TAMB√âM ativado em desenvolvimento.',
    secundarioEm: ['Ombro'], resposta: 'tensao' },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CORE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  abdReto:      { nome: 'Reto Abdominal', partes: ['Superior','Inferior'], icone: 'üî•', grupo: 'Abd√¥men',
    desc: 'O "tanquinho". Flex√£o do tronco. Trabalha como estabilizador em TODOS os compostos.', resposta: 'tensao' },
  obliquo:      { nome: 'Obl√≠quos',       partes: ['Externo','Interno'], icone: 'üî•', grupo: 'Abd√¥men',
    desc: 'Rota√ß√£o e flex√£o lateral. Essenciais para cintura fina e prote√ß√£o da coluna.', resposta: 'tensao' },
  transverso:   { nome: 'Transverso',     partes: ['√önico feixe'], icone: 'üî•', grupo: 'Abd√¥men',
    desc: 'O "cinto" profundo. Comprime o abd√¥men ‚Äî ativado na respira√ß√£o e no bracing.', resposta: 'tensao' },
};

const EXERCICIOS_DB = [
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PERNA / GL√öTEO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id: 'agachamento',
    nome: 'Agachamento Livre',
    grupo: 'Perna',
    tipo: 'composto',
    articulacoes: ['joelho','quadril','tornozelo'],
    fadiga: 'alta',
    primarios: ['quad','glutMax'],
    secundarios: ['isquio','glutMed','eretores','panturrilha'],
    dica: 'Rei dos exerc√≠cios compostos. Recruta mais de 200 m√∫sculos. Des√ßa at√© a paralela ou abaixo.',
    sobreposicao: ['leg_press','hack_squat','bulgaro'],
    barraObrigatoria: true,
  },
  {
    id: 'leg_press',
    nome: 'Leg Press 45¬∞',
    grupo: 'Perna',
    tipo: 'composto',
    articulacoes: ['joelho','quadril'],
    fadiga: 'media',
    primarios: ['quad','glutMax'],
    secundarios: ['isquio','glutMed'],
    dica: 'P√©s mais altos = mais gl√∫teo. P√©s mais baixos = mais quadr√≠ceps. N√£o trave o joelho na extens√£o.',
    sobreposicao: ['agachamento','hack_squat'],
    barraObrigatoria: false,
  },
  {
    id: 'hack_squat',
    nome: 'Hack Squat',
    grupo: 'Perna',
    tipo: 'composto',
    articulacoes: ['joelho','quadril'],
    fadiga: 'media',
    primarios: ['quad'],
    secundarios: ['glutMax','isquio'],
    dica: 'Excelente para isolamento de quadr√≠ceps com seguran√ßa para a lombar.',
    sobreposicao: ['agachamento','leg_press'],
    barraObrigatoria: false,
  },
  {
    id: 'bulgaro',
    nome: 'Agachamento B√∫lgaro',
    grupo: 'Perna',
    tipo: 'composto',
    articulacoes: ['joelho','quadril'],
    fadiga: 'alta',
    primarios: ['quad','glutMax'],
    secundarios: ['glutMed','isquio'],
    dica: 'Unilateral ‚Äî corrige desequil√≠brios entre pernas. Perna de tr√°s serve de equil√≠brio, n√£o de apoio.',
    sobreposicao: ['agachamento','leg_press'],
    barraObrigatoria: false,
  },
  {
    id: 'cadeira_extensora',
    nome: 'Cadeira Extensora',
    grupo: 'Perna',
    tipo: 'isolamento',
    articulacoes: ['joelho'],
    fadiga: 'baixa',
    primarios: ['quad'],
    secundarios: [],
    dica: 'Isolamento puro de quadr√≠ceps. √ìtimo como finalizador ap√≥s compostos. Cuidado com dor no joelho.',
    sobreposicao: [],
    barraObrigatoria: false,
  },
  {
    id: 'mesa_flexora',
    nome: 'Mesa Flexora',
    grupo: 'Perna',
    tipo: 'isolamento',
    articulacoes: ['joelho'],
    fadiga: 'baixa',
    primarios: ['isquio'],
    secundarios: [],
    dica: '√önico exerc√≠cio de isolamento de isquiotibiais. Essencial para equil√≠brio quad/isquio.',
    sobreposicao: [],
    barraObrigatoria: false,
  },
  {
    id: 'terra',
    nome: 'Terra (Deadlift)',
    grupo: 'Costas',
    tipo: 'composto',
    articulacoes: ['quadril','joelho','coluna'],
    fadiga: 'alta',
    primarios: ['eretores','glutMax','isquio'],
    secundarios: ['quad','trapezio','dorsal'],
    dica: 'Exerc√≠cio mais completo do corpo. Exige t√©cnica rigorosa ‚Äî aprenda com peso leve primeiro.',
    sobreposicao: ['terra_romeno'],
    barraObrigatoria: true,
  },
  {
    id: 'terra_romeno',
    nome: 'Terra Romeno',
    grupo: 'Perna',
    tipo: 'composto',
    articulacoes: ['quadril'],
    fadiga: 'media',
    primarios: ['isquio','glutMax'],
    secundarios: ['eretores','glutMed'],
    dica: 'Joelhos levemente dobrados, quadril para tr√°s ‚Äî sente o alongamento dos isquiotibiais.',
    sobreposicao: ['terra','mesa_flexora'],
    barraObrigatoria: true,
  },
  {
    id: 'abducao',
    nome: 'Abdu√ß√£o (M√°quina)',
    grupo: 'Gl√∫teo',
    tipo: 'isolamento',
    articulacoes: ['quadril'],
    fadiga: 'baixa',
    primarios: ['glutMed','glutMin'],
    secundarios: [],
    dica: '√önico exerc√≠cio que isola o gl√∫teo m√©dio e m√≠nimo. Essencial para largura e equil√≠brio p√©lvico.',
    sobreposicao: [],
    barraObrigatoria: false,
  },
  {
    id: 'hip_thrust',
    nome: 'Hip Thrust',
    grupo: 'Gl√∫teo',
    tipo: 'composto',
    articulacoes: ['quadril'],
    fadiga: 'media',
    primarios: ['glutMax'],
    secundarios: ['isquio','glutMed'],
    dica: 'Melhor exerc√≠cio para ativa√ß√£o do gl√∫teo m√°ximo. Aperte o gl√∫teo no topo do movimento.',
    sobreposicao: ['agachamento','leg_press'],
    barraObrigatoria: true,
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PEITO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id: 'supino_reto',
    nome: 'Supino Reto',
    grupo: 'Peito',
    tipo: 'composto',
    articulacoes: ['ombro','cotovelo'],
    fadiga: 'alta',
    primarios: ['peitoMed'],
    secundarios: ['peitoSup','tricepsLat','tricepsMed','deltAnt'],
    dica: 'Base do treino de peito. Esc√°pulas retra√≠das, arco leve, p√©s no ch√£o.',
    sobreposicao: ['supino_inclinado','crossover'],
    barraObrigatoria: true,
  },
  {
    id: 'supino_inclinado',
    nome: 'Supino Inclinado',
    grupo: 'Peito',
    tipo: 'composto',
    articulacoes: ['ombro','cotovelo'],
    fadiga: 'media',
    primarios: ['peitoSup'],
    secundarios: ['peitoMed','deltAnt','tricepsLat'],
    dica: '30-45¬∞ √© o √¢ngulo ideal. Acima disso vira exerc√≠cio de ombro.',
    sobreposicao: ['supino_reto','desenvolvimento'],
    barraObrigatoria: true,
  },
  {
    id: 'crucifixo',
    nome: 'Crucifixo / Voador',
    grupo: 'Peito',
    tipo: 'isolamento',
    articulacoes: ['ombro'],
    fadiga: 'baixa',
    primarios: ['peitoMed','peitoSup'],
    secundarios: ['deltAnt'],
    dica: 'Isolamento de peito ‚Äî cotovelos levemente dobrados, movimento como se abra√ßasse uma √°rvore.',
    sobreposicao: [],
    barraObrigatoria: false,
  },
  {
    id: 'crossover',
    nome: 'Crossover / Polia',
    grupo: 'Peito',
    tipo: 'isolamento',
    articulacoes: ['ombro'],
    fadiga: 'baixa',
    primarios: ['peitoMed','peitoInf'],
    secundarios: ['peitoSup'],
    dica: 'Polia de cima para baixo = peitoral inferior. De baixo para cima = peitoral superior.',
    sobreposicao: ['crucifixo'],
    barraObrigatoria: false,
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COSTAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id: 'puxada_frontal',
    nome: 'Puxada Frontal',
    grupo: 'Costas',
    tipo: 'composto',
    articulacoes: ['ombro','cotovelo'],
    fadiga: 'media',
    primarios: ['dorsal'],
    secundarios: ['bicepsCurto','bicepsLongo','romboid','trapezio'],
    dica: 'Pegada mais larga = mais dorsal. Puxe os cotovelos para baixo, n√£o as m√£os.',
    sobreposicao: ['barra_fixa','remada_curvada'],
    barraObrigatoria: false,
  },
  {
    id: 'barra_fixa',
    nome: 'Barra Fixa',
    grupo: 'Costas',
    tipo: 'composto',
    articulacoes: ['ombro','cotovelo'],
    fadiga: 'alta',
    primarios: ['dorsal'],
    secundarios: ['bicepsCurto','bicepsLongo','romboid'],
    dica: 'Vers√£o mais dif√≠cil e completa da puxada. Corpo livre ativa mais estabilizadores.',
    sobreposicao: ['puxada_frontal','remada_curvada'],
    barraObrigatoria: false,
  },
  {
    id: 'remada_curvada',
    nome: 'Remada Curvada',
    grupo: 'Costas',
    tipo: 'composto',
    articulacoes: ['ombro','cotovelo','quadril'],
    fadiga: 'alta',
    primarios: ['dorsal','romboid'],
    secundarios: ['bicepsCurto','trapezio','eretores'],
    dica: 'Tronco a 45¬∞, puxe a barra at√© o umbigo. Essencial para espessura de costas.',
    sobreposicao: ['remada_maquina','puxada_frontal'],
    barraObrigatoria: true,
  },
  {
    id: 'remada_maquina',
    nome: 'Remada M√°quina / Cavalinho',
    grupo: 'Costas',
    tipo: 'composto',
    articulacoes: ['ombro','cotovelo'],
    fadiga: 'media',
    primarios: ['dorsal','romboid'],
    secundarios: ['bicepsCurto','trapezio'],
    dica: 'Peito apoiado elimina o trap√©zio do movimento ‚Äî foco total em dorsal e romboides.',
    sobreposicao: ['remada_curvada'],
    barraObrigatoria: false,
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê OMBRO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id: 'desenvolvimento',
    nome: 'Desenvolvimento',
    grupo: 'Ombro',
    tipo: 'composto',
    articulacoes: ['ombro','cotovelo'],
    fadiga: 'alta',
    primarios: ['deltAnt','deltLat'],
    secundarios: ['tricepsLat','tricepsMed','trapezio'],
    dica: 'Base do treino de ombro. Cuidado com a lombar ‚Äî fa√ßa sentado ou com apoio.',
    sobreposicao: ['elevacao_lateral','supino_inclinado'],
    barraObrigatoria: true,
  },
  {
    id: 'elevacao_lateral',
    nome: 'Eleva√ß√£o Lateral',
    grupo: 'Ombro',
    tipo: 'isolamento',
    articulacoes: ['ombro'],
    fadiga: 'baixa',
    primarios: ['deltLat'],
    secundarios: ['deltAnt','trapezio'],
    dica: 'Cotovelos levemente dobrados, n√£o suba acima de 90¬∞. Peso bem mais leve do que parece necess√°rio.',
    sobreposicao: [],
    barraObrigatoria: false,
  },
  {
    id: 'voador_inverso',
    nome: 'Voador Inverso / Face Pull',
    grupo: 'Ombro',
    tipo: 'isolamento',
    articulacoes: ['ombro'],
    fadiga: 'baixa',
    primarios: ['deltPost'],
    secundarios: ['romboid','trapezio'],
    dica: 'Delt√≥ide posterior √© o mais negligenciado. Essencial para sa√∫de dos ombros e postura.',
    sobreposicao: [],
    barraObrigatoria: false,
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê B√çCEPS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id: 'rosca_direta',
    nome: 'Rosca Direta',
    grupo: 'B√≠ceps',
    tipo: 'isolamento',
    articulacoes: ['cotovelo'],
    fadiga: 'baixa',
    primarios: ['bicepsLongo'],
    secundarios: ['bicepsCurto'],
    dica: 'Cotovelos fixos no corpo. Supina√ß√£o no topo (gire o punho) para ativar mais o b√≠ceps longo.',
    sobreposicao: ['rosca_martelo','rosca_concentrada'],
    barraObrigatoria: false,
  },
  {
    id: 'rosca_martelo',
    nome: 'Rosca Martelo',
    grupo: 'B√≠ceps',
    tipo: 'isolamento',
    articulacoes: ['cotovelo'],
    fadiga: 'baixa',
    primarios: ['bicepsCurto'],
    secundarios: ['bicepsLongo','braquial'],
    dica: 'Pegada neutra ativa mais o b√≠ceps curto e o braquial ‚Äî d√° mais espessura ao bra√ßo.',
    sobreposicao: ['rosca_direta'],
    barraObrigatoria: false,
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TR√çCEPS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id: 'triceps_polia',
    nome: 'Tr√≠ceps Polia',
    grupo: 'Tr√≠ceps',
    tipo: 'isolamento',
    articulacoes: ['cotovelo'],
    fadiga: 'baixa',
    primarios: ['tricepsLat'],
    secundarios: ['tricepsMed'],
    dica: 'Com corda: na extens√£o, abra as pontas para ativar mais a cabe√ßa lateral.',
    sobreposicao: ['triceps_testa','supino_fechado'],
    barraObrigatoria: false,
  },
  {
    id: 'triceps_testa',
    nome: 'Tr√≠ceps Testa / Franc√™s',
    grupo: 'Tr√≠ceps',
    tipo: 'isolamento',
    articulacoes: ['cotovelo'],
    fadiga: 'media',
    primarios: ['tricepsLong'],
    secundarios: ['tricepsLat','tricepsMed'],
    dica: 'Melhor exerc√≠cio para a cabe√ßa longa do tr√≠ceps ‚Äî o que d√° mais volume ao bra√ßo de tr√°s.',
    sobreposicao: ['triceps_polia'],
    barraObrigatoria: false,
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADUTORES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id: 'aducao_maquina',
    nome: 'Adu√ß√£o (M√°quina)',
    grupo: 'Perna',
    tipo: 'isolamento',
    articulacoes: ['quadril'],
    fadiga: 'baixa',
    primarios: ['adutorLongo','adutorMagno'],
    secundarios: ['gracil','adutorCurto'],
    dica: '√önico exerc√≠cio que isola o interno da coxa. Cad√™ncia lenta na abertura = mais ativa√ß√£o.',
    sobreposicao: [],
    barraObrigatoria: false,
    resposta: 'tensao',
  },
  {
    id: 'agachamento_sumo',
    nome: 'Agachamento Sumo',
    grupo: 'Perna',
    tipo: 'composto',
    articulacoes: ['joelho','quadril'],
    fadiga: 'alta',
    primarios: ['adutorMagno','glutMed','quad'],
    secundarios: ['glutMax','isquio'],
    dica: 'P√©s afastados e virados para fora ‚Äî ativa mais interno da coxa e gl√∫teo m√©dio que o agachamento convencional.',
    sobreposicao: ['agachamento','leg_press'],
    barraObrigatoria: true,
    resposta: 'densidade',
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANTURRILHA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id: 'panturrilha_em_pe',
    nome: 'Panturrilha em P√©',
    grupo: 'Perna',
    tipo: 'isolamento',
    articulacoes: ['tornozelo'],
    fadiga: 'baixa',
    primarios: ['gastrocnemio'],
    secundarios: ['soleo'],
    dica: 'Joelho ESTENDIDO = mais gastrocn√™mio (cabe√ßa vis√≠vel). Amplitude total ‚Äî calcanhar abaixo do degrau.',
    sobreposicao: ['panturrilha_sentado'],
    barraObrigatoria: false,
    resposta: 'tensao',
  },
  {
    id: 'panturrilha_sentado',
    nome: 'Panturrilha Sentado',
    grupo: 'Perna',
    tipo: 'isolamento',
    articulacoes: ['tornozelo'],
    fadiga: 'baixa',
    primarios: ['soleo'],
    secundarios: ['gastrocnemio'],
    dica: 'Joelho DOBRADO = mais s√≥leo (espessura profunda). Carga diferente ‚Äî s√≥leo aguenta muito volume.',
    sobreposicao: [],
    barraObrigatoria: false,
    resposta: 'tensao',
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STIFF / TERRA VARIA√á√ïES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id: 'stiff',
    nome: 'Stiff',
    grupo: 'Perna',
    tipo: 'composto',
    articulacoes: ['quadril'],
    fadiga: 'media',
    primarios: ['isquio','glutMax'],
    secundarios: ['eretores','adutorMagno'],
    dica: 'Pernas retas (n√£o trancadas). Foco total no alongamento dos isquiotibiais. Cad√™ncia lenta na descida.',
    sobreposicao: ['terra_romeno','mesa_flexora'],
    barraObrigatoria: true,
    resposta: 'tensao',
  },
  {
    id: 'afundo',
    nome: 'Afundo / Passada',
    grupo: 'Perna',
    tipo: 'composto',
    articulacoes: ['joelho','quadril'],
    fadiga: 'media',
    primarios: ['quad','glutMax'],
    secundarios: ['glutMed','isquio','adutorLongo'],
    dica: 'Passo largo = mais gl√∫teo. Passo curto = mais quadr√≠ceps. Joelho da frente n√£o ultrapassa o p√©.',
    sobreposicao: ['bulgaro','agachamento'],
    barraObrigatoria: false,
    resposta: 'densidade',
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COSTAS EXTRAS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id: 'pullover',
    nome: 'Pullover',
    grupo: 'Costas',
    tipo: 'isolamento',
    articulacoes: ['ombro'],
    fadiga: 'baixa',
    primarios: ['dorsal'],
    secundarios: ['peitoInf','tricepsLong'],
    dica: '√önico exerc√≠cio que trabalha dorsal E peitoral inferior juntos. Cotovelos levemente dobrados.',
    sobreposicao: [],
    barraObrigatoria: false,
    resposta: 'tensao',
  },
  {
    id: 'encolhimento',
    nome: 'Encolhimento de Ombros',
    grupo: 'Costas',
    tipo: 'isolamento',
    articulacoes: ['ombro'],
    fadiga: 'baixa',
    primarios: ['trapezio'],
    secundarios: [],
    dica: 'Isolamento do trap√©zio superior. Movimento vertical ‚Äî n√£o role os ombros, apenas suba e des√ßa.',
    sobreposicao: [],
    barraObrigatoria: false,
    resposta: 'tensao',
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CORE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id: 'prancha',
    nome: 'Prancha',
    grupo: 'Abd√¥men',
    tipo: 'isolamento',
    articulacoes: ['coluna'],
    fadiga: 'baixa',
    primarios: ['transverso','abdReto'],
    secundarios: ['obliquo','eretores'],
    dica: 'Ative o transverso: "sugue" o umbigo levemente. Corpo em linha reta ‚Äî sem elevar o quadril.',
    sobreposicao: [],
    barraObrigatoria: false,
    resposta: 'tensao',
  },
  {
    id: 'abdominal',
    nome: 'Abdominal (Crunch)',
    grupo: 'Abd√¥men',
    tipo: 'isolamento',
    articulacoes: ['coluna'],
    fadiga: 'baixa',
    primarios: ['abdReto'],
    secundarios: ['obliquo','transverso'],
    dica: 'Flexione o tronco ‚Äî n√£o puxe o pesco√ßo. Expira√ß√£o no esfor√ßo. Imagine esmagar uma laranja no abd√¥men.',
    sobreposicao: [],
    barraObrigatoria: false,
    resposta: 'tensao',
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUPINO FECHADO / TR√çCEPS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  {
    id: 'supino_fechado',
    nome: 'Supino Fechado',
    grupo: 'Tr√≠ceps',
    tipo: 'composto',
    articulacoes: ['cotovelo','ombro'],
    fadiga: 'media',
    primarios: ['tricepsLat','tricepsMed'],
    secundarios: ['peitoMed','deltAnt'],
    dica: 'Pegada na largura dos ombros. Cotovelos pr√≥ximos ao corpo ‚Äî descida controlada.',
    sobreposicao: ['triceps_polia','triceps_testa','supino_reto'],
    barraObrigatoria: true,
    resposta: 'densidade',
  },
];

// ‚îÄ‚îÄ FUN√á√ïES DO BANCO DE DADOS ‚îÄ‚îÄ

function getExercicioDb(nomeOuId) {
  const nome = (nomeOuId || '').toLowerCase().trim();
  return EXERCICIOS_DB.find(e =>
    e.id === nome ||
    e.nome.toLowerCase().includes(nome) ||
    nome.includes(e.id.replace(/_/g,' '))
  );
}

function detectarSobreposicao(exerciciosDoTreino) {
  // Receives array of exercise names/ids
  // Returns array of overlap warnings
  const alertas = [];
  const compostos = [];

  exerciciosDoTreino.forEach(nome => {
    const ex = getExercicioDb(nome);
    if (!ex) return;
    if (ex.tipo === 'composto') compostos.push(ex);
  });

  // Check each pair
  for (let i = 0; i < compostos.length; i++) {
    for (let j = i + 1; j < compostos.length; j++) {
      const a = compostos[i];
      const b = compostos[j];
      // Check if they share primary muscles
      const shared = a.primarios.filter(m => b.primarios.includes(m));
      if (shared.length > 0) {
        const musculoNomes = shared.map(m => MUSCULOS[m]?.nome || m).join(' e ');
        alertas.push({
          tipo: 'sobreposicao',
          exercicio1: a.nome,
          exercicio2: b.nome,
          musculos: musculoNomes,
          html: `<div class="card card-sm" style="border-color:var(--yellow); margin-bottom:10px;">
            <div style="display:flex; align-items:flex-start; gap:10px;">
              <span style="font-size:20px; flex-shrink:0;">‚ö†Ô∏è</span>
              <div>
                <div style="font-weight:700; color:var(--yellow); font-size:13px;">Sobreposi√ß√£o detectada</div>
                <div style="font-size:12px; color:var(--muted2); margin-top:3px; line-height:1.5;">
                  <strong style="color:var(--text);">${a.nome}</strong> e <strong style="color:var(--text);">${b.nome}</strong> 
                  s√£o ambos compostos que recrutam <strong style="color:var(--yellow);">${musculoNomes}</strong> como m√∫sculo prim√°rio.
                  Para iniciante, considere substituir um por um exerc√≠cio de isolamento.
                </div>
              </div>
            </div>
          </div>`
        });
      }
    }
  }
  return alertas;
}

function getInfoMusculo(musculoId) {
  return MUSCULOS[musculoId] || null;
}

// ‚îÄ‚îÄ FADIGA DE SECUND√ÅRIOS ‚îÄ‚îÄ
// Checks if muscles trained yesterday/today (as secondary) will affect today's workout
function detectarFadigaSecundaria(grupoHoje) {
  const alertas = [];
  const agora = Date.now();
  const ontem = agora - 86400000;
  const doisDias = agora - 172800000;

  // Get sessions from last 2 days
  const sessoeRecentes = (state.sessions || []).filter(s =>
    s.date > doisDias && !s.isRestDay && !s.isCardio
  );

  if (!sessoeRecentes.length) return [];

  // Map: which muscle groups were trained recently
  const gruposTreinados = new Set();
  sessoeRecentes.forEach(s => {
    (s.exercises || []).forEach(ex => {
      const dbEx = getExercicioDb(ex.name);
      if (dbEx) {
        gruposTreinados.add(dbEx.grupo);
        // Also add secondary muscle groups
        dbEx.secundarios.forEach(mId => {
          const m = MUSCULOS[mId];
          if (m?.grupo) gruposTreinados.add(m.grupo);
        });
      }
    });
  });

  // Rules: which groups affect which
  const conflitos = {
    'Peito':   ['Ombro','Tr√≠ceps'],   // peito usa ombro ant + tr√≠ceps
    'Costas':  ['B√≠ceps','Ombro'],    // costas usa b√≠ceps + delt√≥ide post
    'Ombro':   ['Peito','Tr√≠ceps'],   // ombro usa tr√≠ceps + peito sup
    'B√≠ceps':  ['Costas'],
    'Tr√≠ceps': ['Peito','Ombro'],
  };

  const gruposConflitantes = conflitos[grupoHoje] || [];
  const conflitosEncontrados = gruposConflitantes.filter(g => gruposTreinados.has(g));

  if (conflitosEncontrados.length > 0) {
    const horasAtras = sessoeRecentes.length > 0
      ? Math.round((agora - Math.max(...sessoeRecentes.map(s => s.date))) / 3600000)
      : 0;

    alertas.push({
      tipo: 'fadiga_secundaria',
      grupos: conflitosEncontrados,
      html: `<div class="card card-sm" style="border-color:rgba(255,152,0,0.5); margin-bottom:10px; background:rgba(255,152,0,0.05);">
        <div style="display:flex; align-items:flex-start; gap:10px;">
          <span style="font-size:20px; flex-shrink:0;">‚ö°</span>
          <div>
            <div style="font-weight:700; color:#ff9800; font-size:13px;">Fadiga de m√∫sculos secund√°rios</div>
            <div style="font-size:12px; color:var(--muted2); margin-top:3px; line-height:1.5;">
              Voc√™ treinou <strong style="color:var(--text);">${conflitosEncontrados.join(' e ')}</strong> h√° ~${horasAtras}h.
              Esses grupos s√£o <strong style="color:#ff9800;">secund√°rios no treino de ${grupoHoje}</strong> de hoje.
              Pode afetar volume e progress√£o ‚Äî considere reduzir 10-15% da carga inicial.
            </div>
          </div>
        </div>
      </div>`
    });
  }

  return alertas;
}

// ‚îÄ‚îÄ RESPOSTA IDEAL POR GRUPO (densidade vs tens√£o) ‚îÄ‚îÄ
function getRespostaIdeal(grupoOuMusculo) {
  const mapa = {
    'Quadr√≠ceps': 'densidade', 'quad': 'densidade',
    'Gl√∫teo M√°ximo': 'densidade', 'glutMax': 'densidade',
    'Peito': 'densidade',
    'Grande Dorsal': 'densidade', 'dorsal': 'densidade',
    'Isquiotibiais': 'tensao', 'isquio': 'tensao',
    'Gl√∫teo M√©dio': 'tensao', 'glutMed': 'tensao',
    'Adutores': 'tensao',
    'Panturrilha': 'tensao',
    'B√≠ceps': 'tensao',
    'Tr√≠ceps': 'densidade',
  };
  return mapa[grupoOuMusculo] || null;
}

function getDicaResposta(grupo) {
  const resposta = getRespostaIdeal(grupo);
  if (!resposta) return '';
  if (resposta === 'densidade') {
    return `<div style="background:rgba(255,92,0,0.08); border-radius:8px; padding:8px 12px; font-size:12px; color:var(--muted2); margin-top:8px;">
      üî• <strong style="color:var(--orange);">Densidade Din√¢mica</strong> ‚Äî ${grupo} responde melhor a intervalos curtos (45-60s) e volume alto. Progrida na carga quando dominar as reps.
    </div>`;
  } else {
    return `<div style="background:rgba(76,175,80,0.08); border-radius:8px; padding:8px 12px; font-size:12px; color:var(--muted2); margin-top:8px;">
      ‚è±Ô∏è <strong style="color:var(--green);">Tempo sob Tens√£o</strong> ‚Äî ${grupo} responde melhor a cad√™ncia lenta (3s na descida) e amplitude completa. Menos peso, mais controle.
    </div>`;
  }
}

function getFichaExercicio(nomeOuId) {
  const ex = getExercicioDb(nomeOuId);
  if (!ex) return null;

  const primNomes = ex.primarios.map(m => MUSCULOS[m]?.nome || m);
  const secNomes  = ex.secundarios.map(m => MUSCULOS[m]?.nome || m);
  const fadugaCor = { alta: 'var(--red)', media: 'var(--yellow)', baixa: 'var(--green)' }[ex.fadiga];
  const tipoCor   = ex.tipo === 'composto' ? 'var(--orange)' : 'var(--blue)';

  return `
    <div style="padding:4px 0;">
      <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:12px;">
        <span class="tag" style="background:rgba(255,92,0,0.1);color:${tipoCor};">
          ${ex.tipo === 'composto' ? 'üîó Composto' : 'üéØ Isolamento'}
        </span>
        <span class="tag" style="color:${fadugaCor}; background:rgba(255,255,255,0.05);">
          ‚ö° Fadiga ${ex.fadiga}
        </span>
        <span class="tag tag-blue">${ex.articulacoes.length} articula√ß√£o${ex.articulacoes.length > 1 ? '√µes' : ''}</span>
      </div>

      <div style="font-size:12px; font-weight:700; color:var(--muted2); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">M√∫sculos prim√°rios</div>
      <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:12px;">
        ${primNomes.map(n => `<span class="tag" style="background:rgba(255,92,0,0.15);color:var(--orange);">${n}</span>`).join('')}
      </div>

      ${secNomes.length ? `
      <div style="font-size:12px; font-weight:700; color:var(--muted2); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">M√∫sculos secund√°rios</div>
      <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:12px;">
        ${secNomes.map(n => `<span class="tag tag-blue">${n}</span>`).join('')}
      </div>` : ''}

      <div style="background:var(--card2); border-left:3px solid var(--orange); border-radius:0 8px 8px 0; padding:10px 12px; font-size:13px; color:var(--muted2); line-height:1.6; margin-bottom:12px;">
        üí° ${ex.dica}
      </div>

      ${getDicaResposta(ex.grupo)}

    ${ex.sobreposicao?.length ? `
      <div style="font-size:12px; font-weight:700; color:var(--yellow); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px;">‚ö†Ô∏è Evite combinar com</div>
      <div style="font-size:13px; color:var(--muted2);">
        ${ex.sobreposicao.map(id => {
          const s = EXERCICIOS_DB.find(e => e.id === id);
          return s ? `<span style="color:var(--text);">${s.nome}</span>` : id;
        }).join(', ')}
        <span style="display:block;margin-top:4px;font-size:11px;">Recrutam os mesmos m√∫sculos prim√°rios ‚Äî excesso de volume no mesmo grupo.</span>
      </div>` : ''}
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BIBLIOTECA ADN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const MUSCULOS_ADN = {
  quadriceps: {
    nome: 'Quadr√≠ceps', complexo: 'Complexo Anterior da Coxa', icone: 'ü¶µ',
    resposta: 'üî• Alta Densidade ‚Äî Suporta muita carga. Responde bem a descansos curtos (45-60s) e volume alto.',
    alertaSecundario: ['Peito','Gl√∫teo'],
    ramificacoes: [
      { nome: 'Vasto Lateral', desc: 'Por√ß√£o EXTERNA ‚Äî d√° largura √† coxa',
        isolados: ['Cadeira Extensora (p√©s para dentro)', 'Extens√£o unilateral'],
        compostos: ['Agachamento (base estreita)', 'Leg Press (p√©s baixos e juntos)'] },
      { nome: 'Vasto Medial (Gota)', desc: 'A "gota" acima do joelho ‚Äî defini√ß√£o interna',
        isolados: ['Cadeira Extensora (p√©s para fora)', 'Extens√£o com rota√ß√£o externa'],
        compostos: ['Agachamento B√∫lgaro', 'Hack Machine (p√©s largos)'] },
      { nome: 'Reto Femoral', desc: 'Por√ß√£o frontal ‚Äî atua no quadril E no joelho',
        isolados: ['Cadeira Extensora (contra√ß√£o no topo)', 'Sissy Squat'],
        compostos: ['Agachamento Frontal', 'Leg Press (p√©s altos)'] },
      { nome: 'Vasto Interm√©dio', desc: 'Por√ß√£o profunda ‚Äî ativado em amplitude total',
        isolados: ['Cadeira Extensora (p√©s neutros)', 'Extens√£o com isometria'],
        compostos: ['Hack Squat', 'Leg Press (p√©s m√©dios)'] }
    ]
  },
  posteriores: {
    nome: 'Posteriores', complexo: 'Complexo Posterior da Coxa', icone: 'ü¶µ',
    resposta: '‚è±Ô∏è Tempo sob Tens√£o ‚Äî Cad√™ncia lenta na fase exc√™ntrica (3s descendo). Amplitude total.',
    alertaSecundario: ['Gl√∫teo','Lombar'],
    ramificacoes: [
      { nome: 'B√≠ceps Femoral', desc: 'Por√ß√£o lateral ‚Äî cabe√ßa longa e curta',
        isolados: ['Mesa Flexora (p√©s em ponta)', 'Flexora Unilateral'],
        compostos: ['Stiff (p√©s juntos)', 'Terra Romeno'] },
      { nome: 'Semitend√≠neo', desc: 'Por√ß√£o medial superficial',
        isolados: ['Mesa Flexora (p√©s flexionados)', 'Cadeira Flexora lenta'],
        compostos: ['Stiff (base larga)', 'Good Morning'] },
      { nome: 'Semimembran√°ceo', desc: 'Por√ß√£o medial profunda',
        isolados: ['Mesa Flexora Deitado', 'Cadeira Flexora (p√©s neutros)'],
        compostos: ['Terra', 'Stiff com halteres'] }
    ]
  },
  gluteos: {
    nome: 'Gl√∫teos', complexo: 'Complexo P√©lvico ‚Äî O Motor do Shape', icone: 'üçë',
    resposta: '‚ö° Explos√£o + Carga ‚Äî Gl√∫teo m√°ximo: alta carga. M√©dio/M√≠nimo: tens√£o constante e abdu√ß√£o.',
    alertaSecundario: ['Perna','Lombar'],
    ramificacoes: [
      { nome: 'Gl√∫teo M√°ximo', desc: 'Maior m√∫sculo do corpo ‚Äî volume e pot√™ncia',
        isolados: ['Hip Thrust', 'Eleva√ß√£o P√©lvica', 'Coice na m√°quina'],
        compostos: ['Agachamento Profundo', 'Terra Sum√¥', 'Afundo'] },
      { nome: 'Gl√∫teo M√©dio', desc: 'LATERAL do quadril ‚Äî evita o "buraco" na lateral',
        isolados: ['Cadeira Abdutora', 'Concha com caneleira', 'Abdu√ß√£o deitado'],
        compostos: ['Agachamento B√∫lgaro', 'Passada lateral'] },
      { nome: 'Gl√∫teo M√≠nimo', desc: 'Profundo ‚Äî rota√ß√£o e equil√≠brio p√©lvico',
        isolados: ['Abdu√ß√£o deitado lateral', 'Cadeira Abdutora (isometria)'],
        compostos: ['Agachamento', 'Afundo'] }
    ]
  },
  adutores: {
    nome: 'Adutores', complexo: 'Complexo Interno da Coxa', icone: 'ü¶µ',
    resposta: '‚è±Ô∏è Alongamento Ativo ‚Äî Amplitude total e tens√£o constante. Cad√™ncia lenta na abertura.',
    alertaSecundario: ['Gl√∫teo'],
    ramificacoes: [
      { nome: 'Adutor Longo', desc: 'Por√ß√£o superior e medial ‚Äî o mais vis√≠vel',
        isolados: ['Cadeira Adutora', 'Adu√ß√£o com cabo'],
        compostos: ['Agachamento Sum√¥', 'Afundo lateral'] },
      { nome: 'Adutor Curto', desc: 'Profundo ‚Äî estabiliza√ß√£o do quadril',
        isolados: ['Cadeira Adutora (p√©s neutros)', 'Adu√ß√£o com el√°stico'],
        compostos: ['Agachamento amplo', 'Passada lateral com el√°stico'] },
      { nome: 'Adutor Magno', desc: 'O MAIOR adutor ‚Äî tamb√©m auxilia extens√£o de quadril',
        isolados: ['Cadeira Adutora (isometria)', 'Adu√ß√£o deitado lateral'],
        compostos: ['Stiff (base larga)', 'Agachamento profundo'] },
      { nome: 'Gr√°cil', desc: 'Cruza joelho E quadril ‚Äî estabilidade do joelho',
        isolados: ['Mesa Flexora', 'Adu√ß√£o com perna estendida'],
        compostos: ['Agachamento', 'Afundo curto'] }
    ]
  },
  panturrilhas: {
    nome: 'Panturrilhas', complexo: 'Complexo Posterior da Perna', icone: 'ü¶µ',
    resposta: '‚è±Ô∏è Alta Repeti√ß√£o ‚Äî M√∫sculos posturais. Respondem a amplitude COMPLETA e muitas reps (15-25).',
    alertaSecundario: [],
    ramificacoes: [
      { nome: 'Gastrocn√™mio', desc: 'As duas "cabe√ßas" vis√≠veis ‚Äî joelho ESTENDIDO',
        isolados: ['Panturrilha em P√©', 'G√™meos no Leg Press'],
        compostos: ['Agachamento', 'Saltos'] },
      { nome: 'S√≥leo', desc: 'Por baixo ‚Äî d√° ESPESSURA. Joelho DOBRADO',
        isolados: ['Panturrilha Sentado', 'Eleva√ß√£o sentado com carga'],
        compostos: ['Caminhada inclinada', 'Corrida'] },
      { nome: 'Tibial Posterior', desc: 'Profundo ‚Äî invers√£o do p√© e arco plantar',
        isolados: ['Invers√£o com el√°stico', 'Eleva√ß√£o com rota√ß√£o'],
        compostos: ['Pular corda', 'Corrida em terreno irregular'] }
    ]
  },
  peitoral: {
    nome: 'Peitoral', complexo: 'Tronco Anterior', icone: 'üí™',
    resposta: 'üî• Progress√£o de Carga ‚Äî Foco em empurrar. ‚ö†Ô∏è Delt√≥ide anterior e Tr√≠ceps ser√£o exigidos como secund√°rios.',
    alertaSecundario: ['Ombro','Tr√≠ceps'],
    ramificacoes: [
      { nome: 'Peitoral Superior (Clavicular)', desc: 'D√° a "prateleira" ao peito ‚Äî inclinado 30-45¬∞',
        isolados: ['Crucifixo Inclinado', 'Crossover (cabos baixos)'],
        compostos: ['Supino Inclinado', 'Desenvolvimento'] },
      { nome: 'Peitoral M√©dio (Esternal)', desc: 'A maior parte do peito ‚Äî supino reto',
        isolados: ['Crucifixo Reto', 'Voador (Peck Deck)'],
        compostos: ['Supino Reto', 'Flex√µes'] },
      { nome: 'Peitoral Inferior (Costal)', desc: 'Curvatura inferior ‚Äî declinado e mergulho',
        isolados: ['Crucifixo Declinado', 'Crossover (cabos altos)'],
        compostos: ['Supino Declinado', 'Mergulho'] },
      { nome: 'Peitoral Menor', desc: 'Profundo ‚Äî estabiliza a esc√°pula',
        isolados: ['Pullover', 'Serr√°til no cabo'],
        compostos: ['Flex√µes com esc√°pula', 'Desenvolvimento'] }
    ]
  },
  dorsal: {
    nome: 'Dorsal / Costas', complexo: 'Tronco Posterior', icone: 'ü¶∫',
    resposta: 'üî• Amplitude M√°xima ‚Äî Puxe com os COTOVELOS, n√£o as m√£os. ‚ö†Ô∏è B√≠ceps ser√£o muito exigidos como secund√°rios.',
    alertaSecundario: ['B√≠ceps','Ombro'],
    ramificacoes: [
      { nome: 'Lat√≠ssimo do Dorso (Asas)', desc: 'Maior m√∫sculo das costas ‚Äî o "V"',
        isolados: ['Puxada Aberta', 'Pullover'],
        compostos: ['Barra Fixa', 'Remada Curvada'] },
      { nome: 'Trap√©zio M√©dio', desc: 'Retra√ß√£o escapular ‚Äî postura',
        isolados: ['Voador Inverso', 'Face Pull'],
        compostos: ['Remada Baixa', 'Remada Cavalinho'] },
      { nome: 'Trap√©zio Inferior', desc: 'Depress√£o escapular ‚Äî estabilidade',
        isolados: ['Face Pull alto', 'Eleva√ß√£o Frontal (acima da cabe√ßa)'],
        compostos: ['Puxada pela frente', 'Remada alta'] },
      { nome: 'Romboides', desc: 'Retra√ß√£o e rota√ß√£o escapular',
        isolados: ['Voador Inverso', 'Remada com el√°stico'],
        compostos: ['Remada Serrote', 'Barra Fixa'] }
    ]
  },
  ombros: {
    nome: 'Ombros', complexo: 'Cintura Escapular', icone: 'üî∫',
    resposta: '‚ö° Volume Acumulado ‚Äî Respondem a mais repeti√ß√µes (12-20). ‚ö†Ô∏è Tr√≠ceps e Peitoral Superior s√£o secund√°rios.',
    alertaSecundario: ['Peito','Tr√≠ceps'],
    ramificacoes: [
      { nome: 'Delt√≥ide Anterior', desc: '‚ö†Ô∏è J√Å exigido em exerc√≠cios de PEITO ‚Äî cuidado com excesso',
        isolados: ['Eleva√ß√£o Frontal', 'Crucifixo Inclinado'],
        compostos: ['Desenvolvimento', 'Supino Inclinado'] },
      { nome: 'Delt√≥ide Lateral', desc: 'Largura dos ombros ‚Äî √öNICO exerc√≠cio que o isola',
        isolados: ['Eleva√ß√£o Lateral', 'Eleva√ß√£o Lateral Inclinado'],
        compostos: ['Desenvolvimento', 'Remada Alta'] },
      { nome: 'Delt√≥ide Posterior', desc: '‚ö†Ô∏è Muito negligenciado ‚Äî essencial para sa√∫de e postura',
        isolados: ['Crucifixo Inverso', 'Face Pull'],
        compostos: ['Remada Baixa', 'Remada Curvada'] }
    ]
  },
  bracos: {
    nome: 'Bra√ßos', complexo: 'B√≠ceps + Tr√≠ceps', icone: 'üí™',
    resposta: 'üéØ Conex√£o Mente-M√∫sculo ‚Äî ‚ö†Ô∏è B√≠ceps j√° trabalham em Costas. Tr√≠ceps j√° trabalham em Peito e Ombro.',
    alertaSecundario: ['Costas','Peito','Ombro'],
    ramificacoes: [
      { nome: 'B√≠ceps ‚Äî Cabe√ßa Longa', desc: 'Comprimento e pico do b√≠ceps',
        isolados: ['Rosca Direta', 'Rosca Scott', 'Rosca Inclinada'],
        compostos: ['Barra Fixa (supinada)', 'Remada Supinada'] },
      { nome: 'B√≠ceps ‚Äî Cabe√ßa Curta', desc: 'Largura e espessura',
        isolados: ['Rosca Martelo', 'Rosca Concentrada'],
        compostos: ['Barra Fixa (fechada)', 'Puxada (pegada neutra)'] },
      { nome: 'Braquial', desc: 'Por baixo do b√≠ceps ‚Äî empurra o pico para cima',
        isolados: ['Rosca Martelo', 'Rosca Inversa'],
        compostos: ['Barra Fixa', 'Remada'] },
      { nome: 'Tr√≠ceps ‚Äî Cabe√ßa Longa', desc: 'Maior parte do tr√≠ceps ‚Äî cruza o ombro',
        isolados: ['Tr√≠ceps Testa', 'Tr√≠ceps Franc√™s'],
        compostos: ['Supino Fechado', 'Mergulho'] },
      { nome: 'Tr√≠ceps ‚Äî Cabe√ßa Lateral', desc: 'A "ferradura" do bra√ßo ‚Äî mais vis√≠vel',
        isolados: ['Tr√≠ceps Pulley (corda)', 'Tr√≠ceps Coice'],
        compostos: ['Desenvolvimento', 'Supino'] },
      { nome: 'Tr√≠ceps ‚Äî Cabe√ßa Medial', desc: 'Profunda ‚Äî base e espessura',
        isolados: ['Tr√≠ceps Pulley (corda)', 'Extens√£o unilateral'],
        compostos: ['Mergulho', 'Flex√£o diamante'] }
    ]
  },
  abdomen: {
    nome: 'Abd√¥men / Core', complexo: 'Estabiliza√ß√£o do Tronco', icone: 'üî•',
    resposta: '‚è±Ô∏è Frequ√™ncia + Isometria ‚Äî Pode treinar 3-4x/semana. Foco em estabilidade, n√£o em movimento.',
    alertaSecundario: [],
    ramificacoes: [
      { nome: 'Reto Abdominal', desc: 'O "tanquinho" ‚Äî flex√£o do tronco',
        isolados: ['Abdominal Supra', 'Abdominal Infra', 'Canivete'],
        compostos: ['Prancha', 'Eleva√ß√£o de Pernas'] },
      { nome: 'Obl√≠quo Externo', desc: 'Lateral e rota√ß√£o do tronco',
        isolados: ['Abdominal Lateral', 'Tor√ß√£o Russa'],
        compostos: ['Prancha Lateral', 'Remada com rota√ß√£o'] },
      { nome: 'Obl√≠quo Interno', desc: 'Profundo ‚Äî abaixo do externo',
        isolados: ['Abdominal Lateral (lento)', 'Tor√ß√£o com cabo'],
        compostos: ['Prancha com eleva√ß√£o', 'Agachamento unilateral'] },
      { nome: 'Transverso Abdominal', desc: 'O "cinto" profundo ‚Äî comprime e estabiliza',
        isolados: ['V√°cuo Abdominal', 'Prancha com suc√ß√£o'],
        compostos: ['Agachamento', 'Terra'] }
    ]
  },
  lombar: {
    nome: 'Lombar / Eretores', complexo: 'Regi√£o Lombar', icone: 'ü¶∫',
    resposta: '‚è±Ô∏è Estabilidade e Controle ‚Äî Foco em resist√™ncia, n√£o for√ßa m√°xima. Nunca treinar fatigado.',
    alertaSecundario: ['Perna','Gl√∫teo'],
    ramificacoes: [
      { nome: 'Eretor da Espinha (Iliocostal)', desc: 'Por√ß√£o lateral da coluna',
        isolados: ['Extens√£o de Lombar', 'Superman'],
        compostos: ['Levantamento Terra', 'Bom Dia'] },
      { nome: 'Eretor da Espinha (Longu√≠ssimo)', desc: 'Por√ß√£o central ‚Äî mais longa',
        isolados: ['Extens√£o no Banco Romano', 'Ponte Inversa'],
        compostos: ['Agachamento', 'Terra'] },
      { nome: 'Mult√≠fidos', desc: 'Profundos ‚Äî estabiliza√ß√£o segmentar da coluna',
        isolados: ['Prancha', 'Cachorro-Passarinho'],
        compostos: ['Agachamento controlado', 'Terra'] }
    ]
  },
  trapezio: {
    nome: 'Trap√©zio', complexo: 'Superior das Costas / Pesco√ßo', icone: 'ü¶∫',
    resposta: 'üî• Carga Progressiva ‚Äî Responde bem a altas cargas e isometria. Encolhimento pesado.',
    alertaSecundario: ['Costas','Ombro'],
    ramificacoes: [
      { nome: 'Trap√©zio Superior', desc: 'Eleva√ß√£o dos ombros ‚Äî o mais vis√≠vel',
        isolados: ['Encolhimento', 'Remada Alta'],
        compostos: ['Desenvolvimento', 'Puxada Alta'] },
      { nome: 'Trap√©zio M√©dio', desc: 'Retra√ß√£o escapular ‚Äî postura',
        isolados: ['Voador Inverso', 'Face Pull'],
        compostos: ['Remada Baixa', 'Remada Curvada'] },
      { nome: 'Trap√©zio Inferior', desc: 'Depress√£o escapular ‚Äî pouco treinado',
        isolados: ['Eleva√ß√£o Frontal (acima da cabe√ßa)', 'Face Pull alto'],
        compostos: ['Puxada pela frente', 'Desenvolvimento'] }
    ]
  },
};

let bibExpandedMusculo = null;
let bibExpandedRam = null;

function renderBiblioteca() {
  const el = document.getElementById('biblioteca-lista');
  if (!el) return;

  const iconeMap = {
    quadriceps: 'ü¶µ', posteriores: 'ü¶µ', gluteos: 'üçë', adutores: 'ü¶µ',
    panturrilhas: 'ü¶µ', peitoral: 'üí™', dorsal: 'ü¶∫', ombros: 'üî∫',
    bracos: 'üí™', abdomen: 'üî•', lombar: 'ü¶∫', trapezio: 'ü¶∫'
  };

  el.innerHTML = Object.entries(MUSCULOS_ADN).map(([key, m]) => {
    const isOpen = bibExpandedMusculo === key;
    return `
    <div style="background:var(--card); border:1px solid ${isOpen ? 'var(--orange)' : 'var(--border2)'}; border-radius:16px; margin-bottom:12px; overflow:hidden; transition:border-color 0.2s;">
      <!-- Cabe√ßalho do m√∫sculo -->
      <div onclick="bibToggleMusculo('${key}')" style="display:flex; align-items:center; gap:12px; padding:16px; cursor:pointer;">
        <div style="width:44px; height:44px; background:var(--orange-dim); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:22px; flex-shrink:0;">
          ${iconeMap[key] || 'üí™'}
        </div>
        <div style="flex:1;">
          <div style="font-weight:700; font-size:16px;">${m.nome}</div>
          <div style="font-size:11px; color:var(--muted2); margin-top:2px;">${m.complexo}</div>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
          <span style="background:var(--orange-dim); color:var(--orange); font-size:10px; font-weight:700; padding:3px 8px; border-radius:20px;">${m.ramificacoes.length} por√ß√µes</span>
          <span style="color:var(--muted2); font-size:18px; transition:transform 0.3s; ${isOpen ? 'transform:rotate(180deg)' : ''}">‚ñæ</span>
        </div>
      </div>

      <!-- Corpo expandido -->
      ${isOpen ? `
      <div style="border-top:1px solid var(--border); padding:14px 16px;">
        <!-- Est√≠mulo ideal -->
        <div style="background:var(--orange-dim); border:1px solid rgba(255,92,0,0.2); border-radius:10px; padding:10px 12px; font-size:12px; color:var(--orange); margin-bottom:14px; line-height:1.6;">
          <strong>‚ö° EST√çMULO IDEAL:</strong><br><span style="color:var(--muted2);">${m.resposta}</span>
        </div>

        ${m.alertaSecundario?.length ? `
        <div style="background:rgba(255,200,0,0.06); border:1px solid rgba(255,200,0,0.2); border-radius:10px; padding:10px 12px; font-size:12px; color:var(--yellow); margin-bottom:14px; line-height:1.6;">
          ‚ö†Ô∏è <strong>Fadiga cruzada com:</strong> <span style="color:var(--muted2);">${m.alertaSecundario.join(', ')} ‚Äî verifique seus treinos recentes antes de adicionar volume aqui.</span>
        </div>` : ''}

        <!-- Ramifica√ß√µes -->
        ${m.ramificacoes.map((ram, idx) => {
          const ramKey = key + '_' + idx;
          const ramOpen = bibExpandedRam === ramKey;
          return `
          <div style="background:var(--card2); border-radius:12px; margin-bottom:8px; overflow:hidden; border:1px solid ${ramOpen ? 'var(--orange)' : 'transparent'};">
            <div onclick="bibToggleRam('${ramKey}')" style="display:flex; align-items:center; justify-content:space-between; padding:12px 14px; cursor:pointer;">
              <div>
                <div style="font-weight:700; font-size:14px; color:${ramOpen ? 'var(--orange)' : 'var(--text)'};">${ram.nome}</div>
                <div style="font-size:12px; color:var(--muted2); margin-top:2px;">${ram.desc}</div>
              </div>
              <span style="color:var(--muted2); font-size:16px; transition:transform 0.2s; ${ramOpen ? 'transform:rotate(90deg)' : ''}">‚ñ∂</span>
            </div>

            ${ramOpen ? `
            <div style="border-top:1px solid var(--border); padding:12px 14px; animation:fadeIn 0.2s ease;">
              <div style="font-size:11px; font-weight:700; color:var(--orange); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px;">üéØ Isoladores</div>
              ${ram.isolados.map(ex => `
                <div style="display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid var(--border);">
                  <span style="color:var(--orange); font-size:14px;">‚Ä¢</span>
                  <span style="font-size:13px;">${ex}</span>
                </div>`).join('')}

              <div style="font-size:11px; font-weight:700; color:#60a5fa; text-transform:uppercase; letter-spacing:1px; margin:12px 0 8px;">üîó Compostos</div>
              ${ram.compostos.map(ex => `
                <div style="display:flex; align-items:center; gap:8px; padding:6px 0; border-bottom:1px solid var(--border);">
                  <span style="color:#60a5fa; font-size:14px;">‚Ä¢</span>
                  <span style="font-size:13px;">${ex}</span>
                </div>`).join('')}
            </div>` : ''}
          </div>`;
        }).join('')}
      </div>` : ''}
    </div>`;
  }).join('');
}

function bibToggleMusculo(key) {
  bibExpandedMusculo = bibExpandedMusculo === key ? null : key;
  bibExpandedRam = null;
  renderBiblioteca();
  // Scroll to opened card
  setTimeout(() => {
    const cards = document.querySelectorAll('#biblioteca-lista > div');
    const keys = Object.keys(MUSCULOS_ADN);
    const idx = keys.indexOf(key);
    if (idx !== -1 && cards[idx]) {
      cards[idx].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }, 50);
}

function bibToggleRam(ramKey) {
  bibExpandedRam = bibExpandedRam === ramKey ? null : ramKey;
  renderBiblioteca();
}

// Legacy compat
function setBibliotecaFiltro() {}
function filtrarBiblioteca() {}

// ‚îÄ‚îÄ Overlap check when adding exercises to a plan ‚îÄ‚îÄ
function checkOverlapNoPlan(planId, newExName) {
  const plan = state.plans?.find(p => p.id === planId);
  if (!plan || !plan.exercises?.length) return [];

  const todosNomes = [...plan.exercises.map(e => e.name), newExName];
  return detectarSobreposicao(todosNomes);
}

// ‚îÄ‚îÄ Show overlap warning inside saveExercise ‚îÄ‚îÄ
function renderOverlapAlerts(planId, newExName) {
  const alertas = checkOverlapNoPlan(planId, newExName);
  const container = document.getElementById('overlap-alerts-modal');
  if (!container) return;
  if (!alertas.length) { container.innerHTML = ''; return; }
  container.innerHTML = alertas.map(a => a.html).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
load();

if (state.user) {
  document.getElementById('onboarding-screen').style.display = 'none';
  document.getElementById('app-screen').style.display = 'flex';
  initApp();
}
</script>
  <!-- PWA Service Worker (only registers when hosted on GitHub Pages, not in preview) -->
  <script>
    if ('serviceWorker' in navigator && location.hostname !== 'www.claudeusercontent.com') {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('service-worker.js')
          .then(reg => console.log('SW registrado:', reg.scope))
          .catch(err => console.log('SW erro:', err));
      });
    }

    // Install prompt ‚Äî mostra bot√£o "Instalar app" quando dispon√≠vel
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      const btn = document.getElementById('install-btn');
      if (btn) btn.style.display = 'flex';
    });

    window.addEventListener('appinstalled', () => {
      deferredPrompt = null;
      const btn = document.getElementById('install-btn');
      if (btn) btn.style.display = 'none';
      showNotif('üéâ', 'App instalado!', 'PROGRESSAR foi adicionado √† sua tela inicial', 'success');
    });

    function installApp() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(choice => {
          deferredPrompt = null;
        });
      }
    }
  </script>
</body>
</html>